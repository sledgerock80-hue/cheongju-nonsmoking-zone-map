<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CLUSTRO ì™„ì „ í†µí•© ë²„ì „ - ëª¨ë“  ê¸°ëŠ¥ í¬í•¨ (Final v13.5)</title>

<!-- ğŸ”’ SECURITY HEADERS - ë¯¼ê° ì •ë³´ ë…¸ì¶œ ë° XSS ë°©ì§€ -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self'; 
  script-src 'self' 'unsafe-inline' https://unpkg.com https://fonts.gstatic.com https://api.vworld.kr https://router.project-osrm.org;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com;
  font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com;
  img-src 'self' data: blob: https: http:;
  connect-src 'self' https: http: https://router.project-osrm.org;
  frame-ancestors 'none';
  base-uri 'self';
  form-action 'self';
">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
<meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

<style>
/**
 * ğŸ¨ DESIGN SYSTEM - ì¼ê´€ëœ ì½”ë”© ìŠ¤íƒ€ì¼ê³¼ ë°˜ì‘í˜• ë””ìì¸
 * ëª¨ë“  CSS ë³€ìˆ˜ì™€ í´ë˜ìŠ¤ëŠ” ì²´ê³„ì ìœ¼ë¡œ ì •ë¦¬ë¨
 */
:root {
  /* ğŸ¨ Color System - ì ‘ê·¼ì„±ì„ ê³ ë ¤í•œ ìƒ‰ìƒ ëŒ€ë¹„ */
  --c-primary: #1F3A8A;
  --c-sky: #0EA5E9;
  --c-accent: #EA580C;
  --c-util: #334155;
  --c-success: #059669;
  --c-warning: #D97706;
  --c-danger: #DC2626;
  
  /* ğŸ“ Layout System */
  --rail-w: 64px;
  --side-w: 380px;
  --gut-w: 6px;
  
  /* ğŸ“ Typography System */
  --flt-font: 14px;
  --tbl-font: 14px;
  --font-family: 300 "Roboto", "Apple SD Gothic Neo", "Malgun Gothic", system-ui, sans-serif;
  
  /* ğŸ—ºï¸ Map System */
  --mk: 30px;
  
  /* ğŸ¯ Animation System */
  --transition-fast: 0.15s ease;
  --transition-normal: 0.25s ease;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
}

/* ğŸ“± RESPONSIVE DESIGN - ë‹¤ì–‘í•œ í™”ë©´ í¬ê¸° ì§€ì› */
@media (max-width: 768px) {
  :root {
    --rail-w: 48px;
    --side-w: 280px;
    --flt-font: 12px;
    --tbl-font: 12px;
  }
  
  #app {
    grid-template-columns: var(--rail-w) 1fr;
    grid-template-areas: "rail toolbar" "rail main";
  }
  
  #lhs {
    position: fixed;
    left: -100%;
    top: 0;
    width: var(--side-w);
    height: 100vh;
    z-index: 9999;
    transition: left var(--transition-normal);
  }
  
  #lhs.mobile-open {
    left: var(--rail-w);
  }
  
  .mobile-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9998;
    display: none;
  }
  
  .mobile-overlay.show {
    display: block;
  }
  
  /* ì„ íƒëª©ë¡ íŒ¨ë„ ëª¨ë°”ì¼ ìµœì í™” */
  #selPanel {
    right: 12px !important;
    bottom: 70px !important;
    min-width: 280px !important;
    max-width: calc(100vw - 24px) !important;
    min-height: 180px !important;
    max-height: calc(100vh - 140px) !important;
    border-radius: 16px !important;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12) !important;
  }
  
  #mapControlsTop {
    flex-direction: row !important;
    flex-wrap: wrap !important;
    gap: 6px !important;
    align-items: center !important;
    padding: 8px !important;
  }
  
  #mapControlsTop .btn {
    flex: 1 1 auto !important;
    min-width: 80px !important;
    padding: 10px 12px !important;
    font-size: 14px !important;
    min-height: 40px !important;
  }
}

@media (max-width: 480px) {
  :root {
    --rail-w: 40px;
    --side-w: 100vw;
  }
  
  .icbtn span {
    display: none;
  }
  
  #selPanel {
    right: 8px !important;
    bottom: 60px !important;
    min-width: 260px !important;
    max-width: calc(100vw - 16px) !important;
  }
}

/* ğŸ¯ BASE STYLES */
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font: 14px/1.45 var(--font-family);
  color: #111;
  background: #fff;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ğŸ“ LAYOUT GRID */
#app {
  display: grid;
  min-height: 100vh;
  grid-template-columns: var(--rail-w) var(--side-w) var(--gut-w) 1fr;
  grid-template-rows: auto 1fr;
  grid-template-areas: "rail toolbar toolbar toolbar" "rail lhs gut rhs";
}

/* ğŸ”§ TOOLBAR */
#toolbar {
  grid-area: toolbar;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  padding: 8px 10px;
  border-bottom: 1px solid #e5e7eb;
  background: #fff;
  position: relative;
  z-index: 1000;
}

/* ğŸ›ï¸ FORM CONTROLS - ì¼ê´€ëœ ìŠ¤íƒ€ì¼ë§ */
.form-control,
select,
input[type="text"],
input[type="file"],
input[type="number"],
input[type="url"],
input[type="search"] {
  padding: 7px 10px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  background: #fff;
  font-weight: 300;
  transition: all var(--transition-fast);
  font-family: inherit;
}

.form-control:focus,
select:focus,
input:focus {
  outline: none;
  border-color: var(--c-sky);
  box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.1);
}

.form-control:invalid {
  border-color: var(--c-danger);
}

/* ğŸ·ï¸ BADGES & STATUS */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid #e5e7eb;
  background: #fff;
  font-weight: 700;
  font-size: 12px;
  transition: all var(--transition-fast);
}

.badge.ok {
  border-color: #cfe9d5;
  color: var(--c-success);
  background: #f0fdf4;
}

.badge.warn {
  border-color: #fed7aa;
  color: var(--c-warning);
  background: #fffbeb;
}

.badge.bad {
  border-color: #fecaca;
  color: var(--c-danger);
  background: #fef2f2;
}

/* ğŸ”˜ BUTTONS - í–¥ìƒëœ ë²„íŠ¼ ì‹œìŠ¤í…œ */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  border: 1px solid transparent;
  font-weight: 600;
  font-size: 14px;
  text-decoration: none;
  transition: all var(--transition-fast);
  user-select: none;
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.btn:hover::before {
  left: 100%;
}

.btn-primary {
  background: var(--c-primary);
  border-color: var(--c-primary);
  color: #fff;
}

.btn-sky {
  background: var(--c-sky);
  border-color: var(--c-sky);
  color: #fff;
}

.btn-accent {
  background: var(--c-accent);
  border-color: var(--c-accent);
  color: #fff;
}

.btn-util {
  background: var(--c-util);
  border-color: var(--c-util);
  color: #fff;
}

.btn-outline {
  background: transparent;
  border-color: currentColor;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}

.btn:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn:active:not(:disabled) {
  transform: translateY(0);
}

/* ğŸ“± LEFT RAIL */
#rail {
  grid-area: rail;
  border-right: 1px solid #e5e7eb;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 8px 6px;
  gap: 8px;
  position: relative;
  z-index: 1001;
}

.logo-box {
  width: 56px;
  height: 56px;
  padding: 4px;
  border-radius: 14px;
  border: 1px solid #e5e7eb;
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

.logo-box svg {
  width: 48px;
  height: 48px;
  display: block;
}

.icbtn {
  width: 56px;
  border: 1px solid #e5e7eb;
  border-radius: 14px;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 8px 4px;
  cursor: pointer;
  transition: all var(--transition-fast);
  position: relative;
}

.icbtn svg {
  width: 22px;
  height: 22px;
  stroke: #111;
  fill: none;
  stroke-width: 2;
  transition: all var(--transition-fast);
}

.icbtn span {
  font-size: 11px;
  font-weight: 700;
  color: #111;
  transition: all var(--transition-fast);
}

.icbtn.active {
  background: var(--c-sky);
  border-color: var(--c-sky);
  box-shadow: var(--shadow-md);
}

.icbtn.active svg,
.icbtn.active span {
  stroke: #fff;
  color: #fff;
}

.icbtn:hover:not(.active) {
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

/* ğŸ“‹ LEFT SIDEBAR */
#lhs {
  grid-area: lhs;
  border-right: 1px solid #e5e7eb;
  background: #fff;
  overflow: auto;
  font-size: var(--flt-font);
}

/* ğŸ” DETAILS & ACCORDION */
details {
  border-bottom: 1px solid #f1f5f9;
}

details:last-child {
  border-bottom: none;
}

summary {
  list-style: none;
  cursor: pointer;
  padding: 14px 12px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: all var(--transition-fast);
  user-select: none;
}

summary::-webkit-details-marker {
  display: none;
}

summary::after {
  content: '+';
  font-size: 18px;
  font-weight: 300;
  transition: transform var(--transition-fast);
}

details[open] summary::after {
  transform: rotate(45deg);
}

summary:hover {
  background: #f8fafc;
}

details[open] summary {
  border-bottom: 1px solid #e2e8f0;
  background: #f8fafc;
}

.card {
  padding: 12px;
}

/* ğŸ“ RESIZER */
#gut {
  grid-area: gut;
  background: #f3f4f6;
  cursor: col-resize;
  transition: background var(--transition-fast);
}

#gut:hover {
  background: #e5e7eb;
}

/* ğŸ—ºï¸ MAP CONTAINER */
#rhs {
  grid-area: rhs;
  position: relative;
  background: #fafafa;
}

#map {
  position: absolute;
  inset: 0;
}

/* ğŸ”˜ MAP CONTROLS */
.map-bottom {
  position: absolute;
  right: 16px;
  bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  z-index: 6500;
}

.toolbar-map {
  position: static;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  z-index: 6500;
}

/* ğŸ“‹ PANELS */
.panel {
  position: absolute;
  right: 16px;
  bottom: 90px;
  width: min(640px, 60vw);
  max-height: 60vh;
  overflow: hidden;
  background: #fff;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  box-shadow: var(--shadow-lg);
  z-index: 6000;
  display: none;
  min-width: 360px;
  min-height: 220px;
  backdrop-filter: blur(10px);
}

.panel .head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid #e2e8f0;
  background: #f8fafc;
  cursor: move;
  user-select: none;
}

.panel .head h4 {
  margin: 0;
  font-size: 14px;
  font-weight: 700;
}

.panel .body {
  overflow: auto;
  max-height: calc(60vh - 60px);
}

/* ğŸ“Š TABLES */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: var(--tbl-font);
  border: 1px solid #e2e8f0;
}

thead th {
  position: sticky;
  top: 0;
  background: #f8fafc;
  border-bottom: 1px solid #e2e8f0;
  padding: 10px 8px;
  font-weight: 700;
  border-right: 1px solid #f1f5f9;
  text-align: left;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

tbody td {
  border-bottom: 1px solid #f1f5f9;
  border-right: 1px solid #f1f5f9;
  padding: 8px;
  font-weight: 400;
  background: #fff;
}

tbody tr:hover {
  background: #f8fafc;
}

tbody tr.selected {
  background: #eff6ff;
  border-color: var(--c-sky);
}

/* ğŸ¯ MARKERS */
.mk {
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  line-height: 1;
  transform-origin: center;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.mk-circle {
  width: var(--mk);
  height: var(--mk);
  border-radius: 50%;
  border: 2px solid #000;
  background: #fff;
  color: #000;
  box-shadow: var(--shadow-md);
  font-size: 12px;
}

.mk-tag {
  padding: 4px 8px;
  border-radius: 6px;
  background: #000;
  color: #fff;
  border: 2px solid #000;
  box-shadow: var(--shadow-md);
  font-size: 12px;
}

.mk-bubble {
  position: relative;
  padding: 4px 8px 6px 8px;
  border-radius: 6px;
  background: #fff;
  color: #000;
  border: 2px solid #000;
  box-shadow: var(--shadow-md);
  font-size: 12px;
}

.mk-bubble i {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: -7px;
  width: 0;
  height: 0;
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 8px solid #000;
}

.mk-bubble.sel {
  background: var(--c-danger);
  color: #fff;
  border-color: var(--c-danger);
}

.mk-bubble.sel i {
  border-top-color: var(--c-danger);
}

.mk.hover {
  transform: scale(1.15);
  z-index: 1000;
}

/* ğŸ”§ UTILITY CLASSES */
.small { font-size: 12px; color: #6b7280; font-weight: 400; }
.text-center { text-align: center; }
.text-right { text-align: right; }
.hidden { display: none !important; }
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

/* ğŸ¨ FORM LAYOUTS */
.row {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

.row > * {
  flex: 1 1 auto;
}

.chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 6px;
}

.chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #f3f4f6;
  border: 1px solid #e5e7eb;
  border-radius: 999px;
  padding: 4px 8px;
  color: #111;
  font-size: 12px;
  transition: all var(--transition-fast);
  cursor: pointer;
  user-select: none;
}

.chip:hover {
  background: #e5e7eb;
  transform: translateY(-1px);
}

.chip input[type="checkbox"] {
  margin: 0;
}

/* ğŸ›ï¸ SWITCHES */
.switch {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 26px;
}

.switch input {
  display: none;
}

.slider {
  position: absolute;
  inset: 0;
  background: #e5e7eb;
  border: 1px solid #d1d5db;
  border-radius: 999px;
  transition: all var(--transition-normal);
  cursor: pointer;
}

.slider:before {
  content: "";
  position: absolute;
  width: 22px;
  height: 22px;
  left: 2px;
  top: 1px;
  background: #fff;
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: all var(--transition-normal);
}

.switch input:checked + .slider {
  background: var(--c-sky);
  border-color: var(--c-sky);
}

.switch input:checked + .slider:before {
  transform: translateX(22px);
}

/* ğŸ·ï¸ WATERMARK */
#wm {
  position: fixed;
  bottom: 8px;
  right: 8px;
  z-index: 9999;
  background: rgba(255,255,255,0.8);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  color: #666;
  backdrop-filter: blur(4px);
}

/* íŒ¨ë„ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ */
.panel .edge {
  position: absolute;
  background: transparent;
}

.panel .e-left {
  left: -16px;
  top: 0;
  width: 22px;
  height: 100%;
  cursor: ew-resize;
}

.panel .e-right {
  right: -16px;
  top: 0;
  width: 22px;
  height: 100%;
  cursor: ew-resize;
}

.panel .e-top {
  top: -20px;
  left: 0;
  width: 100%;
  height: 24px;
  cursor: ns-resize;
}

.panel .e-bottom {
  bottom: -16px;
  left: 0;
  width: 100%;
  height: 22px;
  cursor: ns-resize;
}

.panel.dragging .edge {
  pointer-events: none;
  opacity: 0;
}

.panel.resizing .head {
  pointer-events: none;
  cursor: default;
}

/* ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€ */
.clo-hidden {
  opacity: 0 !important;
  pointer-events: none !important;
}

/* ì§€ë„ ì°¨ë‹¨ ì‹¤ë“œ */
#mapShield {
  position: fixed;
  inset: 0;
  background: transparent;
  z-index: 5999;
  display: none;
}

/* A/B ì§€ì  ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
.ab-marker {
  background: var(--c-accent) !important;
  border-color: var(--c-accent) !important;
}

/* ë‹¤í¬ëª¨ë“œ ì§€ì› */
.bw #map {
  filter: grayscale(100%) contrast(105%);
}

body.dark {
  background: #0b1220;
  color: #e5e7eb;
}

body.dark #toolbar,
body.dark #lhs,
body.dark #rail,
body.dark .panel {
  background: #0f172a;
  border-color: #1f2937;
  color: #e5e7eb;
}

body.dark details {
  border-color: #1f2937;
}

body.dark summary {
  color: #e5e7eb;
}

body.dark .card {
  background: #0f172a;
}

body.dark select,
body.dark input[type="text"],
body.dark input[type="file"],
body.dark input[type="number"],
body.dark input[type="search"] {
  background: #0b1220;
  color: #e5e7eb;
  border-color: #334155;
}

body.dark .chip {
  background: #0b1322;
  border-color: #243041;
  color: #e5e7eb;
}

body.dark .panel .head {
  background: #0b1322;
  border-bottom-color: #243041;
}

body.dark table {
  background: #0f172a;
  border-color: #243041;
}

body.dark thead th {
  background: #0b1322;
  border-bottom-color: #243041;
  border-right-color: #243041;
}

body.dark tbody td {
  background: #0f172a;
  border-right-color: #243041;
  border-bottom-color: #243041;
}

body.dark .icbtn {
  background: #0f172a;
  border-color: #243041;
}

body.dark .icbtn svg {
  stroke: #e5e7eb;
}

body.dark .icbtn span {
  color: #e5e7eb;
}

body.dark .badge {
  background: #111827;
  border-color: #374151;
  color: #e5e7eb;
}

body.dark .badge.ok {
  background: #0f1a14;
  border-color: #1a3c2a;
  color: #8bf0b2;
}

body.dark .badge.warn {
  background: #2a2310;
  border-color: #4b3a0e;
  color: #ffd36a;
}

body.dark .badge.bad {
  background: #2a1212;
  border-color: #4b1e1e;
  color: #ff9e9e;
}

/* í”„ë¦°íŠ¸ ìŠ¤íƒ€ì¼ */
@media print {
  #rail, #lhs, .panel, .map-bottom { display: none !important; }
  #rhs { grid-column: 1 / -1; }
  body { background: white !important; }
}
</style>

<link id="leaflet-css" rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
</head>

<body>
<!-- ì§€ë„ ìƒí˜¸ì‘ìš© ì°¨ë‹¨ìš© ì‹¤ë“œ -->
<div id="mapShield" aria-hidden="true"></div>

<!-- Mobile Overlay -->
<div class="mobile-overlay" id="mobileOverlay"></div>

<div id="app">
  <!-- ğŸ“± LEFT RAIL - ëª¨ë°”ì¼ ì¹œí™”ì  ë„¤ë¹„ê²Œì´ì…˜ -->
  <aside id="rail">
    <div class="logo-box" title="CLUSTRO v13.5 - ì™„ì „ í†µí•© ë²„ì „" aria-label="CLUSTRO ë¡œê³ ">
      <svg viewBox="0 0 64 64" aria-label="CLUSTRO logo">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#0EA5E9"/>
            <stop offset="1" stop-color="#1F3A8A"/>
          </linearGradient>
        </defs>
        <circle cx="32" cy="32" r="28" fill="url(#g)" stroke="#0b2540" stroke-width="2"/>
        <circle cx="22" cy="22" r="4" fill="#fff"/>
        <circle cx="42" cy="22" r="4" fill="#fff"/>
        <circle cx="22" cy="42" r="4" fill="#fff"/>
        <circle cx="42" cy="42" r="4" fill="#fff"/>
        <path d="M22 22 L42 42 M42 22 L22 42" stroke="#fff" stroke-width="2"/>
      </svg>
    </div>
    
    <button class="icbtn" data-target="#secData" title="ë°ì´í„° ê´€ë¦¬" aria-label="ë°ì´í„° ê´€ë¦¬" role="tab">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 7h18M3 12h18M3 17h18"/>
        <circle cx="7" cy="7" r="1"/>
        <circle cx="11" cy="12" r="1"/>
        <circle cx="15" cy="17" r="1"/>
      </svg>
      <span>ë°ì´í„°</span>
    </button>
    
    <button class="icbtn" data-target="#secFilter" title="í•„í„° ì„¤ì •" aria-label="í•„í„° ì„¤ì •" role="tab">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 5h18l-7 8v5l-4 2v-7z"/>
      </svg>
      <span>í•„í„°</span>
    </button>
    
    <button class="icbtn" data-target="#secMap" title="ì§€ë„ ì„¤ì •" aria-label="ì§€ë„ ì„¤ì •" role="tab">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 6l7-3 7 3 4-2v16l-7 3-7-3-4 2V6zM10 3v16M17 6v15M3 6v14"/>
      </svg>
      <span>ì§€ë„</span>
    </button>
    
    <button class="icbtn" data-target="#secRoute" title="ê²½ë¡œ ê³„íš" aria-label="ê²½ë¡œ ê³„íš" role="tab">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 6h6l2 4h8M4 18h10l2-4h4"/>
      </svg>
      <span>ê²½ë¡œ</span>
    </button>
    
    <button class="icbtn" data-target="#secPrint" title="ì¶œë ¥ ì„¤ì •" aria-label="ì¶œë ¥ ì„¤ì •" role="tab">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M6 9V3h12v6M6 14h12v7H6z"/>
        <rect x="3" y="9" width="18" height="7" rx="2"/>
      </svg>
      <span>ì¶œë ¥</span>
    </button>
    
    <!-- ë‹¤í¬ëª¨ë“œ í† ê¸€ -->
    <label class="chip" style="font-size:10px;user-select:none;padding:4px 6px;margin-top:8px">
      <input type="checkbox" id="darkToggle" style="margin-right:4px"> ë‹¤í¬ëª¨ë“œ
    </label>
    
    <div style="margin-top:auto;font-size:11px;color:#9ca3af;text-align:center;">
      <div>v13.5</div>
      <div style="font-size:9px;">ğŸ”’ ì™„ì „í†µí•©</div>
    </div>
  </aside>

  <!-- ğŸ”§ TOOLBAR - ë°˜ì‘í˜• ë„êµ¬ëª¨ìŒ -->
  <header id="toolbar" role="banner">
    <button class="btn btn-sky mobile-menu-btn" id="mobileMenuBtn" aria-label="ë©”ë‰´ ì—´ê¸°" style="display:none;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
      ë©”ë‰´
    </button>
    
    <div class="badge ok">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 12l2 2 4-4"></path>
        <circle cx="12" cy="12" r="9"></circle>
      </svg>
      ë³´ì•ˆ ê°•í™”ë¨
    </div>
    
    <div class="badge" id="statusBadge">
      <span id="statusText">ì¤€ë¹„ë¨</span>
    </div>
    
    <!-- ìƒë‹¨ ì§€ë„ ì»¨íŠ¸ë¡¤: ì„ íƒëª©ë¡/ë§ì¶¤/í•„í„°ì ìš© -->
    <div id="mapControlsTop" style="display:flex;gap:6px;align-items:center">
      <button class="btn btn-sky" id="btnToggleSelTop" title="ì„ íƒëª©ë¡">ì„ íƒëª©ë¡</button>
      <button class="btn btn-sky" id="btnFitTop" title="ë§ì¶¤">ë§ì¶¤</button>
      <button class="btn btn-sky" id="btnRefreshTop" title="í•„í„°ì ìš©">í•„í„°ì ìš©</button>
    </div>
    
    <div style="display:flex;gap:6px;align-items:center">
      <!-- ë¼ë²¨ ì†ŒìŠ¤ ì„ íƒ -->
      <span class="small">ë¼ë²¨</span>
      <select id="labelSrc">
        <option value="id">ê³ ìœ ë²ˆí˜¸</option>
        <option value="name">ì‹œì„¤ëª…</option>
        <option value="addr">êµ¬ë¶„ì£¼ì†Œ</option>
      </select>
      
      <!-- ë°°ê²½ ì§€ë„ ì„ íƒ -->
      <span class="small">ë°°ê²½</span>
      <select id="baseSelect">
        <option value="osm">OpenStreetMap</option>
        <option value="vworld_base" selected>VWorld ê¸°ë³¸</option>
        <option value="vworld_satellite">VWorld ìœ„ì„±</option>
        <option value="google_roadmap">Google ë„ë¡œ</option>
        <option value="google_satellite">Google ìœ„ì„±</option>
      </select>
      
      <!-- ì¤Œ ì»¨íŠ¸ë¡¤ -->
      <span class="small">ì¤Œ</span>
      <input type="range" id="zoomRange" min="5" max="19" step="0.1" value="12" style="width:160px">
      <span id="zoomVal" class="badge">12.0</span>
    </div>
    
    <div style="display:flex;gap:6px;align-items:center">
      <!-- ê²½ë¡œ ì•Œê³ ë¦¬ì¦˜ ì„ íƒ -->
      <select id="routeMethod">
        <option value="nn2opt" selected>ë¹ ë¥¸(ìµœê·¼ì +2-opt)</option>
        <option value="nn">ìµœê·¼ì </option>
        <option value="cluster">í´ëŸ¬ìŠ¤í„°</option>
        <option value="hilbert">íë²„íŠ¸</option>
        <option value="kmeans">K-í‰ê· </option>
        <option value="osrm">OSRM (ì‹¤ì œë„ë¡œ)</option>
      </select>
      
      <!-- í•˜ë£¨ ìµœëŒ€ í¬ì¸íŠ¸ -->
      <label class="small">í•˜ë£¨ ìµœëŒ€</label>
      <input type="number" id="dailyMax" value="50" min="1" max="999" style="width:84px">
      
      <!-- ê²½ë¡œ ê³„ì‚° ë²„íŠ¼ -->
      <button class="btn btn-primary" id="btnRoute" style="padding:6px 12px;font-size:12px">ê²½ë¡œ ê³„ì‚°</button>
      <button class="btn btn-util" id="btnRouteClear" style="padding:6px 12px;font-size:12px">ì´ˆê¸°í™”</button>
    </div>
    
    <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
      <span class="badge" id="bTotal">ì´: 0</span>
      <span class="badge ok" id="bShown">í‘œì‹œ: 0</span>
      <span class="badge warn" id="bMissing">ì¢Œí‘œì—†ìŒ: 0</span>
      <span class="badge bad" id="bFiltered">í•„í„°ì œì™¸: 0</span>
    </div>
    
    <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ -->
    <input type="file" id="selFile" accept=".xlsx,.xls,.xlsm,.tsv,.csv" style="display:none">
  </header>

  <!-- ğŸ“‹ LEFT SIDEBAR - í–¥ìƒëœ UI/UX -->
  <nav id="lhs" role="navigation" aria-label="ë©”ì¸ ë„¤ë¹„ê²Œì´ì…˜">
    <!-- ğŸ“Š DATA SECTION -->
    <section id="secData" class="sec active">
      <details open>
        <summary role="button" aria-expanded="true">
          <span>ğŸ“Š ë°ì´í„° ë¡œë“œ</span>
        </summary>
        <div class="card">
          <div class="row">
            <label class="form-control" for="fileInput" style="cursor: pointer; text-align: center;">
              <input type="file" id="fileInput" accept=".xlsx,.xls,.xlsm,.csv,.json" style="display: none;" aria-describedby="fileHelp">
              ğŸ“ íŒŒì¼ ì„ íƒ
            </label>
          </div>
          <div id="fileHelp" class="small" style="margin-top: 4px;">
            Excel(.xlsx, .xlsm), CSV, JSON íŒŒì¼ ì§€ì› (ìµœëŒ€ 10MB)
          </div>
        </div>
      </details>

      <details id="adv" style="display:none">
        <summary role="button" aria-expanded="false">
          <span>âš™ï¸ ê³ ê¸‰ ì„¤ì •</span>
        </summary>
        <div class="card">
          <div class="row">
            <label for="sheet">ì‹œíŠ¸:</label>
            <select id="sheet" class="form-control" aria-label="ì‹œíŠ¸ ì„ íƒ"></select>
          </div>
          <div class="row">
            <label for="latCol">ìœ„ë„ ì—´:</label>
            <input type="text" id="latCol" value="R" class="form-control" aria-label="ìœ„ë„ ì»¬ëŸ¼">
          </div>
          <div class="row">
            <label for="lngCol">ê²½ë„ ì—´:</label>
            <input type="text" id="lngCol" value="S" class="form-control" aria-label="ê²½ë„ ì»¬ëŸ¼">
          </div>
          <button class="btn btn-primary" id="apply">ì ìš©</button>
        </div>
      </details>

      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ“ˆ ë°ì´í„° í˜„í™©</span>
        </summary>
        <div class="card">
          <div class="row">
            <span class="badge" id="totalBadge">ì „ì²´: 0</span>
            <span class="badge ok" id="validBadge">ìœ íš¨: 0</span>
            <span class="badge warn" id="errorBadge">ì˜¤ë¥˜: 0</span>
          </div>
        </div>
      </details>
    </section>

    <!-- ğŸ” FILTER SECTION -->
    <section id="secFilter" class="sec">
      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ” ê²€ìƒ‰ í•„í„°</span>
        </summary>
        <div class="card">
          <div class="row">
            <input type="search" 
                   id="scopeInput" 
                   placeholder="ìë©´ë™ ë˜ëŠ” êµ°ì§‘ë²ˆí˜¸ ê²€ìƒ‰..." 
                   class="form-control"
                   autocomplete="off"
                   aria-label="ê²€ìƒ‰ì–´ ì…ë ¥">
            <button class="btn btn-sky" id="btnApplyScope">
              ê²€ìƒ‰
            </button>
          </div>
        </div>
      </details>

      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ˜ï¸ ìë©´ë™ë³„</span>
        </summary>
        <div class="card">
          <div class="chips" id="emdBox" role="group" aria-label="ìë©´ë™ í•„í„°"></div>
        </div>
      </details>

      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ‘¥ êµ°ì§‘ë³„</span>
        </summary>
        <div class="card">
          <div class="chips" id="grpBox" role="group" aria-label="êµ°ì§‘ í•„í„°"></div>
        </div>
      </details>
    </section>

    <!-- ğŸ—ºï¸ MAP SECTION -->
    <section id="secMap" class="sec">
      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ—ºï¸ ì§€ë„ ì„¤ì •</span>
        </summary>
        <div class="card">
          <div class="row">
            <label>ë§ˆì»¤ ìŠ¤íƒ€ì¼:</label>
            <select id="markerStyle" class="form-control" aria-label="ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì„ íƒ">
              <option value="circle">ì›í˜•</option>
              <option value="tag">íƒœê·¸</option>
              <option value="bubble" selected>ë§í’ì„ </option>
            </select>
          </div>
          
          <div class="row" style="margin-top: 12px;">
            <label>
              <input type="checkbox" id="clusterToggle" checked> 
              ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ë§
            </label>
          </div>
          
          <div class="row">
            <label>
              <input type="checkbox" id="bwToggle"> 
              í‘ë°± ëª¨ë“œ
            </label>
          </div>
        </div>
      </details>

      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ¨ í‘œì‹œ ì˜µì…˜</span>
        </summary>
        <div class="card">
          <div class="row">
            <label for="fontSizeRange">í°íŠ¸ í¬ê¸°:</label>
            <input type="range" 
                   id="fontSizeRange" 
                   min="10" 
                   max="18" 
                   value="14" 
                   class="form-control"
                   aria-label="í°íŠ¸ í¬ê¸° ì¡°ì ˆ">
            <span id="fontSizeValue">14px</span>
          </div>
          
          <div class="row">
            <label for="markerSizeRange">ë§ˆì»¤ í¬ê¸°:</label>
            <input type="range" 
                   id="markerSizeRange" 
                   min="20" 
                   max="50" 
                   value="30" 
                   class="form-control"
                   aria-label="ë§ˆì»¤ í¬ê¸° ì¡°ì ˆ">
            <span id="markerSizeValue">30px</span>
          </div>
        </div>
      </details>
    </section>

    <!-- ğŸ›£ï¸ ROUTE SECTION -->
    <section id="secRoute" class="sec">
      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ›£ï¸ ê³ ê¸‰ ê²½ë¡œ ì„¤ì •</span>
        </summary>
        <div class="card">
          <!-- ìë™ ì±„ì›€ ë° ì‹œì‘/ë ê³ ì • -->
          <div class="row" style="margin-bottom: 8px;">
            <label class="chip">
              <input type="checkbox" id="autoFill"> í•„í„° ê²°ê³¼ â†’ ì„ íƒëª©ë¡ ìë™ ì±„ì›€(ë®ì–´ì“°ê¸°)
            </label>
          </div>
          
          <div class="row" style="margin-bottom: 8px;">
            <label class="chip">
              <input type="checkbox" id="fixEnds"> ì‹œì‘/ë ê³ ì •(ì²«Â·ë§ˆì§€ë§‰ ìœ ì§€)
            </label>
          </div>
          
          <!-- A/B ì§€ì  ì„ íƒ -->
          <div class="row" style="margin-bottom: 8px;">
            <button class="btn btn-sky" id="btnPickAB">ì§€ë„ì—ì„œ A/B ì„ íƒ</button>
            <button class="btn btn-util" id="btnABReset">ì´ˆê¸°í™”</button>
          </div>
          
          <div class="row">
            <span class="badge" id="abInfo">A/B: -</span>
            <span class="badge" id="routeStat">ê±°ë¦¬: - / ì‹œê°„: -</span>
          </div>
          
          <!-- OSRM í”„ë¡œí•„ ì„¤ì • -->
          <div class="row" style="margin-top: 8px;">
            <label>OSRM í”„ë¡œí•„:</label>
            <select id="osrmProfile" class="form-control">
              <option value="driving">ìë™ì°¨</option>
              <option value="walking">ë„ë³´</option>
              <option value="cycling">ìì „ê±°</option>
            </select>
          </div>
          
          <!-- ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€ í† ê¸€ -->
          <div style="margin-top:8px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
            <label class="chip" style="user-select:none">
              <input type="checkbox" id="toggleHideNonRoute"> ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€
            </label>
            <span class="small">â€» í‘œì˜ <b>ê³ ìœ ë²ˆí˜¸</b>ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìˆ¨ê¹€ ì²˜ë¦¬</span>
          </div>
        </div>
      </details>

      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ“‹ ì„ íƒ ê´€ë¦¬</span>
        </summary>
        <div class="card">
          <button class="btn btn-sky" id="btnSelLoad">
            ğŸ“‚ ì„ íƒëª©ë¡ ë¡œë“œ
          </button>
          
          <button class="btn btn-util" id="btnSelClear">
            ğŸ—‘ï¸ ì„ íƒ ì´ˆê¸°í™”
          </button>
          
          <div id="selectionStats" class="small" style="margin-top: 8px;">
            ì„ íƒëœ í•­ëª©: <span id="selectedCount">0</span>ê°œ
          </div>
        </div>
      </details>
    </section>

    <!-- ğŸ–¨ï¸ PRINT SECTION -->
    <section id="secPrint" class="sec">
      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ–¨ï¸ ì¶œë ¥ ì„¤ì •</span>
        </summary>
        <div class="card">
          <div class="row">
            <button class="btn btn-primary" id="btnExportExcel">
              ğŸ“Š Excel ë‚´ë³´ë‚´ê¸°
            </button>
          </div>
          
          <div class="row">
            <button class="btn btn-accent" id="btnPrintScreen">
              ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°
            </button>
          </div>
        </div>
      </details>
    </section>
  </nav>

  <!-- ğŸ“ RESIZER -->
  <div id="gut" title="íŒ¨ë„ í¬ê¸° ì¡°ì ˆ" tabindex="0" role="separator" aria-label="íŒ¨ë„ í¬ê¸° ì¡°ì ˆ"></div>

  <!-- ğŸ—ºï¸ MAP CONTAINER -->
  <main id="rhs" role="main">
    <div id="map" aria-label="ì¸í„°ë™í‹°ë¸Œ ì§€ë„"></div>
    
    <!-- MAP CONTROLS -->
    <div class="map-bottom">
      <div class="toolbar-map">
        <button class="btn btn-sky" id="btnCenterMap" title="ì§€ë„ ì¤‘ì‹¬ ì´ë™">
          ğŸ¯ ì¤‘ì‹¬
        </button>
        
        <button class="btn btn-primary" id="btnFitBounds" title="ì „ì²´ ë³´ê¸°">
          ğŸ” ì „ì²´
        </button>
        
        <button class="btn btn-accent" id="btnShowStats" title="í†µê³„ ë³´ê¸°">
          ğŸ“Š í†µê³„
        </button>
      </div>
    </div>
    
    <!-- WATERMARK -->
    <div id="wm">CLUSTRO v13.5 ì™„ì „ í†µí•© ë²„ì „</div>
  </main>
</div>

<!-- ğŸ“‹ SELECTION PANEL -->
<div class="panel" id="selPanel" role="dialog" aria-labelledby="selPanelTitle" aria-hidden="true">
  <div class="head">
    <h4 id="selPanelTitle">ğŸ“‹ ì„ íƒëœ í•­ëª©</h4>
    <button class="btn btn-util" id="btnClosePanel" aria-label="íŒ¨ë„ ë‹«ê¸°">
      âœ•
    </button>
  </div>
  <div class="body">
    <div style="padding: 8px;">
      <button class="btn btn-accent" id="btnClearAll" style="margin-bottom: 8px;">
        ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
      </button>
      <button class="btn btn-primary" id="btnExportSel" style="margin-bottom: 8px;">
        ğŸ“Š ì„ íƒí•­ëª© Excel ì €ì¥
      </button>
    </div>
    <table role="table" aria-label="ì„ íƒëœ í•­ëª© ëª©ë¡">
      <thead>
        <tr>
          <th scope="col">ê³ ìœ ë²ˆí˜¸</th>
          <th scope="col">ì‹œì„¤ëª…</th>
          <th scope="col">êµ¬ë¶„ì£¼ì†Œ</th>
          <th scope="col">ê²½ë¡œìˆœë²ˆ</th>
          <th scope="col" class="row-actions">ì‚­ì œ</th>
        </tr>
      </thead>
      <tbody id="selBody"></tbody>
    </table>
  </div>
  
  <!-- ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ -->
  <div class="edge e-left"></div>
  <div class="edge e-right"></div>
  <div class="edge e-top"></div>
  <div class="edge e-bottom"></div>
</div>

<!-- ğŸ”§ EXTERNAL SCRIPTS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- ğŸš€ MAIN APPLICATION SCRIPT -->
<script>
'use strict';

/**
 * CLUSTRO ì™„ì „ í†µí•© ë²„ì „ v13.5
 * UI/UX ìµœì í™” ê¸°ë°˜ìœ¼ë¡œ ëª¨ë“  ê¸°ëŠ¥ ì™„ì „ í†µí•©
 */

// ì „ì—­ ë³€ìˆ˜
let myMap, clusterGroup, routeLayer;
let rows = [], rowsById = new Map(), selectedIds = new Set();
let currentWorkbook = null;
let isComputing = false;
let AB = [], abMarkers = [];

// jQuery-like í—¬í¼
const $ = (q, root = document) => root.querySelector(q);
const $$ = (q, root = document) => Array.from(root.querySelectorAll(q));

// ì„¤ì • ë³€ìˆ˜
let tblFont = 14, fltFont = 14, mk = 30;

/**
 * ğŸ”’ ë³´ì•ˆ ë° ê²€ì¦ í•¨ìˆ˜ë“¤
 */
const SecurityUtils = {
  escapeHtml(unsafe) {
    if (unsafe == null) return '';
    return String(unsafe)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  },

  validateInput(input, type = 'text', maxLength = 1000) {
    if (input == null) return '';
    
    input = String(input).trim();
    
    if (input.length > maxLength) {
      input = input.substring(0, maxLength);
    }
    
    switch(type) {
      case 'number':
        return input.replace(/[^\d.-]/g, '');
      case 'alphanumeric':
        return input.replace(/[^a-zA-Z0-9ê°€-í£\s\-_]/g, '');
      case 'coordinate':
        return input.replace(/[^\d.-]/g, '');
      default:
        return input.replace(/<script[^>]*>.*?<\/script>/gi, '')
                   .replace(/javascript:/gi, '')
                   .replace(/on\w+\s*=/gi, '')
                   .replace(/<iframe[^>]*>.*?<\/iframe>/gi, '');
    }
  },

  validateFile(file) {
    const errors = [];
    const MAX_SIZE = 10 * 1024 * 1024; // 10MB
    const ALLOWED_TYPES = ['.xlsx', '.xls', '.xlsm', '.csv', '.json'];
    
    if (!file) {
      errors.push('íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return errors;
    }
    
    if (file.size > MAX_SIZE) {
      errors.push(`íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. (ìµœëŒ€: ${MAX_SIZE/1024/1024}MB)`);
    }
    
    const fileExt = '.' + file.name.split('.').pop().toLowerCase();
    if (!ALLOWED_TYPES.includes(fileExt)) {
      errors.push(`í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (í—ˆìš©: ${ALLOWED_TYPES.join(', ')})`);
    }
    
    return errors;
  }
};

/**
 * ğŸ”” ì•Œë¦¼ ì‹œìŠ¤í…œ
 */
const NotificationSystem = {
  show(message, type = 'success', duration = 3000) {
    // ê°„ë‹¨í•œ ì•Œë¦¼ êµ¬í˜„
    const badge = $('#statusBadge');
    const statusText = $('#statusText');
    
    if (badge && statusText) {
      const typeClass = type === 'error' ? 'bad' : (type === 'warning' ? 'warn' : 'ok');
      badge.className = `badge ${typeClass}`;
      statusText.textContent = message;
      
      setTimeout(() => {
        badge.className = 'badge';
        statusText.textContent = 'ì¤€ë¹„ë¨';
      }, duration);
    }
  }
};

/**
 * ğŸ—ºï¸ ì§€ë„ ì´ˆê¸°í™” ë° ê´€ë¦¬
 */
async function initializeMap() {
  try {
    const mapContainer = $('#map');
    if (!mapContainer) throw new Error('ì§€ë„ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    
    if (myMap) {
      myMap.remove();
    }
    
    myMap = L.map('map').setView([36.5, 127.5], 8);
    
    // ê¸°ë³¸ íƒ€ì¼ ë ˆì´ì–´
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(myMap);
    
    // í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ì´ˆê¸°í™”
    clusterGroup = L.markerClusterGroup({
      maxClusterRadius: 50,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false
    });
    
    myMap.addLayer(clusterGroup);
    
    // ê²½ë¡œ ë ˆì´ì–´ ì´ˆê¸°í™”
    routeLayer = L.layerGroup().addTo(myMap);
    
    console.log('ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ');
    
  } catch (error) {
    console.error('ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    NotificationSystem.show('ì§€ë„ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
  }
}

/**
 * ğŸ“‚ íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜ë“¤
 */
async function loadExcelFile() {
  const fileInput = $('#fileInput');
  const file = fileInput?.files?.[0];
  
  if (!file) {
    NotificationSystem.show('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
    return;
  }
  
  const validationErrors = SecurityUtils.validateFile(file);
  if (validationErrors.length > 0) {
    NotificationSystem.show(validationErrors.join('\n'), 'error');
    return;
  }
  
  try {
    const workbook = await readExcelFile(file);
    currentWorkbook = workbook;
    
    if (workbook.SheetNames.includes("2025DATA")) {
      const processedRows = processWorksheet(workbook.Sheets["2025DATA"]);
      await updateDataState(processedRows);
      NotificationSystem.show(`ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${processedRows.length}ê°œ í–‰`, 'success');
    } else {
      showAdvancedSettings(workbook);
      NotificationSystem.show('2025DATA ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ê³ ê¸‰ ì„¤ì •ì„ ì—½ë‹ˆë‹¤.', 'warning');
    }
    
  } catch (error) {
    console.error('íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
    NotificationSystem.show('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
  }
}

function readExcelFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      try {
        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
        resolve(workbook);
      } catch (error) {
        reject(new Error(`Excel íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨: ${error.message}`));
      }
    };
    
    reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
    reader.readAsArrayBuffer(file);
  });
}

function processWorksheet(worksheet, latCol = 'R', lngCol = 'S') {
  try {
    const jsonData = XLSX.utils.sheet_to_json(worksheet);
    
    return jsonData.map((row, index) => {
      const processedRow = {
        id: SecurityUtils.validateInput(row['ê³ ìœ ë²ˆí˜¸'] || row['ID'] || index + 1, 'alphanumeric'),
        name: SecurityUtils.validateInput(row['ì‹œì„¤ëª…'] || row['name'] || '', 'text'),
        addr: SecurityUtils.validateInput(row['êµ¬ë¶„ì£¼ì†Œ'] || row['address'] || '', 'text'),
        emd: SecurityUtils.validateInput(row['ìë©´ë™'] || row['emd'] || '', 'alphanumeric'),
        grp: SecurityUtils.validateInput(row['êµ°ì§‘'] || row['group'] || '', 'number'),
        lat: parseFloat(SecurityUtils.validateInput(row['ìœ„ë„'] || row['lat'] || 0, 'coordinate')),
        lng: parseFloat(SecurityUtils.validateInput(row['ê²½ë„'] || row['lng'] || 0, 'coordinate'))
      };
      
      processedRow.valid = !isNaN(processedRow.lat) && !isNaN(processedRow.lng) && 
                          processedRow.lat !== 0 && processedRow.lng !== 0;
      
      return processedRow;
    }).filter(row => row.id);
    
  } catch (error) {
    throw new Error(`ì›Œí¬ì‹œíŠ¸ ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
  }
}

async function updateDataState(newRows) {
  rows = newRows;
  rowsById = new Map(newRows.map(row => [String(row.id), row]));
  
  const validRows = rows.filter(row => row.valid);
  const errorRows = rows.filter(row => !row.valid);
  
  updateDataBadges(rows.length, validRows.length, errorRows.length);
  await rebuildFilterBoxes();
  await renderMap();
}

function updateDataBadges(total, valid, error) {
  const totalBadge = $('#totalBadge');
  const validBadge = $('#validBadge');  
  const errorBadge = $('#errorBadge');
  
  if (totalBadge) totalBadge.textContent = `ì „ì²´: ${total}`;
  if (validBadge) validBadge.textContent = `ìœ íš¨: ${valid}`;
  if (errorBadge) {
    errorBadge.textContent = `ì˜¤ë¥˜: ${error}`;
    errorBadge.className = error > 0 ? 'badge warn' : 'badge ok';
  }
  
  // íˆ´ë°” ë°°ì§€ ì—…ë°ì´íŠ¸
  const bTotal = $('#bTotal');
  const bShown = $('#bShown');
  const bMissing = $('#bMissing');
  
  if (bTotal) bTotal.textContent = `ì´: ${total}`;
  if (bShown) bShown.textContent = `í‘œì‹œ: ${valid}`;
  if (bMissing) bMissing.textContent = `ì¢Œí‘œì—†ìŒ: ${error}`;
}

function showAdvancedSettings(workbook) {
  const advSection = $('#adv');
  const sheetSelect = $('#sheet');
  
  if (!advSection || !sheetSelect) return;
  
  // ì‹œíŠ¸ ëª©ë¡ ì±„ìš°ê¸°
  sheetSelect.innerHTML = '';
  workbook.SheetNames.forEach(name => {
    const option = document.createElement('option');
    option.value = name;
    option.textContent = name;
    sheetSelect.appendChild(option);
  });
  
  advSection.style.display = 'block';
  advSection.open = true;
}

/**
 * ğŸ” í•„í„°ë§ ë° ê²€ìƒ‰ ê¸°ëŠ¥
 */
function filtered() {
  if (!rows || rows.length === 0) return [];
  
  const checkedEmd = new Set();
  const checkedGrp = new Set();
  
  $$('input[name="emd"]:checked').forEach(cb => {
    checkedEmd.add(decodeURIComponent(cb.value));
  });
  
  $$('input[name="grp"]:checked').forEach(cb => {
    checkedGrp.add(decodeURIComponent(cb.value));
  });
  
  const searchTerm = $('#scopeInput')?.value?.trim().toLowerCase() || '';
  
  return rows.filter(row => {
    if (checkedEmd.size > 0 && !checkedEmd.has(row.emd)) return false;
    if (checkedGrp.size > 0 && !checkedGrp.has(row.grp)) return false;
    
    if (searchTerm) {
      return (
        row.name?.toLowerCase().includes(searchTerm) ||
        row.addr?.toLowerCase().includes(searchTerm) ||
        row.emd?.toLowerCase().includes(searchTerm)
      );
    }
    
    return true;
  });
}

/**
 * ğŸ—ºï¸ ì§€ë„ ë Œë”ë§
 */
async function renderMap() {
  if (!myMap) {
    await initializeMap();
  }
  
  if (!rows || rows.length === 0) {
    NotificationSystem.show('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
    return;
  }
  
  clusterGroup.clearLayers();
  
  const filteredRows = filtered();
  const validRows = filteredRows.filter(row => row.valid && row.lat && row.lng);
  const markers = validRows.map(row => createMarker(row));
  
  if (markers.length > 0) {
    clusterGroup.addLayers(markers);
    const group = new L.featureGroup(markers);
    myMap.fitBounds(group.getBounds(), { padding: [20, 20] });
  }
  
  // í•„í„°ë§ í†µê³„ ì—…ë°ì´íŠ¸
  const bShown = $('#bShown');
  const bFiltered = $('#bFiltered');
  if (bShown) bShown.textContent = `í‘œì‹œ: ${validRows.length}`;
  if (bFiltered) bFiltered.textContent = `í•„í„°ì œì™¸: ${rows.length - filteredRows.length}`;
  
  NotificationSystem.show(`${markers.length}ê°œ ë§ˆì»¤ê°€ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
  
  // ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€ ì ìš©
  setTimeout(() => applyRouteFilter(), 100);
}

function createMarker(row) {
  const marker = L.marker([row.lat, row.lng]);
  
  const markerStyle = $('#markerStyle')?.value || 'bubble';
  const labelSrc = $('#labelSrc')?.value || 'id';
  
  let labelText = '';
  switch(labelSrc) {
    case 'name':
      labelText = row.name || row.id;
      break;
    case 'addr':
      labelText = row.addr || row.id;
      break;
    default:
      labelText = row.id;
  }
  
  // ë§ˆì»¤ HTML ìƒì„±
  const markerHtml = `<div class="mk mk-${markerStyle}">${SecurityUtils.escapeHtml(labelText)}<i></i></div>`;
  
  const divIcon = L.divIcon({
    html: markerHtml,
    className: 'custom-div-icon',
    iconSize: [30, 30],
    iconAnchor: [15, 15]
  });
  
  marker.setIcon(divIcon);
  
  // íŒì—… ë‚´ìš©
  const popupContent = `
    <div class="marker-popup">
      <h4>${SecurityUtils.escapeHtml(row.name || 'ì´ë¦„ ì—†ìŒ')}</h4>
      <p><strong>ID:</strong> ${SecurityUtils.escapeHtml(row.id)}</p>
      <p><strong>ì£¼ì†Œ:</strong> ${SecurityUtils.escapeHtml(row.addr || 'ì£¼ì†Œ ì—†ìŒ')}</p>
      <p><strong>ìë©´ë™:</strong> ${SecurityUtils.escapeHtml(row.emd || 'ì •ë³´ ì—†ìŒ')}</p>
      <p><strong>êµ°ì§‘:</strong> ${SecurityUtils.escapeHtml(row.grp || 'ì •ë³´ ì—†ìŒ')}</p>
      <div style="margin-top: 8px;">
        <button class="btn btn-sky" onclick="selectItem('${SecurityUtils.escapeHtml(row.id)}')">
          ì„ íƒ
        </button>
      </div>
    </div>
  `;
  
  marker.bindPopup(popupContent);
  marker.rowData = row;
  
  return marker;
}

/**
 * ğŸ” í•„í„°ë§ ê¸°ëŠ¥
 */
async function rebuildFilterBoxes() {
  if (!rows || rows.length === 0) return;
  
  const emdValues = [...new Set(rows.map(row => row.emd).filter(Boolean))].sort();
  fillChipBox($('#emdBox'), emdValues, 'emd');
  
  const grpValues = [...new Set(rows.map(row => row.grp).filter(Boolean))].sort((a, b) => Number(a) - Number(b));
  fillChipBox($('#grpBox'), grpValues, 'grp');
}

function fillChipBox(container, values, name) {
  if (!container || !Array.isArray(values)) return;
  
  while (container.firstChild) {
    container.removeChild(container.firstChild);
  }
  
  if (values.length === 0) {
    const emptyDiv = document.createElement('div');
    emptyDiv.className = 'small';
    emptyDiv.textContent = 'í•´ë‹¹ í•­ëª© ì—†ìŒ';
    container.appendChild(emptyDiv);
    return;
  }
  
  values.forEach(value => {
    const safeValue = SecurityUtils.validateInput(value, 'alphanumeric');
    
    const label = document.createElement('label');
    label.className = 'chip';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.name = name;
    checkbox.value = encodeURIComponent(safeValue);
    checkbox.checked = true;
    checkbox.addEventListener('change', debounce(renderMap, 300));
    
    const textNode = document.createTextNode(' ' + safeValue);
    
    label.appendChild(checkbox);
    label.appendChild(textNode);
    container.appendChild(label);
  });
}

/**
 * ğŸ¯ ì„ íƒ ê´€ë¦¬
 */
function selectItem(id) {
  const row = rowsById.get(String(id));
  if (!row) return;
  
  if (selectedIds.has(id)) {
    selectedIds.delete(id);
    removeFromSelection(id);
  } else {
    selectedIds.add(id);
    addToSelection(row);
  }
  
  updateSelectionCount();
}

function addToSelection(row) {
  const tbody = $('#selBody');
  if (!tbody) return;
  
  const tr = document.createElement('tr');
  tr.dataset.id = row.id;
  
  tr.innerHTML = `
    <td>${SecurityUtils.escapeHtml(row.id)}</td>
    <td>${SecurityUtils.escapeHtml(row.name || 'ì´ë¦„ ì—†ìŒ')}</td>
    <td>${SecurityUtils.escapeHtml(row.addr || 'ì£¼ì†Œ ì—†ìŒ')}</td>
    <td><input type="number" class="routeOrder form-control" min="1" style="width:60px"></td>
    <td class="row-actions">
      <button class="btn btn-accent btn-sm" onclick="removeSelection('${SecurityUtils.escapeHtml(row.id)}')">ì‚­ì œ</button>
    </td>
  `;
  
  tbody.appendChild(tr);
}

function removeFromSelection(id) {
  const row = $(`#selBody tr[data-id="${id}"]`);
  if (row) {
    row.remove();
  }
}

function removeSelection(id) {
  selectedIds.delete(id);
  removeFromSelection(id);
  updateSelectionCount();
}

function updateSelectionCount() {
  const countElement = $('#selectedCount');
  if (countElement) {
    countElement.textContent = selectedIds.size.toString();
  }
}

function clearAllSelections() {
  selectedIds.clear();
  const tbody = $('#selBody');
  if (tbody) {
    tbody.innerHTML = '';
  }
  updateSelectionCount();
  NotificationSystem.show('ì„ íƒì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

/**
 * ğŸ›£ï¸ ê³ ê¸‰ ê²½ë¡œ ê³„ì‚° ì‹œìŠ¤í…œ
 */
function getSelectedPoints() {
  const points = [];
  $$('#selBody tr').forEach(tr => {
    const id = tr.dataset.id;
    const row = rowsById.get(id);
    if (row && row.valid) {
      points.push({
        id: row.id,
        lat: row.lat,
        lng: row.lng,
        name: row.name,
        addr: row.addr
      });
    }
  });
  return points;
}

async function computeRoute(skipAutoFill = false) {
  if (isComputing) return;
  isComputing = true;
  
  try {
    // í•„í„° ê²°ê³¼ â†’ ì„ íƒëª©ë¡ ìë™ ì±„ì›€ ê¸°ëŠ¥
    if (!skipAutoFill && $('#autoFill')?.checked) {
      const candidates = filtered().filter(r => r.valid && isFinite(r.lat) && isFinite(r.lng));
      const max = Math.max(1, parseInt($('#dailyMax')?.value) || 999);
      
      // ê¸°ì¡´ ì„ íƒ ë®ì–´ì“°ê¸°
      $('#selBody').innerHTML = '';
      selectedIds.clear();
      
      for (const r of candidates.slice(0, max)) {
        selectedIds.add(r.id);
        addToSelection(r);
      }
      
      updateSelectionCount();
      NotificationSystem.show(`í•„í„°ëœ ${candidates.slice(0, max).length}ê°œ í•­ëª©ì„ ì„ íƒëª©ë¡ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.`, 'success');
    }
    
    const pts = getSelectedPoints();
    if (pts.length < 2) {
      NotificationSystem.show('ì„ íƒëª©ë¡ì— 2ê°œ ì´ìƒì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
      return;
    }
    
    const method = $('#routeMethod')?.value || 'nn2opt';
    
    // ê²½ë¡œ ê³„ì‚°
    let orderIds = [];
    if (method === 'osrm') {
      orderIds = await computeOSRMRoute(pts);
    } else if (method === 'cluster') {
      orderIds = await computeClusterRoute(pts);
    } else if (method === 'hilbert') {
      orderIds = await computeHilbertRoute(pts);
    } else if (method === 'kmeans') {
      orderIds = await computeKMeansRoute(pts);
    } else {
      orderIds = await computeNearestNeighborRoute(pts, method === 'nn2opt');
    }
    
    // ê²½ë¡œ ìˆœë²ˆ ì—…ë°ì´íŠ¸
    drawRouteOrder(orderIds);
    
    NotificationSystem.show(`${method} ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ê²½ë¡œê°€ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
    
  } catch (error) {
    console.error('ê²½ë¡œ ê³„ì‚° ì‹¤íŒ¨:', error);
    NotificationSystem.show('ê²½ë¡œ ê³„ì‚°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  } finally {
    isComputing = false;
  }
}

async function computeOSRMRoute(points) {
  const server = 'https://router.project-osrm.org';
  const profile = $('#osrmProfile')?.value || 'driving';
  
  const coords = points.map(p => `${p.lng},${p.lat}`).join(';');
  const roundtrip = $('#fixEnds')?.checked ? 'false' : 'true';
  const src = $('#fixEnds')?.checked ? 'first' : 'any';
  const dst = $('#fixEnds')?.checked ? 'last' : 'any';
  
  const url = `${server}/trip/v1/${profile}/${coords}?geometries=geojson&overview=full&roundtrip=${roundtrip}&source=${src}&destination=${dst}`;
  
  const response = await fetch(url);
  if (!response.ok) throw new Error('OSRM ì‘ë‹µ ì˜¤ë¥˜');
  
  const data = await response.json();
  if (!data.trips || !data.trips.length) throw new Error('ê²½ë¡œ ì—†ìŒ');
  
  const trip = data.trips[0];
  const orderIds = trip.waypoints
    .sort((a, b) => a.waypoint_index - b.waypoint_index)
    .map(wp => points[wp.trips_index ?? wp.waypoint_index]?.id ?? points[wp.waypoint_index]?.id);
  
  // ê²½ë¡œ ê·¸ë¦¬ê¸°
  if (trip.geometry) {
    routeLayer.clearLayers();
    L.geoJSON(trip.geometry, {
      style: { color: '#EA580C', weight: 4, opacity: 0.8 }
    }).addTo(routeLayer);
  }
  
  // í†µê³„ ì—…ë°ì´íŠ¸
  const distance = (trip.distance || 0) / 1000;
  const duration = (trip.duration || 0) / 60;
  $('#routeStat').textContent = `ê±°ë¦¬: ${distance.toFixed(1)}km / ì‹œê°„: ${duration.toFixed(0)}ë¶„ (OSRM)`;
  
  return orderIds;
}

async function computeNearestNeighborRoute(points, use2opt = false) {
  let orderedPoints = [...points];
  
  // ìµœê·¼ì  ì•Œê³ ë¦¬ì¦˜
  const visited = new Set();
  const route = [];
  let current = orderedPoints[0];
  route.push(current);
  visited.add(current.id);
  
  while (route.length < orderedPoints.length) {
    let nearest = null;
    let minDistance = Infinity;
    
    for (const point of orderedPoints) {
      if (!visited.has(point.id)) {
        const distance = getDistance(current.lat, current.lng, point.lat, point.lng);
        if (distance < minDistance) {
          minDistance = distance;
          nearest = point;
        }
      }
    }
    
    if (nearest) {
      route.push(nearest);
      visited.add(nearest.id);
      current = nearest;
    } else {
      break;
    }
  }
  
  // 2-opt ê°œì„ 
  if (use2opt && route.length > 3) {
    route = improve2opt(route);
  }
  
  return route.map(p => p.id);
}

function improve2opt(route) {
  let improved = true;
  let bestRoute = [...route];
  
  while (improved) {
    improved = false;
    
    for (let i = 1; i < bestRoute.length - 2; i++) {
      for (let j = i + 1; j < bestRoute.length - 1; j++) {
        const newRoute = [...bestRoute];
        
        // iì™€ j ì‚¬ì´ êµ¬ê°„ì„ ë’¤ì§‘ê¸°
        const segment = newRoute.slice(i, j + 1).reverse();
        newRoute.splice(i, j - i + 1, ...segment);
        
        if (calculateTotalDistance(newRoute) < calculateTotalDistance(bestRoute)) {
          bestRoute = newRoute;
          improved = true;
        }
      }
    }
  }
  
  return bestRoute;
}

function calculateTotalDistance(route) {
  let total = 0;
  for (let i = 0; i < route.length - 1; i++) {
    total += getDistance(route[i].lat, route[i].lng, route[i + 1].lat, route[i + 1].lng);
  }
  return total;
}

async function computeClusterRoute(points) {
  // K-means í´ëŸ¬ìŠ¤í„°ë§ìœ¼ë¡œ ê·¸ë£¹ ìƒì„±
  const dailyMax = parseInt($('#dailyMax')?.value) || 50;
  const numClusters = Math.ceil(points.length / dailyMax);
  
  const clusters = kmeansClustering(points, numClusters);
  let allOrderIds = [];
  
  for (const cluster of clusters) {
    if (cluster.length > 0) {
      const clusterOrder = await computeNearestNeighborRoute(cluster, true);
      allOrderIds = allOrderIds.concat(clusterOrder);
    }
  }
  
  return allOrderIds;
}

async function computeHilbertRoute(points) {
  // Hilbert ê³¡ì„ ì„ ì´ìš©í•œ ê³µê°„ ì¶©ì „ ê³¡ì„  ì •ë ¬
  const minLat = Math.min(...points.map(p => p.lat));
  const maxLat = Math.max(...points.map(p => p.lat));
  const minLng = Math.min(...points.map(p => p.lng));
  const maxLng = Math.max(...points.map(p => p.lng));
  
  const pointsWithHilbert = points.map(p => ({
    ...p,
    hilbertValue: hilbertIndex(
      Math.floor(((p.lat - minLat) / (maxLat - minLat)) * 255),
      Math.floor(((p.lng - minLng) / (maxLng - minLng)) * 255)
    )
  }));
  
  pointsWithHilbert.sort((a, b) => a.hilbertValue - b.hilbertValue);
  
  return pointsWithHilbert.map(p => p.id);
}

function hilbertIndex(x, y) {
  let d = 0;
  let s = 128;
  
  while (s > 0) {
    const rx = (x & s) > 0 ? 1 : 0;
    const ry = (y & s) > 0 ? 1 : 0;
    d += s * s * ((3 * rx) ^ ry);
    
    if (ry === 0) {
      if (rx === 1) {
        x = s - 1 - x;
        y = s - 1 - y;
      }
      [x, y] = [y, x];
    }
    
    s = Math.floor(s / 2);
  }
  
  return d;
}

async function computeKMeansRoute(points) {
  const dailyMax = parseInt($('#dailyMax')?.value) || 50;
  const numClusters = Math.ceil(points.length / dailyMax);
  
  const clusters = kmeansClustering(points, numClusters);
  let allOrderIds = [];
  
  for (const cluster of clusters) {
    if (cluster.length > 0) {
      const clusterOrder = await computeNearestNeighborRoute(cluster, true);
      allOrderIds = allOrderIds.concat(clusterOrder);
    }
  }
  
  return allOrderIds;
}

function kmeansClustering(points, k) {
  if (points.length <= k) {
    return points.map(p => [p]);
  }
  
  // ì´ˆê¸° ì¤‘ì‹¬ì  ì„ íƒ
  let centroids = [];
  for (let i = 0; i < k; i++) {
    centroids.push({
      lat: points[Math.floor(Math.random() * points.length)].lat,
      lng: points[Math.floor(Math.random() * points.length)].lng
    });
  }
  
  let clusters = [];
  let maxIterations = 50;
  let iteration = 0;
  
  while (iteration < maxIterations) {
    // í´ëŸ¬ìŠ¤í„° ì´ˆê¸°í™”
    clusters = Array.from({ length: k }, () => []);
    
    // ê° ì ì„ ê°€ì¥ ê°€ê¹Œìš´ ì¤‘ì‹¬ì ì— í• ë‹¹
    for (const point of points) {
      let minDistance = Infinity;
      let closestCluster = 0;
      
      for (let i = 0; i < centroids.length; i++) {
        const distance = getDistance(point.lat, point.lng, centroids[i].lat, centroids[i].lng);
        if (distance < minDistance) {
          minDistance = distance;
          closestCluster = i;
        }
      }
      
      clusters[closestCluster].push(point);
    }
    
    // ìƒˆë¡œìš´ ì¤‘ì‹¬ì  ê³„ì‚°
    let converged = true;
    for (let i = 0; i < k; i++) {
      if (clusters[i].length > 0) {
        const newLat = clusters[i].reduce((sum, p) => sum + p.lat, 0) / clusters[i].length;
        const newLng = clusters[i].reduce((sum, p) => sum + p.lng, 0) / clusters[i].length;
        
        if (Math.abs(centroids[i].lat - newLat) > 0.001 || Math.abs(centroids[i].lng - newLng) > 0.001) {
          converged = false;
        }
        
        centroids[i] = { lat: newLat, lng: newLng };
      }
    }
    
    if (converged) break;
    iteration++;
  }
  
  return clusters.filter(cluster => cluster.length > 0);
}

function drawRouteOrder(orderIds) {
  orderIds.forEach((id, index) => {
    const tr = $(`#selBody tr[data-id="${id}"]`);
    const input = tr?.querySelector('.routeOrder');
    if (input) {
      input.value = index + 1;
    }
  });
}

function clearRoute() {
  // ê²½ë¡œ ìˆœë²ˆ ì´ˆê¸°í™”
  $$('#selBody .routeOrder').forEach(input => {
    input.value = '';
  });
  
  // ê²½ë¡œ ë ˆì´ì–´ ì´ˆê¸°í™”
  if (routeLayer) {
    routeLayer.clearLayers();
  }
  
  // í†µê³„ ì´ˆê¸°í™”
  $('#routeStat').textContent = 'ê±°ë¦¬: - / ì‹œê°„: -';
  
  // A/B ë§ˆì»¤ ì´ˆê¸°í™”
  enableAB(false);
  
  // ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€ í•´ì œ
  const toggleHide = $('#toggleHideNonRoute');
  if (toggleHide) toggleHide.checked = false;
  applyRouteFilter();
  
  NotificationSystem.show('ê²½ë¡œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

/**
 * ğŸ¯ A/B ì§€ì  ì„ íƒ ê¸°ëŠ¥
 */
function enableAB(on) {
  if (on) {
    AB = [];
    abMarkers.forEach(m => m.remove());
    abMarkers = [];
    
    myMap.getContainer().style.cursor = 'crosshair';
    $('#abInfo').textContent = 'A/B: ì§€ë„ì—ì„œ ì„ íƒí•˜ì„¸ìš”';
    
    const handler = (e) => {
      AB.push([e.latlng.lat, e.latlng.lng]);
      const marker = L.circleMarker(e.latlng, {
        radius: 8,
        color: '#EA580C',
        fillColor: '#EA580C',
        fillOpacity: 0.8
      }).addTo(routeLayer);
      abMarkers.push(marker);
      
      $('#abInfo').textContent = `A/B: ${AB.length}ê°œ ì„ íƒ`;
      
      if (AB.length === 2) {
        myMap.off('click', handler);
        myMap.getContainer().style.cursor = '';
        computeABRoute();
      }
    };
    
    myMap.on('click', handler);
    
    $('#btnABReset').onclick = () => {
      myMap.off('click', handler);
      myMap.getContainer().style.cursor = '';
      enableAB(false);
    };
  } else {
    AB = [];
    abMarkers.forEach(m => m.remove());
    abMarkers = [];
    $('#abInfo').textContent = 'A/B: -';
  }
}

async function computeABRoute() {
  if (AB.length < 2) return;
  
  try {
    const server = 'https://router.project-osrm.org';
    const profile = $('#osrmProfile')?.value || 'driving';
    const coords = `${AB[0][1]},${AB[0][0]};${AB[1][1]},${AB[1][0]}`;
    const url = `${server}/route/v1/${profile}/${coords}?geometries=geojson&overview=full`;
    
    const response = await fetch(url);
    if (response.ok) {
      const data = await response.json();
      if (data.routes && data.routes.length > 0) {
        const route = data.routes[0];
        
        // ê¸°ì¡´ A/B ê²½ë¡œ ì œê±°
        routeLayer.eachLayer(layer => {
          if (layer.options && layer.options.className === 'ab-route') {
            routeLayer.removeLayer(layer);
          }
        });
        
        // ìƒˆ ê²½ë¡œ ê·¸ë¦¬ê¸°
        L.geoJSON(route.geometry, {
          style: { color: '#EA580C', weight: 4, opacity: 0.8, className: 'ab-route' }
        }).addTo(routeLayer);
        
        const distance = (route.distance || 0) / 1000;
        const duration = (route.duration || 0) / 60;
        $('#routeStat').textContent = `Aâ†’B: ${distance.toFixed(1)}km / ${duration.toFixed(0)}ë¶„ (OSRM)`;
        
        NotificationSystem.show('A/B ê²½ë¡œê°€ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        return;
      }
    }
    
    // OSRM ì‹¤íŒ¨ì‹œ ì§ì„  ê±°ë¦¬ë¡œ ëŒ€ì²´
    const distance = getDistance(AB[0][0], AB[0][1], AB[1][0], AB[1][1]);
    
    // ì§ì„  ê²½ë¡œ ê·¸ë¦¬ê¸°
    const line = L.polyline(AB, { color: '#EA580C', weight: 4, opacity: 0.6 }).addTo(routeLayer);
    
    $('#routeStat').textContent = `ì§ì„  ê±°ë¦¬: ~${distance.toFixed(1)}km (ë‚´ì¥)`;
    NotificationSystem.show('A/B ì§ì„  ê±°ë¦¬ê°€ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    
  } catch (error) {
    console.error('A/B ê²½ë¡œ ê³„ì‚° ì‹¤íŒ¨:', error);
    NotificationSystem.show('A/B ê²½ë¡œ ê³„ì‚°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

/**
 * ğŸ“Š ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥
 */
function exportToExcel() {
  if (selectedIds.size === 0) {
    NotificationSystem.show('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
    return;
  }
  
  const selectedData = Array.from(selectedIds).map(id => {
    const row = rowsById.get(id);
    const tr = $(`#selBody tr[data-id="${id}"]`);
    const routeOrder = tr?.querySelector('.routeOrder')?.value || '';
    
    return {
      'ê³ ìœ ë²ˆí˜¸': row?.id || '',
      'ì‹œì„¤ëª…': row?.name || '',
      'êµ¬ë¶„ì£¼ì†Œ': row?.addr || '',
      'ìë©´ë™': row?.emd || '',
      'êµ°ì§‘': row?.grp || '',
      'ìœ„ë„': row?.lat || '',
      'ê²½ë„': row?.lng || '',
      'ê²½ë¡œìˆœë²ˆ': routeOrder
    };
  });
  
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(selectedData);
  XLSX.utils.book_append_sheet(wb, ws, "ì„ íƒëª©ë¡");
  XLSX.writeFile(wb, "ì„ íƒëª©ë¡.xlsx");
  
  NotificationSystem.show('Excel íŒŒì¼ë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.', 'success');
}

/**
 * ğŸ›¡ï¸ ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€ ê¸°ëŠ¥
 */
function currentRouteIdSet() {
  const set = new Set();
  $$('#selBody tr').forEach(tr => {
    const id = (tr.querySelector('td')?.textContent || '').trim();
    const ord = tr.querySelector('input.routeOrder')?.value?.trim() || '';
    if (id && ord) set.add(String(id));
  });
  return set;
}

function readMarkerIdFromEl(el) {
  if (!el) return '';
  const box = el.querySelector('.mk, .mk-circle, .mk-bubble, .mk-tag') || el.firstElementChild;
  const t = (box?.textContent || '').trim();
  const m = t.match(/\d{2,}/);
  return m ? m[0] : t;
}

function iterMarkerBoxes() {
  return $$('.leaflet-marker-pane > div');
}

function applyRouteFilter() {
  const on = $('#toggleHideNonRoute')?.checked;
  if (!on) {
    iterMarkerBoxes().forEach(el => el.classList.remove('clo-hidden'));
    return;
  }
  
  const routeIds = currentRouteIdSet();
  if (routeIds.size === 0) {
    iterMarkerBoxes().forEach(el => el.classList.remove('clo-hidden'));
    return;
  }
  
  iterMarkerBoxes().forEach(el => {
    const id = readMarkerIdFromEl(el);
    if (routeIds.has(String(id))) {
      el.classList.remove('clo-hidden');
    } else {
      el.classList.add('clo-hidden');
    }
  });
}

/**
 * ğŸ“‹ íŒ¨ë„ ê´€ë¦¬
 */
function showSelectionPanel() {
  const panel = $('#selPanel');
  if (panel) {
    panel.style.display = 'block';
    panel.setAttribute('aria-hidden', 'false');
  }
}

function hideSelectionPanel() {
  const panel = $('#selPanel');
  if (panel) {
    panel.style.display = 'none';
    panel.setAttribute('aria-hidden', 'true');
  }
}

/**
 * ğŸ¯ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
 */
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function toRad(deg) {
  return deg * (Math.PI/180);
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function setVar(name, value) {
  document.documentElement.style.setProperty(name, value);
}

function updateFontVars() {
  setVar('--tbl-font', tblFont + 'px');
  setVar('--flt-font', fltFont + 'px');
  setVar('--mk', mk + 'px');
}

/**
 * ğŸ“± ë°˜ì‘í˜• ì§€ì›
 */
function setupResponsive() {
  const mobileMenuBtn = $('#mobileMenuBtn');
  const mobileOverlay = $('#mobileOverlay');
  const lhs = $('#lhs');
  
  function checkMobile() {
    const isMobile = window.innerWidth <= 768;
    if (mobileMenuBtn) {
      mobileMenuBtn.style.display = isMobile ? 'flex' : 'none';
    }
  }
  
  if (mobileMenuBtn && mobileOverlay && lhs) {
    mobileMenuBtn.addEventListener('click', () => {
      lhs.classList.add('mobile-open');
      mobileOverlay.classList.add('show');
    });
    
    mobileOverlay.addEventListener('click', () => {
      lhs.classList.remove('mobile-open');
      mobileOverlay.classList.remove('show');
    });
  }
  
  checkMobile();
  window.addEventListener('resize', debounce(() => {
    checkMobile();
    if (myMap) myMap.invalidateSize();
  }, 250));
}

/**
 * ğŸ“‹ íŒ¨ë„ ë“œë˜ê·¸ ë° ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥
 */
function setupPanelInteractions() {
  const panel = $('#selPanel');
  const shield = $('#mapShield');
  if (!panel || !shield) return;
  
  function showShield() { shield.style.display = 'block'; }
  function hideShield() { shield.style.display = 'none'; }
  
  // íŒ¨ë„ hover ì‹œ ì§€ë„ ìƒí˜¸ì‘ìš© ì°¨ë‹¨
  panel.addEventListener('mouseenter', showShield);
  panel.addEventListener('mouseleave', hideShield);
  
  // ë“œë˜ê·¸ ê¸°ëŠ¥
  const head = panel.querySelector('.head') || panel;
  let dragging = false, sx = 0, sy = 0, sl = 0, st = 0;
  
  head.addEventListener('mousedown', (e) => {
    if (/BUTTON|A|INPUT|SELECT|TEXTAREA/.test(e.target.tagName)) return;
    
    const r = panel.getBoundingClientRect();
    dragging = true;
    panel.classList.add('dragging');
    
    sx = e.clientX;
    sy = e.clientY;
    sl = r.left;
    st = r.top;
    
    panel.style.left = sl + 'px';
    panel.style.top = st + 'px';
    panel.style.right = '';
    panel.style.bottom = '';
    
    document.body.style.userSelect = 'none';
    showShield();
    e.preventDefault();
  });
  
  window.addEventListener('mousemove', (e) => {
    if (!dragging) return;
    panel.style.left = (sl + (e.clientX - sx)) + 'px';
    panel.style.top = (st + (e.clientY - sy)) + 'px';
  });
  
  window.addEventListener('mouseup', () => {
    if (!dragging) return;
    dragging = false;
    panel.classList.remove('dragging');
    document.body.style.userSelect = '';
    hideShield();
  });
  
  // ë”ë¸”í´ë¦­ìœ¼ë¡œ ê¸°ë³¸ ìœ„ì¹˜ ë³µì›
  head.addEventListener('dblclick', () => {
    panel.style.width = '';
    panel.style.height = '';
    panel.style.left = '';
    panel.style.top = '';
    panel.style.right = '16px';
    panel.style.bottom = '90px';
  });
  
  // ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥
  setupPanelResize(panel, shield);
}

function setupPanelResize(panel, shield) {
  const minW = 360, minH = 220;
  let resizing = false, edge = '', sx = 0, sy = 0, sw = 0, sh = 0, sl = 0, st = 0;
  
  function showShield() { shield.style.display = 'block'; }
  function hideShield() { shield.style.display = 'none'; }
  
  function startResize(e, which) {
    const r = panel.getBoundingClientRect();
    resizing = true;
    edge = which;
    sx = e.clientX;
    sy = e.clientY;
    sw = r.width;
    sh = r.height;
    sl = r.left;
    st = r.top;
    
    panel.style.left = sl + 'px';
    panel.style.top = st + 'px';
    panel.style.right = '';
    panel.style.bottom = '';
    
    document.body.style.cursor = (which === 'left' || which === 'right') ? 'ew-resize' : 'ns-resize';
    showShield();
    e.preventDefault();
    
    window.addEventListener('mousemove', moveResize);
    window.addEventListener('mouseup', stopResize);
  }
  
  function moveResize(e) {
    if (!resizing) return;
    const dx = e.clientX - sx, dy = e.clientY - sy;
    
    if (edge === 'right') {
      panel.style.width = Math.max(minW, sw + dx) + 'px';
    }
    if (edge === 'left') {
      const w = Math.max(minW, sw - dx);
      panel.style.width = w + 'px';
      panel.style.left = (sl + dx) + 'px';
    }
    if (edge === 'bottom') {
      panel.style.height = Math.max(minH, sh + dy) + 'px';
    }
    if (edge === 'top') {
      const h = Math.max(minH, sh - dy);
      panel.style.height = h + 'px';
      panel.style.top = (st + dy) + 'px';
    }
  }
  
  function stopResize() {
    if (!resizing) return;
    resizing = false;
    edge = '';
    document.body.style.cursor = '';
    hideShield();
    window.removeEventListener('mousemove', moveResize);
    window.removeEventListener('mouseup', stopResize);
  }
  
  // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
  panel.querySelector('.e-left')?.addEventListener('mousedown', e => startResize(e, 'left'));
  panel.querySelector('.e-right')?.addEventListener('mousedown', e => startResize(e, 'right'));
  panel.querySelector('.e-top')?.addEventListener('mousedown', e => startResize(e, 'top'));
  panel.querySelector('.e-bottom')?.addEventListener('mousedown', e => startResize(e, 'bottom'));
}

/**
 * ğŸš€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
 */
function setupEventListeners() {
  // íŒŒì¼ ì…ë ¥
  const fileInput = $('#fileInput');
  if (fileInput) {
    fileInput.addEventListener('change', loadExcelFile);
  }
  
  // ê³ ê¸‰ ì„¤ì • ì ìš©
  const applyBtn = $('#apply');
  if (applyBtn) {
    applyBtn.addEventListener('click', () => {
      if (!currentWorkbook) return;
      
      const sheetName = $('#sheet')?.value;
      const latCol = $('#latCol')?.value || 'R';
      const lngCol = $('#lngCol')?.value || 'S';
      
      if (sheetName && currentWorkbook.Sheets[sheetName]) {
        const processedRows = processWorksheet(currentWorkbook.Sheets[sheetName], latCol, lngCol);
        updateDataState(processedRows);
        NotificationSystem.show(`${sheetName} ì‹œíŠ¸ì—ì„œ ${processedRows.length}ê°œ í–‰ì„ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'success');
      }
    });
  }
  
  // ê²€ìƒ‰ í•„í„°
  const scopeInput = $('#scopeInput');
  const btnApplyScope = $('#btnApplyScope');
  if (scopeInput && btnApplyScope) {
    scopeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') renderMap();
    });
    btnApplyScope.addEventListener('click', renderMap);
  }
  
  // ì§€ë„ ì»¨íŠ¸ë¡¤
  $('#btnToggleSelTop')?.addEventListener('click', showSelectionPanel);
  $('#btnFitTop')?.addEventListener('click', () => {
    if (clusterGroup && clusterGroup.getLayers().length > 0) {
      myMap.fitBounds(clusterGroup.getBounds(), { padding: [20, 20] });
    }
  });
  $('#btnRefreshTop')?.addEventListener('click', renderMap);
  
  // ì„ íƒ ê´€ë¦¬
  $('#btnSelLoad')?.addEventListener('click', () => $('#selFile').click());
  $('#btnSelClear')?.addEventListener('click', clearAllSelections);
  $('#selectedCount')?.addEventListener('click', showSelectionPanel);
  
  // ê²½ë¡œ ê³„ì‚°
  $('#btnRoute')?.addEventListener('click', () => computeRoute(false));
  $('#btnRouteClear')?.addEventListener('click', clearRoute);
  
  // A/B ì§€ì  ì„ íƒ
  $('#btnPickAB')?.addEventListener('click', () => enableAB(true));
  $('#btnABReset')?.addEventListener('click', () => enableAB(false));
  
  // íŒ¨ë„ ì»¨íŠ¸ë¡¤
  $('#btnClosePanel')?.addEventListener('click', hideSelectionPanel);
  $('#btnClearAll')?.addEventListener('click', clearAllSelections);
  $('#btnExportSel')?.addEventListener('click', exportToExcel);
  
  // ë‚´ë³´ë‚´ê¸°
  $('#btnExportExcel')?.addEventListener('click', exportToExcel);
  $('#btnPrintScreen')?.addEventListener('click', () => window.print());
  
  // ì§€ë„ ì»¨íŠ¸ë¡¤
  $('#btnCenterMap')?.addEventListener('click', () => {
    if (rows.length > 0) {
      const validRows = rows.filter(row => row.valid);
      if (validRows.length > 0) {
        const avgLat = validRows.reduce((sum, row) => sum + row.lat, 0) / validRows.length;
        const avgLng = validRows.reduce((sum, row) => sum + row.lng, 0) / validRows.length;
        myMap.setView([avgLat, avgLng], 12);
      }
    }
  });
  
  $('#btnFitBounds')?.addEventListener('click', () => {
    if (clusterGroup && clusterGroup.getLayers().length > 0) {
      myMap.fitBounds(clusterGroup.getBounds(), { padding: [20, 20] });
    }
  });
  
  // ì„¤ì • ì»¨íŠ¸ë¡¤
  $('#fontSizeRange')?.addEventListener('input', (e) => {
    const size = e.target.value + 'px';
    $('#fontSizeValue').textContent = size;
    tblFont = fltFont = parseInt(e.target.value);
    updateFontVars();
  });
  
  $('#markerSizeRange')?.addEventListener('input', (e) => {
    const size = e.target.value + 'px';
    $('#markerSizeValue').textContent = size;
    mk = parseInt(e.target.value);
    updateFontVars();
    renderMap();
  });
  
  // ìŠ¤íƒ€ì¼ í† ê¸€
  $('#darkToggle')?.addEventListener('change', (e) => {
    document.body.classList.toggle('dark', e.target.checked);
  });
  
  $('#bwToggle')?.addEventListener('change', (e) => {
    document.body.classList.toggle('bw', e.target.checked);
  });
  
  $('#clusterToggle')?.addEventListener('change', renderMap);
  $('#markerStyle')?.addEventListener('change', renderMap);
  $('#labelSrc')?.addEventListener('change', renderMap);
  $('#baseSelect')?.addEventListener('change', updateBaseLayer);
  
  $('#toggleHideNonRoute')?.addEventListener('change', applyRouteFilter);
  
  // ì¤Œ ì»¨íŠ¸ë¡¤
  const zoomRange = $('#zoomRange');
  const zoomVal = $('#zoomVal');
  if (zoomRange && zoomVal) {
    zoomRange.addEventListener('input', (e) => {
      const zoom = parseFloat(e.target.value);
      zoomVal.textContent = zoom.toFixed(1);
      if (myMap) myMap.setZoom(zoom);
    });
  }
  
  // ì„ íƒëª©ë¡ ë¡œë“œ
  $('#selFile')?.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xlsm') || file.name.toLowerCase().endsWith('.xls')) {
        const buffer = await file.arrayBuffer();
        const workbook = XLSX.read(new Uint8Array(buffer), { type: "array" });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(worksheet);
        
        clearAllSelections();
        
        data.forEach(row => {
          const id = row["ê³ ìœ ë²ˆí˜¸"] || row["id"] || row["ID"];
          const baseRow = rowsById.get(String(id));
          if (baseRow) {
            selectedIds.add(String(id));
            addToSelection(baseRow);
            
            // ê²½ë¡œ ìˆœë²ˆ ì„¤ì •
            const routeOrder = row["ê²½ë¡œ"] || row["ê²½ë¡œìˆœë²ˆ"] || '';
            if (routeOrder) {
              const tr = $(`#selBody tr[data-id="${id}"]`);
              const input = tr?.querySelector('.routeOrder');
              if (input) input.value = routeOrder;
            }
          }
        });
        
        NotificationSystem.show('ì„ íƒëª©ë¡ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      }
    } catch (error) {
      console.error('ì„ íƒëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
      NotificationSystem.show('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
    }
    
    e.target.value = '';
  });
}

function updateBaseLayer() {
  const baseSelect = $('#baseSelect');
  if (!baseSelect || !myMap) return;
  
  // ê¸°ì¡´ íƒ€ì¼ ë ˆì´ì–´ ì œê±°
  myMap.eachLayer((layer) => {
    if (layer instanceof L.TileLayer) {
      myMap.removeLayer(layer);
    }
  });
  
  const baseType = baseSelect.value;
  let tileLayer;
  
  switch (baseType) {
    case 'vworld_base':
      tileLayer = L.tileLayer('http://api.vworld.kr/req/wmts/1.0.0/EB30978A-DC8F-3FD0-B46F-CDC6C3B96D84/Base/{z}/{y}/{x}.png', {
        attribution: 'Â© VWorld'
      });
      break;
    case 'vworld_satellite':
      tileLayer = L.tileLayer('http://api.vworld.kr/req/wmts/1.0.0/EB30978A-DC8F-3FD0-B46F-CDC6C3B96D84/Satellite/{z}/{y}/{x}.jpeg', {
        attribution: 'Â© VWorld'
      });
      break;
    case 'google_roadmap':
      tileLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
        attribution: 'Â© Google'
      });
      break;
    case 'google_satellite':
      tileLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        attribution: 'Â© Google'
      });
      break;
    default:
      tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      });
  }
  
  tileLayer.addTo(myMap);
}

/**
 * ğŸ¯ ë„¤ë¹„ê²Œì´ì…˜ ì„¤ì •
 */
function setupNavigation() {
  $$('.icbtn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      if (!target) return;
      
      // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
      $$('.sec').forEach(sec => {
        sec.classList.remove('active');
      });
      
      // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
      $$('.icbtn').forEach(b => {
        b.classList.remove('active');
      });
      
      // ì„ íƒëœ ì„¹ì…˜ í‘œì‹œ
      const targetSection = $(target);
      if (targetSection) {
        targetSection.classList.add('active');
        btn.classList.add('active');
      }
      
      // ëª¨ë°”ì¼ì—ì„œ ë©”ë‰´ ë‹«ê¸°
      if (window.innerWidth <= 768) {
        $('#lhs')?.classList.remove('mobile-open');
        $('#mobileOverlay')?.classList.remove('show');
      }
    });
  });
}

/**
 * ğŸ“ ì‚¬ì´ë“œë°” í¬ê¸° ì¡°ì •
 */
function setupGutResize() {
  let dragging = false, sx, sw;
  const gut = $('#gut');
  const lhs = $('#lhs');
  
  if (!gut) return;
  
  gut.addEventListener('mousedown', (e) => {
    dragging = true;
    sx = e.clientX;
    sw = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--side-w')) || 380;
    document.body.style.cursor = 'col-resize';
    e.preventDefault();
  });
  
  window.addEventListener('mousemove', (e) => {
    if (!dragging) return;
    const w = Math.min(640, Math.max(0, sw + (e.clientX - sx)));
    setVar('--side-w', w + 'px');
    if (lhs) {
      lhs.style.display = (w === 0) ? 'none' : 'block';
    }
    if (myMap) myMap.invalidateSize();
  });
  
  window.addEventListener('mouseup', () => {
    if (dragging) {
      dragging = false;
      document.body.style.cursor = '';
    }
  });
}

/**
 * ğŸš€ ì´ˆê¸°í™” í•¨ìˆ˜
 */
async function init() {
  try {
    console.log('ğŸš€ CLUSTRO ì™„ì „ í†µí•© ë²„ì „ v13.5 ì´ˆê¸°í™” ì‹œì‘...');
    
    // ì§€ë„ ì´ˆê¸°í™”
    await initializeMap();
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    setupEventListeners();
    setupNavigation();
    setupResponsive();
    setupGutResize();
    setupPanelInteractions();
    
    // ì²« ë²ˆì§¸ ì„¹ì…˜ í™œì„±í™”
    const firstBtn = $('.icbtn');
    const firstSection = $('.sec');
    if (firstBtn && firstSection) {
      firstBtn.classList.add('active');
      firstSection.classList.add('active');
    }
    
    // ë§ˆì»¤ DOM ë³€í™” ê´€ì°°ì ì„¤ì • (ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€ìš©)
    const markerPane = document.querySelector('.leaflet-marker-pane');
    if (markerPane) {
      const observer = new MutationObserver(() => {
        if ($('#toggleHideNonRoute')?.checked) {
          applyRouteFilter();
        }
      });
      observer.observe(markerPane, { childList: true, subtree: true });
    }
    
    console.log('âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì™„ë£Œ');
    NotificationSystem.show('CLUSTRO v13.5ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    
  } catch (error) {
    console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    NotificationSystem.show('ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
}

// DOM ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', init);

// ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (ë²„íŠ¼ onclickì—ì„œ ì‚¬ìš©)
window.selectItem = selectItem;
window.removeSelection = removeSelection;

console.log('%cğŸ”’ CLUSTRO ì™„ì „ í†µí•© ë²„ì „ v13.5', 'color: #0EA5E9; font-weight: bold; font-size: 16px;');
console.log('%cëª¨ë“  ê¸°ëŠ¥ ì™„ì „ í†µí•© + XLSM ì§€ì› + OSRM ì—°ë™ + A/B ê²½ë¡œ', 'color: #059669;');
</script>

</body>
</html>