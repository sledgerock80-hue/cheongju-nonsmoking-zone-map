<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>ì²­ì£¼ ê¸ˆì—°êµ¬ì—­ ì ê²€ì§€ë„ - í†µí•©ê°œì„ íŒ v13.0</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    /* ì²­ì£¼ì‹œ CI ìƒ‰ìƒì„ ë°˜ì˜í•œ í˜„ëŒ€ì ì¸ ë””ìì¸ */
    --primary: #1E40AF; /* ì²­ì£¼ì‹œ ëŒ€í‘œìƒ‰ìƒ */
    --primary-light: #3B82F6;
    --accent: #F59E0B; /* ê°•ì¡°ìƒ‰ */
    --accent-light: #FCD34D;
    --success: #10B981;
    --warning: #F59E0B;
    --danger: #EF4444;
    --gray-50: #F9FAFB;
    --gray-100: #F3F4F6;
    --gray-200: #E5E7EB;
    --gray-300: #D1D5DB;
    --gray-400: #9CA3AF;
    --gray-500: #6B7280;
    --gray-600: #4B5563;
    --gray-700: #374151;
    --gray-800: #1F2937;
    --gray-900: #111827;
    
    --rail-w: 68px;
    --side-w: 400px;
    --gap: 8px;
    --marker-size: 32px;
    --border-radius: 12px;
    --border-radius-sm: 8px;
    --shadow: 0 4px 12px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
    --transition: all 0.2s ease;
  }

  /* ì˜¤í”„ë¼ì¸/ì˜¨ë¼ì¸ ìƒíƒœ í‘œì‹œ */
  .online-status {
    position: fixed;
    top: 16px;
    right: 16px;
    z-index: 10000;
    padding: 8px 12px;
    border-radius: var(--border-radius-sm);
    font-size: 12px;
    font-weight: 600;
    transition: var(--transition);
    box-shadow: var(--shadow);
  }
  .online-status.online {
    background: var(--success);
    color: white;
  }
  .online-status.offline {
    background: var(--danger);
    color: white;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë¦¬ì…‹ ë° ê°œì„  */
  * { box-sizing: border-box; }
  
  body {
    margin: 0;
    font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    color: var(--gray-800);
    background: var(--gray-50);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* ì ‘ê·¼ì„± ê°œì„  */
  *:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
  }

  button, .btn {
    cursor: pointer;
    transition: var(--transition);
    border: none;
    font-family: inherit;
  }

  button:hover, .btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow);
  }

  button:active, .btn:active {
    transform: translateY(0);
  }

  /* ë ˆì´ì•„ì›ƒ ê·¸ë¦¬ë“œ */
  #app {
    display: grid;
    min-height: 100vh;
    grid-template-columns: var(--rail-w) var(--side-w) var(--gap) 1fr;
    grid-template-rows: auto 1fr;
    grid-template-areas: 
      "rail toolbar toolbar toolbar" 
      "rail sidebar gap main";
  }

  /* ìƒë‹¨ íˆ´ë°” */
  #toolbar {
    grid-area: toolbar;
    background: white;
    border-bottom: 2px solid var(--gray-200);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  /* ì¢Œì¸¡ ë ˆì¼ */
  #rail {
    grid-area: rail;
    background: white;
    border-right: 2px solid var(--gray-200);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px 8px;
    gap: 12px;
  }

  .logo-container {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 12px;
    text-align: center;
    line-height: 1.2;
    box-shadow: var(--shadow);
  }

  .nav-button {
    width: 52px;
    height: 52px;
    background: var(--gray-100);
    border: 2px solid var(--gray-200);
    border-radius: var(--border-radius-sm);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: var(--transition);
    text-decoration: none;
    color: var(--gray-600);
    font-size: 10px;
    font-weight: 500;
  }

  .nav-button:hover {
    background: var(--primary-light);
    border-color: var(--primary);
    color: white;
    transform: translateY(-2px);
  }

  .nav-button.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
  }

  .nav-button svg {
    width: 20px;
    height: 20px;
    stroke-width: 2;
  }

  /* ì‚¬ì´ë“œë°” */
  #sidebar {
    grid-area: sidebar;
    background: white;
    border-right: 2px solid var(--gray-200);
    overflow-y: auto;
    font-size: 13px;
  }

  .section {
    border-bottom: 1px solid var(--gray-200);
  }

  .section-header {
    padding: 16px 20px;
    background: var(--gray-50);
    border-bottom: 1px solid var(--gray-200);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 600;
    color: var(--gray-700);
    transition: var(--transition);
  }

  .section-header:hover {
    background: var(--gray-100);
  }

  .section-content {
    padding: 20px;
  }

  /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°œì„  */
  .btn {
    padding: 8px 16px;
    border-radius: var(--border-radius-sm);
    font-size: 13px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: var(--transition);
    text-decoration: none;
    cursor: pointer;
    min-height: 36px;
  }

  .btn-primary {
    background: var(--primary);
    color: white;
    border: 2px solid var(--primary);
  }

  .btn-primary:hover {
    background: var(--primary-light);
    border-color: var(--primary-light);
  }

  .btn-secondary {
    background: var(--gray-100);
    color: var(--gray-700);
    border: 2px solid var(--gray-200);
  }

  .btn-secondary:hover {
    background: var(--gray-200);
    border-color: var(--gray-300);
  }

  .btn-accent {
    background: var(--accent);
    color: white;
    border: 2px solid var(--accent);
  }

  .btn-accent:hover {
    background: var(--accent-light);
    border-color: var(--accent-light);
  }

  .btn-success {
    background: var(--success);
    color: white;
    border: 2px solid var(--success);
  }

  .btn-danger {
    background: var(--danger);
    color: white;
    border: 2px solid var(--danger);
  }

  /* ì…ë ¥ ìš”ì†Œ ê°œì„  */
  input, select, textarea {
    padding: 8px 12px;
    border: 2px solid var(--gray-200);
    border-radius: var(--border-radius-sm);
    background: white;
    font-size: 13px;
    transition: var(--transition);
    min-height: 36px;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  /* ë°°ì§€ ìŠ¤íƒ€ì¼ */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
    border: 1px solid;
  }

  .badge-primary {
    background: rgba(59, 130, 246, 0.1);
    color: var(--primary);
    border-color: rgba(59, 130, 246, 0.2);
  }

  .badge-success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
    border-color: rgba(16, 185, 129, 0.2);
  }

  .badge-warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
    border-color: rgba(245, 158, 11, 0.2);
  }

  .badge-danger {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
    border-color: rgba(239, 68, 68, 0.2);
  }

  /* ì¹© ìŠ¤íƒ€ì¼ */
  .chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--gray-100);
    border: 1px solid var(--gray-200);
    border-radius: 999px;
    font-size: 12px;
    cursor: pointer;
    transition: var(--transition);
  }

  .chip:hover {
    background: var(--gray-200);
  }

  .chip input[type="checkbox"] {
    margin: 0;
    min-height: auto;
  }

  /* ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ ê°œì„  */
  .switch {
    position: relative;
    display: inline-block;
    width: 52px;
    height: 28px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
    min-height: auto;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--gray-300);
    transition: var(--transition);
    border-radius: 28px;
    border: 2px solid var(--gray-200);
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 2px;
    top: 2px;
    background: white;
    transition: var(--transition);
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .switch input:checked + .slider {
    background: var(--primary);
    border-color: var(--primary);
  }

  .switch input:checked + .slider:before {
    transform: translateX(24px);
  }

  /* ê°­ ì˜ì—­ */
  #gap {
    grid-area: gap;
    background: var(--gray-200);
    cursor: col-resize;
    position: relative;
  }

  #gap:hover {
    background: var(--primary-light);
  }

  #gap::after {
    content: 'â‹®';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--gray-500);
    font-size: 16px;
  }

  /* ë©”ì¸ ì§€ë„ ì˜ì—­ */
  #main {
    grid-area: main;
    position: relative;
    background: var(--gray-100);
  }

  #map {
    position: absolute;
    inset: 0;
    border-radius: 0;
  }

  /* ì§€ë„ ì»¨íŠ¸ë¡¤ */
  .map-controls {
    position: absolute;
    top: 16px;
    left: 16px;
    z-index: 1000;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* ì„ íƒ íŒ¨ë„ ê°œì„  */
  .selection-panel {
    position: absolute;
    right: 20px;
    bottom: 20px;
    width: min(600px, 45vw);
    max-width: 90vw;
    max-height: 60vh;
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    z-index: 2000;
    display: none;
    overflow: hidden;
    resize: both;
    min-width: 400px;
    min-height: 300px;
  }

  .panel-header {
    background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
    border-bottom: 2px solid var(--gray-200);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: move;
    user-select: none;
  }

  .panel-title {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-800);
    margin: 0;
  }

  .panel-content {
    flex: 1;
    overflow: auto;
    padding: 0;
  }

  /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ ê°œì„  */
  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }

  .data-table th {
    background: var(--gray-50);
    border-bottom: 2px solid var(--gray-200);
    border-right: 1px solid var(--gray-200);
    padding: 12px 8px;
    text-align: left;
    font-weight: 600;
    color: var(--gray-700);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .data-table td {
    border-bottom: 1px solid var(--gray-200);
    border-right: 1px solid var(--gray-200);
    padding: 10px 8px;
    background: white;
  }

  .data-table tr:hover td {
    background: var(--gray-50);
  }

  /* ë§ˆì»¤ ìŠ¤íƒ€ì¼ ê°œì„  */
  .marker {
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 11px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: var(--transition);
  }

  .marker:hover {
    transform: scale(1.1);
    z-index: 1000;
  }

  .marker.selected {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
  }

  /* ì¹´í…Œê³ ë¦¬ë³„ ì•„ì´ì½˜ê³¼ ìƒ‰ìƒ - Eì—´ ê°’ ê¸°ì¤€ */
  .marker.category-pcë°© { background: #FF6B6B; }
  .marker.category-ë…¸ë˜ë°© { background: #4ECDC4; }
  .marker.category-ë‹¹êµ¬ì¥ { background: #45B7D1; }
  .marker.category-ê²Œì„ì¥ { background: #96CEB4; }
  .marker.category-ë…ì„œì‹¤ { background: #FECA57; }
  .marker.category-ì°œì§ˆë°© { background: #FF9FF3; }
  .marker.category-ì¹´í˜ { background: #54A0FF; }
  .marker.category-ìŒì‹ì  { background: #5F27CD; }
  .marker.category-ê¸°íƒ€ { background: #758495; }

  /* ì›Œí„°ë§ˆí¬ */
  .watermark {
    position: fixed;
    bottom: 8px;
    right: 8px;
    z-index: 9999;
    background: rgba(255,255,255,0.9);
    padding: 4px 8px;
    border-radius: var(--border-radius-sm);
    font-size: 10px;
    color: var(--gray-500);
    backdrop-filter: blur(4px);
  }

  /* ë‹¤í¬ëª¨ë“œ ì§€ì› */
  @media (prefers-color-scheme: dark) {
    body.auto-dark {
      background: var(--gray-900);
      color: var(--gray-100);
    }
    
    body.auto-dark #toolbar,
    body.auto-dark #rail,
    body.auto-dark #sidebar,
    body.auto-dark .selection-panel {
      background: var(--gray-800);
      border-color: var(--gray-700);
      color: var(--gray-100);
    }
    
    body.auto-dark input,
    body.auto-dark select,
    body.auto-dark textarea {
      background: var(--gray-700);
      border-color: var(--gray-600);
      color: var(--gray-100);
    }
  }

  /* ë°˜ì‘í˜• ë””ìì¸ ê°œì„  */
  @media screen and (max-width: 1200px) {
    :root {
      --side-w: 360px;
    }
  }

  @media screen and (max-width: 1024px) {
    #app {
      grid-template-columns: var(--rail-w) 1fr;
      grid-template-areas:
        "rail toolbar"
        "rail main";
    }
    
    #sidebar {
      position: fixed;
      top: 0;
      left: var(--rail-w);
      width: var(--side-w);
      height: 100vh;
      z-index: 3000;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      box-shadow: var(--shadow-lg);
    }
    
    #sidebar.open {
      transform: translateX(0);
    }
    
    #gap {
      display: none;
    }
    
    .selection-panel {
      width: min(500px, 90vw);
      right: 10px;
      bottom: 10px;
    }
  }

  @media screen and (max-width: 768px) {
    :root {
      --rail-w: 60px;
    }
    
    #toolbar {
      padding: 8px 12px;
      flex-direction: column;
      align-items: stretch;
      gap: 8px;
    }
    
    .nav-button {
      width: 44px;
      height: 44px;
      font-size: 9px;
    }
    
    .nav-button svg {
      width: 18px;
      height: 18px;
    }
    
    .logo-container {
      width: 48px;
      height: 48px;
      font-size: 10px;
    }
    
    .btn {
      min-height: 44px;
      padding: 12px 16px;
    }
    
    .selection-panel {
      width: calc(100vw - 20px);
      right: 10px;
      bottom: 10px;
      min-width: 280px;
      max-height: 70vh;
    }
    
    .chips {
      gap: 6px;
    }
    
    .chip {
      font-size: 11px;
      padding: 4px 8px;
    }
  }

  @media screen and (max-width: 480px) {
    :root {
      --rail-w: 56px;
    }
    
    .selection-panel {
      width: calc(100vw - 16px);
      right: 8px;
      bottom: 8px;
      min-width: 250px;
    }
    
    .section-content {
      padding: 16px;
    }
  }

  /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ ìµœì í™” */
  @media (pointer: coarse) {
    .btn, button, input, select {
      min-height: 44px;
    }
    
    .chip {
      min-height: 40px;
      padding: 8px 12px;
    }
    
    .nav-button {
      min-width: 48px;
      min-height: 48px;
    }
    
    .marker {
      min-width: 36px;
      min-height: 36px;
    }
  }

  /* ê³ ëŒ€ë¹„ ì ‘ê·¼ì„± */
  @media (prefers-contrast: high) {
    :root {
      --gray-200: #000000;
      --gray-300: #333333;
    }
    
    .btn {
      border-width: 3px;
    }
  }

  /* ì• ë‹ˆë©”ì´ì…˜ ë¹„í™œì„±í™” ì˜µì…˜ */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--gray-300);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ GPU ê°€ì† */
  .marker,
  .btn,
  .nav-button {
    transform: translateZ(0);
    will-change: transform;
  }

  /* ì¸ì‡„ ìŠ¤íƒ€ì¼ */
  @media print {
    #rail,
    #sidebar,
    .map-controls,
    .selection-panel {
      display: none !important;
    }
    
    #main {
      grid-column: 1 / -1;
    }
    
    body {
      background: white;
    }
  }

  /* ì‚¬ìš©ì ì •ì˜ ìŠ¤í¬ë¡¤ë°” */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: var(--gray-100);
  }

  ::-webkit-scrollbar-thumb {
    background: var(--gray-300);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--gray-400);
  }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
</head>
<body>
  <!-- ì˜¨ë¼ì¸ ìƒíƒœ í‘œì‹œ -->
  <div class="online-status" id="onlineStatus">
    <span id="statusText">ì—°ê²° í™•ì¸ì¤‘...</span>
  </div>

  <div id="app">
    <!-- ì¢Œì¸¡ ë„¤ë¹„ê²Œì´ì…˜ ë ˆì¼ -->
    <nav id="rail">
      <div class="logo-container">
        ì²­ì£¼ì‹œ<br>ê¸ˆì—°êµ¬ì—­
      </div>
      
      <button class="nav-button active" data-section="data" aria-label="ë°ì´í„° ê´€ë¦¬">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <span>ë°ì´í„°</span>
      </button>

      <button class="nav-button" data-section="filter" aria-label="í•„í„° ì„¤ì •">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"/>
        </svg>
        <span>í•„í„°</span>
      </button>

      <button class="nav-button" data-section="map" aria-label="ì§€ë„ ì„¤ì •">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
        </svg>
        <span>ì§€ë„</span>
      </button>

      <button class="nav-button" data-section="route" aria-label="ê²½ë¡œ ì„¤ì •">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
        </svg>
        <span>ê²½ë¡œ</span>
      </button>

      <button class="nav-button" data-section="export" aria-label="ë‚´ë³´ë‚´ê¸°">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <span>ë‚´ë³´ë‚´ê¸°</span>
      </button>

      <div style="margin-top: auto; padding-top: 20px;">
        <label class="chip" style="writing-mode: vertical-rl; text-orientation: mixed;">
          <input type="checkbox" id="darkToggle"> ë‹¤í¬ëª¨ë“œ
        </label>
      </div>
    </nav>

    <!-- ìƒë‹¨ íˆ´ë°” -->
    <header id="toolbar">
      <button class="btn btn-secondary" id="toggleSidebar">
        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
        ë©”ë‰´
      </button>

      <div style="display: flex; gap: 8px; align-items: center;">
        <label style="font-size: 12px; color: var(--gray-600);">ë¼ë²¨</label>
        <select id="labelSource">
          <option value="id">ê³ ìœ ë²ˆí˜¸</option>
          <option value="name">ì‹œì„¤ëª…</option>
          <option value="addr">ì£¼ì†Œ</option>
        </select>
      </div>

      <div style="display: flex; gap: 8px; align-items: center;">
        <label style="font-size: 12px; color: var(--gray-600);">ë°°ê²½ì§€ë„</label>
        <select id="baseMap">
          <option value="auto">ìë™ ì„ íƒ</option>
          <option value="osm">OpenStreetMap</option>
          <option value="vworld_gray">VWorld íšŒìƒ‰</option>
          <option value="vworld_base" selected>VWorld ê¸°ë³¸</option>
          <option value="none">ì—†ìŒ</option>
        </select>
      </div>

      <div style="display: flex; gap: 8px; align-items: center;">
        <label style="font-size: 12px; color: var(--gray-600);">ì¤Œ ë ˆë²¨</label>
        <input type="range" id="zoomSlider" min="5" max="19" step="0.1" value="12" style="width: 120px;">
        <span class="badge badge-primary" id="zoomDisplay">12.0</span>
      </div>

      <div style="margin-left: auto; display: flex; gap: 8px; align-items: center;">
        <span class="badge badge-primary" id="totalCount">ì´: 0</span>
        <span class="badge badge-success" id="shownCount">í‘œì‹œ: 0</span>
        <span class="badge badge-warning" id="missingCount">ì¢Œí‘œì—†ìŒ: 0</span>
        <span class="badge badge-danger" id="filteredCount">ì œì™¸: 0</span>
      </div>
    </header>

    <!-- ì‚¬ì´ë“œë°” -->
    <aside id="sidebar">
      <!-- ë°ì´í„° ì„¹ì…˜ -->
      <section class="section" data-section="data">
        <div class="section-header">
          <span>ğŸ“Š ë°ì´í„° ê´€ë¦¬</span>
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
          </svg>
        </div>
        <div class="section-content">
          <div style="margin-bottom: 16px;">
            <label class="btn btn-primary" for="dataFile" style="cursor: pointer;">
              ğŸ“ ì—‘ì…€ íŒŒì¼ ì„ íƒ
            </label>
            <input type="file" id="dataFile" accept=".xlsx,.xls,.xlsm" style="display: none;">
          </div>
          <div style="font-size: 12px; color: var(--gray-600); margin-bottom: 16px;">
            <strong>2025DATA</strong> ì‹œíŠ¸ì˜ <strong>B,C,E,G,H,J,R,S,U</strong> ì—´ì„ ìë™ìœ¼ë¡œ ì½ì–´ì˜µë‹ˆë‹¤.<br>
            (êµ¬ë¶„ì£¼ì†Œ/ê³ ìœ ë²ˆí˜¸/ì¹´í…Œê³ ë¦¬/ì‹œì„¤ëª…/ìë©´ë™/ì ê²€ì¼/ìœ„ë„/ê²½ë„/êµ°ì§‘)
          </div>
          <details style="margin-top: 12px;">
            <summary style="cursor: pointer; font-weight: 500;">ê³ ê¸‰ ì„¤ì •</summary>
            <div style="padding: 12px 0; border-top: 1px solid var(--gray-200); margin-top: 8px;">
              <div style="margin-bottom: 12px;">
                <label style="font-size: 12px; color: var(--gray-600);">ì‹œíŠ¸ ì„ íƒ</label>
                <select id="sheetSelect" style="width: 100%; margin-top: 4px;"></select>
              </div>
              <div style="display: flex; gap: 8px;">
                <div style="flex: 1;">
                  <label style="font-size: 12px; color: var(--gray-600);">ìœ„ë„ ì—´</label>
                  <input id="latColumn" placeholder="R" style="width: 100%; margin-top: 4px;">
                </div>
                <div style="flex: 1;">
                  <label style="font-size: 12px; color: var(--gray-600);">ê²½ë„ ì—´</label>
                  <input id="lngColumn" placeholder="S" style="width: 100%; margin-top: 4px;">
                </div>
              </div>
              <button class="btn btn-primary" id="applyAdvanced" style="width: 100%; margin-top: 12px;">ì ìš©</button>
            </div>
          </details>
        </div>
      </section>

      <!-- í•„í„° ì„¹ì…˜ -->
      <section class="section" data-section="filter">
        <div class="section-header">
          <span>ğŸ” í•„í„° ë° ê²€ìƒ‰</span>
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
          </svg>
        </div>
        <div class="section-content">
          <div style="margin-bottom: 16px;">
            <input id="searchInput" placeholder="êµ°ì§‘ ë²ˆí˜¸ ë˜ëŠ” ìë©´ë™ ê²€ìƒ‰..." style="width: 100%;">
            <button class="btn btn-secondary" id="clearSearch" style="margin-top: 8px;">ê²€ìƒ‰ ì´ˆê¸°í™”</button>
          </div>
          
          <div style="margin-bottom: 16px;">
            <label class="chip">
              <input type="checkbox" id="includeNoCoords" checked> ì¢Œí‘œ ì—†ëŠ” ë°ì´í„° í¬í•¨
            </label>
            <label class="chip" style="margin-top: 8px;">
              <input type="checkbox" id="onlyUninspected" checked> ë¯¸ì ê²€ë§Œ í‘œì‹œ
            </label>
          </div>

          <!-- êµ°ì§‘ í•„í„° -->
          <div style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
              <strong>êµ°ì§‘ë³„ í•„í„°</strong>
              <label class="switch">
                <input type="checkbox" id="clusterToggle" checked>
                <span class="slider"></span>
              </label>
            </div>
            <div id="clusterChips" class="chips"></div>
          </div>

          <!-- ìë©´ë™ í•„í„° -->
          <div style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
              <strong>ìë©´ë™ë³„ í•„í„°</strong>
              <label class="switch">
                <input type="checkbox" id="districtToggle" checked>
                <span class="slider"></span>
              </label>
            </div>
            <div id="districtChips" class="chips"></div>
          </div>

          <!-- ì¹´í…Œê³ ë¦¬ í•„í„° -->
          <div style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
              <strong>ì—…ì¢…ë³„ í•„í„°</strong>
              <label class="switch">
                <input type="checkbox" id="categoryToggle" checked>
                <span class="slider"></span>
              </label>
            </div>
            <div id="categoryChips" class="chips"></div>
          </div>
        </div>
      </section>

      <!-- ì§€ë„ ì„¹ì…˜ -->
      <section class="section" data-section="map">
        <div class="section-header">
          <span>ğŸ—ºï¸ ì§€ë„ ì„¤ì •</span>
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
          </svg>
        </div>
        <div class="section-content">
          <div style="margin-bottom: 16px;">
            <label style="font-size: 12px; color: var(--gray-600);">ë§ˆì»¤ ìŠ¤íƒ€ì¼</label>
            <select id="markerStyle" style="width: 100%; margin-top: 4px;">
              <option value="circle">ì›í˜•</option>
              <option value="square">ì‚¬ê°í˜•</option>
              <option value="bubble" selected>ë§í’ì„ </option>
            </select>
          </div>
          
          <div style="margin-bottom: 16px;">
            <label style="font-size: 12px; color: var(--gray-600);">ë§ˆì»¤ í¬ê¸°</label>
            <input type="range" id="markerSize" min="20" max="40" value="32" style="width: 100%; margin-top: 4px;">
          </div>

          <div style="margin-bottom: 16px;">
            <label class="chip">
              <input type="checkbox" id="clusterMarkers"> ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ë§
            </label>
          </div>

          <div style="margin-bottom: 16px;">
            <label class="chip">
              <input type="checkbox" id="showLabels" checked> ë¼ë²¨ í‘œì‹œ
            </label>
          </div>
        </div>
      </section>

      <!-- ê²½ë¡œ ì„¹ì…˜ -->
      <section class="section" data-section="route">
        <div class="section-header">
          <span>ğŸš— ê²½ë¡œ ê³„íš</span>
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
          </svg>
        </div>
        <div class="section-content">
          <div style="margin-bottom: 16px;">
            <label style="font-size: 12px; color: var(--gray-600);">ê²½ë¡œ ì•Œê³ ë¦¬ì¦˜</label>
            <select id="routeAlgorithm" style="width: 100%; margin-top: 4px;">
              <option value="nearest" selected>ìµœê·¼ì ‘ ì´ì›ƒ</option>
              <option value="tsp">TSP ìµœì í™”</option>
              <option value="cluster">í´ëŸ¬ìŠ¤í„° ê¸°ë°˜</option>
            </select>
          </div>

          <div style="margin-bottom: 16px;">
            <label style="font-size: 12px; color: var(--gray-600);">ì¼ì¼ ìµœëŒ€ ë°©ë¬¸ì§€</label>
            <input type="number" id="dailyLimit" value="50" min="1" max="200" style="width: 100%; margin-top: 4px;">
          </div>

          <div style="margin-bottom: 16px;">
            <button class="btn btn-primary" id="calculateRoute" style="width: 100%;">
              <div class="loading-spinner" id="routeSpinner" style="display: none;"></div>
              ê²½ë¡œ ê³„ì‚°
            </button>
            <button class="btn btn-secondary" id="clearRoute" style="width: 100%; margin-top: 8px;">ê²½ë¡œ ì´ˆê¸°í™”</button>
          </div>

          <div id="routeStats" style="font-size: 12px; color: var(--gray-600); display: none;">
            <div>ì´ ê±°ë¦¬: <span id="totalDistance">-</span></div>
            <div>ì˜ˆìƒ ì‹œê°„: <span id="estimatedTime">-</span></div>
            <div>ë°©ë¬¸ì§€ ìˆ˜: <span id="waypointCount">-</span></div>
          </div>
        </div>
      </section>

      <!-- ë‚´ë³´ë‚´ê¸° ì„¹ì…˜ -->
      <section class="section" data-section="export">
        <div class="section-header">
          <span>ğŸ“¤ ë‚´ë³´ë‚´ê¸°</span>
          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
          </svg>
        </div>
        <div class="section-content">
          <div style="margin-bottom: 16px;">
            <button class="btn btn-primary" id="exportExcel" style="width: 100%;">
              ğŸ“Š Excel ë‚´ë³´ë‚´ê¸°
            </button>
          </div>

          <div style="margin-bottom: 16px;">
            <button class="btn btn-secondary" id="exportPDF" style="width: 100%;">
              ğŸ“„ PDF ë‚´ë³´ë‚´ê¸°
            </button>
          </div>

          <div style="margin-bottom: 16px;">
            <button class="btn btn-secondary" id="exportImage" style="width: 100%;">
              ğŸ–¼ï¸ ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸°
            </button>
          </div>

          <div style="margin-bottom: 16px;">
            <label class="chip">
              <input type="checkbox" id="includeRoute"> ê²½ë¡œ í¬í•¨
            </label>
            <label class="chip" style="margin-top: 8px;">
              <input type="checkbox" id="highQuality"> ê³ í™”ì§ˆ
            </label>
          </div>
        </div>
      </section>
    </aside>

    <!-- ê°­ ë¦¬ì‚¬ì´ì € -->
    <div id="gap"></div>

    <!-- ë©”ì¸ ì§€ë„ ì˜ì—­ -->
    <main id="main">
      <!-- ì§€ë„ ì»¨íŠ¸ë¡¤ -->
      <div class="map-controls">
        <button class="btn btn-primary" id="showSelectionPanel">
          ğŸ“‹ ì„ íƒ ëª©ë¡ (0)
        </button>
        <button class="btn btn-secondary" id="fitToMarkers">ğŸ¯ ì „ì²´ ë³´ê¸°</button>
        <button class="btn btn-secondary" id="refreshMap">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      </div>

      <!-- ì§€ë„ -->
      <div id="map"></div>

      <!-- ì„ íƒ ëª©ë¡ íŒ¨ë„ -->
      <div class="selection-panel" id="selectionPanel">
        <div class="panel-header">
          <h3 class="panel-title">ì„ íƒëœ ì ê²€ ëŒ€ìƒì§€ <span id="selectedCount">(0ê°œ)</span></h3>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-accent" id="exportSelected">ğŸ“Š ë‚´ë³´ë‚´ê¸°</button>
            <button class="btn btn-secondary" id="clearSelected">ğŸ—‘ï¸ ëª¨ë‘ ì‚­ì œ</button>
            <button class="btn btn-secondary" id="closePanel">âœ•</button>
          </div>
        </div>
        <div class="panel-content">
          <table class="data-table" id="selectionTable">
            <thead>
              <tr>
                <th>ê³ ìœ ë²ˆí˜¸</th>
                <th>ì‹œì„¤ëª…</th>
                <th>ì£¼ì†Œ</th>
                <th>ì¹´í…Œê³ ë¦¬</th>
                <th>êµ°ì§‘</th>
                <th>ìˆœì„œ</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="selectionTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- ì›Œí„°ë§ˆí¬ -->
  <div class="watermark">
    Â© 2025 ì²­ì£¼ì‹œ ê¸ˆì—°êµ¬ì—­ ì ê²€ì§€ë„ v13.0 | ê°œë°œ: Claude Code
  </div>

  <!-- ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    // ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ë° ì£¼ìš” ê¸°ëŠ¥
    class CheongJuInspectionMap {
      constructor() {
        this.map = null;
        this.dataLayer = null;
        this.routeLayer = null;
        this.markers = new Map();
        this.selectedMarkers = new Set();
        this.data = [];
        this.filteredData = [];
        this.currentRoute = [];
        
        this.init();
      }

      async init() {
        this.initializeOnlineStatus();
        this.initializeMap();
        this.bindEventListeners();
        this.updateUI();
        
        // ì ‘ê·¼ì„± ê°œì„ 
        this.setupKeyboardNavigation();
        
        console.log('ì²­ì£¼ ê¸ˆì—°êµ¬ì—­ ì ê²€ì§€ë„ v13.0 ì´ˆê¸°í™” ì™„ë£Œ');
      }

      initializeOnlineStatus() {
        const updateStatus = () => {
          const statusElement = document.getElementById('onlineStatus');
          const statusText = document.getElementById('statusText');
          
          if (navigator.onLine) {
            statusElement.className = 'online-status online';
            statusText.textContent = 'ì˜¨ë¼ì¸ âœ…';
            
            // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€
            setTimeout(() => {
              statusElement.style.opacity = '0.3';
            }, 3000);
          } else {
            statusElement.className = 'online-status offline';
            statusText.textContent = 'ì˜¤í”„ë¼ì¸ âš ï¸';
            statusElement.style.opacity = '1';
          }
        };

        window.addEventListener('online', updateStatus);
        window.addEventListener('offline', updateStatus);
        updateStatus();
      }

      initializeMap() {
        // í•œêµ­ ì˜ì—­ ì œí•œ
        const KOREA_BOUNDS = L.latLngBounds([33.0, 124.0], [39.6, 132.5]);
        
        this.map = L.map('map', {
          zoomControl: true,
          zoomSnap: 0.1,
          zoomDelta: 0.1,
          preferCanvas: true,
          maxBounds: KOREA_BOUNDS,
          maxBoundsViscosity: 0.8,
          attributionControl: false
        }).setView([36.635, 127.491], 12);

        // ë ˆì´ì–´ ì´ˆê¸°í™”
        this.dataLayer = L.layerGroup().addTo(this.map);
        this.routeLayer = L.layerGroup().addTo(this.map);

        // ìŠ¤ì¼€ì¼ ì»¨íŠ¸ë¡¤
        L.control.scale({ 
          imperial: false,
          position: 'bottomleft'
        }).addTo(this.map);

        // ê¸°ë³¸ ë°°ê²½ì§€ë„ ì„¤ì •
        this.setBaseMap('vworld_base');

        // ì§€ë„ ì´ë²¤íŠ¸
        this.map.on('zoom', () => {
          const zoom = this.map.getZoom().toFixed(1);
          document.getElementById('zoomSlider').value = zoom;
          document.getElementById('zoomDisplay').textContent = zoom;
        });

        console.log('ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ');
      }

      setBaseMap(type) {
        if (this.baseLayer) {
          this.map.removeLayer(this.baseLayer);
        }

        const baseMaps = {
          'osm': {
            url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
            options: {
              maxZoom: 19,
              attribution: 'Â© OpenStreetMap contributors'
            }
          },
          'vworld_gray': {
            url: 'https://xdworld.vworld.kr/2d/gray/202002/service/{z}/{x}/{y}.png',
            options: {
              maxZoom: 19,
              attribution: 'Â© VWorld'
            }
          },
          'vworld_base': {
            url: 'https://xdworld.vworld.kr/2d/Base/service/{z}/{x}/{y}.png',
            options: {
              maxZoom: 19,
              attribution: 'Â© VWorld'
            }
          }
        };

        if (type === 'auto') {
          // ìë™ ì„ íƒ ë¡œì§
          type = navigator.onLine ? 'vworld_base' : 'osm';
        }

        if (type !== 'none' && baseMaps[type]) {
          this.baseLayer = L.tileLayer(baseMaps[type].url, baseMaps[type].options);
          this.baseLayer.addTo(this.map);
        }
      }

      bindEventListeners() {
        // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼
        document.querySelectorAll('.nav-button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const section = e.currentTarget.dataset.section;
            this.showSection(section);
          });
        });

        // ì‚¬ì´ë“œë°” í† ê¸€
        document.getElementById('toggleSidebar').addEventListener('click', () => {
          const sidebar = document.getElementById('sidebar');
          sidebar.classList.toggle('open');
        });

        // ì„¹ì…˜ í—¤ë” í† ê¸€
        document.querySelectorAll('.section-header').forEach(header => {
          header.addEventListener('click', () => {
            const section = header.parentElement;
            const content = section.querySelector('.section-content');
            const isOpen = content.style.display !== 'none';
            
            content.style.display = isOpen ? 'none' : 'block';
            header.querySelector('svg').style.transform = isOpen ? 'rotate(-90deg)' : 'rotate(0deg)';
          });
        });

        // íŒŒì¼ ì—…ë¡œë“œ
        document.getElementById('dataFile').addEventListener('change', (e) => {
          this.loadExcelFile(e.target.files[0]);
        });

        // ì§€ë„ ì»¨íŠ¸ë¡¤
        document.getElementById('baseMap').addEventListener('change', (e) => {
          this.setBaseMap(e.target.value);
        });

        document.getElementById('zoomSlider').addEventListener('input', (e) => {
          this.map.setZoom(parseFloat(e.target.value));
        });

        document.getElementById('labelSource').addEventListener('change', () => {
          this.updateMarkers();
        });

        document.getElementById('markerStyle').addEventListener('change', () => {
          this.updateMarkers();
        });

        document.getElementById('markerSize').addEventListener('change', (e) => {
          document.documentElement.style.setProperty('--marker-size', e.target.value + 'px');
          this.updateMarkers();
        });

        // í•„í„° ì´ë²¤íŠ¸
        document.getElementById('searchInput').addEventListener('input', () => {
          this.applyFilters();
        });

        document.getElementById('clearSearch').addEventListener('click', () => {
          document.getElementById('searchInput').value = '';
          this.applyFilters();
        });

        document.getElementById('includeNoCoords').addEventListener('change', () => {
          this.applyFilters();
        });

        document.getElementById('onlyUninspected').addEventListener('change', () => {
          this.applyFilters();
        });

        // ì„ íƒ íŒ¨ë„
        document.getElementById('showSelectionPanel').addEventListener('click', () => {
          document.getElementById('selectionPanel').style.display = 'block';
        });

        document.getElementById('closePanel').addEventListener('click', () => {
          document.getElementById('selectionPanel').style.display = 'none';
        });

        document.getElementById('clearSelected').addEventListener('click', () => {
          this.clearSelection();
        });

        // ê²½ë¡œ ê³„ì‚°
        document.getElementById('calculateRoute').addEventListener('click', () => {
          this.calculateRoute();
        });

        document.getElementById('clearRoute').addEventListener('click', () => {
          this.clearRoute();
        });

        // ë‚´ë³´ë‚´ê¸°
        document.getElementById('exportSelected').addEventListener('click', () => {
          this.exportSelection();
        });

        document.getElementById('exportExcel').addEventListener('click', () => {
          this.exportToExcel();
        });

        document.getElementById('exportPDF').addEventListener('click', () => {
          this.exportToPDF();
        });

        document.getElementById('exportImage').addEventListener('click', () => {
          this.exportToImage();
        });

        // ì§€ë„ ì»¨íŠ¸ë¡¤ ë²„íŠ¼
        document.getElementById('fitToMarkers').addEventListener('click', () => {
          this.fitToMarkers();
        });

        document.getElementById('refreshMap').addEventListener('click', () => {
          this.refreshMap();
        });

        // ë‹¤í¬ëª¨ë“œ í† ê¸€
        document.getElementById('darkToggle').addEventListener('change', (e) => {
          document.body.classList.toggle('auto-dark', e.target.checked);
        });
      }

      showSection(sectionName) {
        // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í™œì„±í™”
        document.querySelectorAll('.nav-button').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.section === sectionName);
        });

        // ì„¹ì…˜ í‘œì‹œ
        document.querySelectorAll('.section').forEach(section => {
          const isTarget = section.dataset.section === sectionName;
          section.style.display = isTarget ? 'block' : 'none';
        });
      }

      async loadExcelFile(file) {
        if (!file) return;

        try {
          const arrayBuffer = await file.arrayBuffer();
          const workbook = XLSX.read(arrayBuffer, { type: 'array' });
          
          let worksheet;
          if (workbook.SheetNames.includes('2025DATA')) {
            worksheet = workbook.Sheets['2025DATA'];
          } else {
            // ì‹œíŠ¸ ì„ íƒ UI í‘œì‹œ
            const sheetSelect = document.getElementById('sheetSelect');
            sheetSelect.innerHTML = workbook.SheetNames.map(name => 
              `<option value="${name}">${name}</option>`
            ).join('');
            return;
          }

          this.parseWorksheet(worksheet);
        } catch (error) {
          console.error('Excel íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
          alert('Excel íŒŒì¼ì„ ì½ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

      parseWorksheet(worksheet) {
        const data = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });
        
        this.data = [];
        
        // í—¤ë”ë¥¼ ì œì™¸í•˜ê³  ë°ì´í„° íŒŒì‹±
        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          if (!row || row.length === 0) continue;

          const item = {
            id: row[2] || i, // Cì—´: ê³ ìœ ë²ˆí˜¸
            addr: row[1] || '', // Bì—´: êµ¬ë¶„ì£¼ì†Œ  
            category: row[4] || 'ê¸°íƒ€', // Eì—´: ì¹´í…Œê³ ë¦¬
            name: row[6] || '', // Gì—´: ì‹œì„¤ëª…
            district: row[7] || '', // Hì—´: ìë©´ë™
            inspectionDate: row[9] || '', // Jì—´: ì ê²€ì¼
            lat: parseFloat(String(row[17]).replace(/,/g, '')) || null, // Rì—´: ìœ„ë„
            lng: parseFloat(String(row[18]).replace(/,/g, '')) || null, // Sì—´: ê²½ë„
            cluster: row[20] || '' // Uì—´: êµ°ì§‘
          };

          // ì¢Œí‘œ ìœ íš¨ì„± ê²€ì‚¬
          if (item.lat === 0) item.lat = null;
          if (item.lng === 0) item.lng = null;
          if (!isFinite(item.lat)) item.lat = null;
          if (!isFinite(item.lng)) item.lng = null;

          this.data.push(item);
        }

        console.log(`${this.data.length}ê°œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
        
        this.buildFilterChips();
        this.applyFilters();
        this.updateUI();
      }

      buildFilterChips() {
        // êµ°ì§‘ í•„í„° ì¹©
        const clusters = [...new Set(this.data.map(item => item.cluster).filter(Boolean))].sort();
        const clusterChips = document.getElementById('clusterChips');
        clusterChips.innerHTML = clusters.map(cluster => 
          `<label class="chip">
            <input type="checkbox" value="${cluster}" checked> ${cluster}
          </label>`
        ).join('');

        // ìë©´ë™ í•„í„° ì¹©
        const districts = [...new Set(this.data.map(item => item.district).filter(Boolean))].sort();
        const districtChips = document.getElementById('districtChips');
        districtChips.innerHTML = districts.map(district => 
          `<label class="chip">
            <input type="checkbox" value="${district}" checked> ${district}
          </label>`
        ).join('');

        // ì¹´í…Œê³ ë¦¬ í•„í„° ì¹©
        const categories = [...new Set(this.data.map(item => item.category).filter(Boolean))].sort();
        const categoryChips = document.getElementById('categoryChips');
        categoryChips.innerHTML = categories.map(category => 
          `<label class="chip">
            <input type="checkbox" value="${category}" checked> ${category}
          </label>`
        ).join('');

        // í•„í„° ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ì—°ê²°
        [clusterChips, districtChips, categoryChips].forEach(container => {
          container.addEventListener('change', () => this.applyFilters());
        });

        // ì „ì²´ í† ê¸€ ì´ë²¤íŠ¸
        ['cluster', 'district', 'category'].forEach(type => {
          document.getElementById(`${type}Toggle`).addEventListener('change', (e) => {
            const chips = document.getElementById(`${type}Chips`);
            chips.querySelectorAll('input[type="checkbox"]').forEach(cb => {
              cb.checked = e.target.checked;
            });
            this.applyFilters();
          });
        });
      }

      applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
        const includeNoCoords = document.getElementById('includeNoCoords').checked;
        const onlyUninspected = document.getElementById('onlyUninspected').checked;

        // ì„ íƒëœ í•„í„° ê°’ë“¤
        const selectedClusters = new Set(
          Array.from(document.querySelectorAll('#clusterChips input:checked'))
            .map(cb => cb.value)
        );
        
        const selectedDistricts = new Set(
          Array.from(document.querySelectorAll('#districtChips input:checked'))
            .map(cb => cb.value)
        );
        
        const selectedCategories = new Set(
          Array.from(document.querySelectorAll('#categoryChips input:checked'))
            .map(cb => cb.value)
        );

        this.filteredData = this.data.filter(item => {
          // ê²€ìƒ‰ì–´ í•„í„°
          if (searchTerm) {
            const searchableText = `${item.name} ${item.addr} ${item.district} ${item.cluster}`.toLowerCase();
            if (!searchableText.includes(searchTerm)) return false;
          }

          // ì¢Œí‘œ í•„í„°
          if (!includeNoCoords && (!item.lat || !item.lng)) return false;

          // ë¯¸ì ê²€ í•„í„°
          if (onlyUninspected && item.inspectionDate && item.inspectionDate.trim()) return false;

          // êµ°ì§‘ í•„í„°
          if (selectedClusters.size > 0 && !selectedClusters.has(item.cluster)) return false;

          // ìë©´ë™ í•„í„°
          if (selectedDistricts.size > 0 && !selectedDistricts.has(item.district)) return false;

          // ì¹´í…Œê³ ë¦¬ í•„í„°
          if (selectedCategories.size > 0 && !selectedCategories.has(item.category)) return false;

          return true;
        });

        console.log(`í•„í„° ì ìš©: ${this.filteredData.length}/${this.data.length}ê°œ í•­ëª©`);
        this.updateMarkers();
        this.updateUI();
      }

      updateMarkers() {
        this.dataLayer.clearLayers();
        this.markers.clear();

        const labelSource = document.getElementById('labelSource').value;
        const markerStyle = document.getElementById('markerStyle').value;
        const showLabels = document.getElementById('showLabels').checked;

        this.filteredData.forEach(item => {
          if (!item.lat || !item.lng) return;

          const label = this.getItemLabel(item, labelSource);
          const markerHtml = this.createMarkerHtml(label, item.category, markerStyle);
          
          const marker = L.marker([item.lat, item.lng], {
            icon: L.divIcon({
              html: markerHtml,
              className: 'custom-marker',
              iconSize: null,
              iconAnchor: [16, 16]
            })
          });

          // íˆ´íŒ
          if (showLabels) {
            marker.bindTooltip(this.createTooltipContent(item), { 
              sticky: true,
              className: 'custom-tooltip'
            });
          }

          // íŒì—…
          marker.bindPopup(this.createPopupContent(item), {
            className: 'custom-popup'
          });

          // ì´ë²¤íŠ¸
          marker.on('click', () => {
            this.toggleMarkerSelection(item.id);
          });

          marker.on('popupopen', (e) => {
            this.bindPopupEvents(e.popup.getElement(), item);
          });

          marker.addTo(this.dataLayer);
          this.markers.set(item.id, marker);

          // ì„ íƒëœ ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì ìš©
          if (this.selectedMarkers.has(item.id)) {
            marker.getElement().classList.add('selected');
          }
        });
      }

      getItemLabel(item, source) {
        switch (source) {
          case 'name': return item.name || item.id;
          case 'addr': return item.addr || item.id;
          default: return item.id;
        }
      }

      createMarkerHtml(label, category, style) {
        const categoryClass = `category-${category.replace(/\s+/g, '')}`;
        
        switch (style) {
          case 'square':
            return `<div class="marker ${categoryClass}" style="border-radius: 4px;">${label}</div>`;
          case 'bubble':
            return `<div class="marker ${categoryClass}" style="border-radius: 12px; position: relative;">
              ${label}
              <div style="position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid currentColor;"></div>
            </div>`;
          default:
            return `<div class="marker ${categoryClass}">${label}</div>`;
        }
      }

      createTooltipContent(item) {
        return `<div>
          <strong>${item.name || item.id}</strong><br>
          ${item.addr}<br>
          ${item.district} â€¢ ${item.category}
        </div>`;
      }

      createPopupContent(item) {
        return `<div style="min-width: 200px; font-size: 13px;">
          <div style="margin-bottom: 8px;">
            <strong>${item.name || 'ì‹œì„¤ëª… ì—†ìŒ'}</strong>
          </div>
          <div style="margin-bottom: 4px;"><strong>ê³ ìœ ë²ˆí˜¸:</strong> ${item.id}</div>
          <div style="margin-bottom: 4px;"><strong>ì£¼ì†Œ:</strong> ${item.addr}</div>
          <div style="margin-bottom: 4px;"><strong>ì—…ì¢…:</strong> ${item.category}</div>
          <div style="margin-bottom: 4px;"><strong>ìë©´ë™:</strong> ${item.district}</div>
          <div style="margin-bottom: 4px;"><strong>êµ°ì§‘:</strong> ${item.cluster}</div>
          <div style="margin-bottom: 12px;"><strong>ì ê²€ì¼:</strong> ${item.inspectionDate || 'ë¯¸ì ê²€'}</div>
          
          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <button class="btn btn-primary btn-sm" onclick="app.addToSelection('${item.id}')">ì„ íƒ ì¶”ê°€</button>
            <button class="btn btn-danger btn-sm" onclick="app.removeFromSelection('${item.id}')">ì„ íƒ ì œê±°</button>
          </div>
          
          ${item.lat && item.lng ? `
          <div style="border-top: 1px solid var(--gray-200); padding-top: 8px;">
            <div style="font-weight: 600; margin-bottom: 4px;">ê¸¸ì°¾ê¸°:</div>
            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
              <button onclick="app.openNavigation('kakao', ${item.lat}, ${item.lng}, '${item.name || item.addr}')" style="background: #FEE500; color: #000; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px;">ì¹´ì¹´ì˜¤</button>
              <button onclick="app.openNavigation('naver', ${item.lat}, ${item.lng}, '${item.name || item.addr}')" style="background: #03C75A; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px;">ë„¤ì´ë²„</button>
              <button onclick="app.openNavigation('tmap', ${item.lat}, ${item.lng}, '${item.name || item.addr}')" style="background: #FF0000; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px;">í‹°ë§µ</button>
              <button onclick="app.openNavigation('google', ${item.lat}, ${item.lng}, '${item.name || item.addr}')" style="background: #4285F4; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px;">êµ¬ê¸€</button>
            </div>
          </div>
          ` : ''}
        </div>`;
      }

      bindPopupEvents(popupElement, item) {
        // íŒì—… ë‚´ ë²„íŠ¼ ì´ë²¤íŠ¸ëŠ” ì¸ë¼ì¸ìœ¼ë¡œ ì²˜ë¦¬ë¨
      }

      toggleMarkerSelection(itemId) {
        if (this.selectedMarkers.has(itemId)) {
          this.removeFromSelection(itemId);
        } else {
          this.addToSelection(itemId);
        }
      }

      addToSelection(itemId) {
        const item = this.data.find(d => d.id == itemId);
        if (!item) return;

        this.selectedMarkers.add(itemId);
        
        // ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        const marker = this.markers.get(itemId);
        if (marker) {
          marker.getElement().classList.add('selected');
        }

        this.updateSelectionPanel();
        this.updateUI();
        
        // 2ê°œ ì´ìƒì´ë©´ ê²½ë¡œ ìë™ ê³„ì‚°
        if (this.selectedMarkers.size >= 2) {
          this.calculateRoute();
        }
      }

      removeFromSelection(itemId) {
        this.selectedMarkers.delete(itemId);
        
        // ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
        const marker = this.markers.get(itemId);
        if (marker) {
          marker.getElement().classList.remove('selected');
        }

        this.updateSelectionPanel();
        this.updateUI();
        
        // ê²½ë¡œ ì¬ê³„ì‚°
        if (this.selectedMarkers.size >= 2) {
          this.calculateRoute();
        } else {
          this.clearRoute();
        }
      }

      clearSelection() {
        this.selectedMarkers.clear();
        
        // ëª¨ë“  ë§ˆì»¤ì˜ ì„ íƒ ìŠ¤íƒ€ì¼ ì œê±°
        this.markers.forEach(marker => {
          marker.getElement().classList.remove('selected');
        });

        this.updateSelectionPanel();
        this.updateUI();
        this.clearRoute();
      }

      updateSelectionPanel() {
        const tbody = document.getElementById('selectionTableBody');
        const selectedItems = this.data.filter(item => this.selectedMarkers.has(item.id));
        
        tbody.innerHTML = selectedItems.map((item, index) => `
          <tr>
            <td>${item.id}</td>
            <td>${item.name}</td>
            <td>${item.addr}</td>
            <td>${item.category}</td>
            <td>${item.cluster}</td>
            <td><input type="number" value="${index + 1}" min="1" style="width: 60px;" onchange="app.updateOrder('${item.id}', this.value)"></td>
            <td>
              <button class="btn btn-danger btn-sm" onclick="app.removeFromSelection('${item.id}')">ì‚­ì œ</button>
              ${item.lat && item.lng ? `<button class="btn btn-secondary btn-sm" onclick="app.showNavigationMenu('${item.id}', ${item.lat}, ${item.lng}, '${item.name || item.addr}')">ğŸ§­</button>` : ''}
            </td>
          </tr>
        `).join('');

        document.getElementById('selectedCount').textContent = `(${selectedItems.length}ê°œ)`;
      }

      updateOrder(itemId, newOrder) {
        // ìˆœì„œ ë³€ê²½ ë¡œì§ êµ¬í˜„
        console.log(`${itemId}ì˜ ìˆœì„œë¥¼ ${newOrder}ë¡œ ë³€ê²½`);
        this.calculateRoute();
      }

      showNavigationMenu(itemId, lat, lng, name) {
        // ë„¤ë¹„ê²Œì´ì…˜ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í‘œì‹œ
        const existingMenu = document.querySelector('.nav-dropdown');
        if (existingMenu) existingMenu.remove();

        const menu = document.createElement('div');
        menu.className = 'nav-dropdown';
        menu.style.cssText = `
          position: fixed;
          background: white;
          border: 2px solid var(--gray-200);
          border-radius: 8px;
          box-shadow: var(--shadow-lg);
          z-index: 10000;
          padding: 8px;
          min-width: 150px;
        `;

        menu.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 8px; padding: 4px 0; border-bottom: 1px solid var(--gray-200);">ê¸¸ì°¾ê¸° ì„ íƒ</div>
          <button onclick="app.openNavigation('kakao', ${lat}, ${lng}, '${name}')" style="display: block; width: 100%; margin: 4px 0; padding: 8px; background: #FEE500; color: #000; border: none; border-radius: 4px; font-size: 12px;">ì¹´ì¹´ì˜¤ë§µ</button>
          <button onclick="app.openNavigation('naver', ${lat}, ${lng}, '${name}')" style="display: block; width: 100%; margin: 4px 0; padding: 8px; background: #03C75A; color: white; border: none; border-radius: 4px; font-size: 12px;">ë„¤ì´ë²„ì§€ë„</button>
          <button onclick="app.openNavigation('tmap', ${lat}, ${lng}, '${name}')" style="display: block; width: 100%; margin: 4px 0; padding: 8px; background: #FF0000; color: white; border: none; border-radius: 4px; font-size: 12px;">í‹°ë§µ</button>
          <button onclick="app.openNavigation('google', ${lat}, ${lng}, '${name}')" style="display: block; width: 100%; margin: 4px 0; padding: 8px; background: #4285F4; color: white; border: none; border-radius: 4px; font-size: 12px;">êµ¬ê¸€ì§€ë„</button>
        `;

        document.body.appendChild(menu);

        // ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì— ë©”ë‰´ í‘œì‹œ
        const rect = event.target.getBoundingClientRect();
        menu.style.left = rect.left + 'px';
        menu.style.top = (rect.bottom + 5) + 'px';

        // ì™¸ë¶€ í´ë¦­ì‹œ ë©”ë‰´ ë‹«ê¸°
        const closeMenu = (e) => {
          if (!menu.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', closeMenu);
          }
        };
        setTimeout(() => document.addEventListener('click', closeMenu), 100);
      }

      openNavigation(app, lat, lng, name) {
        const encodedName = encodeURIComponent(name);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /android/i.test(navigator.userAgent);

        let url = '';
        let fallbackUrl = '';

        switch (app) {
          case 'kakao':
            url = `kakaomap://route?ep=${lat},${lng}&by=car`;
            fallbackUrl = `http://m.map.kakao.com/route?ep=${lat},${lng}&by=car`;
            break;
          case 'naver':
            url = `nmap://route/car?dlat=${lat}&dlng=${lng}&dname=${encodedName}`;
            fallbackUrl = isIOS ? 
              'https://apps.apple.com/kr/app/naver-map/id311867728' : 
              'https://play.google.com/store/apps/details?id=com.nhn.android.nmap';
            break;
          case 'tmap':
            url = isIOS ? 
              `tmap://route?rGoName=${encodedName}&rGoX=${lng}&rGoY=${lat}` :
              `tmap://route?goalx=${lng}&goaly=${lat}&goalname=${encodedName}`;
            fallbackUrl = isIOS ?
              'https://apps.apple.com/kr/app/tmap/id431589174' :
              'https://play.google.com/store/apps/details?id=com.skt.tmap.ku';
            break;
          case 'google':
            url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
            break;
        }

        // ë„¤ë¹„ê²Œì´ì…˜ ì•± ì‹¤í–‰
        if (app === 'google') {
          window.open(url, '_blank');
        } else {
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          document.body.appendChild(iframe);
          iframe.src = url;

          setTimeout(() => {
            document.body.removeChild(iframe);
            if (fallbackUrl && app !== 'kakao') {
              window.open(fallbackUrl, '_blank');
            } else if (app === 'kakao') {
              window.open(fallbackUrl, '_blank');
            }
          }, 1500);
        }

        // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ë‹«ê¸°
        const dropdown = document.querySelector('.nav-dropdown');
        if (dropdown) dropdown.remove();
      }

      async calculateRoute() {
        if (this.selectedMarkers.size < 2) return;

        const button = document.getElementById('calculateRoute');
        const spinner = document.getElementById('routeSpinner');
        
        button.disabled = true;
        spinner.style.display = 'inline-block';

        try {
          const selectedItems = this.data.filter(item => this.selectedMarkers.has(item.id));
          const algorithm = document.getElementById('routeAlgorithm').value;
          
          let orderedPoints;
          switch (algorithm) {
            case 'tsp':
              orderedPoints = await this.solveTSP(selectedItems);
              break;
            case 'cluster':
              orderedPoints = await this.clusterBasedRoute(selectedItems);
              break;
            default:
              orderedPoints = this.nearestNeighborRoute(selectedItems);
          }

          this.currentRoute = orderedPoints;
          this.drawRoute(orderedPoints);
          this.showRouteStats(orderedPoints);

        } catch (error) {
          console.error('ê²½ë¡œ ê³„ì‚° ì‹¤íŒ¨:', error);
          alert('ê²½ë¡œ ê³„ì‚°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        } finally {
          button.disabled = false;
          spinner.style.display = 'none';
        }
      }

      nearestNeighborRoute(points) {
        if (points.length < 2) return points;

        const unvisited = [...points];
        const route = [unvisited.shift()];

        while (unvisited.length > 0) {
          const current = route[route.length - 1];
          let nearest = unvisited[0];
          let minDistance = this.calculateDistance(current, nearest);

          for (let i = 1; i < unvisited.length; i++) {
            const distance = this.calculateDistance(current, unvisited[i]);
            if (distance < minDistance) {
              minDistance = distance;
              nearest = unvisited[i];
            }
          }

          route.push(nearest);
          unvisited.splice(unvisited.indexOf(nearest), 1);
        }

        return route;
      }

      async solveTSP(points) {
        // ê°„ë‹¨í•œ 2-opt ìµœì í™”
        let route = this.nearestNeighborRoute(points);
        let improved = true;

        while (improved) {
          improved = false;
          for (let i = 0; i < route.length - 1; i++) {
            for (let j = i + 2; j < route.length; j++) {
              const oldDistance = 
                this.calculateDistance(route[i], route[i + 1]) +
                this.calculateDistance(route[j], route[(j + 1) % route.length]);
              
              const newDistance = 
                this.calculateDistance(route[i], route[j]) +
                this.calculateDistance(route[i + 1], route[(j + 1) % route.length]);

              if (newDistance < oldDistance) {
                // 2-opt swap
                const newRoute = route.slice(0, i + 1)
                  .concat(route.slice(i + 1, j + 1).reverse())
                  .concat(route.slice(j + 1));
                route = newRoute;
                improved = true;
              }
            }
          }
        }

        return route;
      }

      async clusterBasedRoute(points) {
        // ì§€ë¦¬ì  í´ëŸ¬ìŠ¤í„°ë§ ê¸°ë°˜ ê²½ë¡œ
        const clusters = this.clusterPoints(points, 5); // 5ê°œ í´ëŸ¬ìŠ¤í„°
        const clusterCenters = clusters.map(cluster => this.getClusterCenter(cluster));
        const orderedCenters = this.nearestNeighborRoute(clusterCenters);
        
        let route = [];
        for (const center of orderedCenters) {
          const cluster = clusters.find(c => this.getClusterCenter(c) === center);
          route = route.concat(this.nearestNeighborRoute(cluster));
        }

        return route;
      }

      clusterPoints(points, k) {
        // K-means í´ëŸ¬ìŠ¤í„°ë§ êµ¬í˜„
        if (points.length <= k) return points.map(p => [p]);

        // ì´ˆê¸° ì¤‘ì‹¬ì  ì„ íƒ
        let centroids = [];
        for (let i = 0; i < k; i++) {
          centroids.push(points[Math.floor(i * points.length / k)]);
        }

        let clusters = [];
        let prevCentroids = [];

        while (!this.centroidsEqual(centroids, prevCentroids)) {
          prevCentroids = [...centroids];
          clusters = Array(k).fill().map(() => []);

          // ê° ì ì„ ê°€ì¥ ê°€ê¹Œìš´ ì¤‘ì‹¬ì ì— í• ë‹¹
          for (const point of points) {
            let minDistance = Infinity;
            let clusterIndex = 0;

            for (let i = 0; i < centroids.length; i++) {
              const distance = this.calculateDistance(point, centroids[i]);
              if (distance < minDistance) {
                minDistance = distance;
                clusterIndex = i;
              }
            }

            clusters[clusterIndex].push(point);
          }

          // ìƒˆë¡œìš´ ì¤‘ì‹¬ì  ê³„ì‚°
          centroids = clusters.map(cluster => this.getClusterCenter(cluster));
        }

        return clusters.filter(cluster => cluster.length > 0);
      }

      getClusterCenter(cluster) {
        if (cluster.length === 0) return null;
        
        const avgLat = cluster.reduce((sum, p) => sum + p.lat, 0) / cluster.length;
        const avgLng = cluster.reduce((sum, p) => sum + p.lng, 0) / cluster.length;
        
        return cluster.reduce((closest, point) => {
          const distToCurrent = this.calculateDistance(point, { lat: avgLat, lng: avgLng });
          const distToClosest = this.calculateDistance(closest, { lat: avgLat, lng: avgLng });
          return distToCurrent < distToClosest ? point : closest;
        });
      }

      centroidsEqual(c1, c2) {
        if (c1.length !== c2.length) return false;
        for (let i = 0; i < c1.length; i++) {
          if (!c1[i] || !c2[i]) return false;
          if (Math.abs(c1[i].lat - c2[i].lat) > 0.001 || 
              Math.abs(c1[i].lng - c2[i].lng) > 0.001) {
            return false;
          }
        }
        return true;
      }

      calculateDistance(p1, p2) {
        // í•˜ë²„ì‚¬ì¸ ê³µì‹
        const R = 6371; // ì§€êµ¬ ë°˜ê²½ (km)
        const dLat = (p2.lat - p1.lat) * Math.PI / 180;
        const dLng = (p2.lng - p1.lng) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
                  Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      drawRoute(points) {
        this.routeLayer.clearLayers();
        
        if (points.length < 2) return;

        // ê²½ë¡œ ë¼ì¸ ê·¸ë¦¬ê¸°
        const latlngs = points.map(p => [p.lat, p.lng]);
        const routeLine = L.polyline(latlngs, {
          color: '#2563EB',
          weight: 4,
          opacity: 0.8,
          dashArray: '10, 5'
        });

        routeLine.addTo(this.routeLayer);

        // ì‹œì‘ì ê³¼ ëì  ë§ˆì»¤
        const startIcon = L.divIcon({
          html: '<div style="background: #10B981; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold;">S</div>',
          className: 'route-marker',
          iconSize: [24, 24]
        });

        const endIcon = L.divIcon({
          html: '<div style="background: #EF4444; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold;">E</div>',
          className: 'route-marker',
          iconSize: [24, 24]
        });

        L.marker([points[0].lat, points[0].lng], { icon: startIcon }).addTo(this.routeLayer);
        L.marker([points[points.length - 1].lat, points[points.length - 1].lng], { icon: endIcon }).addTo(this.routeLayer);
      }

      showRouteStats(points) {
        if (points.length < 2) return;

        let totalDistance = 0;
        for (let i = 0; i < points.length - 1; i++) {
          totalDistance += this.calculateDistance(points[i], points[i + 1]);
        }

        const estimatedTime = (totalDistance / 40) * 60; // 40km/h ê°€ì •, ë¶„ ë‹¨ìœ„

        document.getElementById('totalDistance').textContent = `${totalDistance.toFixed(1)}km`;
        document.getElementById('estimatedTime').textContent = `${Math.round(estimatedTime)}ë¶„`;
        document.getElementById('waypointCount').textContent = `${points.length}ê°œ`;
        document.getElementById('routeStats').style.display = 'block';
      }

      clearRoute() {
        this.routeLayer.clearLayers();
        this.currentRoute = [];
        document.getElementById('routeStats').style.display = 'none';
      }

      fitToMarkers() {
        if (this.filteredData.length === 0) return;

        const validPoints = this.filteredData.filter(item => item.lat && item.lng);
        if (validPoints.length === 0) return;

        const bounds = L.latLngBounds(validPoints.map(item => [item.lat, item.lng]));
        this.map.fitBounds(bounds, { padding: [20, 20] });
      }

      refreshMap() {
        this.applyFilters();
        this.updateMarkers();
      }

      updateUI() {
        // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        const totalCount = this.data.length;
        const shownCount = this.filteredData.filter(item => item.lat && item.lng).length;
        const missingCount = this.data.filter(item => !item.lat || !item.lng).length;
        const filteredCount = totalCount - this.filteredData.length;

        document.getElementById('totalCount').textContent = `ì´: ${totalCount}`;
        document.getElementById('shownCount').textContent = `í‘œì‹œ: ${shownCount}`;
        document.getElementById('missingCount').textContent = `ì¢Œí‘œì—†ìŒ: ${missingCount}`;
        document.getElementById('filteredCount').textContent = `ì œì™¸: ${filteredCount}`;

        // ì„ íƒ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        document.getElementById('showSelectionPanel').innerHTML = 
          `ğŸ“‹ ì„ íƒ ëª©ë¡ (${this.selectedMarkers.size})`;
      }

      setupKeyboardNavigation() {
        document.addEventListener('keydown', (e) => {
          // Escape: íŒì—… ë‹«ê¸°
          if (e.key === 'Escape') {
            this.map.closePopup();
            const panel = document.getElementById('selectionPanel');
            if (panel.style.display === 'block') {
              panel.style.display = 'none';
            }
          }

          // Ctrl+A: ì „ì²´ ì„ íƒ
          if (e.ctrlKey && e.key === 'a') {
            e.preventDefault();
            this.selectAll();
          }

          // Ctrl+D: ì„ íƒ í•´ì œ
          if (e.ctrlKey && e.key === 'd') {
            e.preventDefault();
            this.clearSelection();
          }

          // F: ì§€ë„ ë§ì¶¤
          if (e.key === 'f' || e.key === 'F') {
            this.fitToMarkers();
          }
        });
      }

      selectAll() {
        const validItems = this.filteredData.filter(item => item.lat && item.lng);
        const dailyLimit = parseInt(document.getElementById('dailyLimit').value) || 50;
        
        // ì¼ì¼ í•œë„ë§Œí¼ë§Œ ì„ íƒ
        const itemsToSelect = validItems.slice(0, dailyLimit);
        
        this.clearSelection();
        itemsToSelect.forEach(item => {
          this.selectedMarkers.add(item.id);
          const marker = this.markers.get(item.id);
          if (marker) {
            marker.getElement().classList.add('selected');
          }
        });

        this.updateSelectionPanel();
        this.updateUI();
        
        if (this.selectedMarkers.size >= 2) {
          this.calculateRoute();
        }
      }

      // ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ë“¤
      exportSelection() {
        if (this.selectedMarkers.size === 0) {
          alert('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        const selectedItems = this.data.filter(item => this.selectedMarkers.has(item.id));
        this.exportToExcel(selectedItems);
      }

      exportToExcel(data = null) {
        const exportData = data || this.filteredData;
        
        if (exportData.length === 0) {
          alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        const worksheet = XLSX.utils.json_to_sheet(exportData.map((item, index) => ({
          'ìˆœë²ˆ': index + 1,
          'ê³ ìœ ë²ˆí˜¸': item.id,
          'ì‹œì„¤ëª…': item.name,
          'ì£¼ì†Œ': item.addr,
          'ì—…ì¢…': item.category,
          'ìë©´ë™': item.district,
          'êµ°ì§‘': item.cluster,
          'ì ê²€ì¼': item.inspectionDate,
          'ìœ„ë„': item.lat,
          'ê²½ë„': item.lng,
          'ê²½ë¡œìˆœì„œ': this.currentRoute.findIndex(r => r.id === item.id) + 1 || ''
        })));

        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'ì ê²€ëŒ€ìƒì§€');

        const filename = `ì²­ì£¼_ê¸ˆì—°êµ¬ì—­_ì ê²€ëŒ€ìƒì§€_${new Date().toISOString().slice(0, 10)}.xlsx`;
        XLSX.writeFile(workbook, filename);
      }

      async exportToPDF() {
        try {
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('l', 'mm', 'a4'); // ê°€ë¡œ ë°©í–¥
          
          // ì§€ë„ ìº¡ì²˜
          const mapElement = document.getElementById('map');
          const canvas = await html2canvas(mapElement, {
            useCORS: true,
            allowTaint: true,
            scale: 2
          });
          
          const imgData = canvas.toDataURL('image/png');
          const imgWidth = 277; // A4 ê°€ë¡œ í¬ê¸° (mm)
          const imgHeight = (canvas.height * imgWidth) / canvas.width;
          
          pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
          
          // ë©”íƒ€ë°ì´í„° ì¶”ê°€
          pdf.setFontSize(12);
          pdf.text(`ì²­ì£¼ì‹œ ê¸ˆì—°êµ¬ì—­ ì ê²€ì§€ë„`, 10, imgHeight + 25);
          pdf.text(`ìƒì„±ì¼: ${new Date().toLocaleDateString()}`, 10, imgHeight + 35);
          pdf.text(`ì´ ${this.filteredData.length}ê°œ ì§€ì  í‘œì‹œ`, 10, imgHeight + 45);
          
          const filename = `ì²­ì£¼_ê¸ˆì—°êµ¬ì—­_ì§€ë„_${new Date().toISOString().slice(0, 10)}.pdf`;
          pdf.save(filename);
        } catch (error) {
          console.error('PDF ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
          alert('PDF ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }

      async exportToImage() {
        try {
          const mapElement = document.getElementById('map');
          const canvas = await html2canvas(mapElement, {
            useCORS: true,
            allowTaint: true,
            scale: 2
          });
          
          // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
          const link = document.createElement('a');
          link.download = `ì²­ì£¼_ê¸ˆì—°êµ¬ì—­_ì§€ë„_${new Date().toISOString().slice(0, 10)}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
        } catch (error) {
          console.error('ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
          alert('ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      }
    }

    // ì• í”Œë¦¬ì¼€ì´ì…˜ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì „ì—­ ë…¸ì¶œ
    let app;
    document.addEventListener('DOMContentLoaded', () => {
      app = new CheongJuInspectionMap();
      window.app = app; // ì „ì—­ ì ‘ê·¼ì„ ìœ„í•´
    });
  </script>
</body>
</html>