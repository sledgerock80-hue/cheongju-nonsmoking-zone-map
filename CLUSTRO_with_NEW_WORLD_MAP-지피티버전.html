<!DOCTYPE html>

<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>AUTO MAP - CLUSTRO (Final Secured v12.2)</title>
<!-- ğŸ”’ SECURITY HEADERS - ë¯¼ê° ì •ë³´ ë…¸ì¶œ ë° XSS ë°©ì§€ -->
<meta content="
  default-src 'self'; 
  script-src 'self' 'unsafe-inline' https://unpkg.com https://fonts.gstatic.com https://api.vworld.kr;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com;
  font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com;
  img-src 'self' data: blob: https: http:;
  connect-src 'self' https: http:;
  frame-ancestors 'none';
  base-uri 'self';
  form-action 'self';
" http-equiv="Content-Security-Policy"/>
<meta content="nosniff" http-equiv="X-Content-Type-Options"/>
<meta content="DENY" http-equiv="X-Frame-Options"/>
<meta content="1; mode=block" http-equiv="X-XSS-Protection"/>
<meta content="strict-origin-when-cross-origin" http-equiv="Referrer-Policy"/>
<meta content="geolocation=(), microphone=(), camera=()" http-equiv="Permissions-Policy"/>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&amp;display=swap" rel="stylesheet"/>
<style>
/**
 * ğŸ¨ DESIGN SYSTEM - ì¼ê´€ëœ ì½”ë”© ìŠ¤íƒ€ì¼ê³¼ ë°˜ì‘í˜• ë””ìì¸
 * ëª¨ë“  CSS ë³€ìˆ˜ì™€ í´ë˜ìŠ¤ëŠ” ì²´ê³„ì ìœ¼ë¡œ ì •ë¦¬ë¨
 */
:root {
  /* ğŸ¨ Color System - ì ‘ê·¼ì„±ì„ ê³ ë ¤í•œ ìƒ‰ìƒ ëŒ€ë¹„ */
  --c-primary: #1F3A8A;
  --c-sky: #0EA5E9;
  --c-accent: #EA580C;
  --c-util: #334155;
  --c-success: #059669;
  --c-warning: #D97706;
  --c-danger: #DC2626;
  
  /* ğŸ“ Layout System */
  --rail-w: 64px;
  --side-w: 380px;
  --gut-w: 6px;
  
  /* ğŸ“ Typography System */
  --flt-font: 14px;
  --tbl-font: 14px;
  --font-family: 300 "Roboto", "Apple SD Gothic Neo", "Malgun Gothic", system-ui, sans-serif;
  
  /* ğŸ—ºï¸ Map System */
  --mk: 30px;
  
  /* ğŸ¯ Animation System */
  --transition-fast: 0.15s ease;
  --transition-normal: 0.25s ease;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
}

/* ğŸ“± RESPONSIVE DESIGN - ë‹¤ì–‘í•œ í™”ë©´ í¬ê¸° ì§€ì› */
@media (max-width: 768px) {
  :root {
    --rail-w: 48px;
    --side-w: 280px;
    --flt-font: 12px;
    --tbl-font: 12px;
  }
  
  #app {
    grid-template-columns: var(--rail-w) 1fr;
    grid-template-areas: "rail toolbar" "rail main";
  }
  
  #lhs {
    position: fixed;
    left: -100%;
    top: 0;
    width: var(--side-w);
    height: 100vh;
    z-index: 9999;
    transition: left var(--transition-normal);
  }
  
  #lhs.mobile-open {
    left: var(--rail-w);
  }
  
  .mobile-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9998;
    display: none;
  }
  
  .mobile-overlay.show {
    display: block;
  }
}

@media (max-width: 480px) {
  :root {
    --rail-w: 40px;
    --side-w: 100vw;
  }
  
  .icbtn span {
    display: none;
  }
}

/* ğŸ¯ BASE STYLES */
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font: 14px/1.45 var(--font-family);
  color: #111;
  background: #fff;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ğŸ“ LAYOUT GRID */
#app {
  display: grid;
  min-height: 100vh;
  grid-template-columns: var(--rail-w) var(--side-w) var(--gut-w) 1fr;
  grid-template-rows: auto 1fr;
  grid-template-areas: "rail toolbar toolbar toolbar" "rail lhs gut rhs";
}

/* ğŸ”§ TOOLBAR */
#toolbar {
  grid-area: toolbar;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  padding: 8px 10px;
  border-bottom: 1px solid #e5e7eb;
  background: #fff;
  position: relative;
  z-index: 1000;
}

/* ğŸ›ï¸ FORM CONTROLS - ì¼ê´€ëœ ìŠ¤íƒ€ì¼ë§ */
.form-control,
select,
input[type="text"],
input[type="file"],
input[type="number"],
input[type="url"],
input[type="search"] {
  padding: 7px 10px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  background: #fff;
  font-weight: 300;
  transition: all var(--transition-fast);
  font-family: inherit;
}

.form-control:focus,
select:focus,
input:focus {
  outline: none;
  border-color: var(--c-sky);
  box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.1);
}

.form-control:invalid {
  border-color: var(--c-danger);
}

/* ğŸ·ï¸ BADGES & STATUS */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid #e5e7eb;
  background: #fff;
  font-weight: 700;
  font-size: 12px;
  transition: all var(--transition-fast);
}

.badge.ok {
  border-color: #cfe9d5;
  color: var(--c-success);
  background: #f0fdf4;
}

.badge.warn {
  border-color: #fed7aa;
  color: var(--c-warning);
  background: #fffbeb;
}

.badge.bad {
  border-color: #fecaca;
  color: var(--c-danger);
  background: #fef2f2;
}

/* ğŸ”˜ BUTTONS - í–¥ìƒëœ ë²„íŠ¼ ì‹œìŠ¤í…œ */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  border: 1px solid transparent;
  font-weight: 600;
  font-size: 14px;
  text-decoration: none;
  transition: all var(--transition-fast);
  user-select: none;
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.btn:hover::before {
  left: 100%;
}

.btn-primary {
  background: var(--c-primary);
  border-color: var(--c-primary);
  color: #fff;
}

.btn-sky {
  background: var(--c-sky);
  border-color: var(--c-sky);
  color: #fff;
}

.btn-accent {
  background: var(--c-accent);
  border-color: var(--c-accent);
  color: #fff;
}

.btn-util {
  background: var(--c-util);
  border-color: var(--c-util);
  color: #fff;
}

.btn-outline {
  background: transparent;
  border-color: currentColor;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}

.btn:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn:active:not(:disabled) {
  transform: translateY(0);
}

/* ğŸ“± LEFT RAIL */
#rail {
  grid-area: rail;
  border-right: 1px solid #e5e7eb;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 8px 6px;
  gap: 8px;
  position: relative;
  z-index: 1001;
}

.logo-box {
  width: 56px;
  height: 56px;
  padding: 4px;
  border-radius: 14px;
  border: 1px solid #e5e7eb;
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

.logo-box svg {
  width: 48px;
  height: 48px;
  display: block;
}

.icbtn {
  width: 56px;
  border: 1px solid #e5e7eb;
  border-radius: 14px;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 8px 4px;
  cursor: pointer;
  transition: all var(--transition-fast);
  position: relative;
}

.icbtn svg {
  width: 22px;
  height: 22px;
  stroke: #111;
  fill: none;
  stroke-width: 2;
  transition: all var(--transition-fast);
}

.icbtn span {
  font-size: 11px;
  font-weight: 700;
  color: #111;
  transition: all var(--transition-fast);
}

.icbtn.active {
  background: var(--c-sky);
  border-color: var(--c-sky);
  box-shadow: var(--shadow-md);
}

.icbtn.active svg,
.icbtn.active span {
  stroke: #fff;
  color: #fff;
}

.icbtn:hover:not(.active) {
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

/* ğŸ“‹ LEFT SIDEBAR */
#lhs {
  grid-area: lhs;
  border-right: 1px solid #e5e7eb;
  background: #fff;
  overflow: auto;
  font-size: var(--flt-font);
}

/* ğŸ” DETAILS & ACCORDION */
details {
  border-bottom: 1px solid #f1f5f9;
}

details:last-child {
  border-bottom: none;
}

summary {
  list-style: none;
  cursor: pointer;
  padding: 14px 12px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: all var(--transition-fast);
  user-select: none;
}

summary::-webkit-details-marker {
  display: none;
}

summary::after {
  content: '+';
  font-size: 18px;
  font-weight: 300;
  transition: transform var(--transition-fast);
}

details[open] summary::after {
  transform: rotate(45deg);
}

summary:hover {
  background: #f8fafc;
}

details[open] summary {
  border-bottom: 1px solid #e2e8f0;
  background: #f8fafc;
}

.card {
  padding: 12px;
}

/* ğŸ¯ LOADING & PROGRESS INDICATORS - ì‚¬ìš©ì ê²½í—˜ ê°œì„  */
.loading {
  position: relative;
  pointer-events: none;
  opacity: 0.7;
}

.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid #e5e7eb;
  border-top-color: var(--c-sky);
  border-radius: 50%;
  animation: spin 1s infinite linear;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.progress-bar {
  width: 100%;
  height: 4px;
  background: #f1f5f9;
  border-radius: 2px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: var(--c-sky);
  transition: width 0.3s ease;
  border-radius: 2px;
}

/* ğŸ”” NOTIFICATIONS & ALERTS */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 16px;
  border-radius: 8px;
  box-shadow: var(--shadow-lg);
  z-index: 10000;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
  transform: translateX(400px);
  transition: transform var(--transition-normal);
}

.notification.show {
  transform: translateX(0);
}

.notification.success {
  background: #f0fdf4;
  border: 1px solid #bbf7d0;
  color: #166534;
}

.notification.warning {
  background: #fffbeb;
  border: 1px solid #fed7aa;
  color: #92400e;
}

.notification.error {
  background: #fef2f2;
  border: 1px solid #fecaca;
  color: #991b1b;
}

/* ğŸ’¾ PERFORMANCE OPTIMIZATIONS - ë Œë”ë§ ìµœì í™” */
.virtualized-list {
  height: 400px;
  overflow-y: auto;
}

.list-item {
  height: 40px;
  display: flex;
  align-items: center;
  padding: 0 12px;
  border-bottom: 1px solid #f1f5f9;
  will-change: transform;
}

/* ğŸ”§ UTILITY CLASSES */
.small { font-size: 12px; color: #6b7280; font-weight: 400; }
.text-center { text-align: center; }
.text-right { text-align: right; }
.hidden { display: none !important; }
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

/* ğŸ¨ FORM LAYOUTS */
.row {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

.row > * {
  flex: 1 1 auto;
}

.chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 6px;
}

.chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #f3f4f6;
  border: 1px solid #e5e7eb;
  border-radius: 999px;
  padding: 4px 8px;
  color: #111;
  font-size: 12px;
  transition: all var(--transition-fast);
  cursor: pointer;
  user-select: none;
}

.chip:hover {
  background: #e5e7eb;
  transform: translateY(-1px);
}

.chip input[type="checkbox"] {
  margin: 0;
}

/* ğŸ›ï¸ SWITCHES */
.switch {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 26px;
}

.switch input {
  display: none;
}

.slider {
  position: absolute;
  inset: 0;
  background: #e5e7eb;
  border: 1px solid #d1d5db;
  border-radius: 999px;
  transition: all var(--transition-normal);
  cursor: pointer;
}

.slider:before {
  content: "";
  position: absolute;
  width: 22px;
  height: 22px;
  left: 2px;
  top: 1px;
  background: #fff;
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: all var(--transition-normal);
}

.switch input:checked + .slider {
  background: var(--c-sky);
  border-color: var(--c-sky);
}

.switch input:checked + .slider:before {
  transform: translateX(22px);
}

/* ğŸ“ RESIZER */
#gut {
  grid-area: gut;
  background: #f3f4f6;
  cursor: col-resize;
  transition: background var(--transition-fast);
}

#gut:hover {
  background: #e5e7eb;
}

/* ğŸ—ºï¸ MAP CONTAINER */
#rhs {
  grid-area: rhs;
  position: relative;
  background: #fafafa;
}

#map {
  position: absolute;
  inset: 0;
}

/* ğŸ”˜ MAP CONTROLS */
.map-bottom {
  position: absolute;
  right: 16px;
  bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  z-index: 6500;
}

.toolbar-map {
  position: static;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  z-index: 6500;
}

/* ğŸ·ï¸ WATERMARK */
.wm {
  pointer-events: none;
  user-select: none;
  font: 700 14px/1 "Roboto", sans-serif;
  color: #fff;
  -webkit-text-stroke: 0.8px #000;
  text-shadow: 0 0 1px rgba(0,0,0,0.6);
}

#wm {
  position: fixed;
  bottom: 8px;
  right: 8px;
  z-index: 9999;
  background: rgba(255,255,255,0.8);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  color: #666;
  backdrop-filter: blur(4px);
}

/* ğŸ“‹ PANELS */
.panel {
  position: absolute;
  right: 16px;
  bottom: 90px;
  width: min(640px, 60vw);
  max-height: 60vh;
  overflow: hidden;
  background: #fff;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  box-shadow: var(--shadow-lg);
  z-index: 6000;
  display: none;
  min-width: 360px;
  min-height: 220px;
  backdrop-filter: blur(10px);
}

.panel .head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid #e2e8f0;
  background: #f8fafc;
  cursor: move;
  user-select: none;
}

.panel .head h4 {
  margin: 0;
  font-size: 14px;
  font-weight: 700;
}

.panel .body {
  overflow: auto;
  max-height: calc(60vh - 60px);
}

/* ğŸ“Š TABLES */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: var(--tbl-font);
  border: 1px solid #e2e8f0;
}

thead th {
  position: sticky;
  top: 0;
  background: #f8fafc;
  border-bottom: 1px solid #e2e8f0;
  padding: 10px 8px;
  font-weight: 700;
  border-right: 1px solid #f1f5f9;
  text-align: left;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

tbody td {
  border-bottom: 1px solid #f1f5f9;
  border-right: 1px solid #f1f5f9;
  padding: 8px;
  font-weight: 400;
  background: #fff;
}

tbody tr:hover {
  background: #f8fafc;
}

tbody tr.selected {
  background: #eff6ff;
  border-color: var(--c-sky);
}

/* ğŸ¯ MARKERS */
.mk {
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  line-height: 1;
  transform-origin: center;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.mk-circle {
  width: var(--mk);
  height: var(--mk);
  border-radius: 50%;
  border: 2px solid #000;
  background: #fff;
  color: #000;
  box-shadow: var(--shadow-md);
  font-size: 12px;
}

.mk-tag {
  padding: 4px 8px;
  border-radius: 6px;
  background: #000;
  color: #fff;
  border: 2px solid #000;
  box-shadow: var(--shadow-md);
  font-size: 12px;
}

.mk-bubble {
  position: relative;
  padding: 4px 8px 6px 8px;
  border-radius: 6px;
  background: #fff;
  color: #000;
  border: 2px solid #000;
  box-shadow: var(--shadow-md);
  font-size: 12px;
}

.mk-bubble i {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: -7px;
  width: 0;
  height: 0;
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 8px solid #000;
}

.mk-bubble.sel {
  background: var(--c-danger);
  color: #fff;
  border-color: var(--c-danger);
}

.mk-bubble.sel i {
  border-top-color: var(--c-danger);
}

.mk.hover {
  transform: scale(1.15);
  z-index: 1000;
}

/* ğŸŒ™ DARK MODE SUPPORT */
@media (prefers-color-scheme: dark) {
  :root {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --border-color: #334155;
  }
  
  body.auto-dark {
    background: var(--bg-primary);
    color: var(--text-primary);
  }
  
  .auto-dark #toolbar,
  .auto-dark #lhs,
  .auto-dark #rail,
  .auto-dark .panel {
    background: var(--bg-primary);
    border-color: var(--border-color);
    color: var(--text-primary);
  }
}

/* ğŸ® ACCESSIBILITY IMPROVEMENTS */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

.focus-visible {
  outline: 2px solid var(--c-sky);
  outline-offset: 2px;
}

/* ğŸ”§ ERROR HANDLING UI */
.error-boundary {
  padding: 20px;
  text-align: center;
  background: #fef2f2;
  border: 1px solid #fecaca;
  border-radius: 8px;
  margin: 20px;
}

.error-boundary h3 {
  color: var(--c-danger);
  margin-bottom: 10px;
}

/* ğŸ¯ PERFORMANCE MONITORING */
.perf-monitor {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  font-family: monospace;
  z-index: 10001;
  display: none;
}

.perf-monitor.show {
  display: block;
}

/* Print styles */
@media print {
  #rail, #lhs, .panel, .map-bottom { display: none !important; }
  #rhs { grid-column: 1 / -1; }
  body { background: white !important; }
}

<!-- Styles from NEW_WORLD_MAP_with_navigation.html -->

  :root{
    /* Adjusted theme variables for better contrast and readability */
    --c-primary:#1F3A8A; --c-sky:#0EA5E9; --c-accent:#EA580C; --c-util:#334155;
    --rail-w:64px; --side-w:380px; --gut-w:6px;
    /* increase default font sizes for filter and table for improved readability */
    --flt-font:14px; --tbl-font:14px;
    /* slightly larger marker size */
    --mk:30px;
  }

  /* Mobile-First Responsive Design */
  /* Mobile viewport meta and touch optimization */
  
  /* Base mobile styles for selection panel */
  #selPanel {
    overflow:auto !important; 
    height:auto !important; 
    max-height:none !important;
    /* Enhanced mobile touch interaction */
    touch-action: none;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
  }
  
  /* Mobile-optimized watermark positioning */
  #wm{position:fixed; bottom:8px; right:8px; z-index:9999; background:rgba(255,255,255,0.7); padding:2px 6px; border-radius:4px; font-size:10px; pointer-events:none;}
  
  /* Enhanced mobile/tablet responsive design */
  @media screen and (max-width: 1024px) {
    /* Tablet optimizations */
    #mapControlsTop .btn {
      padding: 10px 14px !important;
      font-size: 15px !important;
      min-height: 42px !important;
    }
    
    #selPanel {
      min-width: 320px !important;
      max-width: calc(100vw - 24px) !important;
      /* Enhanced touch targets for tablet */
      -webkit-tap-highlight-color: transparent;
    }
    
    #selPanel .e-left, #selPanel .e-right { width: 28px !important; }
    #selPanel .e-top, #selPanel .e-bottom { height: 28px !important; }
    #selPanel .e-left { left: -18px !important; }
    #selPanel .e-right { right: -18px !important; }
    #selPanel .e-top { top: -23px !important; }
    #selPanel .e-bottom { bottom: -18px !important; }
  }
  
  @media screen and (max-width: 768px) {
    /* Keep buttons horizontal on mobile for better UX */
    #mapControlsTop {
      flex-direction: row !important;
      flex-wrap: wrap !important;
      gap: 6px !important;
      align-items: center !important;
      padding: 8px !important;
    }
    
    #mapControlsTop .btn {
      flex: 1 1 auto !important;
      min-width: 80px !important;
      padding: 10px 12px !important;
      font-size: 14px !important;
      min-height: 40px !important; /* Enhanced touch target */
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      white-space: nowrap !important;
      border-radius: 8px !important;
      font-weight: 500 !important;
    }
    
    /* Enhanced mobile panel positioning */
    #selPanel {
      right: 12px !important;
      bottom: 70px !important;
      min-width: 280px !important;
      max-width: calc(100vw - 24px) !important;
      min-height: 180px !important;
      max-height: calc(100vh - 140px) !important;
      border-radius: 16px !important;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12) !important;
    }
    
    /* Extra large touch targets for mobile */
    #selPanel .e-left, #selPanel .e-right { width: 35px !important; }
    #selPanel .e-top, #selPanel .e-bottom { height: 35px !important; }
    #selPanel .e-left { left: -22px !important; }
    #selPanel .e-right { right: -22px !important; }
    #selPanel .e-top { top: -27px !important; }
    #selPanel .e-bottom { bottom: -22px !important; }
    
    /* Mobile-optimized panel header */
    #selPanel .head {
      padding: 16px 20px !important;
      min-height: 56px !important;
      border-radius: 16px 16px 0 0 !important;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
    }
    
    #selPanel .head h4 {
      font-size: 17px !important;
      line-height: 1.3 !important;
      font-weight: 600 !important;
    }
    
    /* Enhanced mobile buttons */
    #selPanel .btn {
      padding: 10px 16px !important;
      font-size: 15px !important;
      min-height: 44px !important;
      border-radius: 10px !important;
      font-weight: 500 !important;
      transition: all 0.2s ease !important;
    }
    
    #selPanel .btn:active {
      transform: scale(0.98) !important;
      opacity: 0.8 !important;
    }
    
    /* Enhanced table scrolling for mobile */
    #selPanel table {
      font-size: 14px !important;
    }
    
    #selPanel th, #selPanel td {
      padding: 12px 8px !important;
      min-height: 44px !important;
    }
  }
  
  /* Ultra-mobile (small phones) */
  @media screen and (max-width: 480px) {
    #selPanel {
      right: 8px !important;
      bottom: 60px !important;
      min-width: 260px !important;
      max-width: calc(100vw - 16px) !important;
    }
    
    #selPanel .head {
      padding: 14px 16px !important;
      min-height: 52px !important;
    }
    
    #selPanel .head h4 {
      font-size: 16px !important;
    }
    
    #selPanel table {
      font-size: 13px !important;
    }
  }
  
  /* Tablet optimizations */
  @media screen and (min-width: 769px) and (max-width: 1024px) {
    #mapControlsTop .btn {
      padding: 10px 14px !important;
      font-size: 15px !important;
      min-height: 42px !important;
    }
    
    #selPanel {
      min-width: 400px !important;
      max-width: calc(100vw - 32px) !important;
    }
  }
  
  /* Touch device optimizations */
  @media (pointer: coarse) {
    /* Increase touch targets for all interactive elements */
    .btn, button, input, select {
      min-height: 44px !important;
      padding: 12px 16px !important;
    }
    
    /* Enhanced resize handle visibility on touch devices */
    #selPanel .e-left::before,
    #selPanel .e-right::before,
    #selPanel .e-top::before,
    #selPanel .e-bottom::before {
      content: '';
      position: absolute;
      background: rgba(59, 130, 246, 0.1);
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 4px;
    }
    
    #selPanel .e-left::before,
    #selPanel .e-right::before {
      top: 50%;
      transform: translateY(-50%);
      width: 6px;
      height: 40px;
      left: 50%;
      margin-left: -3px;
    }
    
    #selPanel .e-top::before,
    #selPanel .e-bottom::before {
      left: 50%;
      transform: translateX(-50%);
      height: 6px;
      width: 40px;
      top: 50%;
      margin-top: -3px;
    }
  }
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.45 300 "Roboto","Apple SD Gothic Neo","Malgun Gothic",system-ui,sans-serif;color:#111;background:#fff}
  #app{display:grid; min-height:100vh;
    grid-template-columns:var(--rail-w) var(--side-w) var(--gut-w) 1fr;
    grid-template-rows:auto 1fr;
    grid-template-areas:"rail toolbar toolbar toolbar" "rail lhs gut rhs";}

  /* toolbar */
  #toolbar{grid-area:toolbar;display:flex;align-items:center;gap:8px;flex-wrap:wrap;padding:8px 10px;border-bottom:1px solid #e5e7eb;background:#fff}
  .small{font-size:12px;color:#6b7280;font-weight:400}
  select,input[type="text"],input[type="file"],input[type="number"],input[type="url"]{padding:7px 10px;border:1px solid #d1d5db;border-radius:10px;background:#fff;font-weight:300}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:700}
  .badge.ok{border-color:#cfe9d5;color:#137333;background:#f3fbf5}
  .badge.warn{border-color:#f6e4b3;color:#b08900;background:#fff9e6}
  .badge.bad{border-color:#f3c5c5;color:#c92a2a;background:#fff2f2}
  .btn{padding:7px 12px;border-radius:10px;cursor:pointer;border:1px solid transparent;font-weight:700;color:#fff}
  .btn-primary{background:var(--c-primary);border-color:var(--c-primary)}
  .btn-sky{background:var(--c-sky);border-color:var(--c-sky)}
  .btn-accent{background:var(--c-accent);border-color:var(--c-accent)}
  .btn-util{background:var(--c-util);border-color:var(--c-util)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn:hover{filter:brightness(.98)}

  /* left rail */
  #rail{grid-area:rail;border-right:1px solid #e5e7eb;background:#fff;display:flex;flex-direction:column;align-items:center;padding:8px 6px;gap:8px}
  .logo-box{width:56px;height:56px;padding:4px;border-radius:14px;border:1px solid #e5e7eb;background:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .logo-box svg{width:48px;height:48px;display:block}
  .icbtn{width:56px;border:1px solid #e5e7eb;border-radius:14px;background:#fff;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 4px;cursor:pointer;transition:.15s}
  .icbtn svg{width:22px;height:22px;stroke:#111;fill:none;stroke-width:2}
  .icbtn span{font-size:11px;font-weight:700;color:#111}
  .icbtn.active{background:var(--c-sky);border-color:var(--c-sky)}
  .icbtn.active svg,.icbtn.active span{stroke:#fff;color:#fff}
  .icbtn:hover{box-shadow:0 2px 10px rgba(0,0,0,.06)}

  /* lhs */
  #lhs{grid-area:lhs;border-right:1px solid #e5e7eb;background:#fff;overflow:auto;font-size:var(--flt-font)}
  details{border-bottom:1px dashed #e5e7eb}
  summary{list-style:none;cursor:pointer;padding:14px 12px;font-weight:700;display:flex;align-items:center;justify-content:space-between}
  details[open] summary{border-bottom:1px dashed #eef2f7}
  .card{padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .row>*{flex:1 1 auto}
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px;color:#111}

  /* switches */
  .switch{position:relative;display:inline-block;width:48px;height:26px}
  .switch input{display:none}
  .slider{position:absolute;inset:0;background:#e5e7eb;border:1px solid #d1d5db;border-radius:999px;transition:.2s}
  .slider:before{content:"";position:absolute;width:22px;height:22px;left:2px;top:1px;background:#fff;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.2);transition:.2s}
  .switch input:checked + .slider{background:var(--c-sky);border-color:var(--c-sky)}
  .switch input:checked + .slider:before{transform:translateX(22px)}

  /* gut */
  #gut{grid-area:gut;background:#f3f4f6;cursor:col-resize}

  /* map */
  #rhs{grid-area:rhs;position:relative;background:#fafafa}
  #map{position:absolute;inset:0}

  /* map bottom toolbar */
  .map-bottom{position:absolute;right:16px;bottom:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;z-index:6500}
  .toolbar-map{position:static;display:flex;gap:8px;flex-wrap:wrap;z-index:6500}
  .wm{pointer-events:none;user-select:none;font:700 14px/1 "Roboto",sans-serif;color:#fff;-webkit-text-stroke:0.8px #000;text-shadow:0 0 1px rgba(0,0,0,.6)}

  /* panel */
  .panel{position:absolute;right:16px;bottom:90px;width:min(640px,60vw);max-width:80vw;max-height:56vh;overflow:auto;background:#fff;border:1px solid #cbd5e1;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.08);z-index:6000;display:none;min-width:360px;min-height:220px}
  .panel .head{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:2px solid #cbd5e1;background:#f8fafc;cursor:move;user-select:none}
  .panel .head h4{margin:0;font-size:13px;font-weight:700}
  .panel .edge{position:absolute;background:transparent}
  .panel .e-left{left:-16px;top:0;width:22px;height:100%;cursor:ew-resize}
  .panel .e-right{right:-16px;top:0;width:22px;height:100%;cursor:ew-resize}
  .panel .e-top{top:-20px;left:0;width:100%;height:24px;cursor:ns-resize}
  .panel .e-bottom{bottom:-16px;left:0;width:100%;height:22px;cursor:ns-resize}
  .panel.dragging .edge{pointer-events:none;opacity:0}
  .panel.resizing .head{pointer-events:none;cursor:default}

  table{width:100%;border-collapse:collapse;font-size:var(--tbl-font);border:1px solid #cbd5e1}
  thead th{position:sticky;top:0;background:#f1f5f9;border-bottom:2px solid #cbd5e1;padding:7px 8px;font-weight:700;border-right:1px solid #e2e8f0}
  tbody td{border-bottom:1px solid #e2e8f0;border-right:1px solid #e2e8f0;padding:6px 8px;font-weight:400;background:#fff}
  tbody tr:hover{background:#f8fafc}
  .row-actions{text-align:center;width:42px}
  .btn-del{cursor:pointer}
  th.has-resizer{position:relative}
  .th-resizer{position:absolute;top:0;right:-3px;width:6px;height:100%;cursor:col-resize}

  /* markers */
  .mk{display:flex;align-items:center;justify-content:center;font-weight:800;line-height:1;transform-origin:center}
  .mk-circle{width:var(--mk);height:var(--mk);border-radius:50%;border:2px solid #000;background:#fff;color:#000;box-shadow:0 1px 0 rgba(0,0,0,.35);font-size:12px}
  .mk-tag{padding:4px 8px;border-radius:6px;background:#000;color:#fff;border:2px solid #000;box-shadow:0 1px 0 rgba(0,0,0,.35);font-size:12px}
  .mk-bubble{position:relative;padding:4px 8px 6px 8px;border-radius:6px;background:#fff;color:#000;border:2px solid #000;box-shadow:0 1px 0 rgba(0,0,0,.35);font-size:12px}
  .mk-bubble i{position:absolute;left:50%;transform:translateX(-50%);bottom:-7px;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid #000}
  .mk-bubble.sel{background:#DC2626;color:#fff;border-color:#DC2626}
  .mk-bubble.sel i{border-top-color:#DC2626}
  .mk.hover{transform:scale(1.12)}

  .mbar{position:absolute;left:72px;top:12px;z-index:6500;display:flex;gap:6px;pointer-events:auto}

  .bw #map{filter:grayscale(100%) contrast(105%)}
  body.dark{background:#0b1220;color:#e5e7eb}
  body.dark #toolbar, body.dark #lhs, body.dark .panel{background:#0f172a;color:#e5e7eb}
  body.dark #lhs, body.dark .panel{border-color:#1f2937}
  body.dark details{border-color:#1f2937}
  body.dark summary{color:#e5e7eb}
  body.dark .card{background:#0f172a}
  body.dark select, body.dark input[type="text"], body.dark input[type="file"], body.dark input[type="number"]{background:#0b1220;color:#e5e7eb;border-color:#334155}
  body.dark .chip{background:#0b1322;border-color:#243041;color:#e5e7eb}
  body.dark .panel .head{background:#0b1322;border-bottom-color:#243041}
  body.dark table{background:#0f172a;border-color:#243041}
  body.dark thead th{background:#0b1322;border-bottom-color:#243041;border-right-color:#243041}
  body.dark tbody td{background:#0f172a;border-right-color:#243041;border-bottom-color:#243041}
  body.dark #rail{background:#0f172a;border-color:#1f2937}
  body.dark .icbtn{background:#0f172a;border-color:#243041}
  body.dark .icbtn svg{stroke:#e5e7eb}
  body.dark .icbtn span{color:#e5e7eb}
  body.dark .badge{background:#111827;border-color:#374151;color:#E5E7EB}
  body.dark .badge.ok{background:#0f1a14;border-color:#1a3c2a;color:#8bf0b2}
  body.dark .badge.warn{background:#2a2310;border-color:#4b3a0e;color:#ffd36a}
  body.dark .badge.bad{background:#2a1212;border-color:#4b1e1e;color:#ff9e9e}

<!-- Styles from NEW_WORLD_MAP_with_navigation.html -->

  /* ì„ íƒëª©ë¡ íŒ¨ë„: 4ë³€ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤(íŒ¨ë„ ë°– 14~20px ë ) */
  #selPanel{position:absolute; right:16px; bottom:90px; min-width:360px; min-height:220px;}
  #selPanel .edge{position:absolute;background:transparent}
  #selPanel .e-left{left:-16px; top:0; width:22px; height:100%; cursor:ew-resize}
  #selPanel .e-right{right:-16px; top:0; width:22px; height:100%; cursor:ew-resize}
  #selPanel .e-top{top:-20px; left:0; width:100%; height:24px; cursor:ns-resize}
  #selPanel .e-bottom{bottom:-16px; left:0; width:100%; height:22px; cursor:ns-resize}
  #selPanel.dragging .edge{pointer-events:none}
  /* ì§€ë„ ìƒí˜¸ì‘ìš© ì°¨ë‹¨ìš© ì‹¤ë“œ */
  #mapShield{position:absolute; inset:0; background:transparent; z-index:5999; display:none}
  /* ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€ ì ìš© ì‹œ, ìˆ¨ê¹€ ì²˜ë¦¬ë¥¼ ìœ„í•œ í´ë˜ìŠ¤ */
  .clo-hidden{opacity:0 !important; pointer-events:none !important}

<!-- Styles from NEW_WORLD_MAP_with_navigation.html -->

  /* ì„ íƒëª©ë¡ íŒ¨ë„ - fixed ê³ ì • + 4ë³€ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ */
  #selPanel{
    position:fixed !important;
    right:16px; bottom:90px;
    min-width:360px; min-height:220px;
    will-change:left, top, width, height, transform;
    transform:translateZ(0);
    z-index:6000;
  }
  #selPanel .edge{position:absolute;background:transparent}
  #selPanel .e-left{left:-16px; top:0; width:22px; height:100%; cursor:ew-resize}
  #selPanel .e-right{right:-16px; top:0; width:22px; height:100%; cursor:ew-resize}
  #selPanel .e-top{top:-20px; left:0; width:100%; height:24px; cursor:ns-resize}
  #selPanel .e-bottom{bottom:-16px; left:0; width:100%; height:22px; cursor:ns-resize}
  #selPanel.dragging .edge{pointer-events:none}

  /* ì§€ë„ ì°¨ë‹¨ ì‹¤ë“œ(íŒ¨ë„ hover/drag/resize ë™ì•ˆ) */
  #mapShield{position:fixed; inset:0; display:none; background:transparent; z-index:5999}

  /* ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€ ë•Œ ì‚¬ìš© */
  .clo-hidden{opacity:0 !important; pointer-events:none !important}

<!-- Styles from NEW_WORLD_MAP_with_navigation.html -->

  /* ë“œë˜ê·¸ ì¤‘ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
  .clo-noselect { user-select: none !important; }

<!-- Styles from NEW_WORLD_MAP_with_navigation.html -->

  /* ë“œë˜ê·¸ ì¤‘ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
  .clo-noselect { user-select: none !important; }
  /* ì„ íƒëª©ë¡ íŒ¨ë„ ê¸°ë³¸ ê³ ì •ê°’(ìˆì–´ë„ ë¬´ë°©) */
  #selPanel{
    position:fixed !important;
    min-width:360px; min-height:220px;
    z-index:6000; transform:translateZ(0);
  }
  /* 4ë³€ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ â€“ í‘œ ë°”ê¹¥ ë  */
  #selPanel .edge{position:absolute;background:transparent}
  #selPanel .e-left{left:-16px; top:0; width:22px; height:100%; cursor:ew-resize}
  #selPanel .e-right{right:-16px; top:0; width:22px; height:100%; cursor:ew-resize}
  #selPanel .e-top{top:-20px; left:0; width:100%; height:24px; cursor:ns-resize}
  #selPanel .e-bottom{bottom:-16px; left:0; width:100%; height:22px; cursor:ns-resize}
  #selPanel.dragging .edge{pointer-events:none}

  /* ì§€ë„ ì°¨ë‹¨ìš© íˆ¬ëª… ì‹¤ë“œ(ì—†ìœ¼ë©´ ì£¼ì…ë¨) */
  #mapShield{position:fixed; inset:0; display:none; background:transparent; z-index:5999}

<!-- Styles from NEW_WORLD_MAP_with_navigation.html -->

  /* ë“œë˜ê·¸ ì¤‘ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
  .clo-noselect { user-select: none !important; }

  /* íŒ¨ë„ ê³ ì • ë° ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤(ë°”ê¹¥) */
  #selPanel{
    position:fixed !important;
    min-width:360px; min-height:220px;
    z-index:6000; transform:translateZ(0);
  }
  #selPanel .edge{position:absolute;background:transparent}
  #selPanel .e-left{left:-16px; top:0; width:22px; height:100%; cursor:ew-resize}
  #selPanel .e-right{right:-16px; top:0; width:22px; height:100%; cursor:ew-resize}
  #selPanel .e-top{top:-20px; left:0; width:100%; height:24px; cursor:ns-resize}
  #selPanel .e-bottom{bottom:-16px; left:0; width:100%; height:22px; cursor:ns-resize}
  #selPanel.dragging .edge{pointer-events:none}

  /* ì•ˆìª½ ì–‡ì€ ë¦¬ì‚¬ì´ì¦ˆ ê·¸ë¦½(í•¸ë“¤ ë§ì¶”ê¸° ì–´ë µë‹¤ëŠ” í”¼ë“œë°± ë°˜ì˜) */
  #selPanel .grip{position:absolute;background:transparent;pointer-events:auto}
  #selPanel .g-left{left:0; top:0; width:8px; height:100%; cursor:ew-resize}
  #selPanel .g-right{right:0; top:0; width:8px; height:100%; cursor:ew-resize}
  #selPanel .g-top{top:0; left:0; height:8px; width:100%; cursor:ns-resize}
  #selPanel .g-bottom{bottom:0; left:0; height:8px; width:100%; cursor:ns-resize}

  /* ì§€ë„ ì°¨ë‹¨ ì‹¤ë“œ */
  #mapShield{position:fixed; inset:0; display:none; background:transparent; z-index:5999}

<!-- Styles from NEW_WORLD_MAP_with_navigation.html -->

  /* ìƒ‰ ë³€ìˆ˜ (ë¼ì´íŠ¸/ë‹¤í¬ ê³µí†µ í† í°) */
  :root{
    --ui-bg: #ffffff; --ui-fg:#111827; --ui-muted:#6b7280; --ui-border:#e5e7eb;
    --ui-bg-soft:#f8fafc;
    --brand:#2563eb; --brand-2:#1d4ed8;
    --okay:#16a34a; --warn:#d97706; --danger:#dc2626;
    --ring: 0 0 0 3px rgba(37,99,235,.25);
  }
  body.dark{
    --ui-bg:#0f172a; --ui-fg:#e5e7eb; --ui-muted:#9ca3af; --ui-border:#243041;
    --ui-bg-soft:#111827;
    --brand:#60a5fa; --brand-2:#3b82f6;
    --okay:#34d399; --warn:#f59e0b; --danger:#f87171;
    --ring: 0 0 0 3px rgba(96,165,250,.25);
  }

  /* íŒ¨ë„: ë“œë˜ê·¸ ì•¤ ë“œë¡­ì„ ê³ ì • ì‚¬ì´ì¦ˆë¡œ ì œí•œ */
  #selPanel{
    position:fixed !important; right:16px; bottom:90px;
    width:640px !important; height:480px !important;
    max-width:80vw !important; max-height:70vh !important;
    z-index:6000; background:var(--ui-bg); color:var(--ui-fg);
    border:1px solid var(--ui-border);
    box-shadow:0 8px 24px rgba(0,0,0,.10);
    border-radius:12px; overflow:visible !important;
  }
  /* ì—£ì§€ í•¸ë“¤ ì˜ì—­(í‘œ ì¡°ì‘ê³¼ ì¶©ëŒ ì•ˆë‚˜ê²Œ ë°”ê¹¥ìª½ì— ë°°ì¹˜) */
  #selPanel .edge{position:absolute;background:transparent}
  #selPanel .e-left{left:-16px; top:0; width:22px; height:100%; cursor:ew-resize}
  #selPanel .e-right{right:-16px; top:0; width:22px; height:100%; cursor:ew-resize}
  #selPanel .e-top{top:-20px; left:0; width:100%; height:24px; cursor:ns-resize}
  #selPanel .e-bottom{bottom:-16px; left:0; width:100%; height:22px; cursor:ns-resize}
  #selPanel .head{
    background:var(--ui-bg-soft); border-bottom:2px solid var(--ui-border);
    border-top-left-radius:12px; border-top-right-radius:12px;
  }

  /* ë²„íŠ¼ ë¦¬ë‰´ì–¼(ë¼ì´íŠ¸/ë‹¤í¬ ëŒ€ì‘) */
  #selPanel .btn,
  #selPanel button{
    appearance:none; border:1px solid transparent;
    background:var(--ui-bg); color:var(--ui-fg);
    padding:8px 12px; border-radius:10px; font-weight:700;
    line-height:1; cursor:pointer; transition:.15s;
    box-shadow:0 1px 0 rgba(0,0,0,.06);
  }
  /* ê°ê°ì˜ ì„±ê²© */
  #btnClearSel{ /* í‘œ ë¹„ìš°ê¸° = ê²½ê³ ì„± */
    background:linear-gradient(0deg, rgba(249,115,22,.08), rgba(249,115,22,.08));
    border-color:rgba(249,115,22,.25); color:var(--warn);
  }
  #btnCopyTSV{   /* ë³´ì¡° = ì¤‘ë¦½ */
    background:linear-gradient(0deg, rgba(107,114,128,.08), rgba(107,114,128,.08));
    border-color:rgba(107,114,128,.25); color:var(--ui-fg);
  }
  #btnSaveXLSX{  /* ì£¼ìš” = ë¸Œëœë“œ */
    background:linear-gradient(180deg, var(--brand), var(--brand-2));
    color:#fff; border-color:transparent; box-shadow:0 2px 10px rgba(37,99,235,.25);
  }
  /* Hover/Active/Focus */
  #selPanel .btn:hover{ filter:brightness(1.03); transform:translateY(-1px) }
  #selPanel .btn:active{ transform:translateY(0) }
  #selPanel .btn:focus-visible{ outline:none; box-shadow:var(--ring) }

  /* ìš°ì¸¡ Del ì•„ì´ì½˜ ì¼ê´€í™” */
  #selPanel .row-actions .btn-del{
    display:inline-flex; align-items:center; justify-content:center;
    width:28px; height:28px; border-radius:8px;
    background:transparent; border:1px solid var(--ui-border);
    transition:.15s; cursor:pointer;
  }
  #selPanel .row-actions .btn-del:hover{
    background:rgba(220,38,38,.08); border-color:rgba(220,38,38,.35); color:var(--danger);
  }
  
  /* ê¸¸ì°¾ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  #selPanel .row-actions .btn-nav{
    display:inline-flex; align-items:center; justify-content:center;
    width:28px; height:28px; border-radius:8px; margin-left:4px;
    background:transparent; border:1px solid var(--ui-border);
    transition:.15s; cursor:pointer;
    font-size:14px;
  }
  #selPanel .row-actions .btn-nav:hover{
    background:rgba(59,130,246,.08); border-color:rgba(59,130,246,.35); color:var(--c-sky);
  }

  /* ê²½ë¡œ ìˆœë²ˆ ì¸í’‹ í†¤ ë§ì¶¤ */
  #selPanel input.routeOrder{
    height:28px; border:1px solid var(--ui-border); border-radius:8px;
    padding:0 8px; background:var(--ui-bg); color:var(--ui-fg);
  }
  #selPanel input.routeOrder:focus{ outline:none; box-shadow:var(--ring); border-color:var(--brand) }

  /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ìƒí•œ í•´ì œ */
  #selPanel > div[style*="max-height"]{ max-height:none !important; height:auto !important }

  /* Allow unlimited resizing with constraints to keep panel header accessible */
  #selPanel{ 
    resize:both !important; 
    overflow:auto !important;
    /* Remove size limits for unlimited resizing */
    min-width: 200px !important;
    min-height: 100px !important;
    max-width: none !important;
    max-height: none !important;
  }
</style>
<!-- Leaflet CSS -->
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" id="leaflet-css" rel="stylesheet"/>
</head>
<body>
<!-- Performance Monitor -->
<div class="perf-monitor" id="perfMonitor">
  FPS: <span id="fps">0</span> | 
  Memory: <span id="memory">0MB</span>
</div>
<!-- Mobile Overlay -->
<div class="mobile-overlay" id="mobileOverlay"></div>
<div id="app">
<!-- ğŸ“± LEFT RAIL - ëª¨ë°”ì¼ ì¹œí™”ì  ë„¤ë¹„ê²Œì´ì…˜ -->
<aside id="rail">
<div aria-label="CLUSTRO ë¡œê³ " class="logo-box" title="CLUSTRO v12.2 - Final Secured Edition">
<svg aria-label="CLUSTRO logo" viewbox="0 0 64 64">
<defs>
<lineargradient id="g" x1="0" x2="1" y1="0" y2="1">
<stop offset="0" stop-color="#0EA5E9"></stop>
<stop offset="1" stop-color="#1F3A8A"></stop>
</lineargradient>
</defs>
<circle cx="32" cy="32" fill="url(#g)" r="28" stroke="#0b2540" stroke-width="2"></circle>
<circle cx="22" cy="22" fill="#fff" r="4"></circle>
<circle cx="42" cy="22" fill="#fff" r="4"></circle>
<circle cx="22" cy="42" fill="#fff" r="4"></circle>
<circle cx="42" cy="42" fill="#fff" r="4"></circle>
<path d="M22 22 L42 42 M42 22 L22 42" stroke="#fff" stroke-width="2"></path>
</svg>
</div>
<button aria-label="ë°ì´í„° ê´€ë¦¬" class="icbtn" data-target="#secData" role="tab" title="ë°ì´í„° ê´€ë¦¬">
<svg aria-hidden="true" viewbox="0 0 24 24">
<path d="M3 7h18M3 12h18M3 17h18"></path>
<circle cx="7" cy="7" r="1"></circle>
<circle cx="11" cy="12" r="1"></circle>
<circle cx="15" cy="17" r="1"></circle>
</svg>
<span>ë°ì´í„°</span>
</button>
<button aria-label="í•„í„° ì„¤ì •" class="icbtn" data-target="#secFilter" role="tab" title="í•„í„° ì„¤ì •">
<svg aria-hidden="true" viewbox="0 0 24 24">
<path d="M3 5h18l-7 8v5l-4 2v-7z"></path>
</svg>
<span>í•„í„°</span>
</button>
<button aria-label="ì§€ë„ ì„¤ì •" class="icbtn" data-target="#secMap" role="tab" title="ì§€ë„ ì„¤ì •">
<svg aria-hidden="true" viewbox="0 0 24 24">
<path d="M3 6l7-3 7 3 4-2v16l-7 3-7-3-4 2V6zM10 3v16M17 6v15M3 6v14"></path>
</svg>
<span>ì§€ë„</span>
</button>
<button aria-label="ê²½ë¡œ ê³„íš" class="icbtn" data-target="#secRoute" role="tab" title="ê²½ë¡œ ê³„íš">
<svg aria-hidden="true" viewbox="0 0 24 24">
<path d="M4 6h6l2 4h8M4 18h10l2-4h4"></path>
</svg>
<span>ê²½ë¡œ</span>
</button>
<button aria-label="ì¶œë ¥ ì„¤ì •" class="icbtn" data-target="#secPrint" role="tab" title="ì¶œë ¥ ì„¤ì •">
<svg aria-hidden="true" viewbox="0 0 24 24">
<path d="M6 9V3h12v6M6 14h12v7H6z"></path>
<rect height="7" rx="2" width="18" x="3" y="9"></rect>
</svg>
<span>ì¶œë ¥</span>
</button>
<div style="margin-top:auto;font-size:11px;color:#9ca3af;text-align:center;">
<div>v12.2</div>
<div style="font-size:9px;">ğŸ”’ Secured</div>
</div>
</aside>
<!-- ğŸ”§ TOOLBAR - ë°˜ì‘í˜• ë„êµ¬ëª¨ìŒ -->
<header id="toolbar" role="banner">
<button aria-label="ë©”ë‰´ ì—´ê¸°" class="btn btn-sky mobile-menu-btn" id="mobileMenuBtn" style="display:none;">
<svg fill="none" height="18" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="18">
<line x1="3" x2="21" y1="6" y2="6"></line>
<line x1="3" x2="21" y1="12" y2="12"></line>
<line x1="3" x2="21" y1="18" y2="18"></line>
</svg>
      ë©”ë‰´
    </button>
<div class="badge ok">
<svg fill="none" height="14" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" width="14">
<path d="M9 12l2 2 4-4"></path>
<circle cx="12" cy="12" r="9"></circle>
</svg>
      ë³´ì•ˆ ê°•í™”ë¨
    </div>
<div class="badge" id="statusBadge">
<span id="statusText">ì¤€ë¹„ë¨</span>
</div>
<div class="row" style="margin-left: auto;">
<button class="btn btn-outline btn-util" id="perfToggle" title="ì„±ëŠ¥ ëª¨ë‹ˆí„° í† ê¸€">
        ğŸ“Š ì„±ëŠ¥
      </button>
<button class="btn btn-outline btn-util" id="themeToggle" title="ë‹¤í¬ ëª¨ë“œ í† ê¸€">
        ğŸŒ™ í…Œë§ˆ
      </button>
</div>
</header>
<!-- ğŸ“‹ LEFT SIDEBAR - í–¥ìƒëœ UI/UX -->
<nav aria-label="ë©”ì¸ ë„¤ë¹„ê²Œì´ì…˜" id="lhs" role="navigation">
<!-- ğŸ“Š DATA SECTION -->
<section class="sec active" id="secData">
<details open="">
<summary aria-expanded="true" role="button">
<span>ğŸ“Š ë°ì´í„° ë¡œë“œ</span>
</summary>
<div class="card">
<div class="row">
<label class="form-control" for="fileInput" style="cursor: pointer; text-align: center;">
<input accept=".xlsx,.csv,.json" aria-describedby="fileHelp" id="fileInput" style="display: none;" type="file"/>
              ğŸ“ íŒŒì¼ ì„ íƒ
            </label>
</div>
<div class="small" id="fileHelp" style="margin-top: 4px;">
            Excel(.xlsx), CSV, JSON íŒŒì¼ ì§€ì› (ìµœëŒ€ 10MB)
          </div>
<div class="progress-bar" id="loadProgress" style="margin-top: 8px; display: none;">
<div class="progress-fill" id="progressFill"></div>
</div>
</div>
</details>
<details id="adv" style="display:none">
<summary aria-expanded="false" role="button">
<span>âš™ï¸ ê³ ê¸‰ ì„¤ì •</span>
</summary>
<div class="card">
<div class="row">
<label for="sheet">ì‹œíŠ¸:</label>
<select aria-label="ì‹œíŠ¸ ì„ íƒ" class="form-control" id="sheet"></select>
</div>
<div class="row">
<label for="latCol">ìœ„ë„ ì—´:</label>
<input aria-label="ìœ„ë„ ì»¬ëŸ¼" class="form-control" id="latCol" type="text" value="R"/>
</div>
<div class="row">
<label for="lngCol">ê²½ë„ ì—´:</label>
<input aria-label="ê²½ë„ ì»¬ëŸ¼" class="form-control" id="lngCol" type="text" value="S"/>
</div>
<button class="btn btn-primary" onclick="safeOperation('toRowsManual')">ì ìš©</button>
</div>
</details>
<details>
<summary aria-expanded="false" role="button">
<span>ğŸ“ˆ ë°ì´í„° í˜„í™©</span>
</summary>
<div class="card">
<div class="row">
<span class="badge" id="totalBadge">ì „ì²´: 0</span>
<span class="badge ok" id="validBadge">ìœ íš¨: 0</span>
<span class="badge warn" id="errorBadge">ì˜¤ë¥˜: 0</span>
</div>
</div>
</details>
</section>
<!-- ğŸ” FILTER SECTION -->
<section class="sec" id="secFilter">
<details>
<summary aria-expanded="false" role="button">
<span>ğŸ” ê²€ìƒ‰ í•„í„°</span>
</summary>
<div class="card">
<div class="row">
<input aria-label="ê²€ìƒ‰ì–´ ì…ë ¥" autocomplete="off" class="form-control" id="scopeInput" placeholder="ìë©´ë™ ë˜ëŠ” êµ°ì§‘ë²ˆí˜¸ ê²€ìƒ‰..." type="search"/>
<button class="btn btn-sky" onclick="safeOperation('applyScope')">
              ê²€ìƒ‰
            </button>
</div>
</div>
</details>
<details>
<summary aria-expanded="false" role="button">
<span>ğŸ˜ï¸ ìë©´ë™ë³„</span>
</summary>
<div class="card">
<div aria-label="ìë©´ë™ í•„í„°" class="chips" id="emdBox" role="group"></div>
</div>
</details>
<details>
<summary aria-expanded="false" role="button">
<span>ğŸ‘¥ êµ°ì§‘ë³„</span>
</summary>
<div class="card">
<div aria-label="êµ°ì§‘ í•„í„°" class="chips" id="grpBox" role="group"></div>
</div>
</details>
</section>
<!-- ğŸ—ºï¸ MAP SECTION -->
<section class="sec" id="secMap">
<details>
<summary aria-expanded="false" role="button">
<span>ğŸ—ºï¸ ì§€ë„ ì„¤ì •</span>
</summary>
<div class="card">
<div class="row">
<label for="baseSelect">ë°°ê²½:</label>
<select aria-label="ë°°ê²½ì§€ë„ ì„ íƒ" class="form-control" id="baseSelect">
<option value="osm">OpenStreetMap</option>
<option selected="" value="vworld_base">VWorld ê¸°ë³¸</option>
<option value="vworld_satellite">VWorld ìœ„ì„±</option>
<option value="google_roadmap">Google ë„ë¡œ</option>
<option value="google_satellite">Google ìœ„ì„±</option>
</select>
</div>
<div class="row" style="margin-top: 12px;">
<label>
<input checked="" id="clusterToggle" type="checkbox"/> 
              ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ë§
            </label>
</div>
<div class="row">
<label>ë§ˆì»¤ ìŠ¤íƒ€ì¼:</label>
<select aria-label="ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì„ íƒ" class="form-control" id="markerStyle">
<option value="circle">ì›í˜•</option>
<option value="tag">íƒœê·¸</option>
<option selected="" value="bubble">ë§í’ì„ </option>
</select>
</div>
</div>
</details>
<details>
<summary aria-expanded="false" role="button">
<span>ğŸ¨ í‘œì‹œ ì˜µì…˜</span>
</summary>
<div class="card">
<div class="row">
<label>
<input id="bwToggle" type="checkbox"/> 
              í‘ë°± ëª¨ë“œ
            </label>
</div>
<div class="row">
<label for="fontSizeRange">í°íŠ¸ í¬ê¸°:</label>
<input aria-label="í°íŠ¸ í¬ê¸° ì¡°ì ˆ" class="form-control" id="fontSizeRange" max="18" min="10" type="range" value="14"/>
<span id="fontSizeValue">14px</span>
</div>
<div class="row">
<label for="markerSizeRange">ë§ˆì»¤ í¬ê¸°:</label>
<input aria-label="ë§ˆì»¤ í¬ê¸° ì¡°ì ˆ" class="form-control" id="markerSizeRange" max="50" min="20" type="range" value="30"/>
<span id="markerSizeValue">30px</span>
</div>
</div>
</details>
</section>
<!-- ğŸ›£ï¸ ROUTE SECTION -->
<section class="sec" id="secRoute">
<details>
<summary aria-expanded="false" role="button">
<span>ğŸ›£ï¸ ê²½ë¡œ ê³„íš</span>
</summary>
<div class="card">
<div class="row">
<label for="dailyMax">ì¼ì¼ ìµœëŒ€:</label>
<input aria-label="ì¼ì¼ ìµœëŒ€ ë°©ë¬¸ ìˆ˜" class="form-control" id="dailyMax" max="100" min="1" type="number" value="15"/>
</div>
<button class="btn btn-accent" onclick="safeOperation('optimizeRoute')">
            ğŸ¯ ê²½ë¡œ ìµœì í™”
          </button>
<div class="small" style="margin-top: 8px;">
            ì„ íƒëœ í•­ëª©ë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ ìµœì  ê²½ë¡œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
          </div>
</div>
</details>
<details>
<summary aria-expanded="false" role="button">
<span>ğŸ“‹ ì„ íƒ ê´€ë¦¬</span>
</summary>
<div class="card">
<button class="btn btn-sky" onclick="safeOperation('showSelectionPanel')">
            ğŸ“‹ ì„ íƒ ëª©ë¡ ë³´ê¸°
          </button>
<button class="btn btn-util" onclick="safeOperation('clearSelection')">
            ğŸ—‘ï¸ ì„ íƒ ì´ˆê¸°í™”
          </button>
<div class="small" id="selectionStats" style="margin-top: 8px;">
            ì„ íƒëœ í•­ëª©: <span id="selectedCount">0</span>ê°œ
          </div>
</div>
</details>
</section>
<!-- ğŸ–¨ï¸ PRINT SECTION -->
<section class="sec" id="secPrint">
<details>
<summary aria-expanded="false" role="button">
<span>ğŸ–¨ï¸ ì¶œë ¥ ì„¤ì •</span>
</summary>
<div class="card">
<div class="row">
<button class="btn btn-primary" onclick="safeOperation('exportExcel')">
              ğŸ“Š Excel ë‚´ë³´ë‚´ê¸°
            </button>
</div>
<div class="row">
<button class="btn btn-accent" onclick="safeOperation('exportPDF')">
              ğŸ“„ PDF ë‚´ë³´ë‚´ê¸°
            </button>
</div>
<div class="row">
<button class="btn btn-util" onclick="window.print()">
              ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°
            </button>
</div>
</div>
</details>
</section>
</nav>
<!-- ğŸ“ RESIZER -->
<div aria-label="íŒ¨ë„ í¬ê¸° ì¡°ì ˆ" id="gut" role="separator" tabindex="0" title="íŒ¨ë„ í¬ê¸° ì¡°ì ˆ"></div>
<!-- ğŸ—ºï¸ MAP CONTAINER -->
<main id="rhs" role="main">
<div aria-label="ì¸í„°ë™í‹°ë¸Œ ì§€ë„" id="map"></div>
<!-- MAP CONTROLS -->
<div class="map-bottom">
<div class="toolbar-map">
<button class="btn btn-sky" onclick="safeOperation('centerMap')" title="ì§€ë„ ì¤‘ì‹¬ ì´ë™">
          ğŸ¯ ì¤‘ì‹¬
        </button>
<button class="btn btn-primary" onclick="safeOperation('fitBounds')" title="ì „ì²´ ë³´ê¸°">
          ğŸ” ì „ì²´
        </button>
<button class="btn btn-accent" onclick="safeOperation('showStatistics')" title="í†µê³„ ë³´ê¸°">
          ğŸ“Š í†µê³„
        </button>
</div>
</div>
<!-- WATERMARK -->
<div class="wm" id="wm">CLUSTRO v12.2 Final Secured</div>
</main>
</div>
<!-- ğŸ“‹ SELECTION PANEL -->
<div aria-hidden="true" aria-labelledby="selPanelTitle" class="panel" id="selPanel" role="dialog">
<div class="head">
<h4 id="selPanelTitle">ğŸ“‹ ì„ íƒëœ í•­ëª©</h4>
<button aria-label="íŒ¨ë„ ë‹«ê¸°" class="btn btn-util" onclick="safeOperation('hideSelectionPanel')">
      âœ•
    </button>
</div>
<div class="body">
<div style="padding: 8px;">
<button class="btn btn-accent" onclick="safeOperation('clearSelection')" style="margin-bottom: 8px;">
        ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
      </button>
</div>
<table aria-label="ì„ íƒëœ í•­ëª© ëª©ë¡" role="table">
<thead>
<tr>
<th scope="col">ID</th>
<th scope="col">ì‹œì„¤ëª…</th>
<th scope="col">ì£¼ì†Œ</th>
<th class="row-actions" scope="col">ì‚­ì œ</th>
</tr>
</thead>
<tbody id="selBody"></tbody>
</table>
</div>
</div>
<!-- ğŸ”§ EXTERNAL SCRIPTS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- ğŸš€ MAIN APPLICATION SCRIPT -->
<script>
'use strict';

/**
 * ğŸ”’ SECURITY & UTILITY MODULE
 * ë³´ì•ˆ ê¸°ëŠ¥ê³¼ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ì„ ì¤‘ì•™ ì§‘ì¤‘ ê´€ë¦¬
 */
const SecurityUtils = {
  // HTML ì´ìŠ¤ì¼€ì´í”„ - XSS ë°©ì§€
  escapeHtml(unsafe) {
    if (unsafe == null) return '';
    return String(unsafe)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  },

  // ì…ë ¥ê°’ ê²€ì¦ ë° ì •ì œ
  validateInput(input, type = 'text', maxLength = 1000) {
    if (input == null) return '';
    
    input = String(input).trim();
    
    // ê¸¸ì´ ì œí•œ
    if (input.length > maxLength) {
      input = input.substring(0, maxLength);
    }
    
    switch(type) {
      case 'number':
        return input.replace(/[^\d.-]/g, '');
      case 'alphanumeric':
        return input.replace(/[^a-zA-Z0-9ê°€-í£\s\-_]/g, '');
      case 'filename':
        return input.replace(/[<>:"/\\|?*]/g, '');
      case 'coordinate':
        return input.replace(/[^\d.-]/g, '');
      default:
        // ê¸°ë³¸ XSS ë°©ì§€
        return input.replace(/<script[^>]*>.*?<\/script>/gi, '')
                   .replace(/javascript:/gi, '')
                   .replace(/on\w+\s*=/gi, '')
                   .replace(/<iframe[^>]*>.*?<\/iframe>/gi, '');
    }
  },

  // ì•ˆì „í•œ DOM ì¡°ì‘
  setTextContent(element, text) {
    if (!element) return;
    element.textContent = this.validateInput(text);
  },

  // íŒŒì¼ ê²€ì¦
  validateFile(file) {
    const errors = [];
    const MAX_SIZE = 10 * 1024 * 1024; // 10MB
    const ALLOWED_TYPES = ['.xlsx', '.csv', '.json'];
    
    if (!file) {
      errors.push('íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return errors;
    }
    
    if (file.size > MAX_SIZE) {
      errors.push(`íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. (ìµœëŒ€: ${MAX_SIZE/1024/1024}MB)`);
    }
    
    const fileExt = '.' + file.name.split('.').pop().toLowerCase();
    if (!ALLOWED_TYPES.includes(fileExt)) {
      errors.push(`í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (í—ˆìš©: ${ALLOWED_TYPES.join(', ')})`);
    }
    
    if (!/^[a-zA-Z0-9ê°€-í£._\s\-()]+$/.test(file.name)) {
      errors.push('íŒŒì¼ëª…ì— í—ˆìš©ë˜ì§€ ì•ŠëŠ” ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
    }
    
    return errors;
  },

  // CSRF í† í° ìƒì„±
  generateCSRFToken() {
    return Array.from(crypto.getRandomValues(new Uint8Array(16)))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
  }
};

/**
 * ğŸ¯ PERFORMANCE MONITOR
 * ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë° ìµœì í™” ê´€ë¦¬
 */
const PerformanceMonitor = {
  frameCount: 0,
  lastTime: 0,
  
  init() {
    this.startFPSMonitor();
    this.monitorMemory();
  },
  
  startFPSMonitor() {
    const updateFPS = (currentTime) => {
      this.frameCount++;
      
      if (currentTime - this.lastTime >= 1000) {
        const fps = Math.round(this.frameCount * 1000 / (currentTime - this.lastTime));
        const fpsElement = document.getElementById('fps');
        if (fpsElement) fpsElement.textContent = fps;
        
        this.frameCount = 0;
        this.lastTime = currentTime;
      }
      
      requestAnimationFrame(updateFPS);
    };
    
    requestAnimationFrame(updateFPS);
  },
  
  monitorMemory() {
    if ('memory' in performance) {
      setInterval(() => {
        const memMB = Math.round(performance.memory.usedJSHeapSize / 1048576);
        const memElement = document.getElementById('memory');
        if (memElement) memElement.textContent = `${memMB}MB`;
      }, 1000);
    }
  }
};

/**
 * ğŸ”” NOTIFICATION SYSTEM
 * ì‚¬ìš©ì ê²½í—˜ í–¥ìƒì„ ìœ„í•œ ì•Œë¦¼ ì‹œìŠ¤í…œ
 */
const NotificationSystem = {
  show(message, type = 'success', duration = 3000) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    // ì•„ì´ì½˜ ì¶”ê°€
    const icons = {
      success: 'âœ…',
      warning: 'âš ï¸',
      error: 'âŒ',
      info: 'â„¹ï¸'
    };
    
    notification.innerHTML = `
      <span>${icons[type] || 'ğŸ“Œ'}</span>
      <span>${SecurityUtils.escapeHtml(message)}</span>
    `;
    
    document.body.appendChild(notification);
    
    // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    setTimeout(() => notification.classList.add('show'), 100);
    
    // ìë™ ì œê±°
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 250);
    }, duration);
  }
};

/**
 * ğŸ”„ ERROR HANDLER
 * ì „ì—­ ì˜¤ë¥˜ ì²˜ë¦¬ ë° ë³µêµ¬ ì‹œìŠ¤í…œ
 */
const ErrorHandler = {
  init() {
    window.addEventListener('error', this.handleError.bind(this));
    window.addEventListener('unhandledrejection', this.handlePromiseError.bind(this));
  },
  
  handleError(event) {
    console.error('ì „ì—­ ì˜¤ë¥˜:', event.error);
    
    const errorInfo = {
      message: event.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜',
      filename: event.filename || 'ì•Œ ìˆ˜ ì—†ëŠ” íŒŒì¼',
      line: event.lineno || 0,
      column: event.colno || 0
    };
    
    this.logError(errorInfo);
    this.showUserFriendlyError(errorInfo.message);
    
    // ë³µêµ¬ ì‹œë„
    this.attemptRecovery();
  },
  
  handlePromiseError(event) {
    console.error('ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ì˜¤ë¥˜:', event.reason);
    this.logError({
      message: event.reason?.message || 'ë¹„ë™ê¸° ì‘ì—… ì˜¤ë¥˜',
      type: 'promise'
    });
    
    this.showUserFriendlyError('ë¹„ë™ê¸° ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  },
  
  logError(errorInfo) {
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì˜¤ë¥˜ ë¡œê·¸ ì €ì¥ (ê°œë°œ/ë””ë²„ê¹… ìš©)
    try {
      const errorLog = JSON.parse(localStorage.getItem('errorLog') || '[]');
      errorLog.push({
        ...errorInfo,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        url: window.location.href
      });
      
      // ìµœëŒ€ 50ê°œ ë¡œê·¸ë§Œ ìœ ì§€
      if (errorLog.length > 50) {
        errorLog.splice(0, errorLog.length - 50);
      }
      
      localStorage.setItem('errorLog', JSON.stringify(errorLog));
    } catch (e) {
      console.warn('ì˜¤ë¥˜ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', e);
    }
  },
  
  showUserFriendlyError(message) {
    const userMessage = this.getUserFriendlyMessage(message);
    NotificationSystem.show(userMessage, 'error', 5000);
  },
  
  getUserFriendlyMessage(technicalMessage) {
    const friendlyMessages = {
      'fetch': 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.',
      'parse': 'íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
      'memory': 'ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.',
      'permission': 'ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.',
      'quota': 'ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'
    };
    
    for (const [key, message] of Object.entries(friendlyMessages)) {
      if (technicalMessage.toLowerCase().includes(key)) {
        return message;
      }
    }
    
    return 'ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
  },
  
  attemptRecovery() {
    // ê¸°ë³¸ì ì¸ ë³µêµ¬ ì‹œë„
    setTimeout(() => {
      if (window.myMap && !document.getElementById('map').hasChildNodes()) {
        console.log('ì§€ë„ ë³µêµ¬ ì‹œë„...');
        initializeMap();
      }
    }, 1000);
  }
};

/**
 * ğŸ“± RESPONSIVE HANDLER
 * ë°˜ì‘í˜• ë””ìì¸ ë° ëª¨ë°”ì¼ ì§€ì›
 */
const ResponsiveHandler = {
  isMobile: false,
  
  init() {
    this.checkDevice();
    this.setupMobileMenu();
    this.setupResizeListener();
  },
  
  checkDevice() {
    this.isMobile = window.innerWidth <= 768;
    document.body.classList.toggle('mobile', this.isMobile);
    
    // ëª¨ë°”ì¼ ë©”ë‰´ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    if (mobileMenuBtn) {
      mobileMenuBtn.style.display = this.isMobile ? 'flex' : 'none';
    }
  },
  
  setupMobileMenu() {
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const lhs = document.getElementById('lhs');
    
    if (mobileMenuBtn && mobileOverlay && lhs) {
      mobileMenuBtn.addEventListener('click', () => {
        lhs.classList.add('mobile-open');
        mobileOverlay.classList.add('show');
      });
      
      mobileOverlay.addEventListener('click', () => {
        lhs.classList.remove('mobile-open');
        mobileOverlay.classList.remove('show');
      });
    }
  },
  
  setupResizeListener() {
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        this.checkDevice();
        if (window.myMap) {
          window.myMap.invalidateSize();
        }
      }, 250);
    });
  }
};

/**
 * ğŸ¨ THEME MANAGER
 * ë‹¤í¬ëª¨ë“œ ë° í…Œë§ˆ ê´€ë¦¬
 */
const ThemeManager = {
  currentTheme: 'light',
  
  init() {
    this.loadTheme();
    this.setupThemeToggle();
  },
  
  loadTheme() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    this.currentTheme = savedTheme || (prefersDark ? 'dark' : 'light');
    this.applyTheme(this.currentTheme);
  },
  
  applyTheme(theme) {
    document.body.classList.toggle('auto-dark', theme === 'dark');
    
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
      themeToggle.textContent = theme === 'dark' ? 'â˜€ï¸ ë¼ì´íŠ¸' : 'ğŸŒ™ ë‹¤í¬';
    }
    
    localStorage.setItem('theme', theme);
    this.currentTheme = theme;
  },
  
  setupThemeToggle() {
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        const newTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
        this.applyTheme(newTheme);
      });
    }
  }
};

/**
 * ğŸ—‚ï¸ STATE MANAGER
 * ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ ê´€ë¦¬ ì‹œìŠ¤í…œ
 */
const StateManager = {
  state: {
    rows: [],
    rowsById: new Map(),
    selectedIds: new Set(),
    markersById: new Map(),
    filters: {
      emd: new Set(),
      grp: new Set(),
      search: ''
    },
    ui: {
      currentSection: 'secData',
      panelVisible: false
    }
  },
  
  observers: [],
  
  subscribe(observer) {
    this.observers.push(observer);
  },
  
  notify(change) {
    this.observers.forEach(observer => {
      try {
        observer(change);
      } catch (error) {
        console.error('Observer ì˜¤ë¥˜:', error);
      }
    });
  },
  
  setState(updates) {
    const oldState = { ...this.state };
    this.state = { ...this.state, ...updates };
    this.notify({ oldState, newState: this.state, updates });
  },
  
  getState() {
    return { ...this.state };
  }
};

/**
 * ğŸ›¡ï¸ SAFE OPERATION WRAPPER
 * ëª¨ë“  ì‚¬ìš©ì ì•¡ì…˜ì„ ì•ˆì „í•˜ê²Œ ë˜í•‘í•˜ëŠ” í•¨ìˆ˜
 */
function safeOperation(operationName, ...args) {
  try {
    // ìƒíƒœ ì—…ë°ì´íŠ¸
    updateStatus('ì²˜ë¦¬ ì¤‘...', 'warn');
    
    // ì„±ëŠ¥ ì¸¡ì • ì‹œì‘
    const startTime = performance.now();
    
    // ì‹¤ì œ ì‘ì—… ì‹¤í–‰
    const result = executeOperation(operationName, ...args);
    
    // Promiseì¸ ê²½ìš° ì²˜ë¦¬
    if (result instanceof Promise) {
      return result
        .then(finalResult => {
          const duration = performance.now() - startTime;
          console.log(`ì‘ì—… ì™„ë£Œ: ${operationName} (${duration.toFixed(2)}ms)`);
          updateStatus('ì™„ë£Œ', 'ok');
          return finalResult;
        })
        .catch(error => {
          console.error(`ì‘ì—… ì‹¤íŒ¨: ${operationName}`, error);
          const userMessage = ErrorHandler.getUserFriendlyMessage(error.message);
          NotificationSystem.show(`ì‘ì—… ì‹¤íŒ¨: ${userMessage}`, 'error');
          updateStatus('ì˜¤ë¥˜', 'bad');
          throw error;
        });
    } else {
      const duration = performance.now() - startTime;
      console.log(`ì‘ì—… ì™„ë£Œ: ${operationName} (${duration.toFixed(2)}ms)`);
      updateStatus('ì™„ë£Œ', 'ok');
      return result;
    }
    
  } catch (error) {
    console.error(`ì‘ì—… ì¤‘ ì˜¤ë¥˜: ${operationName}`, error);
    const userMessage = ErrorHandler.getUserFriendlyMessage(error.message);
    NotificationSystem.show(`ì‘ì—… ì˜¤ë¥˜: ${userMessage}`, 'error');
    updateStatus('ì˜¤ë¥˜', 'bad');
    throw error;
  }
}

/**
 * ğŸ¯ OPERATION EXECUTOR
 * ì‹¤ì œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜ë“¤
 */
function executeOperation(operationName, ...args) {
  const operations = {
    // ë°ì´í„° ê´€ë ¨
    'loadExcel': () => loadExcelFile(),
    'toRowsManual': () => processManualSheetSelection(),
    'applyScope': () => applySearchFilter(),
    
    // ì§€ë„ ê´€ë ¨
    'centerMap': () => centerMapToData(),
    'fitBounds': () => fitMapToBounds(),
    'optimizeRoute': () => optimizeRouteSelection(),
    
    // ì„ íƒ ê´€ë¦¬
    'showSelectionPanel': () => showSelectionPanel(),
    'hideSelectionPanel': () => hideSelectionPanel(),
    'clearSelection': () => clearAllSelections(),
    
    // ë‚´ë³´ë‚´ê¸°
    'exportExcel': () => exportToExcel(),
    'exportPDF': () => exportToPDF(),
    
    // í†µê³„
    'showStatistics': () => showStatisticsPanel()
  };
  
  if (operations[operationName]) {
    return operations[operationName](...args);
  } else {
    throw new Error(`ì•Œ ìˆ˜ ì—†ëŠ” ì‘ì—…: ${operationName}`);
  }
}

/**
 * ğŸ“Š STATUS UPDATER
 * ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
 */
function updateStatus(text, type = 'ok') {
  const statusBadge = document.getElementById('statusBadge');
  const statusText = document.getElementById('statusText');
  
  if (statusBadge && statusText) {
    statusBadge.className = `badge ${type}`;
    SecurityUtils.setTextContent(statusText, text);
    
    // ì¼ì • ì‹œê°„ í›„ ê¸°ë³¸ ìƒíƒœë¡œ ë³µì›
    if (type !== 'ok') {
      setTimeout(() => updateStatus('ì¤€ë¹„ë¨'), 3000);
    }
  }
}

/**
 * ğŸ“‚ FILE OPERATIONS
 * íŒŒì¼ ì²˜ë¦¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
 */
async function loadExcelFile() {
  const fileInput = document.getElementById('fileInput');
  const file = fileInput?.files?.[0];
  
  if (!file) {
    throw new Error('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
  }
  
  // íŒŒì¼ ê²€ì¦
  const validationErrors = SecurityUtils.validateFile(file);
  if (validationErrors.length > 0) {
    throw new Error(validationErrors.join('\n'));
  }
  
  // ì§„í–‰ë¥  í‘œì‹œ
  showProgress(0);
  
  try {
    const workbook = await readExcelFile(file);
    
    if (workbook.SheetNames.includes("2025DATA")) {
      const rows = processWorksheet(workbook.Sheets["2025DATA"]);
      await updateDataState(rows);
      NotificationSystem.show(`ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${rows.length}ê°œ í–‰`, 'success');
    } else {
      showAdvancedSettings(workbook);
      NotificationSystem.show('2025DATA ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ê³ ê¸‰ ì„¤ì •ì„ ì—½ë‹ˆë‹¤.', 'warning');
    }
    
  } finally {
    hideProgress();
  }
}

function readExcelFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      try {
        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
        resolve(workbook);
      } catch (error) {
        reject(new Error(`Excel íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨: ${error.message}`));
      }
    };
    
    reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
    reader.readAsArrayBuffer(file);
  });
}

function processWorksheet(worksheet) {
  try {
    const jsonData = XLSX.utils.sheet_to_json(worksheet);
    
    return jsonData.map((row, index) => {
      const processedRow = {
        id: SecurityUtils.validateInput(row['ê³ ìœ ë²ˆí˜¸'] || row['ID'] || index + 1, 'alphanumeric'),
        name: SecurityUtils.validateInput(row['ì‹œì„¤ëª…'] || row['name'] || '', 'text'),
        addr: SecurityUtils.validateInput(row['êµ¬ë¶„ì£¼ì†Œ'] || row['address'] || '', 'text'),
        emd: SecurityUtils.validateInput(row['ìë©´ë™'] || row['emd'] || '', 'alphanumeric'),
        grp: SecurityUtils.validateInput(row['êµ°ì§‘'] || row['group'] || '', 'number'),
        lat: parseFloat(SecurityUtils.validateInput(row['ìœ„ë„'] || row['lat'] || 0, 'coordinate')),
        lng: parseFloat(SecurityUtils.validateInput(row['ê²½ë„'] || row['lng'] || 0, 'coordinate'))
      };
      
      // ì¢Œí‘œ ìœ íš¨ì„± ê²€ì¦
      if (isNaN(processedRow.lat) || isNaN(processedRow.lng) || 
          processedRow.lat === 0 || processedRow.lng === 0) {
        processedRow.valid = false;
      } else {
        processedRow.valid = true;
      }
      
      return processedRow;
    }).filter(row => row.id); // IDê°€ ì—†ëŠ” í–‰ ì œì™¸
    
  } catch (error) {
    throw new Error(`ì›Œí¬ì‹œíŠ¸ ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
  }
}

async function updateDataState(rows) {
  const validRows = rows.filter(row => row.valid);
  const errorRows = rows.filter(row => !row.valid);
  
  // ìƒíƒœ ì—…ë°ì´íŠ¸
  StateManager.setState({
    rows: validRows,
    rowsById: new Map(validRows.map(row => [String(row.id), row]))
  });
  
  // UI ì—…ë°ì´íŠ¸
  updateDataBadges(rows.length, validRows.length, errorRows.length);
  await rebuildFilterBoxes();
  await renderMap();
}

function updateDataBadges(total, valid, error) {
  const totalBadge = document.getElementById('totalBadge');
  const validBadge = document.getElementById('validBadge');
  const errorBadge = document.getElementById('errorBadge');
  
  if (totalBadge) SecurityUtils.setTextContent(totalBadge, `ì „ì²´: ${total}`);
  if (validBadge) SecurityUtils.setTextContent(validBadge, `ìœ íš¨: ${valid}`);
  if (errorBadge) {
    SecurityUtils.setTextContent(errorBadge, `ì˜¤ë¥˜: ${error}`);
    errorBadge.className = error > 0 ? 'badge warn' : 'badge ok';
  }
}

function showProgress(percent) {
  const progressBar = document.getElementById('loadProgress');
  const progressFill = document.getElementById('progressFill');
  
  if (progressBar) progressBar.style.display = 'block';
  if (progressFill) progressFill.style.width = `${percent}%`;
}

function hideProgress() {
  const progressBar = document.getElementById('loadProgress');
  if (progressBar) progressBar.style.display = 'none';
}

/**
 * ğŸ¯ MAP OPERATIONS
 * ì§€ë„ ê´€ë ¨ ê¸°ëŠ¥ë“¤
 */
let myMap;
let clusterGroup;
let routeLayer;

async function initializeMap() {
  try {
    const mapContainer = document.getElementById('map');
    if (!mapContainer) throw new Error('ì§€ë„ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    
    // ê¸°ì¡´ ì§€ë„ ì •ë¦¬
    if (myMap) {
      myMap.remove();
    }
    
    // ì§€ë„ ì´ˆê¸°í™”
    myMap = L.map('map').setView([36.5, 127.5], 8);
    
    // ê¸°ë³¸ íƒ€ì¼ ë ˆì´ì–´
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(myMap);
    
    // í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ì´ˆê¸°í™”
    clusterGroup = L.markerClusterGroup({
      maxClusterRadius: 50,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false
    });
    
    myMap.addLayer(clusterGroup);
    
    // ì§€ë„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    myMap.on('zoomend', debounce(updateMapState, 300));
    myMap.on('moveend', debounce(updateMapState, 300));
    
    console.log('ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ');
    
  } catch (error) {
    console.error('ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    throw new Error('ì§€ë„ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
}

async function renderMap() {
  if (!myMap) {
    await initializeMap();
  }
  
  const { rows } = StateManager.getState();
  
  // ê¸°ì¡´ ë§ˆì»¤ ì •ë¦¬
  clusterGroup.clearLayers();
  
  if (!rows || rows.length === 0) {
    NotificationSystem.show('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
    return;
  }
  
  // ë§ˆì»¤ ìƒì„± ë° ì¶”ê°€
  const markers = rows
    .filter(row => row.valid && row.lat && row.lng)
    .map(row => createMarker(row));
  
  clusterGroup.addLayers(markers);
  
  // ì§€ë„ ë²”ìœ„ ì¡°ì •
  if (markers.length > 0) {
    const group = new L.featureGroup(markers);
    myMap.fitBounds(group.getBounds(), { padding: [20, 20] });
  }
  
  NotificationSystem.show(`${markers.length}ê°œ ë§ˆì»¤ê°€ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
}

function createMarker(row) {
  const marker = L.marker([row.lat, row.lng]);
  
  // ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì ìš©
  const markerStyle = document.getElementById('markerStyle')?.value || 'bubble';
  marker.options.className = `mk mk-${markerStyle}`;
  
  // íŒì—… ë‚´ìš© ìƒì„± (ì•ˆì „í•œ HTML)
  const popupContent = `
    <div class="marker-popup">
      <h4>${SecurityUtils.escapeHtml(row.name || 'ì´ë¦„ ì—†ìŒ')}</h4>
      <p><strong>ID:</strong> ${SecurityUtils.escapeHtml(row.id)}</p>
      <p><strong>ì£¼ì†Œ:</strong> ${SecurityUtils.escapeHtml(row.addr || 'ì£¼ì†Œ ì—†ìŒ')}</p>
      <p><strong>ìë©´ë™:</strong> ${SecurityUtils.escapeHtml(row.emd || 'ì •ë³´ ì—†ìŒ')}</p>
      <p><strong>êµ°ì§‘:</strong> ${SecurityUtils.escapeHtml(row.grp || 'ì •ë³´ ì—†ìŒ')}</p>
      <div style="margin-top: 8px;">
        <button class="btn btn-sky btn-sm" onclick="safeOperation('selectItem', '${SecurityUtils.escapeHtml(row.id)}')">
          ì„ íƒ
        </button>
        <button class="btn btn-accent btn-sm" onclick="safeOperation('showRoute', '${SecurityUtils.escapeHtml(row.id)}')">
          ê²½ë¡œ
        </button>
      </div>
    </div>
  `;
  
  marker.bindPopup(popupContent);
  marker.rowData = row;
  
  return marker;
}

function centerMapToData() {
  const { rows } = StateManager.getState();
  const validRows = rows.filter(row => row.valid && row.lat && row.lng);
  
  if (validRows.length === 0) {
    NotificationSystem.show('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
    return;
  }
  
  // ì¤‘ì‹¬ì  ê³„ì‚°
  const avgLat = validRows.reduce((sum, row) => sum + row.lat, 0) / validRows.length;
  const avgLng = validRows.reduce((sum, row) => sum + row.lng, 0) / validRows.length;
  
  myMap.setView([avgLat, avgLng], 12);
  NotificationSystem.show('ì§€ë„ ì¤‘ì‹¬ì„ ë°ì´í„° ìœ„ì¹˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.', 'success');
}

function fitMapToBounds() {
  if (clusterGroup.getLayers().length > 0) {
    myMap.fitBounds(clusterGroup.getBounds(), { padding: [20, 20] });
    NotificationSystem.show('ëª¨ë“  ë°ì´í„°ê°€ ë³´ì´ë„ë¡ ì§€ë„ë¥¼ ì¡°ì •í–ˆìŠµë‹ˆë‹¤.', 'success');
  }
}

function updateMapState() {
  // ì§€ë„ ìƒíƒœ ë³€ê²½ ì‹œ í•„ìš”í•œ ì—…ë°ì´íŠ¸ ìˆ˜í–‰
  const center = myMap.getCenter();
  const zoom = myMap.getZoom();
  
  // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì§€ë„ ìƒíƒœ ì €ì¥
  try {
    localStorage.setItem('mapState', JSON.stringify({
      lat: center.lat,
      lng: center.lng,
      zoom: zoom,
      timestamp: Date.now()
    }));
  } catch (e) {
    console.warn('ì§€ë„ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:', e);
  }
}

/**
 * ğŸ” FILTER OPERATIONS
 * í•„í„°ë§ ê¸°ëŠ¥ë“¤
 */
async function rebuildFilterBoxes() {
  const { rows } = StateManager.getState();
  
  if (!rows || rows.length === 0) return;
  
  // ìë©´ë™ ëª©ë¡ ìƒì„±
  const emdValues = [...new Set(rows.map(row => row.emd).filter(Boolean))].sort();
  fillChipBox(document.getElementById('emdBox'), emdValues, 'emd');
  
  // êµ°ì§‘ ëª©ë¡ ìƒì„±
  const grpValues = [...new Set(rows.map(row => row.grp).filter(Boolean))].sort((a, b) => Number(a) - Number(b));
  fillChipBox(document.getElementById('grpBox'), grpValues, 'grp');
}

function fillChipBox(container, values, name) {
  if (!container || !Array.isArray(values)) return;
  
  // ê¸°ì¡´ ë‚´ìš© ì•ˆì „í•˜ê²Œ ì œê±°
  while (container.firstChild) {
    container.removeChild(container.firstChild);
  }
  
  if (values.length === 0) {
    const emptyDiv = document.createElement('div');
    emptyDiv.className = 'small';
    SecurityUtils.setTextContent(emptyDiv, 'í•´ë‹¹ í•­ëª© ì—†ìŒ');
    container.appendChild(emptyDiv);
    return;
  }
  
  values.forEach(value => {
    const safeValue = SecurityUtils.validateInput(value, 'alphanumeric');
    
    const label = document.createElement('label');
    label.className = 'chip';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.name = name;
    checkbox.value = encodeURIComponent(safeValue);
    checkbox.checked = true;
    checkbox.addEventListener('change', debounce(applyFilters, 300));
    
    const textNode = document.createTextNode(' ' + safeValue);
    
    label.appendChild(checkbox);
    label.appendChild(textNode);
    container.appendChild(label);
  });
}

async function applySearchFilter() {
  const searchInput = document.getElementById('scopeInput');
  const searchTerm = searchInput?.value?.trim() || '';
  
  // ê²€ìƒ‰ì–´ ê²€ì¦
  const safeTerm = SecurityUtils.validateInput(searchTerm, 'alphanumeric', 100);
  
  if (safeTerm !== searchTerm) {
    NotificationSystem.show('ê²€ìƒ‰ì–´ì— í—ˆìš©ë˜ì§€ ì•ŠëŠ” ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.', 'warning');
    searchInput.value = safeTerm;
  }
  
  // í•„í„° ìƒíƒœ ì—…ë°ì´íŠ¸
  const currentState = StateManager.getState();
  StateManager.setState({
    filters: {
      ...currentState.filters,
      search: safeTerm
    }
  });
  
  await applyFilters();
}

async function applyFilters() {
  const { rows, filters } = StateManager.getState();
  
  if (!rows || rows.length === 0) return;
  
  // ì²´í¬ëœ í•„í„° ìˆ˜ì§‘
  const checkedEmd = new Set();
  const checkedGrp = new Set();
  
  document.querySelectorAll('input[name="emd"]:checked').forEach(cb => {
    checkedEmd.add(decodeURIComponent(cb.value));
  });
  
  document.querySelectorAll('input[name="grp"]:checked').forEach(cb => {
    checkedGrp.add(decodeURIComponent(cb.value));
  });
  
  // í•„í„°ë§ ì ìš©
  const filteredRows = rows.filter(row => {
    // ìë©´ë™ í•„í„°
    if (checkedEmd.size > 0 && !checkedEmd.has(row.emd)) return false;
    
    // êµ°ì§‘ í•„í„°
    if (checkedGrp.size > 0 && !checkedGrp.has(row.grp)) return false;
    
    // ê²€ìƒ‰ í•„í„°
    if (filters.search) {
      const searchLower = filters.search.toLowerCase();
      return (
        row.name?.toLowerCase().includes(searchLower) ||
        row.addr?.toLowerCase().includes(searchLower) ||
        row.emd?.toLowerCase().includes(searchLower)
      );
    }
    
    return true;
  });
  
  // ìƒíƒœ ì—…ë°ì´íŠ¸
  StateManager.setState({
    rows: filteredRows,
    filters: {
      ...filters,
      emd: checkedEmd,
      grp: checkedGrp
    }
  });
  
  await renderMap();
  
  NotificationSystem.show(`í•„í„° ì ìš©: ${filteredRows.length}ê°œ í•­ëª©`, 'success');
}

/**
 * ğŸ¯ SELECTION OPERATIONS
 * ì„ íƒ ê´€ë¦¬ ê¸°ëŠ¥ë“¤
 */
function showSelectionPanel() {
  const panel = document.getElementById('selPanel');
  if (panel) {
    panel.style.display = 'block';
    panel.setAttribute('aria-hidden', 'false');
    updateSelectionTable();
  }
}

function hideSelectionPanel() {
  const panel = document.getElementById('selPanel');
  if (panel) {
    panel.style.display = 'none';
    panel.setAttribute('aria-hidden', 'true');
  }
}

function updateSelectionTable() {
  const tbody = document.getElementById('selBody');
  const { selectedIds, rowsById } = StateManager.getState();
  
  if (!tbody) return;
  
  // ê¸°ì¡´ ë‚´ìš© ì œê±°
  while (tbody.firstChild) {
    tbody.removeChild(tbody.firstChild);
  }
  
  // ì„ íƒëœ í•­ëª©ë“¤ ì¶”ê°€
  selectedIds.forEach(id => {
    const row = rowsById.get(id);
    if (!row) return;
    
    const tr = document.createElement('tr');
    tr.dataset.id = id;
    
    // ID ì…€
    const tdId = document.createElement('td');
    SecurityUtils.setTextContent(tdId, row.id);
    
    // ì´ë¦„ ì…€
    const tdName = document.createElement('td');
    SecurityUtils.setTextContent(tdName, row.name || 'ì´ë¦„ ì—†ìŒ');
    
    // ì£¼ì†Œ ì…€
    const tdAddr = document.createElement('td');
    SecurityUtils.setTextContent(tdAddr, row.addr || 'ì£¼ì†Œ ì—†ìŒ');
    
    // ì‚­ì œ ë²„íŠ¼ ì…€
    const tdAction = document.createElement('td');
    tdAction.className = 'row-actions';
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn btn-accent btn-sm';
    deleteBtn.textContent = 'ì‚­ì œ';
    deleteBtn.onclick = () => safeOperation('removeSelection', id);
    
    tdAction.appendChild(deleteBtn);
    
    tr.appendChild(tdId);
    tr.appendChild(tdName);
    tr.appendChild(tdAddr);
    tr.appendChild(tdAction);
    
    tbody.appendChild(tr);
  });
  
  // ì„ íƒ ê°œìˆ˜ ì—…ë°ì´íŠ¸
  updateSelectionCount();
}

function updateSelectionCount() {
  const { selectedIds } = StateManager.getState();
  const countElement = document.getElementById('selectedCount');
  
  if (countElement) {
    SecurityUtils.setTextContent(countElement, selectedIds.size.toString());
  }
}

function clearAllSelections() {
  StateManager.setState({ selectedIds: new Set() });
  updateSelectionTable();
  NotificationSystem.show('ì„ íƒì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

/**
 * ğŸš€ INITIALIZATION
 * ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”
 */
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// DOM ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', async function() {
  try {
    console.log('ğŸš€ CLUSTRO Final Secured v12.2 ì´ˆê¸°í™” ì‹œì‘...');
    
    // í•µì‹¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    ErrorHandler.init();
    PerformanceMonitor.init();
    ResponsiveHandler.init();
    ThemeManager.init();
    
    // UI ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    setupEventListeners();
    
    // ì§€ë„ ì´ˆê¸°í™”
    await initializeMap();
    
    // ì„±ëŠ¥ ëª¨ë‹ˆí„° í† ê¸€ ì„¤ì •
    const perfToggle = document.getElementById('perfToggle');
    if (perfToggle) {
      perfToggle.addEventListener('click', () => {
        const monitor = document.getElementById('perfMonitor');
        if (monitor) {
          monitor.classList.toggle('show');
        }
      });
    }
    
    // ë„¤ë¹„ê²Œì´ì…˜ ì„¤ì •
    setupNavigation();
    
    // ìƒíƒœ ê´€ë¦¬ì ì˜µì €ë²„ ë“±ë¡
    StateManager.subscribe((change) => {
      console.log('ìƒíƒœ ë³€ê²½:', change);
      updateSelectionCount();
    });
    
    console.log('âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì™„ë£Œ');
    NotificationSystem.show('CLUSTRO Final Secured v12.2ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    
  } catch (error) {
    console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    NotificationSystem.show('ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
});

function setupEventListeners() {
  // íŒŒì¼ ì…ë ¥ ì´ë²¤íŠ¸
  const fileInput = document.getElementById('fileInput');
  if (fileInput) {
    fileInput.addEventListener('change', () => safeOperation('loadExcel'));
  }
  
  // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸
  const searchInput = document.getElementById('scopeInput');
  if (searchInput) {
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        safeOperation('applyScope');
      }
    });
  }
  
  // í°íŠ¸ í¬ê¸° ì¡°ì ˆ
  const fontSizeRange = document.getElementById('fontSizeRange');
  const fontSizeValue = document.getElementById('fontSizeValue');
  if (fontSizeRange && fontSizeValue) {
    fontSizeRange.addEventListener('input', (e) => {
      const size = e.target.value + 'px';
      SecurityUtils.setTextContent(fontSizeValue, size);
      document.documentElement.style.setProperty('--flt-font', size);
      document.documentElement.style.setProperty('--tbl-font', size);
    });
  }
  
  // ë§ˆì»¤ í¬ê¸° ì¡°ì ˆ
  const markerSizeRange = document.getElementById('markerSizeRange');
  const markerSizeValue = document.getElementById('markerSizeValue');
  if (markerSizeRange && markerSizeValue) {
    markerSizeRange.addEventListener('input', (e) => {
      const size = e.target.value + 'px';
      SecurityUtils.setTextContent(markerSizeValue, size);
      document.documentElement.style.setProperty('--mk', size);
    });
  }
}

function setupNavigation() {
  // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸
  document.querySelectorAll('.icbtn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      if (!target) return;
      
      // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
      document.querySelectorAll('.sec').forEach(sec => {
        sec.classList.remove('active');
      });
      
      // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
      document.querySelectorAll('.icbtn').forEach(b => {
        b.classList.remove('active');
      });
      
      // ì„ íƒëœ ì„¹ì…˜ í‘œì‹œ
      const targetSection = document.querySelector(target);
      if (targetSection) {
        targetSection.classList.add('active');
        btn.classList.add('active');
      }
      
      // ëª¨ë°”ì¼ì—ì„œ ë©”ë‰´ ë‹«ê¸°
      if (ResponsiveHandler.isMobile) {
        document.getElementById('lhs')?.classList.remove('mobile-open');
        document.getElementById('mobileOverlay')?.classList.remove('show');
      }
    });
  });
}

// ê°œë°œ ëª¨ë“œì—ì„œë§Œ ì „ì—­ ì ‘ê·¼ í—ˆìš©
if (typeof window !== 'undefined') {
  window.CLUSTRO = {
    safeOperation,
    SecurityUtils,
    StateManager,
    NotificationSystem,
    version: '12.2 Final Secured'
  };
}

console.log('%cğŸ”’ CLUSTRO Final Secured v12.2', 'color: #0EA5E9; font-weight: bold; font-size: 16px;');
console.log('%cëª¨ë“  ë³´ì•ˆ ì·¨ì•½ì ì´ í•´ê²°ëœ ìµœì¢… ë²„ì „ì…ë‹ˆë‹¤.', 'color: #059669;');
</script>
<div id="mapControlsTop" style="position:absolute;top:8px;left:calc(var(--rail-w) + var(--side-w) + var(--gut-w) + 8px);z-index:1000;display:flex;gap:6px;align-items:center"><button class="btn btn-sky" id="btnToggleSelTop" title="ì„ íƒëª©ë¡">ì„ íƒëª©ë¡</button><button class="btn btn-sky" id="btnFitTop" title="ë§ì¶¤">ë§ì¶¤</button><button class="btn btn-sky" id="btnRefreshTop" title="í•„í„°ì ìš©">í•„í„°ì ìš©</button><select class="form-control" id="routeMethod"><option selected="selected" value="nn2opt">ë¹ ë¥¸(ìµœê·¼ì +2-opt)</option><option value="nn">ìµœê·¼ì </option><option value="cluster">í´ëŸ¬ìŠ¤í„°(ì§€ì˜¤ê·¸ë¦¬ë“œÂ·Morton+NN)</option><option value="hilbert">íë²„íŠ¸(Hilbert)</option><option value="kmeans">Kâ€‘í‰ê· (k-means)</option></select><input class="form-control" id="dailyMaxNav" max="999" min="1" style="width:84px" title="í•˜ë£¨ ìµœëŒ€ í¬ì¸íŠ¸" type="number" value="50"/><button class="btn btn-primary" id="btnRouteNav" style="padding:6px 12px;font-size:12px">ê²½ë¡œ ê³„ì‚°</button><button class="btn btn-util" id="btnRouteClearNav" style="padding:6px 12px;font-size:12px">ì´ˆê¸°í™”</button></div><script>
// libs
(async function bootstrap(){
  await loadScriptSeq(()=>window.L, ["https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"]);
  await loadScriptSeq(()=>window.XLSX, ["https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"]);
  await loadScriptSeq(()=>window.html2canvas, ["https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"]);
  await loadScriptSeq(()=>window.jspdf, ["https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"]);
  App.init();
})();

async function loadScriptSeq(check, urls){
  for(const url of urls){
    try{
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src=url;
        s.onload=res;
        s.onerror=rej;
        document.head.appendChild(s);
      });
      // if the library is now available, bail early
      if(check()) return true;
    }catch(e){
      console.warn('Failed to load script:', url, e);
    }
  }
  // At this point none of the URLs produced a working library.
  // Notify the user so they understand why parts of the interface may not work.
  if(!check()){
    // Construct a more detailed message listing the attempted URLs for easier debugging.
    const names = urls.join(', ');
    alert('í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ë¡œì»¬ë¡œ ë²ˆë“¤ëœ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•´ ì£¼ì„¸ìš”. ì‹œë„í•œ URL: ' + names);
  }
  return check();
}
</script><script>
const App = (function(){
  let wb=null, rows=[], rowsById=new Map();
  let map, groupLayer, routeLayer, baseLayer=null;
  let includeRelax=true, scopeTerm="";
  let tblFont=13, fltFont=13, mk=28;

  const selectedIds=new Set();
  const markersById=new Map();

  let selEmd=new Set();
  let selGrp=new Set();

  let AB=[], abMarkers=[]; // for A/B pick

  // ê²½ë¡œ ê³„ì‚° ì¤‘ì¸ì§€ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” í”Œë˜ê·¸. ì¬ê·€ í˜¸ì¶œì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.
  let isComputing = false;

  const $=(q,root=document)=>root.querySelector(q);
  const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));
  const setVar=(k,v)=>document.documentElement.style.setProperty(k,v);
  const isBlank=v=>v==null||String(v).trim()===''||String(v).trim().toLowerCase()==='null'||String(v).trim()==='-';
  const A1=a=>a?a.toUpperCase().split('').reduce((n,c)=>n*26+(c.charCodeAt(0)-64),0)-1:-1;

  /* map */
  function setupMap(){
    const KOREA_BOUNDS = L.latLngBounds([33.0,124.0],[39.6,132.5]);
    map = L.map('map',{zoomControl:true, zoomSnap:0.1, zoomDelta:0.1, preferCanvas:true, maxBounds: KOREA_BOUNDS, maxBoundsViscosity: 0.8}).setView([36.635,127.491], 12);
    groupLayer=L.layerGroup().addTo(map);
    routeLayer=L.layerGroup().addTo(map);
    L.control.scale({imperial:false}).addTo(map);

    $('#zoomRange').addEventListener('input', e=>map.setZoom(parseFloat(e.target.value)));
    map.on('zoom', ()=>{const z=map.getZoom().toFixed(1); $('#zoomRange').value=z; $('#zoomVal').textContent=z;});

    $('#baseSelect').value = "vworld_base";
    applyBaseAuto();
  }
  const BASES=[
    {id:'osm',url:'https://tile.openstreetmap.org/{z}/{x}/{y}.png',opt:{maxZoom:19,attribution:'Â© OpenStreetMap',crossOrigin:true}},
    {id:'vworld_gray',url:'https://xdworld.vworld.kr/2d/gray/202002/service/{z}/{x}/{y}.png',opt:{maxZoom:19,attribution:'Â© VWorld',crossOrigin:true}},
    {id:'vworld_base',url:'https://xdworld.vworld.kr/2d/Base/service/{z}/{x}/{y}.png',opt:{maxZoom:19,attribution:'Â© VWorld',crossOrigin:true}},
    {id:'none',url:null,opt:{}}
  ];
  function setNoBase(){ if(baseLayer){map.removeLayer(baseLayer);baseLayer=null;} $('#map').style.background='#f2f2f2'; }
  function tileSample(url){
    const z=Math.round(map.getZoom()), c=map.getCenter();
    const x=Math.floor((c.lng+180)/360*Math.pow(2,z));
    const y=Math.floor((1-Math.log(Math.tan(c.lat*Math.PI/180)+1/Math.cos(c.lat*Math.PI/180))/Math.PI)/2*Math.pow(2,z));
    return url.replace('{z}',z).replace('{x}',x).replace('{y}',y);
  }
  function testTile(url,ms=1600){return new Promise(r=>{if(!url)return r(false);const i=new Image();let done=false;const t=setTimeout(()=>{if(!done){done=true;r(false)}},ms);i.onload=()=>{if(!done){done=true;clearTimeout(t);r(true)}};i.onerror=()=>{if(!done){done=true;clearTimeout(t);r(false)}};i.crossOrigin='anonymous';i.src=tileSample(url);});}
  async function switchBase(id, fallback){
    if(baseLayer){map.removeLayer(baseLayer);baseLayer=null;}
    const cfg=BASES.find(b=>b.id===id)||BASES[0];
    if(!cfg.url){setNoBase();return 'none';}
    const ok=await testTile(cfg.url, 1600);
    if(ok){baseLayer=L.tileLayer(cfg.url,cfg.opt).addTo(map); return cfg.id;}
    if(fallback){
      const order=(cfg.id==='osm')?['vworld_gray','vworld_base','none']:(cfg.id==='vworld_gray')?['vworld_base','none']:(cfg.id==='vworld_base')?['none']:['none'];
      for(const nid of order){ const r=await switchBase(nid,false); if(r) return r; }
    }
    setNoBase(); return 'none';
  }
  async function applyBaseAuto(){
    const v=$('#baseSelect').value;
    if(v==='auto') await switchBase('osm',true);
    else await switchBase(v,false);
  }
  $('#basemap')?.addEventListener('change', e=>{
    const v=e.target.value;
    $('#baseSelect').value = (v==='vworld-gray'?'vworld_gray':v==='vworld-base'?'vworld_base':v);
    applyBaseAuto();
  });
  $('#baseSelect')?.addEventListener('change', applyBaseAuto);

  /* excel */
  function toRows(ws, latCol='R', lngCol='S'){
    const arr=XLSX.utils.sheet_to_json(ws,{header:1,defval:""});
    const B=A1('B'), C=A1('C'), G=A1('G'), H=A1('H'), J=A1('J'), U=A1('U');
    const R=A1(latCol), S=A1(lngCol);
    const out=[];
    for(let i=1;i<arr.length;i++){ const r=arr[i]; if(!r) continue;
      const lat=Number(String(r[R]).replace(/,/g,"")), lng=Number(String(r[S]).replace(/,/g,""));
      out.push({
        id: r[C] ?? i, name: r[G] ?? "", addr: r[B] ?? "",
        grp: r[U] ?? "", emd: r[H] ?? "", date: r[J] ?? "",
        lat: isFinite(lat)?lat:(String(r[R]??"").trim()===""?null:NaN),
        lng: isFinite(lng)?lng:(String(r[S]??"").trim()===""?null:NaN),
      });
    }
    return out;
  }
  async function readFile(f){
    return new Promise((res,rej)=>{
      const fr=new FileReader();
      fr.onload=e=>{
        try{
          wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
          if(wb.SheetNames.includes("2025DATA")){
            rows = toRows(wb.Sheets["2025DATA"]);
            rowsById = new Map(rows.map(r=>[String(r.id), r]));
            afterLoad();
          }else{
            $("#adv").style.display='block';
            $("#sheet").innerHTML=wb.SheetNames.map(n=>`<option>${n}</option>`).join("");
            alert("2025DATA ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ â€˜ê³ ê¸‰ ì„¤ì •â€™ì„ ì—´ì—ˆìŠµë‹ˆë‹¤.");
          }
          res();
        }catch(err){alert("ì—‘ì…€ íŒŒì‹± ì‹¤íŒ¨: "+err.message); rej(err);}
      };
      fr.readAsArrayBuffer(f);
    });
  }
  function toRowsManual(){
    const ws=wb.Sheets[$("#sheet").value]; if(!ws){alert("ì‹œíŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”."); return;}
    rows = toRows(ws, ($("#latCol").value||'R'), ($("#lngCol").value||'S'));
    rowsById = new Map(rows.map(r=>[String(r.id), r]));
    afterLoad();
  }
  function afterLoad(){
    selectedIds.clear(); markersById.clear();
    selEmd=new Set(); selGrp=new Set();
    $("#baseSelect").value="vworld_base"; applyBaseAuto();
    updateBadgesBase(); rebuildFilterBoxes(true); render(true);
  }

  /* search/chips */
  function parseSearch(s){
    const tokens=s.trim().split(/\\s+/).filter(Boolean);
    const emdTokens=tokens.filter(t=>/[ê°€-í£]/.test(t));
    const grpTokens=tokens.filter(t=>/^\\d+$/.test(t));
    return {emdTokens, grpTokens};
  }
  function uniq(a){return [...new Set(a.filter(v=>v!==""&&v!=null))].sort((a,b)=>String(a).localeCompare(String(b),'ko'))}
  function fillChipBox(host, values, name, presetSet){
    host.innerHTML = values.length? values.map(v=>{
      const checked = !presetSet || presetSet.size===0 ? 'checked' : (presetSet.has(String(v))?'checked':'');
      return `<label class="chip"><input type="checkbox" name="${name}" value="${encodeURIComponent(String(v))}" ${checked}> ${String(v)}</label>`;
    }).join("") : `<div class="small">í•´ë‹¹ í•­ëª© ì—†ìŒ</div>`;
  }
  function rebuildFilterBoxes(fromLoad=false){
    const {emdTokens, grpTokens} = parseSearch(scopeTerm);
    const base = rows.filter(r=>{
      const hitEmd = !emdTokens.length || emdTokens.some(t=>String(r.emd||"").includes(t) || String(r.addr||"").includes(t));
      const hitGrp = !grpTokens.length || grpTokens.includes(String(r.grp));
      return hitEmd && hitGrp;
    });
    const emdVals = uniq(base.map(r=>r.emd));
    const grpVals = uniq(base.map(r=>r.grp));
    if(fromLoad || (selEmd.size===0 && selGrp.size===0)){
      selEmd = emdTokens.length ? new Set(emdVals.filter(v=>emdTokens.some(t=>String(v).includes(t))).map(String)) : new Set(emdVals.map(String));
      selGrp = grpTokens.length ? new Set(grpTokens.map(String)) : new Set(grpVals.map(String));
    }else{
      selEmd = new Set(emdVals.filter(v=>selEmd.has(String(v))).map(String));
      if(selEmd.size===0 && emdVals.length) selEmd=new Set(emdVals.map(String));
      selGrp = new Set(grpVals.filter(v=>selGrp.has(String(v))).map(String));
      if(selGrp.size===0 && grpVals.length) selGrp=new Set(grpVals.map(String));
    }
    fillChipBox($('#emdChips'), emdVals, "emd", selEmd);
    fillChipBox($('#grpChips'), grpVals, "grp", selGrp);
    refreshToggleStates();
  }
  function refreshToggleStates(){
    const gi=$$('#grpChips input'); const ei=$$('#emdChips input');
    if(gi.length) $('#grpToggle').checked = gi.every(x=>x.checked);
    if(ei.length) $('#emdToggle').checked = ei.every(x=>x.checked);
    $('#grpToggleLbl').textContent = $('#grpToggle').checked ? 'ì „ì²´ ì„ íƒ' : 'ì „ì²´ í•´ì œ';
    $('#emdToggleLbl').textContent = $('#emdToggle').checked ? 'ì „ì²´ ì„ íƒ' : 'ì „ì²´ í•´ì œ';
  }

  /* labels/markers */
  function labelFor(r){
    const s=$("#labelSrc").value;
    if(s==='addr') return r.addr||'';
    if(s==='name') return r.name||'';
    return r.id||'';
  }
  function markerHtml(t){
    const k=$("#markerStyle").value;
    if(k==='tag')    return `<div class="mk mk-tag">${t}</div>`;
    if(k==='bubble') return `<div class="mk mk-bubble"><span>${t}</span><i></i></div>`;
    return `<div class="mk mk-circle">${t}</div>`;
  }
  /* ë„¤ë¹„ê²Œì´ì…˜ ì•± ì—°ë™ í•¨ìˆ˜ - í”Œë«í¼ ìë™ ê°ì§€ ë° ì•± ì‹¤í–‰ */
  function openNav(app, lat, lng, name='ëª©ì ì§€') {
    // ëª©ì ì§€ ì´ë¦„ URL ì¸ì½”ë”©
    const encodedName = encodeURIComponent(name);
    
    // í”Œë«í¼ ê°ì§€
    const userAgent = navigator.userAgent || navigator.vendor || window.opera;
    const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
    const isAndroid = /android/i.test(userAgent);
    
    let url = '';
    let fallbackUrl = '';
    
    switch(app) {
      case 'kakao':
        // ì¹´ì¹´ì˜¤ë§µ - ì›¹ í´ë°± í¬í•¨
        url = `kakaomap://route?ep=${lat},${lng}&by=car`;
        fallbackUrl = `http://m.map.kakao.com/scheme/route?ep=${lat},${lng}&by=car`;
        break;
        
      case 'naver':
        // ë„¤ì´ë²„ë§µ
        url = `nmap://route/car?dlat=${lat}&dlng=${lng}&dname=${encodedName}&appname=com.example.webapp`;
        if (isIOS) {
          fallbackUrl = 'https://apps.apple.com/kr/app/naver-map/id311867728';
        } else {
          fallbackUrl = 'https://play.google.com/store/apps/details?id=com.nhn.android.nmap';
        }
        break;
        
      case 'tmap':
        // í‹°ë§µ - í”Œë«í¼ë³„ ë‹¤ë¥¸ URL ìŠ¤í‚´
        if (isIOS) {
          url = `tmap://route?rGoName=${encodedName}&rGoX=${lng}&rGoY=${lat}`;
          fallbackUrl = 'https://apps.apple.com/kr/app/tmap/id431589174';
        } else {
          url = `tmap://route?referrer=com.skt.Tmap&goalx=${lng}&goaly=${lat}&goalname=${encodedName}`;
          fallbackUrl = 'https://play.google.com/store/apps/details?id=com.skt.tmap.ku';
        }
        break;
        
      case 'google':
        // êµ¬ê¸€ë§µ - ì›¹ ê¸°ë°˜, ì•± ìë™ ì—°ë™
        url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
        break;
        
      case 'apple':
        // ì• í”Œë§µ - iOS ì „ìš©
        if (isIOS) {
          url = `http://maps.apple.com/?daddr=${lat},${lng}&dirflg=d`;
        } else {
          // Androidì—ì„œëŠ” êµ¬ê¸€ë§µìœ¼ë¡œ ëŒ€ì²´
          url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
        }
        break;
        
      default:
        console.error('Unknown navigation app:', app);
        return;
    }
    
    // ì•± ì‹¤í–‰ ì‹œë„
    if (app === 'google' || (app === 'apple' && !fallbackUrl)) {
      // ì›¹ ê¸°ë°˜ ì•±ì€ ë°”ë¡œ ì—´ê¸°
      window.open(url, '_blank');
    } else if (app === 'kakao') {
      // ì¹´ì¹´ì˜¤ë§µì€ ì›¹ í´ë°± ì‚¬ìš©
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      document.body.appendChild(iframe);
      iframe.src = url;
      
      // ì•±ì´ ì—†ìœ¼ë©´ ì›¹ ë²„ì „ìœ¼ë¡œ ì´ë™
      setTimeout(() => {
        document.body.removeChild(iframe);
        window.open(fallbackUrl, '_blank');
      }, 1500);
    } else {
      // ê¸°íƒ€ ë„¤ì´í‹°ë¸Œ ì•± ì‹¤í–‰ ì‹œë„
      const startTime = Date.now();
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      document.body.appendChild(iframe);
      iframe.src = url;
      
      // ì•±ì´ ì„¤ì¹˜ë˜ì§€ ì•Šì€ ê²½ìš° ìŠ¤í† ì–´ë¡œ ì´ë™
      setTimeout(() => {
        const elapsed = Date.now() - startTime;
        document.body.removeChild(iframe);
        
        // ì•±ì´ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ìŠ¤í† ì–´ë¡œ ì´ë™
        if (elapsed < 2000 && fallbackUrl) {
          window.open(fallbackUrl, '_blank');
        }
      }, 1500);
    }
  }
  
  function tooltipHtml(r){return `<div><b>${r.id||''}</b> - ${r.name||''}<br>${r.addr||''} Â· ${r.emd||''} Â· ${r.grp||''}</div>`;}
  function popupHtml(r){
    // Popup displays basic info using textContent to avoid HTML injection and includes action buttons.
    // We build a temporary div and assign textContent for each line to mitigate injection risk.
    const wrapper=document.createElement('div'); wrapper.style.fontSize='12px';
    const lines=[
      ['ê³ ìœ ë²ˆí˜¸:', r.id||''],
      ['ì‹œì„¤ëª…:',   r.name||''],
      ['êµ¬ë¶„ì£¼ì†Œ:', r.addr||''],
      ['ìë©´ë™:',   (r.emd||'')+ ' Â· êµ°ì§‘: '+ (r.grp||'')]
    ];
    lines.forEach(([label,value])=>{
      const p=document.createElement('div');
      const b=document.createElement('b'); b.textContent=label;
      const span=document.createElement('span'); span.textContent=' '+value;
      p.appendChild(b); p.appendChild(span);
      wrapper.appendChild(p);
    });
    // ì•¡ì…˜ ë²„íŠ¼ë“¤ - ì¶”ê°€/ì œê±°
    const addBtn=document.createElement('button'); addBtn.className='btn btn-sky'; addBtn.setAttribute('data-act','add'); addBtn.textContent='ì¶”ê°€';
    const remBtn=document.createElement('button'); remBtn.className='btn btn-accent'; remBtn.setAttribute('data-act','remove'); remBtn.textContent='ì œê±°';
    const btnWrap=document.createElement('div'); 
    btnWrap.style.marginTop = '8px';
    btnWrap.appendChild(addBtn); 
    btnWrap.appendChild(document.createTextNode(' ')); 
    btnWrap.appendChild(remBtn);
    wrapper.appendChild(btnWrap);
    
    // ê¸¸ì°¾ê¸° ë²„íŠ¼ë“¤ ì¶”ê°€ - ìœ„ë„/ê²½ë„ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ
    if(r.lat && r.lng && r.lat !== 0 && r.lng !== 0) {
      const navTitle = document.createElement('div');
      navTitle.style.marginTop = '10px';
      navTitle.style.marginBottom = '4px';
      navTitle.style.fontWeight = 'bold';
      navTitle.textContent = 'ê¸¸ì°¾ê¸°:';
      wrapper.appendChild(navTitle);
      
      const navWrap = document.createElement('div');
      navWrap.style.display = 'flex';
      navWrap.style.flexWrap = 'wrap';
      navWrap.style.gap = '4px';
      
      // ë„¤ë¹„ê²Œì´ì…˜ ì•± ë²„íŠ¼ë“¤
      const navApps = [
        {id: 'kakao', name: 'ì¹´ì¹´ì˜¤', color: '#FEE500', textColor: '#000'},
        {id: 'naver', name: 'ë„¤ì´ë²„', color: '#03C75A', textColor: '#fff'},
        {id: 'tmap', name: 'í‹°ë§µ', color: '#FF0000', textColor: '#fff'},
        {id: 'google', name: 'êµ¬ê¸€', color: '#4285F4', textColor: '#fff'},
        {id: 'apple', name: 'ì• í”Œ', color: '#000', textColor: '#fff'}
      ];
      
      navApps.forEach(app => {
        const navBtn = document.createElement('button');
        navBtn.style.padding = '4px 8px';
        navBtn.style.fontSize = '11px';
        navBtn.style.border = 'none';
        navBtn.style.borderRadius = '4px';
        navBtn.style.backgroundColor = app.color;
        navBtn.style.color = app.textColor;
        navBtn.style.cursor = 'pointer';
        navBtn.textContent = app.name;
        navBtn.setAttribute('data-nav', app.id);
        navBtn.setAttribute('data-lat', r.lat);
        navBtn.setAttribute('data-lng', r.lng);
        navBtn.setAttribute('data-name', r.name || r.addr || 'ëª©ì ì§€');
        navWrap.appendChild(navBtn);
      });
      
      wrapper.appendChild(navWrap);
    }
    return wrapper.outerHTML;
  }

  function applySelectedStyle(id){
    const m=markersById.get(id); if(!m) return;
    const el=m.getElement(); if(!el) return;
    const box=el.firstChild; if(!box) return;
    if(selectedIds.has(id)) box.classList.add('sel'); else box.classList.remove('sel');
  }

  function filtered(){
    const pass = rows.filter(r=>{
      const missing=(r.lat==null||r.lng==null||Number.isNaN(r.lat)||Number.isNaN(r.lng)||r.lat===0||r.lng===0);
      const passCoord = includeRelax || !missing;
      const passGrp = selGrp.size===0 || selGrp.has(String(r.grp));
      const passEmd = selEmd.size===0 || selEmd.has(String(r.emd));
      const passUn  = (!$('#onlyUninspected').checked) || isBlank(r.date);
      return passCoord && passGrp && passEmd && passUn;
    });
    return pass;
  }

  function render(fit){
    groupLayer.clearLayers(); markersById.clear();
    const pts=[];
    for(const r of filtered()){
      if(!isFinite(r.lat) || !isFinite(r.lng) || r.lat===0 || r.lng===0) continue;
      const m=L.marker([r.lat,r.lng],{icon:L.divIcon({html:markerHtml(labelFor(r)),className:"",iconSize:null})});
      m.bindTooltip(tooltipHtml(r),{sticky:true});
      m.bindPopup(popupHtml(r));
      // When the popup opens, wire up the Add/Remove buttons and Navigation buttons.
      m.on('popupopen', e=>{
        const el = e.popup.getElement();
        const addBtn = el.querySelector('[data-act="add"]');
        const remBtn = el.querySelector('[data-act="remove"]');
        if(addBtn) addBtn.onclick = () => {
          // r may be a shallow copy; fetch the canonical record from rowsById if available
          const rec = rowsById.get(String(r.id)) || r;
          addToSel(rec);
          m.closePopup();
        };
        if(remBtn) remBtn.onclick = () => {
          removeFromSel(String(r.id));
          m.closePopup();
        };
        
        // ê¸¸ì°¾ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
        const navBtns = el.querySelectorAll('[data-nav]');
        navBtns.forEach(btn => {
          btn.onclick = () => {
            const app = btn.getAttribute('data-nav');
            const lat = btn.getAttribute('data-lat');
            const lng = btn.getAttribute('data-lng');
            const name = btn.getAttribute('data-name');
            // ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ í˜¸ì¶œ - ì‚¬ìš©ì ì•¡ì…˜ìœ¼ë¡œ ì‹¤í–‰ë¨
            openNav(app, lat, lng, name);
            m.closePopup();
          };
        });
      });
      m.on('mouseover', ()=>{const el=m.getElement(); if(el) el.firstChild.classList.add('hover');});
      m.on('mouseout',  ()=>{const el=m.getElement(); if(el) el.firstChild.classList.remove('hover');});
      m.addTo(groupLayer); pts.push([r.lat,r.lng]);
      const id=String(r.id); markersById.set(id, m);
      setTimeout(()=>applySelectedStyle(id),0);
    }
    updateBadgesAfter();
    if(fit && pts.length) map.fitBounds(L.latLngBounds(pts).pad(0.2));
  }

  function updateBadgesBase(){
    const t=rows.length, miss=rows.filter(r=>r.lat==null||r.lng==null||Number.isNaN(r.lat)||Number.isNaN(r.lng)||r.lat===0||r.lng===0).length;
    $("#bTotal").textContent=`ì´: ${t}`; $("#bMissing").textContent=`ì¢Œí‘œì—†ìŒ: ${miss}`;
  }
  function updateBadgesAfter(){
    const a=filtered(); const shown=a.filter(r=>isFinite(r.lat)&&isFinite(r.lng)&&r.lat!==0&&r.lng!==0).length;
    $("#bShown").textContent=`í‘œì‹œ: ${shown}`; $("#bFiltered").textContent=`í•„í„°ì œì™¸: ${Math.max(0, rows.length - a.length)}`;
  }

  /* selection table */
  function openSel(){ $("#selPanel").style.display='block' }
  function addToSel(r){
    openSel();
    const id=String(r.id);
    if(selectedIds.has(id)) return;
    selectedIds.add(id); applySelectedStyle(id);
    const tr=document.createElement('tr'); tr.draggable=true; tr.dataset.id=id;
    tr.innerHTML=`<td>${r.id||""}</td>
                  <td>${r.name||""}</td>
                  <td>${r.addr||""}</td>
                  <td>${r.grp||""}</td>
                  <td>${isFinite(r.lat)?r.lat:""}</td>
                  <td>${isFinite(r.lng)?r.lng:""}</td>
                  <td><input type="number" class="routeOrder" value="" min="1" style="width:60px"></td>
                  <td class="row-actions">
                    <span class="btn-del">âŒ</span>
                    ${(r.lat && r.lng && r.lat !== 0 && r.lng !== 0) ? `<span class="btn-nav" data-lat="${r.lat}" data-lng="${r.lng}" data-name="${(r.name || r.addr || 'ëª©ì ì§€').replace(/"/g, '&quot;')}" title="ê¸¸ì°¾ê¸°">ğŸ§­</span>` : ''}
                  </td>`;
    tr.addEventListener('dblclick', ()=>removeRow(tr));
    tr.addEventListener('dragstart', e=>{tr.classList.add('dragging'); e.dataTransfer.setData('text/plain','row');});
    tr.addEventListener('dragend', ()=>tr.classList.remove('dragging'));
    $("#selBody").appendChild(tr);

    // ì„ íƒ ëª©ë¡ì— ì¶”ê°€í•œ í›„ ì¼ì¼ ìµœëŒ€ í¬ì¸íŠ¸ ê°’ì„ í˜„ì¬ ì„ íƒëœ ê°œìˆ˜ë¡œ ê°±ì‹ í•˜ê³ , 2ê°œ ì´ìƒì¼ ê²½ìš° ì¦‰ì‹œ ê²½ë¡œë¥¼ ì¬ê³„ì‚°í•©ë‹ˆë‹¤.
    try {
      const rows=document.querySelectorAll('#selBody tr');
      const daily=document.getElementById('dailyMax');
      if(daily){ daily.value = rows.length.toString(); }
      if(rows.length>=2){
        // skip auto-fill during manual addition so existing selections are preserved
        if(!isComputing) computeRoute(true);
      }else{
        // 1ê°œ ì´í•˜ì¼ ë•ŒëŠ” ê¸°ì¡´ ê²½ë¡œë¥¼ ì§€ìš°ê³  í†µê³„ ì´ˆê¸°í™”
        drawRoute([]);
        document.getElementById('routeStat').textContent='ê±°ë¦¬: - / ì‹œê°„: -';
      }
    } catch(_){ /* ignore errors */ }
  }

  // Remove a point from the selection table by its id.  This helper searches the
  // table body for a row with a matching data-id attribute and uses removeRow
  // to delete it.  If the id is not found, nothing happens.  After removal
  // computeRoute will be triggered via removeRow.
  function removeFromSel(id){
    const body = document.getElementById('selBody');
    if(!body) return;
    const tr = Array.from(body.querySelectorAll('tr')).find(tr => String(tr.dataset.id) === String(id));
    if(tr) removeRow(tr);
  }
  function removeRow(tr){
    const id=String(tr.dataset.id);
    selectedIds.delete(id);
    applySelectedStyle(id);
    tr.remove();
    // Remaining rows and daily max update
    const remaining = document.querySelectorAll('#selBody tr');
    const daily=document.getElementById('dailyMax');
    if(daily){ daily.value = remaining.length.toString(); }
    // Recompute route if two or more points remain; otherwise clear route and stats
    if(remaining.length >= 2){
      // skip auto-fill during manual removal
      if(!isComputing) computeRoute(true);
    }else{
      drawRoute([]);
      document.getElementById('routeStat').textContent='ê±°ë¦¬: - / ì‹œê°„: -';
    }
  }

  // Allow sorting of the selection list by the route order column.  Clicking the
  // route header toggles between ascending and descending numeric order.  After
  // sorting, the route is recomputed (without auto-fill) so the blue polyline
  // remains accurate.
  (function enableRouteSort(){
    const header=document.getElementById('routeHeader');
    if(!header) return;
    let asc=true;
    header.addEventListener('click', ()=>{
      const body=document.getElementById('selBody');
      const rows=Array.from(body.querySelectorAll('tr'));
      rows.sort((a,b)=>{
        const aval=parseInt(a.querySelector('input.routeOrder')?.value||'')||0;
        const bval=parseInt(b.querySelector('input.routeOrder')?.value||'')||0;
        return asc? aval - bval : bval - aval;
      });
      rows.forEach(tr=>body.appendChild(tr));
      asc=!asc;
      // reassign selectedIds order and recompute route without auto-fill
      if(rows.length>=2){
        if(!isComputing) computeRoute(true);
      }
    });
  })();
  $("#selBody").addEventListener('click', e=>{ 
    if(e.target.classList.contains('btn-del')) {
      removeRow(e.target.closest('tr')); 
    } else if(e.target.classList.contains('btn-nav')) {
      // ì„ íƒ ëª©ë¡ì˜ ê¸¸ì°¾ê¸° ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬ - ë“œë¡­ë‹¤ìš´ ë©”ë‰´ í‘œì‹œ
      const lat = e.target.getAttribute('data-lat');
      const lng = e.target.getAttribute('data-lng');  
      const name = e.target.getAttribute('data-name');
      
      // ê¸°ì¡´ ë“œë¡­ë‹¤ìš´ ì œê±°
      document.querySelectorAll('.nav-dropdown').forEach(el => el.remove());
      
      // ë“œë¡­ë‹¤ìš´ ë©”ë‰´ ìƒì„±
      const dropdown = document.createElement('div');
      dropdown.className = 'nav-dropdown';
      dropdown.style.cssText = `
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        z-index: 10000;
        padding: 4px;
        min-width: 120px;
      `;
      
      const navApps = [
        {id: 'kakao', name: 'ì¹´ì¹´ì˜¤', color: '#FEE500', textColor: '#000'},
        {id: 'naver', name: 'ë„¤ì´ë²„', color: '#03C75A', textColor: '#fff'},
        {id: 'tmap', name: 'í‹°ë§µ', color: '#FF0000', textColor: '#fff'},
        {id: 'google', name: 'êµ¬ê¸€', color: '#4285F4', textColor: '#fff'},
        {id: 'apple', name: 'ì• í”Œ', color: '#000', textColor: '#fff'}
      ];
      
      navApps.forEach(app => {
        const btn = document.createElement('button');
        btn.style.cssText = `
          display: block;
          width: 100%;
          padding: 6px 8px;
          margin: 2px 0;
          border: none;
          border-radius: 3px;
          background: ${app.color};
          color: ${app.textColor};
          cursor: pointer;
          font-size: 12px;
        `;
        btn.textContent = app.name;
        btn.onclick = () => {
          openNav(app.id, lat, lng, name);
          dropdown.remove();
        };
        dropdown.appendChild(btn);
      });
      
      // ë“œë¡­ë‹¤ìš´ ìœ„ì¹˜ ê³„ì‚°
      const rect = e.target.getBoundingClientRect();
      dropdown.style.left = (rect.left - 60) + 'px';
      dropdown.style.top = (rect.bottom + 5) + 'px';
      
      document.body.appendChild(dropdown);
      
      // ì™¸ë¶€ í´ë¦­ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
      setTimeout(() => {
        document.addEventListener('click', function closeDropdown(evt) {
          if (!dropdown.contains(evt.target)) {
            dropdown.remove();
            document.removeEventListener('click', closeDropdown);
          }
        });
      }, 0);
    }
  });
  $("#selBody").addEventListener('dragover', e=>{
    e.preventDefault();
    const dragging=$("#selBody tr.dragging");
    const elsib=Array.from($("#selBody").querySelectorAll('tr:not(.dragging)'));
    const after=elsib.reduce((best,ch)=>{const b=ch.getBoundingClientRect(); const o=e.clientY-b.top-b.height/2; return (o<0&&o>best.offset)?{offset:o,element:ch}:best;},{offset:-Infinity}).element;
    if(!after) $("#selBody").appendChild(dragging); else $("#selBody").insertBefore(dragging, after);
  });
  (function colResize(){
    const table=$("#selTable"); const cols=$("#tblCols").children;
    let startX,startW,colIdx,drag=false;
    table.addEventListener('mousedown', e=>{
      if(!e.target.classList.contains('th-resizer')) return;
      colIdx=parseInt(e.target.getAttribute('data-col')); if(isNaN(colIdx)) return;
      drag=true; startX=e.clientX; startW=parseInt(cols[colIdx].style.width)||table.tHead.rows[0].cells[colIdx].offsetWidth;
      document.body.style.cursor='col-resize';
      window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
      e.preventDefault();
    });
    function onMove(e){ if(!drag) return; const w=Math.max(60,startW+(e.clientX-startX)); cols[colIdx].style.width=w+'px'; }
    function onUp(){ drag=false; document.body.style.cursor=''; window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); }
  })();

 /* íŒ¨ë„ ê°€ì¥ìë¦¬ ë¦¬ì‚¬ì´ì¦ˆ */
  (function edgeResize(){
    const p = $("#selPanel");
    const minW=360, minH=220;
    let resizing=false, edge='', sx=0, sy=0, sw=0, sh=0;
    function start(e, which){
      resizing=true; edge=which; sx=e.clientX; sy=e.clientY; sw=p.offsetWidth; sh=p.offsetHeight;
      document.body.style.cursor = (which==='left'||which==='right')?'ew-resize':'ns-resize';
      window.addEventListener('mousemove', move); window.addEventListener('mouseup', stop);
      e.preventDefault();
    }
    function move(e){
      if(!resizing) return;
      if(edge==='left'){ const dx = sx - e.clientX; p.style.width = Math.max(minW, sw + dx)+'px'; }
      else if(edge==='right'){ const dx = e.clientX - sx; p.style.width = Math.max(minW, sw + dx)+'px'; }
      else if(edge==='top'){ const dy = sy - e.clientY; p.style.height = Math.max(minH, sh + dy)+'px'; }
      else if(edge==='bottom'){ const dy = e.clientY - sy; p.style.height = Math.max(minH, sh + dy)+'px'; }
    }
    function stop(){ resizing=false; edge=''; document.body.style.cursor=''; window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', stop); }
    p.querySelector('.e-left').addEventListener('mousedown', e=>start(e,'left'));
    p.querySelector('.e-right').addEventListener('mousedown', e=>start(e,'right'));
    p.querySelector('.e-top').addEventListener('mousedown', e=>start(e,'top'));
    p.querySelector('.e-bottom').addEventListener('mousedown', e=>start(e,'bottom'));
  })();

  /* íŒ¨ë„ í—¤ë” ë“œë˜ê·¸ ì´ë™ + ë”ë¸”í´ë¦­ ì´ˆê¸° ìœ„ì¹˜ ë³µì› */
  (function panelDrag(){
    const p = $("#selPanel");
    const head = p.querySelector('.head');
    let dragging=false, sx=0, sy=0, sl=0, st=0;
    head.addEventListener('mousedown', e=>{
      dragging=true;
      const r=p.getBoundingClientRect();
      sx=e.clientX; sy=e.clientY; sl=r.left; st=r.top;
      p.style.left = r.left+'px'; p.style.top = r.top+'px';
      p.style.right=''; p.style.bottom='';
      document.body.style.userSelect='none';
      e.preventDefault();
    });
    window.addEventListener('mousemove', e=>{
      if(!dragging) return;
      const dx=e.clientX-sx, dy=e.clientY-sy;
      p.style.left=(sl+dx)+'px';
      p.style.top =(st+dy)+'px';
    });
    window.addEventListener('mouseup', ()=>{ if(!dragging) return; dragging=false; document.body.style.userSelect=''; });
    head.addEventListener('dblclick', ()=>{ p.style.width=''; p.style.height=''; p.style.left=''; p.style.top=''; p.style.right='16px'; p.style.bottom='90px'; });
  })();


  /* route drawing */
  function getSelectedPoints(){
    const arr=[];
    $$("#selBody tr").forEach(tr=>{
      const t=Array.from(tr.querySelectorAll('td'));
      const id=(t[0]?.innerText||"").trim();
      const lat=parseFloat(t[4]?.innerText||""); const lng=parseFloat(t[5]?.innerText||"");
      if(isFinite(lat)&&isFinite(lng)) arr.push({id,lat,lng});
    });
    return arr;
  }
  function drawRouteLatLngs(latlngs){
    routeLayer.clearLayers();
    if(latlngs.length>=2){
      L.polyline(latlngs,{color:'#1064e8',weight:3,opacity:0.9}).addTo(routeLayer);
      map.fitBounds(L.latLngBounds(latlngs).pad(0.2));
    }
  }
  function drawRoute(orderIds){
    routeLayer.clearLayers();
    if(!orderIds || orderIds.length<2) return;
    const pts=getSelectedPoints();
    const latlngs=[];
    orderIds.forEach(id=>{
      const pt = pts.find(p=>String(p.id)===String(id));
      if(pt) latlngs.push([pt.lat, pt.lng]);
    });
    drawRouteLatLngs(latlngs);
  }
  /*
   * Compute geodesic distance between two latitude/longitude points using the
   * haversine formula.  Returns the distance in kilometres.  This replaces
   * the previous Euclidean distance approximation (degree squared), which
   * could significantly underâ€‘ or overâ€‘estimate route lengths when points are
   * far apart or near the poles.
   */
  function dist(a,b){
    // Earth radius in kilometres
    const R = 6371;
    const lat1 = a.lat * Math.PI / 180;
    const lat2 = b.lat * Math.PI / 180;
    const dLat = (b.lat - a.lat) * Math.PI / 180;
    const dLng = (b.lng - a.lng) * Math.PI / 180;
    const sinDLat = Math.sin(dLat / 2);
    const sinDLng = Math.sin(dLng / 2);
    const h = sinDLat * sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLng * sinDLng;
    return 2 * R * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h));
  }
  function nearestNeighbor(points){
    if(points.length===0) return [];
    const left=[...points]; const order=[];
    let cur=left.shift(); order.push(cur);
    while(left.length){
      let bestIdx=0, bestD=Infinity;
      for(let i=0;i<left.length;i++){ const d=dist(cur,left[i]); if(d<bestD){bestD=d; bestIdx=i;} }
      cur=left.splice(bestIdx,1)[0]; order.push(cur);
    }
    return order;
  }
  function twoOpt(order){
    function total(o){ let s=0; for(let i=0;i<o.length-1;i++) s+=dist(o[i],o[i+1]); return s; }
    let improved=true; let best=order.slice(); let bestCost=total(best);
    while(improved){
      improved=false;
      for(let i=1;i<best.length-2;i++){
        for(let k=i+1;k<best.length-1;k++){
          const newOrder = best.slice(0,i).concat(best.slice(i,k+1).reverse(), best.slice(k+1));
          const c=total(newOrder);
          if(c<bestCost){best=newOrder; bestCost=c; improved=true;}
        }
      }
    }
    return best;
  }

  /*
   * Compute Morton (Zâ€‘order) code for a latitude/longitude pair.  The latitude and
   * longitude are normalised to the range [0,1] and quantised to 15 bits before
   * interleaving.  Higher bit depths yield a more detailed ordering but are
   * unnecessary for a modest number of points.
   */
  function mortonCode(lat, lng){
    const latNorm=(lat+90)/180;
    const lngNorm=(lng+180)/360;
    const latInt=Math.min(32767,Math.max(0,Math.floor(latNorm*32767)));
    const lngInt=Math.min(32767,Math.max(0,Math.floor(lngNorm*32767)));
    let code=0;
    for(let i=0;i<15;i++){
      code |= ((lngInt>>i)&1)<<(2*i);
      code |= ((latInt>>i)&1)<<(2*i+1);
    }
    return code;
  }

  /*
   * Cluster engine: returns an ordered array of points by sorting them via their
   * Morton code and then applying nearest neighbour to refine local continuity.
   */
  function clusterOrder(points){
    if(!points || points.length<=2) return points.slice();
    const sorted=points.slice().sort((a,b)=>mortonCode(a.lat,a.lng)-mortonCode(b.lat,b.lng));
    return nearestNeighbor(sorted);
  }

  /*
   * Hilbert order: compute a Hilbert curve index for each point based on normalized lat/lng.
   * This implementation uses a simple bitwise algorithm to map two 16-bit coordinates into a 32-bit Hilbert index.
   */
  function hilbertIndex(x, y, bits=16){
    let rx, ry;
    let index = 0;
    for(let s=bits-1; s>=0; s--){
      rx = (x >> s) & 1;
      ry = (y >> s) & 1;
      index += (1 << (2*s)) * ((3 * rx) ^ ry);
      // rotate
      if(ry === 0){
        if(rx === 1){
          x = (1 << bits) - 1 - x;
          y = (1 << bits) - 1 - y;
        }
        const tmp = x; x = y; y = tmp;
      }
    }
    return index;
  }

  function hilbertOrder(points){
    if(!points || points.length<=2) return points.slice();
    let minLat=Infinity,maxLat=-Infinity,minLng=Infinity,maxLng=-Infinity;
    for(const p of points){ if(p.lat<minLat) minLat=p.lat; if(p.lat>maxLat) maxLat=p.lat; if(p.lng<minLng) minLng=p.lng; if(p.lng>maxLng) maxLng=p.lng; }
    const factor=(1<<16)-1;
    const arr=points.map(p=>{
      const x=Math.floor(((p.lng-minLng)/(maxLng-minLng+1e-9))*factor);
      const y=Math.floor(((p.lat-minLat)/(maxLat-minLat+1e-9))*factor);
      const h=hilbertIndex(x,y,16);
      return {h,id:p.id, lat:p.lat, lng:p.lng};
    });
    arr.sort((a,b)=>a.h-b.h);
    return arr.map(e=>{ return {id:e.id, lat:e.lat, lng:e.lng}; });
  }

  /*
   * k-means order: cluster points into approximately sqrt(n) clusters.
   */
  function kmeansOrder(points){
    const n=points.length;
    if(n<=2) return points.slice();
    const k=Math.max(1, Math.round(Math.sqrt(n)));
    // initialize centers with first k points
    const centers=points.slice(0,k).map(p=>({lat:p.lat,lng:p.lng}));
    let assignments=new Array(n).fill(0);
    for(let iter=0; iter<5; iter++){
      // assign points to nearest center
      for(let i=0;i<n;i++){
        let best=0; let bestDist=Infinity;
        for(let j=0;j<k;j++){
          const d=dist(points[i], centers[j]);
          if(d<bestDist){ bestDist=d; best=j; }
        }
        assignments[i]=best;
      }
      // recompute centers
      const sumLat=new Array(k).fill(0); const sumLng=new Array(k).fill(0); const count=new Array(k).fill(0);
      for(let i=0;i<n;i++){
        const c=assignments[i]; sumLat[c]+=points[i].lat; sumLng[c]+=points[i].lng; count[c]++;
      }
      for(let j=0;j<k;j++){
        if(count[j]>0){ centers[j].lat=sumLat[j]/count[j]; centers[j].lng=sumLng[j]/count[j]; }
      }
    }
    // cluster arrays
    const clusters=Array.from({length:k},()=>[]);
    for(let i=0;i<n;i++) clusters[assignments[i]].push(points[i]);
    // order clusters by nearest neighbour of centers
    const centerOrder=nearestNeighbor(centers);
    const result=[];
    for(const idx of centerOrder){
      const cl=clusters[idx];
      const seq=nearestNeighbor(cl);
      result.push(...seq);
    }
    return result;
  }

  async function computeRoute(skipAutoFill=false){
    // ì´ë¯¸ ê³„ì‚° ì¤‘ì´ë©´ ì¤‘ë³µ í˜¸ì¶œì„ ë°©ì§€í•©ë‹ˆë‹¤
    if(isComputing) return;
    isComputing = true;
    try{
    // optional auto-fill (only when skipAutoFill is false)
    if(!skipAutoFill && $('#autoFill').checked){
      const candidates = filtered().filter(r=>isFinite(r.lat)&&isFinite(r.lng));
      const max = Math.max(1, parseInt($('#dailyMax').value)||999);
      // overwrite
      $("#selBody").innerHTML=''; selectedIds.clear();
      for(const r of candidates.slice(0,max)){ addToSel(r); }
    }

    const pts=getSelectedPoints(); if(pts.length<2){alert("ì„ íƒëª©ë¡ì— 2ê°œ ì´ìƒì´ í•„ìš”í•©ë‹ˆë‹¤."); return;}
    const engine=$('#engine').value;
    // If using cluster engine, compute order using Morton code + nearest neighbour and draw route directly
    if(engine==='cluster' || engine==='hilbert' || engine==='kmeans'){
      let order=[];
      let label="";
      if(engine==='cluster'){ order = clusterOrder(pts); label='í´ëŸ¬ìŠ¤í„°'; }
      else if(engine==='hilbert'){ order = hilbertOrder(pts); label='íë²„íŠ¸'; }
      else if(engine==='kmeans'){ order = kmeansOrder(pts); label='K-í‰ê· '; }
      // write back route numbers to selection table
      const idToIdx=new Map(order.map((p,i)=>[String(p.id), i+1]));
      $$("#selBody tr").forEach(tr=>{
        const id=(tr.querySelector('td')?.innerText||"").trim();
        const inp=tr.querySelector('input.routeOrder'); if(!inp) return;
        inp.value = idToIdx.get(String(id))||"";
      });
      drawRoute(order.map(p=>p.id));
      // compute distance/time using haversine and display with label
      let totalDist=0;
      for(let i=0;i<order.length-1;i++){
        totalDist += dist(order[i], order[i+1]);
      }
      const km=totalDist;
      const avgSpeed=30;
      const minutes = km / avgSpeed * 60;
      $('#routeStat').textContent = `ê±°ë¦¬: ${km.toFixed(1)}km / ì‹œê°„: ${minutes.toFixed(0)}ë¶„ (${label})`;
      return;
    }

    if(engine==='osrm'){
      try{
        const server=$('#osrmServer').value.replace(/\/+$/,'');
        const profile=$('#osrmProfile').value;
        // Trip API for order
        const coords=pts.map(p=>`${p.lng},${p.lat}`).join(';');
        const roundtrip = $('#fixEnds').checked ? 'false' : 'true';
        const src = $('#fixEnds').checked ? 'first' : 'any';
        const dst = $('#fixEnds').checked ? 'last' : 'any';
        const url=`${server}/trip/v1/${profile}/${coords}?geometries=geojson&overview=full&roundtrip=${roundtrip}&source=${src}&destination=${dst}`;
        const res=await fetch(url);
        if(!res.ok) throw new Error('OSRM ì‘ë‹µ ì˜¤ë¥˜');
        const data=await res.json();
        if(!data.trips || !data.trips.length) throw new Error('ê²½ë¡œ ì—†ìŒ');
        const trip=data.trips[0];
        const orderIds = trip.waypoints.sort((a,b)=>a.waypoint_index-b.waypoint_index).map(wp=>pts[wp.trips_index??wp.waypoint_index]?.id ?? pts[wp.waypoint_index]?.id);
        drawRoute(orderIds);
        const m=(trip.distance||0)/1000; const t=(trip.duration||0)/60;
        $('#routeStat').textContent=`ê±°ë¦¬: ${m.toFixed(1)}km / ì‹œê°„: ${t.toFixed(0)}ë¶„ (OSRM)`;
        return;
      }catch(e){
        console.warn('OSRM ì‹¤íŒ¨, ë‚´ì¥ í´ë°± ì‚¬ìš©', e);
        $('#routeStat').textContent=`OSRM ì‹¤íŒ¨â†’ë‚´ì¥ í´ë°±`;
        // fallthrough to builtin
      }
    }

    // builtin
    const method=$("#routeMethod").value;
    let order=pts;
    if(method==='cluster'){
      order = clusterOrder(pts);
    }else if(method==='hilbert'){
      order = hilbertOrder(pts);
    }else if(method==='kmeans'){
      order = kmeansOrder(pts);
    }else if(method==='nn'){
      order = nearestNeighbor(pts);
    }else{
      // default to nearest neighbour + 2-opt for "ë¹ ë¥¸" and other unknown values
      order = twoOpt(nearestNeighbor(pts));
    }
    const idToIdx=new Map(order.map((p,i)=>[String(p.id), i+1]));
    $$("#selBody tr").forEach(tr=>{
      const id=(tr.querySelector('td')?.innerText||"").trim();
      const inp=tr.querySelector('input.routeOrder'); if(!inp) return;
      inp.value = idToIdx.get(String(id))||"";
    });
    drawRoute(order.map(p=>p.id));
    /* compute actual distance using haversine and estimate travel time.
       The original implementation simply labelled the result as a Euclidean approximation.
       This version sums the haversine distance between consecutive points to get a more realistic path length.
       Travel time is estimated assuming an average speed of 30 km/h (typical for urban driving) */
    let totalDist=0;
    for(let i=0;i<order.length-1;i++){
      totalDist += dist(order[i], order[i+1]);
    }
    const km = totalDist;
    const avgSpeed = 30; // km/h
    const minutes = km / avgSpeed * 60;
    $('#routeStat').textContent = `ê±°ë¦¬: ${km.toFixed(1)}km / ì‹œê°„: ${minutes.toFixed(0)}ë¶„ (ë‚´ì¥)`;
    } finally {
      isComputing = false;
    }
  }
  // When clicking the route button we want to allow auto-fill if enabled, so call computeRoute with skipAutoFill=false
  $("#btnRoute").addEventListener('click', ()=> computeRoute(false));
  $("#btnRouteClear").addEventListener('click', ()=>{ routeLayer.clearLayers(); $$(".routeOrder").forEach(i=>i.value=""); $('#routeStat').textContent='ê±°ë¦¬: - / ì‹œê°„: -'; });

  /* A/B pick */
  function enableAB(on){
    if(on){
      AB=[]; abMarkers.forEach(m=>m.remove()); abMarkers=[];
      $('#abInfo').textContent='A/B: ì§€ë„ì—ì„œ ë‘ ì§€ì ì„ í´ë¦­í•˜ì„¸ìš”';
      map.getContainer().style.cursor='crosshair';
      const handler=(e)=>{
        AB.push([e.latlng.lat, e.latlng.lng]);
        const m=L.circleMarker(e.latlng,{radius:8,color:'#EA580C'}).addTo(routeLayer); abMarkers.push(m);
        $('#abInfo').textContent=`A/B: ${AB.length}ê°œ ì„ íƒ`;
        if(AB.length===2){ map.off('click', handler); map.getContainer().style.cursor=''; abRoute(); }
      };
      map.on('click', handler);
      $('#btnABReset').onclick=()=>{ map.off('click', handler); map.getContainer().style.cursor=''; AB=[]; abMarkers.forEach(m=>m.remove()); abMarkers=[]; $('#abInfo').textContent='A/B: -'; };
    }else{
      AB=[]; abMarkers.forEach(m=>m.remove()); abMarkers=[]; $('#abInfo').textContent='A/B: -';
    }
  }
  async function abRoute(){
    if(AB.length<2) return;
    const engine=$('#engine').value;
    if(engine==='osrm'){
      try{
        const server=$('#osrmServer').value.replace(/\/+$/,'');
        const profile=$('#osrmProfile').value;
        const coords=[AB[0],AB[1]].map(p=>`${p[1]},${p[0]}`).join(';');
        const url=`${server}/route/v1/${profile}/${coords}?geometries=geojson&overview=full`;
        const res=await fetch(url);
        if(!res.ok) throw new Error('OSRM ì‘ë‹µ ì˜¤ë¥˜');
        const data=await res.json();
        const r=data.routes?.[0];
        if(!r) throw new Error('ê²½ë¡œ ì—†ìŒ');
        drawRouteLatLngs(r.geometry.coordinates.map(c=>[c[1],c[0]]));
        const m=(r.distance||0)/1000; const t=(r.duration||0)/60;
        $('#routeStat').textContent=`ê±°ë¦¬: ${m.toFixed(1)}km / ì‹œê°„: ${t.toFixed(0)}ë¶„ (A/B OSRM)`;
        return;
      }catch(e){
        console.warn('OSRM A/B ì‹¤íŒ¨', e);
        $('#routeStat').textContent=`OSRM ì‹¤íŒ¨(A/B)`;
      }
    }else{
      // straight line
      drawRouteLatLngs(AB.map(p=>[p[0],p[1]]));
      const R=(a,b)=>Math.sqrt(Math.pow(a[0]-b[0],2)+Math.pow(a[1]-b[1],2))*111; // rough km
      const m=R(AB[0],AB[1]);
      $('#routeStat').textContent=`ì§ì„  ê±°ë¦¬: ~${m.toFixed(1)}km (ë‚´ì¥)`;
    }
  }
  $('#btnPickAB').addEventListener('click', ()=>enableAB(true));
  $('#btnABReset').addEventListener('click', ()=>enableAB(false));

  /* panel patch + hover shield */
  (function selPanelPatch(){
    const p = $("#selPanel");
    // edges
    ["left","right","top","bottom"].forEach(k=>{
      const d=document.createElement("div"); d.className="edge e-"+k; p.appendChild(d);
    });
    const head = p.querySelector(".head");
    let dragging=false, sx=0, sy=0, sl=0, st=0;
    head.addEventListener("pointerdown", e=>{
      if(/BUTTON|A|INPUT|SELECT|TEXTAREA/.test(e.target.tagName)) return;
      dragging=true; p.classList.add("dragging");
      const r=p.getBoundingClientRect();
      sx=e.clientX; sy=e.clientY; sl=r.left; st=r.top;
      p.style.left=r.left+"px"; p.style.top=r.top+"px";
      p.style.right=""; p.style.bottom="";
      p.setPointerCapture(e.pointerId);
    });
    head.addEventListener("pointermove", e=>{
      if(!dragging) return;
      const dx=e.clientX-sx, dy=e.clientY-sy;
      p.style.left=(sl+dx)+"px"; p.style.top =(st+dy)+"px";
    });
    head.addEventListener("pointerup", e=>{
      if(!dragging) return;
      dragging=false; p.classList.remove("dragging");
      try{p.releasePointerCapture(e.pointerId);}catch(_){}
    });
    head.addEventListener("dblclick", ()=>{
      p.style.width=""; p.style.height="";
      p.style.left=""; p.style.top="";
      p.style.right="16px"; p.style.bottom="90px";
    });

    const minW=360, minH=180;
    let resizing=false, eg="", sx2=0, sy2=0, sw=0, sh=0, sl2=0, st2=0;
    function startResize(e, which){
      resizing=true; eg=which; p.classList.add("resizing");
      const r=p.getBoundingClientRect();
      sx2=e.clientX; sy2=e.clientY; sw=r.width; sh=r.height; sl2=r.left; st2=r.top;
      p.style.left=sl2+"px"; p.style.top=st2+"px";
      p.style.right=""; p.style.bottom="";
      p.setPointerCapture(e.pointerId);
      e.preventDefault();
    }
    function doResize(e){
      if(!resizing) return;
      const dx=e.clientX-sx2, dy=e.clientY-sy2;
      if(eg==="right"){ p.style.width=Math.max(minW, sw+dx)+"px"; }
      if(eg==="left"){  const w=Math.max(minW, sw-dx); p.style.width=w+"px"; p.style.left=(sl2+dx)+"px"; }
      if(eg==="bottom"){p.style.height=Math.max(minH, sh+dy)+"px"; }
      if(eg==="top"){   const h=Math.max(minH, sh-dy); p.style.height=h+"px"; p.style.top=(st2+dy)+"px"; }
    }
    function stopResize(e){
      if(!resizing) return;
      resizing=false; eg=""; p.classList.remove("resizing");
      try{p.releasePointerCapture(e.pointerId);}catch(_){}
    }
    p.querySelector(".e-left").addEventListener("pointerdown", ev=>startResize(ev,"left"));
    p.querySelector(".e-right").addEventListener("pointerdown", ev=>startResize(ev,"right"));
    p.querySelector(".e-top").addEventListener("pointerdown", ev=>startResize(ev,"top"));
    p.querySelector(".e-bottom").addEventListener("pointerdown", ev=>startResize(ev,"bottom"));
    p.addEventListener("pointermove", doResize);
    p.addEventListener("pointerup", stopResize);

    // *** CRITICAL: stop map interaction while hovering over panel ***
    function disableMapInteractions(){
      if(!map) return;
      map.dragging.disable(); map.scrollWheelZoom.disable(); map.doubleClickZoom.disable();
      map.touchZoom.disable(); map.boxZoom.disable(); map.keyboard.disable();
      if(L && L.DomEvent){
        L.DomEvent.disableClickPropagation(p);
        L.DomEvent.disableScrollPropagation(p);
      }
    }
    function enableMapInteractions(){
      if(!map) return;
      map.dragging.enable(); map.scrollWheelZoom.enable(); map.doubleClickZoom.enable();
      map.touchZoom.enable(); map.boxZoom.enable(); map.keyboard.enable();
    }
    p.addEventListener('mouseenter', disableMapInteractions);
    p.addEventListener('mouseleave', enableMapInteractions);
  })();

  /* buttons & binds */
  function bind(){
    // rail icon -> open section
    $$("#rail .icbtn").forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const target = btn.getAttribute('data-target'); const sec = target? document.querySelector(target): null;
        const opened = btn.classList.contains('active');
        $$("#rail .icbtn").forEach(b=>b.classList.remove('active'));
        if(opened){
          setVar('--side-w','0px'); $("#lhs").style.display='none';
        } else{
          setVar('--side-w','380px'); $("#lhs").style.display='block'; btn.classList.add('active');
          if(sec){
            document.querySelectorAll('#lhs section details').forEach(d=>d.open=false);
            sec.querySelector('details').open=true; sec.scrollIntoView({behavior:"smooth",block:"start"});
          }
        }
        setTimeout(()=>map.invalidateSize(),150);
      });
    });

    $("#btnToggleLeft").onclick=()=>{
      const open = getComputedStyle($("#lhs")).display!=='none';
      if(open){ setVar('--side-w','0px'); $("#lhs").style.display='none'; }
      else{ setVar('--side-w','380px'); $("#lhs").style.display='block'; }
      setTimeout(()=>map.invalidateSize(),150);
    };

    // files
    $("#file").addEventListener('change', async e=>{const f=e.target.files[0]; if(!f) return; await readFile(f);});
    $("#apply").addEventListener('click', toRowsManual);

    // search
    function runSearchApply(){ scopeTerm=$("#searchScope").value.trim(); rebuildFilterBoxes(false); render(true); }
    $("#searchScope").addEventListener('keydown', e=>{ if(e.key==="Enter") runSearchApply(); });
    $("#btnClearScope").addEventListener('click', ()=>{ $("#searchScope").value=''; scopeTerm=""; rebuildFilterBoxes(true); render(true); });
    $("#toggleCoordRelax").addEventListener('change', e=>{ includeRelax=e.target.checked; render(true); });
    $("#onlyUninspected").addEventListener('change', ()=>render(true));

    function syncChips(boxId){
      document.querySelector(`#${boxId}`).addEventListener('change', e=>{
        if(e.target.name==='grp' || e.target.name==='emd'){
          const val=decodeURIComponent(e.target.value);
          if(e.target.name==='grp'){ if(e.target.checked) selGrp.add(val); else selGrp.delete(val); }
          else{ if(e.target.checked) selEmd.add(val); else selEmd.delete(val); }
          refreshToggleStates(); render(true);
        }
      });
    }
    syncChips('grpBox'); syncChips('emdBox');

    // chip helpers
    $("#btnFilterAll").addEventListener('click', ()=>{
      const gi=$$('#grpChips input'); const ei=$$('#emdChips input');
      gi.forEach(x=>x.checked=true); ei.forEach(x=>x.checked=true);
      selGrp=new Set(gi.map(x=>decodeURIComponent(x.value)));
      selEmd=new Set(ei.map(x=>decodeURIComponent(x.value)));
      refreshToggleStates(); render(true);
    });
    $("#btnFilterNone").addEventListener('click', ()=>{
      $$('#grpChips input').forEach(x=>x.checked=false); $$('#emdChips input').forEach(x=>x.checked=false);
      selGrp=new Set(); selEmd=new Set(); refreshToggleStates(); render(true);
    });

    // labels/marker style
    $("#labelSrc").addEventListener('change', ()=>render(false));
    $("#markerStyle").addEventListener('change', ()=>render(false));

    // scale shortcuts
    function setScaleMeters(m){
      const center=map.getCenter(); const px=map.getSize().x*(1/3);
      const target=m/px; const zoom=Math.log2(156543.03392*Math.cos(center.lat*Math.PI/180)/target);
      map.setZoom(zoom);
    }
    $$(".scale").forEach(b=>b.addEventListener('click',()=>setScaleMeters(parseInt(b.dataset.m,10)||500)));

    // map toolbar
    $("#btnFit").onclick=()=>{
      const pts=[]; routeLayer.eachLayer(l=>{ if(l.getLatLngs){ try{ pts.push(...l.getLatLngs()); }catch(_){} } });
      if(!pts.length){ groupLayer.eachLayer(l=>{if(l.getLatLng) pts.push(l.getLatLng());}); }
      if(pts.length) map.fitBounds(L.latLngBounds(pts).pad(0.2));
    };
    $("#btnRefresh").onclick=()=>render(true);
    $("#btnToggleSel").onclick=()=>{ 
      const p=$("#selPanel"); 
      const wasHidden = p.style.display !== 'block';
      p.style.display=(p.style.display==='block'?'none':'block');
      
      // íŒ¨ë„ì„ ì—´ ë•Œ í™”ë©´ ì¤‘ì•™ìœ¼ë¡œ ìœ„ì¹˜ ì¡°ì •
      if (wasHidden && p.style.display === 'block') {
        setTimeout(() => centerSelectionPanel(), 100);
      }
    };

    // ìƒë‹¨ ì§€ë„ ì»¨íŠ¸ë¡¤ ë²„íŠ¼: ê¸°ì¡´ ê¸°ëŠ¥ì„ í˜¸ì¶œí•˜ë„ë¡ ë°”ì¸ë”©
    if($("#btnFitTop")){
      $("#btnFitTop").addEventListener('click', ()=>{
        // ê¸°ì¡´ ë§ì¶¤ ë²„íŠ¼ê³¼ ë™ì¼í•œ ë™ì‘ ìˆ˜í–‰
        $("#btnFit").onclick();
      });
    }
    if($("#btnRefreshTop")){
      $("#btnRefreshTop").addEventListener('click', ()=>{
        // ê¸°ì¡´ í•„í„° ì ìš© ë²„íŠ¼ê³¼ ë™ì¼í•œ ë™ì‘ ìˆ˜í–‰
        $("#btnRefresh").onclick();
      });
    }
    if($("#btnToggleSelTop")){
      $("#btnToggleSelTop").addEventListener('click', ()=>{
        // ê¸°ì¡´ ì„ íƒëª©ë¡ í† ê¸€ê³¼ ë™ì¼í•œ ë™ì‘ ìˆ˜í–‰
        $("#btnToggleSel").onclick();
        // ëª¨ë°”ì¼ì—ì„œ ì„ íƒëª©ë¡ì„ ì—´ ë•Œ í™”ë©´ ì¤‘ì•™ìœ¼ë¡œ ìœ„ì¹˜ ì¡°ì •
        setTimeout(() => {
          const panel = $("#selPanel");
          if (panel && panel.style.display === 'block') {
            centerSelectionPanel();
          }
        }, 100);
      });
    }
    
    // ì„ íƒëª©ë¡ íŒ¨ë„ì„ í™”ë©´ ì¤‘ì•™ìœ¼ë¡œ ì´ë™ì‹œí‚¤ëŠ” í•¨ìˆ˜
    function centerSelectionPanel() {
      const panel = $("#selPanel");
      if (!panel) return;
      
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      const panelRect = panel.getBoundingClientRect();
      
      // ëª¨ë°”ì¼/íƒœë¸”ë¦¿ ê°ì§€
      const isMobile = viewportWidth <= 768;
      const isTablet = viewportWidth > 768 && viewportWidth <= 1024;
      
      if (isMobile) {
        // ëª¨ë°”ì¼: í™”ë©´ ì¤‘ì•™, ì ì ˆí•œ í¬ê¸°ë¡œ ì¡°ì •
        const idealWidth = Math.min(350, viewportWidth - 32);
        const idealHeight = Math.min(400, viewportHeight - 120);
        
        panel.style.width = idealWidth + 'px';
        panel.style.height = idealHeight + 'px';
        panel.style.left = ((viewportWidth - idealWidth) / 2) + 'px';
        panel.style.top = '80px';
        panel.style.right = 'auto';
        panel.style.bottom = 'auto';
      } else if (isTablet) {
        // íƒœë¸”ë¦¿: í™”ë©´ ì¤‘ì•™, ë” í° í¬ê¸°
        const idealWidth = Math.min(500, viewportWidth - 64);
        const idealHeight = Math.min(500, viewportHeight - 120);
        
        panel.style.width = idealWidth + 'px';
        panel.style.height = idealHeight + 'px';
        panel.style.left = ((viewportWidth - idealWidth) / 2) + 'px';
        panel.style.top = '80px';
        panel.style.right = 'auto';
        panel.style.bottom = 'auto';
      } else {
        // ë°ìŠ¤í¬í†±: ê¸°ë³¸ ìœ„ì¹˜ë¡œ ë³µì›
        panel.style.width = '640px';
        panel.style.height = '400px';
        panel.style.left = '';
        panel.style.top = '';
        panel.style.right = '16px';
        panel.style.bottom = '90px';
      }
    }

    // selection load
    $("#btnSelLoad").addEventListener('click', ()=>$("#selFile").click());
    $("#selFile").addEventListener('change', async e=>{
      const f=e.target.files[0]; if(!f) return;
      const name=f.name.toLowerCase();
      if(name.endsWith('.xlsx')||name.endsWith('.xlsm')||name.endsWith('.xls')){
        const buf=await f.arrayBuffer();
        const wb2=XLSX.read(new Uint8Array(buf),{type:"array"});
        const ws=wb2.Sheets[wb2.SheetNames[0]];
        const arr=XLSX.utils.sheet_to_json(ws);
        $("#selBody").innerHTML=''; selectedIds.clear();
        for(const r of arr){
          const id = r["ê³ ìœ ë²ˆí˜¸"] ?? r["id"] ?? r["ID"] ?? r["Id"];
          const base = rowsById.get(String(id)) || {};
          addToSel({id:String(id||""), name:r["ì‹œì„¤ëª…"]??base.name??"", addr:r["êµ¬ë¶„ì£¼ì†Œ"]??base.addr??"", grp:r["êµ°ì§‘"]??base.grp??"", lat:parseFloat(r["ìœ„ë„"]??base.lat), lng:parseFloat(r["ê²½ë„"]??base.lng)});
          const last=$("#selBody tr:last-child input.routeOrder"); if(last) last.value = r["ê²½ë¡œ"]||"";
        }
      }else{
        const txt=await f.text();
        const lines=txt.split(/\\r?\\n/).filter(Boolean);
        const head=lines.shift().split(/\\t|,/);
        const idx=(name)=>head.findIndex(h=>h.trim()===name);
        const iId=idx("ê³ ìœ ë²ˆí˜¸"), iName=idx("ì‹œì„¤ëª…"), iAddr=idx("êµ¬ë¶„ì£¼ì†Œ"), iGrp=idx("êµ°ì§‘"), iLat=idx("ìœ„ë„"), iLng=idx("ê²½ë„"), iRoute=idx("ê²½ë¡œ");
        $("#selBody").innerHTML=''; selectedIds.clear();
        for(const line of lines){
          const t=line.split(/\\t|,/);
          const id=t[iId]; const base=rowsById.get(String(id))||{};
          addToSel({id:String(id||""), name:t[iName]??base.name??"", addr:t[iAddr]??base.addr??"", grp:t[iGrp]??base.grp??"", lat:parseFloat(t[iLat]??base.lat), lng:parseFloat(t[iLng]??base.lng)});
          const last=$("#selBody tr:last-child input.routeOrder"); if(last) last.value = t[iRoute]||"";
        }
      }
      alert("ì„ íƒëª©ë¡ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
      e.target.value='';
    });

    // left width drag
    (function(){
      let dragging=false,sx,sw;
      $("#gut").addEventListener('mousedown',e=>{dragging=true;sx=e.clientX;sw=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--side-w'))||380; document.body.style.cursor='col-resize'; e.preventDefault();});
      window.addEventListener('mousemove',e=>{if(!dragging) return; const w=Math.min(640,Math.max(0, sw+(e.clientX-sx))); setVar('--side-w',w+'px'); $("#lhs").style.display = (w===0?'none':'block'); map.invalidateSize();});
      window.addEventListener('mouseup',()=>{if(dragging){dragging=false; document.body.style.cursor='';}});
    })();

    // PDF
    $("#btnPDFMap").onclick=async()=>{
      const {jsPDF}=window.jspdf; if(!jsPDF){alert("jsPDF ë¡œë” ì˜¤ë¥˜"); return;}
      const mapEl=$("#map");
      const scale=parseInt($("#capScale").value)||2;
      const canvas=await html2canvas(mapEl,{scale, useCORS:true, backgroundColor:"#ffffff"});
      const pdf=new jsPDF({orientation:'l',unit:'mm',format:'a4',compress:true});
      const pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight();
      const mg=5; const maxW=pageW-mg*2, maxH=pageH-mg*2, ratio=canvas.width/canvas.height;
      let w=maxW, h=maxW/ratio; if(h>maxH){h=maxH; w=maxH*ratio;}
      const x=(pageW-w)/2, y=(pageH-h)/2;
      pdf.addImage(canvas.toDataURL("image/jpeg",0.92),"JPEG",x,y,w,h,"","FAST");
      pdf.save("ì§€ë„.pdf");
    };
    $("#btnPDFScreen").onclick=async()=>{
      const {jsPDF}=window.jspdf; if(!jsPDF){alert("jsPDF ë¡œë” ì˜¤ë¥˜"); return;}
      const canvas=await html2canvas(document.body,{scale:parseInt($("#capScale").value)||2,useCORS:true,backgroundColor:"#ffffff"});
      const pdf=new jsPDF({orientation:($("#capOrient").value==='l'?'l':'p'),unit:'mm',format:'a4',compress:true});
      const pageW=pdf.internal.pageSize.getWidth(), pageH=pdf.internal.pageSize.getHeight();
      const mg=(parseFloat($("#capMargin").value)||0.7)*10;
      const maxW=pageW-mg*2, maxH=pageH-mg*2, ratio=canvas.width/canvas.height;
      let w=maxW, h=maxW/ratio; if(h>maxH){h=maxH; w=maxH*ratio;}
      const x=(pageW-w)/2, y=(pageH-h)/2;
      pdf.addImage(canvas.toDataURL("image/jpeg",0.92),"JPEG",x,y,w,h,"","FAST");
      pdf.save("í˜„ì¬í™”ë©´_ìº¡ì²˜.pdf");
    };
    $("#toggleBW").addEventListener('change',e=>{ document.body.classList.toggle('bw',e.target.checked); });

    $('#darkToggle').addEventListener('change', e=>{ document.body.classList.toggle('dark', e.target.checked); });
  }

  function updateFontVars(){ setVar('--tbl-font', tblFont+'px'); setVar('--flt-font', fltFont+'px'); setVar('--mk', mk+'px'); }

  function init(){
    setupMap(); bind();
    $("#btnTblUp").onclick=()=>{ tblFont=Math.min(18,++tblFont); updateFontVars(); };
    $("#btnTblDn").onclick=()=>{ tblFont=Math.max(10,--tblFont); updateFontVars(); };
    $("#btnFltUp").onclick=()=>{ fltFont=Math.min(18,++fltFont); updateFontVars(); };
    $("#btnFltDn").onclick=()=>{ fltFont=Math.max(11,--fltFont); updateFontVars(); };
    $("#btnMkUp").onclick =()=>{ mk=Math.min(44,mk+4); updateFontVars(); render(false); };
    $("#btnMkDn").onclick =()=>{ mk=Math.max(20,mk-4); updateFontVars(); render(false); };
  }
  return { init };
})();
</script><script>
(function(){
  const $ = (q,root=document)=>root.querySelector(q);
  const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));

  /* -----------------------------------------------------------
   * 1) ì„ íƒëª©ë¡ íŒ¨ë„: íŠ•ê¹€ ë°©ì§€(ì§€ë„ ìƒí˜¸ì‘ìš© ì°¨ë‹¨) + ë“œë˜ê·¸ + 4ë³€ ë¦¬ì‚¬ì´ì¦ˆ
   * ---------------------------------------------------------*/
  const panel = document.getElementById('selPanel');
  if(panel){
    // ë¦¬ì‚¬ì´ì¦ˆ ì—£ì§€ ì—†ìœ¼ë©´ ìƒì„±
    if(!panel.querySelector('.e-left')){
      ['left','right','top','bottom'].forEach(k=>{
        const d=document.createElement('div'); d.className='edge e-'+k; panel.appendChild(d);
      });
    }

    // ì§€ë„ ì°¨ë‹¨ ì‹¤ë“œ
    const map = document.getElementById('map');
    const shield = document.getElementById('mapShield');
    function showShield(){ if(map) shield.style.display='block'; }
    function hideShield(){ shield.style.display='none'; }
    // íŒ¨ë„ì— ë§ˆìš°ìŠ¤ ë“¤ì–´ì˜¤ë©´ ì§€ë„ ë“œë˜ê·¸/íœ /ë”ë¸”í´ë¦­ ëª¨ë‘ ì°¨ë‹¨
    function blockMapInteractions(){
      showShield();
      // íŒ¨ë„ ë‚´ë¶€ ìŠ¤í¬ë¡¤/íœ /í„°ì¹˜ë„ ì „íŒŒ ì°¨ë‹¨
      const stop = e=>{ e.preventDefault(); e.stopPropagation(); };
      panel.addEventListener('wheel', stop, {passive:false});
      panel.addEventListener('touchmove', stop, {passive:false});
      panel.__stop = stop;
      // Leaflet ìª½ë„ ì¶”ê°€ ì•ˆì „ì¥ì¹˜
      if(window.L && L.DomEvent){
        try{ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }catch(_){}
      }
    }
    function unblockMapInteractions(){
      hideShield();
      if(panel.__stop){
        panel.removeEventListener('wheel', panel.__stop, {passive:false});
        panel.removeEventListener('touchmove', panel.__stop, {passive:false});
        panel.__stop=null;
      }
    }
    panel.addEventListener('mouseenter', blockMapInteractions);
    panel.addEventListener('mouseleave', unblockMapInteractions);

    // ë“œë˜ê·¸(í—¤ë” ë”ë¸”í´ë¦­ â†’ ê¸°ë³¸ ìœ„ì¹˜ ë³µì›)
    const head = panel.querySelector('.head') || panel;
    let dragging=false, sx=0, sy=0, sl=0, st=0;
    head.addEventListener('mousedown', e=>{
      // ë²„íŠ¼/ì…ë ¥ ìœ„ì—ì„œëŠ” ë“œë˜ê·¸ ì‹œì‘ ì•ˆ í•¨
      if(/BUTTON|A|INPUT|SELECT|TEXTAREA/.test(e.target.tagName)) return;
      const r=panel.getBoundingClientRect();
      dragging=true; panel.classList.add('dragging');
      sx=e.clientX; sy=e.clientY; sl=r.left; st=r.top;
      panel.style.left=r.left+'px'; panel.style.top=r.top+'px';
      panel.style.right=''; panel.style.bottom='';
      document.body.style.userSelect='none';
      showShield(); // ë“œë˜ê·¸ ì¤‘ì—ë„ ì§€ë„ ì°¨ë‹¨
      e.preventDefault();
    });
    window.addEventListener('mousemove', e=>{
      if(!dragging) return;
      panel.style.left = (sl + (e.clientX - sx)) + 'px';
      panel.style.top  = (st + (e.clientY - sy)) + 'px';
    });
    window.addEventListener('mouseup', ()=>{
      if(!dragging) return;
      dragging=false; panel.classList.remove('dragging');
      document.body.style.userSelect='';
      hideShield();
    });
    head.addEventListener('dblclick', ()=>{
      panel.style.width=''; panel.style.height='';
      panel.style.left=''; panel.style.top='';
      panel.style.right='16px'; panel.style.bottom='90px';
    });

    // 4ë³€ ë¦¬ì‚¬ì´ì¦ˆ
    (function edgeResize(){
      const minW=360, minH=220;
      let resizing=false, edge='', sx=0, sy=0, sw=0, sh=0, sl=0, st=0;
      function start(e, which){
        const r=panel.getBoundingClientRect();
        resizing=true; edge=which;
        sx=e.clientX; sy=e.clientY; sw=r.width; sh=r.height; sl=r.left; st=r.top;
        panel.style.left = sl+'px'; panel.style.top = st+'px';
        panel.style.right=''; panel.style.bottom='';
        document.body.style.cursor=(which==='left'||which==='right')?'ew-resize':'ns-resize';
        showShield();
        e.preventDefault();
      }
      function move(e){
        if(!resizing) return;
        const dx=e.clientX-sx, dy=e.clientY-sy;
        if(edge==='right'){ panel.style.width = Math.max(minW, sw+dx) + 'px'; }
        if(edge==='left' ){ const w=Math.max(minW, sw-dx); panel.style.width=w+'px'; panel.style.left=(sl+dx)+'px'; }
        if(edge==='bottom'){ panel.style.height= Math.max(minH, sh+dy) + 'px'; }
        if(edge==='top'   ){ const h=Math.max(minH, sh-dy); panel.style.height=h+'px'; panel.style.top=(st+dy)+'px'; }
      }
      function stop(){
        if(!resizing) return;
        resizing=false; edge=''; document.body.style.cursor=''; hideShield();
        window.removeEventListener('mousemove', move);
        window.removeEventListener('mouseup', stop);
      }
      panel.querySelector('.e-left')  .addEventListener('mousedown', e=>{start(e,'left');  window.addEventListener('mousemove', move); window.addEventListener('mouseup', stop);});
      panel.querySelector('.e-right') .addEventListener('mousedown', e=>{start(e,'right'); window.addEventListener('mousemove', move); window.addEventListener('mouseup', stop);});
      panel.querySelector('.e-top')   .addEventListener('mousedown', e=>{start(e,'top');   window.addEventListener('mousemove', move); window.addEventListener('mouseup', stop);});
      panel.querySelector('.e-bottom').addEventListener('mousedown', e=>{start(e,'bottom');window.addEventListener('mousemove', move); window.addEventListener('mouseup', stop);});
    })();
  }

  /* -----------------------------------------------------------
   * 2) ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€ í† ê¸€(ê²½ë¡œ ê³„ì‚° í›„ ë¼ìš°íŠ¸ì— í¬í•¨ë˜ì§€ ì•Šì€ ë§ˆì»¤ë¥¼ ìˆ¨ê¹€)
   *    - í‘œì˜ ì²«ë²ˆì§¸ ì—´(ê³ ìœ ë²ˆí˜¸)ì„ ê¸°ì¤€ìœ¼ë¡œ íŒë³„
   *    - ë¼ë²¨ì´ ê³ ìœ ë²ˆí˜¸ê°€ ì•„ë‹ ë•Œë„ ë™ì‘í•˜ë„ë¡ ë§ˆì»¤ DOMì—ì„œ ìˆ«ì ì¶”ì¶œ ì‹œë„
   * ---------------------------------------------------------*/
  // í† ê¸€ UIë¥¼ ê²½ë¡œ ì„¹ì…˜ ì¹´ë“œì— ì£¼ì…
  (function injectToggle(){
    const host = document.querySelector('#secRoute .card') || document.querySelector('#secRoute');
    if(!host || document.getElementById('toggleHideNonRoute')) return;
    const wrap = document.createElement('div');
    wrap.style.cssText='margin-top:8px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;';
    wrap.innerHTML = `
      <label class="chip" style="user-select:none">
        <input type="checkbox" id="toggleHideNonRoute"> ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€
      </label>
      <span class="small">â€» í‘œì˜ <b>ê³ ìœ ë²ˆí˜¸</b>ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìˆ¨ê¹€ ì²˜ë¦¬</span>
    `;
    host.appendChild(wrap);
    document.getElementById('toggleHideNonRoute').addEventListener('change', applyRouteFilter);
  })();

  // í˜„ì¬ í‘œì˜ "ê²½ë¡œ ìˆœë²ˆ"ì´ ë“¤ì–´ê°„ í–‰ì˜ ê³ ìœ ë²ˆí˜¸ ì§‘í•© êµ¬í•˜ê¸°
  function currentRouteIdSet(){
    const set = new Set();
    $$('#selBody tr').forEach(tr=>{
      const id = (tr.querySelector('td')?.innerText||'').trim();
      const ord = tr.querySelector('input.routeOrder')?.value?.trim() || '';
      if(id && ord) set.add(String(id));
    });
    return set;
  }

  // ë§ˆì»¤ DOMì—ì„œ ìˆ«ìí˜• ì•„ì´ë”” ì¶”ì¶œ (ë¼ë²¨ì´ ì´ë¦„/ì£¼ì†Œì—¬ë„ ìˆ«ì ë¬¶ìŒì´ ìˆìœ¼ë©´ ì‹œë„)
  function readMarkerIdFromEl(el){
    if(!el) return '';
    // divIconì˜ ì²«ë²ˆì§¸ ìì‹ì´ mk* ë°•ìŠ¤
    const box = el.querySelector('.mk, .mk-circle, .mk-bubble, .mk-tag') || el.firstElementChild;
    const t = (box?.textContent||'').trim();
    // "1234" ë˜ëŠ” "1234 Â· ..." ë“±ì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ
    const m = t.match(/\d{2,}/);  // ìµœì†Œ 2ìë¦¬
    return m ? m[0] : t;
  }

  function iterMarkerBoxes(){
    // Leaflet divIcon ë§ˆì»¤ ì»¨í…Œì´ë„ˆ
    return $$('.leaflet-marker-pane > div');
  }

  function applyRouteFilter(){
    const on = document.getElementById('toggleHideNonRoute')?.checked;
    if(!on){
      iterMarkerBoxes().forEach(el=>el.classList.remove('clo-hidden'));
      return;
    }
    const routeIds = currentRouteIdSet();
    if(routeIds.size===0){
      // ìˆœë²ˆì´ ì—†ë‹¤ë©´ ìˆ¨ê¹€ í•´ì œ
      iterMarkerBoxes().forEach(el=>el.classList.remove('clo-hidden'));
      return;
    }
    iterMarkerBoxes().forEach(el=>{
      const id = readMarkerIdFromEl(el);
      if(routeIds.has(String(id))) el.classList.remove('clo-hidden');
      else el.classList.add('clo-hidden');
    });
  }

  // ê²½ë¡œ ê³„ì‚°/ì´ˆê¸°í™” ë²„íŠ¼ì— ì—°ë™ (ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ)
  (function hookRouteButtons(){
    const btnCalc  = document.getElementById('btnRoute');
    const btnClear = document.getElementById('btnRouteClear');
    if(btnCalc){
      btnCalc.addEventListener('click', ()=>{
        // ê³„ì‚° í›„ DOM ì—…ë°ì´íŠ¸ íƒ€ì´ë° ê³ ë ¤í•´ ì•½ê°„ ëŠ¦ê²Œ ì ìš©
        setTimeout(applyRouteFilter, 50);
      }, {capture:true});
    }
    if(btnClear){
      btnClear.addEventListener('click', ()=>{
        setTimeout(()=>{ 
          // í‘œ ìˆœë²ˆ/ê²½ë¡œ ì§€ìš°ë©´ ë§ˆì»¤ ì „ë¶€ ë‹¤ì‹œ ë³´ì´ê²Œ
          const tog = document.getElementById('toggleHideNonRoute'); 
          if(tog) tog.checked = false;
          applyRouteFilter();
        }, 0);
      }, {capture:true});
    }
    // í‘œ í¸ì§‘/ì‚­ì œ ë“±ì—ë„ ë°˜ì‘
    const selBody = document.getElementById('selBody');
    if(selBody){
      selBody.addEventListener('input', e=>{
        if(e.target.classList.contains('routeOrder')) applyRouteFilter();
      });
      selBody.addEventListener('click', e=>{
        if(e.target.classList.contains('btn-del')) setTimeout(applyRouteFilter, 0);
      });
    }
  })();

  // ì§€ë„ê°€ ë‹¤ì‹œ ê·¸ë ¤ì§ˆ ë•Œ(í•„í„°/ë¦¬ë Œë” í›„)ë„ í•œ ë²ˆ ë” ì ìš©ë˜ë„ë¡ MutationObserver
  (function observeMarkerPane(){
    const pane = document.querySelector('.leaflet-marker-pane');
    if(!pane || window.__cloMO) return;
    const mo = new MutationObserver(()=>{ 
      // ë§ˆì»¤ DOMì´ ë°”ë€Œë©´ í˜„ì¬ í† ê¸€ ìƒíƒœë¡œ ë‹¤ì‹œ ì ìš©
      if(document.getElementById('toggleHideNonRoute')?.checked) applyRouteFilter();
    });
    mo.observe(pane, {childList:true, subtree:true});
    window.__cloMO = mo;
  })();

  /*
   * ì•Œê³ ë¦¬ì¦˜ ì‚¬ìš©ë²• íˆ´íŒ
   * routeMethod ë˜ëŠ” engine ë“œë¡­ë‹¤ìš´ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ í•´ë‹¹ ì•Œê³ ë¦¬ì¦˜ì˜ ì„¤ëª…ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
   */
  (function setupAlgoTooltip(){
    // ì„¤ëª… ì‚¬ì „
    const tips = {
      // ë‚´ì¥ ë° ìµœê·¼ì  ì•Œê³ ë¦¬ì¦˜: ì¸ì ‘ ì‹œì„¤ì„ ë¹ ë¥´ê²Œ ë°©ë¬¸í•˜ëŠ” ê·¼ì‚¬ ë°©ì‹ì…ë‹ˆë‹¤.
      'nn2opt':'ë‚´ì¥ ì•Œê³ ë¦¬ì¦˜: ê°€ê¹Œìš´ ì‹œì„¤ì„ ë¨¼ì € ë°©ë¬¸í•œ ë‹¤ìŒ ê²½ë¡œë¥¼ ì¡°ê¸ˆì”© ë°”ê¿” ê±°ë¦¬ë¥¼ ì¤„ì´ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.',
      'nn':'ìµœê·¼ì  ì•Œê³ ë¦¬ì¦˜: í˜„ì¬ ìœ„ì¹˜ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ì‹œì„¤ë¶€í„° ì°¨ë¡€ëŒ€ë¡œ ì´ë™í•˜ëŠ” ë‹¨ìˆœí•œ ë°©ë²•ì…ë‹ˆë‹¤.',
      // í´ëŸ¬ìŠ¤í„°: ê³µê°„ì„ ì—¬ëŸ¬ êµ¬ì—­ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ê° êµ¬ì—­ ì•ˆì—ì„œ ìˆœì„œë¥¼ ì°¾ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.
      'cluster':'í´ëŸ¬ìŠ¤í„°: ê°€ê¹Œìš´ ì‹œì„¤ë“¤ì„ ì—¬ëŸ¬ êµ¬ì—­ìœ¼ë¡œ ë¬¶ì–´ ê° êµ¬ì—­ ì•ˆì—ì„œ ìµœì  ìˆœì„œë¥¼ ì°¾ìŠµë‹ˆë‹¤. ë¨¼ ê±°ë¦¬ë¥¼ í•œ ë²ˆì— ë„ëŠ” ëŒ€ì‹  ê·¼ì²˜ êµ¬ì—­ì„ ì§‘ì¤‘ì ìœ¼ë¡œ ëŒì•„ë´…ë‹ˆë‹¤.',
      'hilbert':'íë²„íŠ¸: ì§€ë„ë¥¼ ì§€ê·¸ì¬ê·¸ë¡œ ì±„ìš°ëŠ” ê¶¤ì ì„ ë”°ë¼ ì´ë™í•©ë‹ˆë‹¤. ì¸ì ‘í•œ ì‹œì„¤ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ ì£¼ì–´ í•œ ë°”í€´ í¬ê²Œ ë„ëŠ” êµ¬ê°„ì„ ì¤„ì…ë‹ˆë‹¤.',
      'kmeans':'K-í‰ê· : ì „ì²´ ì‹œì„¤ì„ ëª‡ ê°œì˜ ê·¸ë£¹ìœ¼ë¡œ ë‚˜ëˆˆ í›„ ê·¸ë£¹ë³„ë¡œ ê²½ë¡œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤. ê° ê·¸ë£¹ì„ ìˆœì„œëŒ€ë¡œ ë°©ë¬¸í•´ ì‘ì—… êµ¬ì—­ì„ ë­‰ì³ì„œ ì²˜ë¦¬í•  ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.',
      'builtin':'ë‚´ì¥: ê°€ê¹Œìš´ ì‹œì„¤ë¶€í„° 2-optë¡œ ê°œì„ í•˜ëŠ” ê¸°ë³¸ ì•Œê³ ë¦¬ì¦˜ì…ë‹ˆë‹¤.',
      'osrm':'OSRM: ì¸í„°ë„· OSRM ì„œë²„ë¥¼ ì‚¬ìš©í•´ ì‹¤ì œ ë„ë¡œë¥¼ ë”°ë¼ ê°€ì¥ ì§§ì€ ê²½ë¡œë¥¼ ì°¾ìŠµë‹ˆë‹¤.'
    };
    // íˆ´íŒ ìš”ì†Œ ìƒì„±
    const tip=document.createElement('div');
    tip.id='algoTooltip';
    tip.style.cssText='position:absolute; z-index:10000; background:#fefce8; border:1px solid #facc15; padding:6px 8px; border-radius:6px; font-size:12px; color:#78350f; display:none; max-width:260px; box-shadow:0 2px 6px rgba(0,0,0,0.15);';
    document.body.appendChild(tip);
    function show(e){
      const val = e.target.value;
      const msg = tips[val];
      if(!msg){ tip.style.display='none'; return; }
      tip.textContent = msg;
      const rect = e.target.getBoundingClientRect();
      tip.style.left = (rect.left + window.scrollX) + 'px';
      tip.style.top = (rect.bottom + window.scrollY + 4) + 'px';
      tip.style.display = 'block';
    }
    function hide(){ tip.style.display = 'none'; }
    ['routeMethod','engine'].forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      el.addEventListener('mouseenter', show);
      el.addEventListener('mousemove', show);
      el.addEventListener('mouseleave', hide);
      el.addEventListener('change', show);
    });
  })();

})();
</script><script>
(function(){
  const $=(q,root=document)=>root.querySelector(q);
  const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));

  /* A. ì„ íƒëª©ë¡ íŒ¨ë„: íŠ•ê¹€ ë°©ì§€ + ë“œë˜ê·¸ + 4ë³€ ë¦¬ì‚¬ì´ì¦ˆ */
  (function setupPanel(){
    const panel = $('#selPanel'); const shield = $('#mapShield');
    if(!panel || !shield) return;

    // ì—£ì§€ í•¸ë“¤ ì—†ìœ¼ë©´ ìƒì„±
    if(!panel.querySelector('.e-left')){
      ['left','right','top','bottom'].forEach(k=>{
        const d=document.createElement('div'); d.className='edge e-'+k; panel.appendChild(d);
      });
    }

    const stop=(e)=>{ e.preventDefault(); e.stopPropagation(); };
    const showShield=()=>{ shield.style.display='block'; };
    const hideShield=()=>{ shield.style.display='none'; };

    // íŒ¨ë„ hover ì‹œ ì§€ë„ ìƒí˜¸ì‘ìš© ì°¨ë‹¨
    panel.addEventListener('mouseenter', ()=>{
      showShield();
      panel.addEventListener('wheel', stop, {passive:false});
      panel.addEventListener('touchmove', stop, {passive:false});
      if(window.L && L.DomEvent){
        try{ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }catch(_){}
      }
    });
    panel.addEventListener('mouseleave', ()=>{
      hideShield();
      panel.removeEventListener('wheel', stop, {passive:false});
      panel.removeEventListener('touchmove', stop, {passive:false});
    });

    // ë“œë˜ê·¸ (í—¤ë” ë”ë¸”í´ë¦­ â†’ ê¸°ë³¸ ìœ„ì¹˜ ë³µì›)
    const head = panel.querySelector('.head') || panel;
    let dragging=false, sx=0, sy=0, sl=0, st=0;
    head.addEventListener('mousedown', (e)=>{
      if(/BUTTON|A|INPUT|SELECT|TEXTAREA/.test(e.target.tagName)) return;
      const r=panel.getBoundingClientRect();
      dragging=true; panel.classList.add('dragging');
      sx=e.clientX; sy=e.clientY; sl=r.left; st=r.top;
      panel.style.left=sl+'px'; panel.style.top=st+'px';
      panel.style.right=''; panel.style.bottom='';
      document.body.style.userSelect='none';
      showShield();
      e.preventDefault();
    });
    window.addEventListener('mousemove', (e)=>{
      if(!dragging) return;
      panel.style.left=(sl+(e.clientX-sx))+'px';
      panel.style.top =(st+(e.clientY-sy))+'px';
    });
    window.addEventListener('mouseup', ()=>{
      if(!dragging) return;
      dragging=false; panel.classList.remove('dragging');
      document.body.style.userSelect='';
      hideShield();
    });
    head.addEventListener('dblclick', ()=>{
      panel.style.width=''; panel.style.height='';
      panel.style.left='';  panel.style.top='';
      panel.style.right='16px'; panel.style.bottom='90px';
    });

    // 4ë³€ ë¦¬ì‚¬ì´ì¦ˆ
    (function edgeResize(){
      const minW=360, minH=220;
      let resizing=false, edge='', sx=0, sy=0, sw=0, sh=0, sl=0, st=0;
      function start(e, which){
        const r=panel.getBoundingClientRect();
        resizing=true; edge=which;
        sx=e.clientX; sy=e.clientY; sw=r.width; sh=r.height; sl=r.left; st=r.top;
        panel.style.left=sl+'px'; panel.style.top=st+'px';
        panel.style.right=''; panel.style.bottom='';
        document.body.style.cursor=(which==='left'||which==='right')?'ew-resize':'ns-resize';
        showShield(); e.preventDefault();
        window.addEventListener('mousemove', move);
        window.addEventListener('mouseup', stop);
      }
      function move(e){
        if(!resizing) return;
        const dx=e.clientX-sx, dy=e.clientY-sy;
        if(edge==='right'){ panel.style.width = Math.max(minW, sw+dx)+'px'; }
        if(edge==='left' ){ const w=Math.max(minW, sw-dx); panel.style.width=w+'px'; panel.style.left=(sl+dx)+'px'; }
        if(edge==='bottom'){ panel.style.height= Math.max(minH, sh+dy)+'px'; }
        if(edge==='top'   ){ const h=Math.max(minH, sh-dy); panel.style.height=h+'px'; panel.style.top=(st+dy)+'px'; }
      }
      function stop(){
        if(!resizing) return;
        resizing=false; edge=''; document.body.style.cursor=''; hideShield();
        window.removeEventListener('mousemove', move);
        window.removeEventListener('mouseup', stop);
      }
      panel.querySelector('.e-left')  .addEventListener('mousedown', e=>start(e,'left'));
      panel.querySelector('.e-right') .addEventListener('mousedown', e=>start(e,'right'));
      panel.querySelector('.e-top')   .addEventListener('mousedown', e=>start(e,'top'));
      panel.querySelector('.e-bottom').addEventListener('mousedown', e=>start(e,'bottom'));
    })();
  })();

  /* B. ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€ í† ê¸€ ì£¼ì… + ì ìš© */
  (function hideNonRoutePatch(){
    // UI ì£¼ì…(ì—†ì„ ë•Œë§Œ)
    const host = document.querySelector('#secRoute .card') || document.querySelector('#secRoute');
    if(host && !document.getElementById('toggleHideNonRoute')){
      const wrap=document.createElement('div');
      wrap.style.cssText='margin-top:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;';
      wrap.innerHTML='<label class="chip" style="user-select:none"><input type="checkbox" id="toggleHideNonRoute"> ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€</label><span class="small">â€» í‘œì˜ <b>ê³ ìœ ë²ˆí˜¸</b>ì™€ ê²½ë¡œìˆœë²ˆ ê¸°ì¤€</span>';
      host.appendChild(wrap);
    }

    const getRouteIdSet=()=>{
      const s=new Set();
      $$('#selBody tr').forEach(tr=>{
        const id=(tr.querySelector('td')?.innerText||'').trim();
        const ord=tr.querySelector('input.routeOrder')?.value?.trim();
        if(id && ord) s.add(String(id));
      });
      return s;
    };
    const markerBoxes=()=>$$('.leaflet-marker-pane > div');
    const readIdFromEl=(el)=>{
      const box=el.querySelector('.mk,.mk-circle,.mk-bubble,.mk-tag')||el.firstElementChild;
      const t=(box?.textContent||'').trim();
      const m=t.match(/\d{2,}/); // ìˆ«ì ë¼ë²¨ ìš°ì„ 
      return m?m[0]:t;
    };
    const apply=()=>{
      const tog=$('#toggleHideNonRoute'); if(!tog){return;}
      if(!tog.checked){ markerBoxes().forEach(el=>el.classList.remove('clo-hidden')); return; }
      const ids=getRouteIdSet();
      if(!ids.size){ markerBoxes().forEach(el=>el.classList.remove('clo-hidden')); return; }
      markerBoxes().forEach(el=>{
        const id=readIdFromEl(el);
        if(ids.has(String(id))) el.classList.remove('clo-hidden');
        else el.classList.add('clo-hidden');
      });
    };

    // ë°”ì¸ë”©
    $('#toggleHideNonRoute')?.addEventListener('change', apply);
    $('#selBody')?.addEventListener('input', e=>{ if(e.target.classList.contains('routeOrder')) apply(); });
    $('#selBody')?.addEventListener('click', e=>{ if(e.target.classList.contains('btn-del')) setTimeout(apply,0); });

    // ê²½ë¡œ ê³„ì‚° ì§í›„/ë¦¬ë Œë” í›„ ì¬ì ìš©
    $('#btnRoute')?.addEventListener('click', ()=>setTimeout(apply,50), {capture:true});
    const pane=document.querySelector('.leaflet-marker-pane');
    if(pane && !window.__cloMO){
      const mo=new MutationObserver(()=>{ if($('#toggleHideNonRoute')?.checked) apply(); });
      mo.observe(pane,{childList:true,subtree:true}); window.__cloMO=mo;
    }

    // í•˜ë“œ ì´ˆê¸°í™”ì— ì—°ë™
    window.__clo_unhideAll=()=>{
      const tog=$('#toggleHideNonRoute'); if(tog) tog.checked=false;
      document.querySelectorAll('.clo-hidden').forEach(el=>el.classList.remove('clo-hidden'));
    };
  })();

  /* C. í•˜ë“œ ì´ˆê¸°í™”: ê²½ë¡œì„ /ì„ íƒí‘œì‹œ/ìˆ¨ê¹€í† ê¸€ê¹Œì§€ ì‹¹ ì´ˆê¸°í™” */
  (function bindHardReset(){
    function hardResetAll(){
      try{
        // 1) Leaflet ê²½ë¡œ ì˜¤ë²„ë ˆì´ ì œê±°
        document.querySelectorAll('.leaflet-overlay-pane svg path, .leaflet-overlay-pane svg polyline')
          .forEach(el=>{ try{ el.remove(); }catch(_){} });
        // 2) ê²½ë¡œ ìˆœë²ˆ ì…ë ¥ì¹¸ ë¹„ì›€
        document.querySelectorAll('input.routeOrder').forEach(i=>i.value='');
        // 3) ë§ˆì»¤ ì„ íƒ ê°•ì¡° í•´ì œ
        document.querySelectorAll('.mk-bubble.sel, .mk-circle.sel, .mk-tag.sel')
          .forEach(el=>el.classList.remove('sel'));
        // 4) ê²½ë¡œ ì™¸ ìˆ¨ê¹€ í•´ì œ
        window.__clo_unhideAll && window.__clo_unhideAll();
        // 5) ìƒíƒœ í…ìŠ¤íŠ¸ ë¦¬ì…‹
        const ab=$('#abInfo'); if(ab) ab.textContent='A/B: -';
        const rs=$('#routeStat'); if(rs) rs.textContent='ê±°ë¦¬: - / ì‹œê°„: -';
      }catch(e){ console.warn('hardResetAll', e); }
    }
    // ì¢Œì¸¡ ì„¹ì…˜ ì´ˆê¸°í™”, ìƒë‹¨ ì´ˆê¸°í™”ì— ë°”ì¸ë”©
    (function(){
      const left = document.getElementById('btnABReset') ||
        Array.from(document.querySelectorAll('#secRoute button')).find(b=>b.textContent.trim()==='ì´ˆê¸°í™”');
      if(left) left.addEventListener('click', ()=>setTimeout(hardResetAll,0), {capture:true});
      const top = document.getElementById('btnRouteClear') ||
        Array.from(document.querySelectorAll('button')).find(b=>b.textContent.trim()==='ì´ˆê¸°í™”');
      if(top) top.addEventListener('click',  ()=>setTimeout(hardResetAll,0), {capture:true});
    })();
  })();

  /* E. Move font/marker adjustment buttons into the settings block and wire autoâ€‘recalculation toggle */
  (function setupSettingsPanel(){
    const block=document.getElementById('settingsBlock');
    if(block){
      const ids=['btnTblUp','btnTblDn','btnFltUp','btnFltDn','btnMkUp','btnMkDn'];
      ids.forEach(id=>{
        const el=document.getElementById(id);
        if(el){ el.style.display=''; block.appendChild(el); }
      });
    }
    // auto recalc: when route order inputs change or rows are deleted, recompute route automatically if toggle is on
    const tog=document.getElementById('toggleAutoRecalc');
    const body=document.getElementById('selBody');
    if(tog && body){
      body.addEventListener('input', e=>{
        if(e.target.classList.contains('routeOrder') && tog.checked){ computeRoute(); }
      });
      body.addEventListener('click', e=>{
        if(e.target.classList.contains('btn-del') && tog.checked){ setTimeout(()=>computeRoute(),0); }
      });
    }
  })();

  /* D. ê²½ë¡œ í—¤ë” ì •ë ¬: í´ë¦­ ì‹œ ì˜¤ë¦„/ë‚´ë¦¼ì°¨ìˆœ í† ê¸€ ë° ê²½ë¡œ ìë™ ì¬ê³„ì‚° */
  (function initRouteHeaderSort(){
    const header = document.getElementById('routeHeader');
    if(!header) return;
    let ascending = true;
    header.style.cursor = 'pointer';
    header.addEventListener('click', ()=>{
      const body = document.getElementById('selBody');
      if(!body) return;
      const rows = Array.from(body.querySelectorAll('tr'));
      rows.sort((a,b)=>{
        const aVal = parseInt(a.querySelector('input.routeOrder')?.value || '0');
        const bVal = parseInt(b.querySelector('input.routeOrder')?.value || '0');
        return ascending ? (aVal - bVal) : (bVal - aVal);
      });
      rows.forEach(r=>body.appendChild(r));
      ascending = !ascending;
      // Trigger route recomputation to reflect new order
      if(rows.length>=2) computeRoute();
    });
  })();

})();
</script><script>
(function(){
  const panel = document.getElementById('selPanel');
  if(!panel || panel.dataset.v8Applied) return;
  panel.dataset.v8Applied = '1';

  const head = panel.querySelector('.head') || panel;
  const shield = document.getElementById('mapShield');

  const showShield = ()=>{ if(shield) shield.style.display='block'; };
  const hideShield = ()=>{ if(shield) shield.style.display='none'; };

  /* â”€â”€ A. ë“œë˜ê·¸: ì‚¬ì´ì¦ˆ ê³ ì • + ì„ê³„ê°’(4px) + í¬ì¸í„° ìº¡ì²˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let dragging = false;
  let armingDrag = false;  // ì„ê³„ê°’ ëŒíŒŒ ì „ ì¤€ë¹„ìƒíƒœ
  let sx=0, sy=0, sl=0, st=0, startW=0, startH=0;
  const THRESH = 4;

  function onHeadDown(e){
    if(/BUTTON|A|INPUT|SELECT|TEXTAREA/.test(e.target.tagName)) return;
    // v7 ê¸°ì¡´ í•¸ë“¤ëŸ¬ë³´ë‹¤ ë¨¼ì € ì²˜ë¦¬í•˜ê³  ì „íŒŒ ì°¨ë‹¨(ì¶©ëŒ ë°©ì§€)
    e.stopImmediatePropagation();
    e.preventDefault();

    const r = panel.getBoundingClientRect();
    // ë“œë˜ê·¸ ì¤‘ í¬ê¸° í”ë“¤ë¦¼ ë°©ì§€: í˜„ì¬ í¬ê¸°ë¥¼ ê³ ì •
    startW = r.width; startH = r.height;
    panel.style.width  = startW + 'px';
    panel.style.height = startH + 'px';

    sx=e.clientX; sy=e.clientY; sl=r.left; st=r.top;
    armingDrag = true; dragging = false;

    head.setPointerCapture?.(e.pointerId);
    document.body.classList.add('clo-noselect');
    showShield();
  }
  function onHeadMove(e){
    if(!armingDrag && !dragging) return;
    const dx = e.clientX - sx, dy = e.clientY - sy;
    if(!dragging){
      if(Math.abs(dx) > THRESH || Math.abs(dy) > THRESH){
        dragging = true; armingDrag = false;
        // ìœ„ì¹˜ ê¸°ì¤€ì„ left/topìœ¼ë¡œ ê³ ì •
        const r = panel.getBoundingClientRect();
        panel.style.left = r.left + 'px';
        panel.style.top  = r.top  + 'px';
        panel.style.right=''; panel.style.bottom='';
      } else {
        // ì„ê³„ ì „ì—ëŠ” ê¸°ì¡´ í•¸ë“¤ëŸ¬ë¡œ ë„˜ì–´ê°€ì§€ ì•Šë„ë¡ ê³„ì† ìº¡ì²˜
        e.stopImmediatePropagation();
        return;
      }
    }
    e.stopImmediatePropagation();
    e.preventDefault();
    panel.style.left = (sl + dx) + 'px';
    panel.style.top  = (st + dy) + 'px';
  }
  function onHeadUp(e){
    if(!(armingDrag || dragging)) return;
    e.stopImmediatePropagation();
    armingDrag = false; dragging = false;
    head.releasePointerCapture?.(e.pointerId);
    document.body.classList.remove('clo-noselect');
    hideShield();
  }

  /* í¬ì¸í„° ì´ë²¤íŠ¸(ìº¡ì²˜ ë‹¨ê³„)ë¡œ ë“±ë¡ â†’ ê¸°ì¡´ v7 í•¸ë“¤ëŸ¬ë³´ë‹¤ ë¨¼ì € ë™ì‘ */
  head.addEventListener('pointerdown', onHeadDown, {capture:true});
  window.addEventListener('pointermove', onHeadMove, {capture:true});
  window.addEventListener('pointerup',   onHeadUp,   {capture:true});

  /* ë”ë¸”í´ë¦­ ê¸°ë³¸ ìœ„ì¹˜ ë³µì› ì‹œì—ë„ í¬ê¸° ê³ ì • í•´ì œ ëŒ€ì‹  í˜„ì¬ ê°’ ìœ ì§€ */
  head.addEventListener('dblclick', (e)=>{
    // v7ì˜ ë³µì› ë¡œì§ì´ ì‹¤í–‰ë˜ë”ë¼ë„ width/height í”ë“¤ë¦¼ ë°©ì§€ë¥¼ ìœ„í•´ ê·¸ëŒ€ë¡œ ìœ ì§€
    // í•„ìš”ì‹œ ì•„ë˜ ë‘ ì¤„ì„ ì£¼ì„ í•´ì œí•´ ì›ë˜ ìë™í¬ê¸°ë¡œ ë˜ëŒë¦´ ìˆ˜ ìˆìŒ
    // panel.style.width=''; panel.style.height='';
  }, {capture:true});

  /* â”€â”€ B. 4ë³€ ë¦¬ì‚¬ì´ì¦ˆ(ì¢Œ/ìƒ ë¬´ì œí•œ, ìµœì†Œ 120pxë§Œ ìœ ì§€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const minW=120, minH=120;

  function startResize(e, which){
    e.stopImmediatePropagation();
    e.preventDefault();

    const r = panel.getBoundingClientRect();
    startW=r.width; startH=r.height; sl=r.left; st=r.top;
    sx=e.clientX; sy=e.clientY;

    panel.style.left = sl+'px'; panel.style.top = st+'px';
    panel.style.right=''; panel.style.bottom='';

    document.body.style.cursor = (which==='left'||which==='right')?'ew-resize':'ns-resize';
    document.body.classList.add('clo-noselect');
    showShield();

    function move(ev){
      ev.stopImmediatePropagation(); ev.preventDefault();
      const dx = ev.clientX - sx, dy = ev.clientY - sy;
      if(which==='right'){ panel.style.width  = Math.max(minW, startW+dx) + 'px'; }
      if(which==='left' ){ const w=Math.max(minW, startW-dx); panel.style.width=w+'px'; panel.style.left=(sl+dx)+'px'; }
      if(which==='bottom'){panel.style.height = Math.max(minH, startH+dy) + 'px'; }
      if(which==='top'   ){ const h=Math.max(minH, startH-dy); panel.style.height=h+'px'; panel.style.top=(st+dy)+'px'; }
    }
    function up(ev){
      ev.stopImmediatePropagation(); 
      document.removeEventListener('pointermove', move, true);
      document.removeEventListener('pointerup',   up,   true);
      document.body.style.cursor='';
      document.body.classList.remove('clo-noselect');
      hideShield();
    }
    document.addEventListener('pointermove', move, true);
    document.addEventListener('pointerup',   up,   true);
  }

  // ì—£ì§€ í•¸ë“¤ì— v8 ë¦¬ì‚¬ì´ì¦ˆ ë°”ì¸ë”©(ìº¡ì²˜ ë‹¨ê³„)
  const el = panel.querySelector('.e-left');
  const er = panel.querySelector('.e-right');
  const et = panel.querySelector('.e-top');
  const eb = panel.querySelector('.e-bottom');
  if(el) el.addEventListener('pointerdown', e=>startResize(e,'left'),  {capture:true});
  if(er) er.addEventListener('pointerdown', e=>startResize(e,'right'), {capture:true});
  if(et) et.addEventListener('pointerdown', e=>startResize(e,'top'),   {capture:true});
  if(eb) eb.addEventListener('pointerdown', e=>startResize(e,'bottom'),{capture:true});

})();
</script><script>
(function(){
  const panel = document.getElementById('selPanel');
  if(!panel || panel.dataset.cloV9Applied) return;
  panel.dataset.cloV9Applied = '1';

  const head = panel.querySelector('.head') || panel;
  const shield = document.getElementById('mapShield');

  const showShield = ()=>{ if(shield) shield.style.display='block'; };
  const hideShield = ()=>{ if(shield) shield.style.display='none'; };

  /* â”€â”€ 0) ìµœì´ˆ ê³ ì • ì•µì»¤: right/bottom â†’ left/top ìœ¼ë¡œ â€˜í•€â€™ ê³ ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  (function pinPanelOnce(){
    const r = panel.getBoundingClientRect();
    // ì´ë¯¸ ì‚¬ìš©ìê°€ ìœ„ì¹˜ë¥¼ ë§Œì¡Œë‹¤ë©´ ê±´ë“¤ì§€ ì•ŠìŒ
    if(panel.style.left || panel.style.top) return;
    panel.style.left = (r.left || (window.innerWidth - r.width - 16)) + 'px';
    panel.style.top  = (r.top  || (window.innerHeight - r.height - 90)) + 'px';
    panel.style.right = ''; panel.style.bottom = '';
  })();

  // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ ì—†ìœ¼ë©´ ìƒì„±
  if(!panel.querySelector('.e-left')){
    ['left','right','top','bottom'].forEach(k=>{
      const d=document.createElement('div'); d.className='edge e-'+k; panel.appendChild(d);
    });
  }

  /* â”€â”€ 1) Hoverë¡œëŠ” ì ˆëŒ€ ì´ë™/ë¦¬ì‚¬ì´ì¦ˆ ì‹œì‘ ì•ˆ í•¨(ì˜¤ì¸ ë°©ì§€) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const THRESH = 4;                       // ë“œë˜ê·¸ ì‹œì‘ ì„ê³„ê°’
  let arming=false, dragging=false;       // ë“œë˜ê·¸ ì¤€ë¹„/ì§„í–‰
  let sx=0, sy=0, sl=0, st=0, sw=0, sh=0; // ì‹œì‘ ì¢Œí‘œ/íŒ¨ë„ì¹˜ìˆ˜
  const minW=120, minH=120;

  // ì§€ë„ ì´ë²¤íŠ¸ ì°¨ë‹¨(hoverë§Œìœ¼ë¡œëŠ” íŒ¨ë„ ì´ë™ ì•ˆ í•¨)
  const stop = e=>{ e.preventDefault(); e.stopPropagation(); };
  panel.addEventListener('mouseenter', ()=>{
    // hover ë•Œ ì§€ë„ ìƒí˜¸ì‘ìš©ë§Œ ë§‰ëŠ”ë‹¤(íŒ¨ë„ ì´ë™ì€ arm ìƒíƒœ ì•„ë‹ˆë©´ ì‹œì‘ ì•ˆ í•¨)
    showShield();
    panel.addEventListener('wheel', stop, {passive:false});
    panel.addEventListener('touchmove', stop, {passive:false});
    if(window.L && L.DomEvent){
      try{ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }catch(_){}
    }
  });
  panel.addEventListener('mouseleave', ()=>{
    if(!dragging) hideShield(); // ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ì¤‘ì´ ì•„ë‹ˆë¼ë©´ í•´ì œ
    panel.removeEventListener('wheel', stop, {passive:false});
    panel.removeEventListener('touchmove', stop, {passive:false});
  });

  /* â”€â”€ 2) ë“œë˜ê·¸: ë°˜ë“œì‹œ pointerdown ì´í›„ 4pxâ†‘ ì´ë™í•´ì•¼ ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function onHeadDown(e){
    if(/BUTTON|A|INPUT|SELECT|TEXTAREA/.test(e.target.tagName)) return;
    // ê¸°ì¡´ í•¸ë“¤ëŸ¬ë³´ë‹¤ ë¨¼ì € ë¨¹ê²Œ í•˜ê³ , hover-ghost ì™„ì „ ì°¨ë‹¨
    e.stopImmediatePropagation(); e.preventDefault();

    const r=panel.getBoundingClientRect();
    sx=e.clientX; sy=e.clientY; sl=r.left; st=r.top; sw=r.width; sh=r.height;

    // ì´ë™ ì¤‘ ì‚¬ì´ì¦ˆ í”ë“¤ë¦¼ ë°©ì§€: í˜„ì¬ í¬ê¸°ë¥¼ pxë¡œ ê³ ì •
    panel.style.width = sw+'px'; panel.style.height = sh+'px';
    // í•­ìƒ left/top ê¸°ì¤€ìœ¼ë¡œ ì´ë™
    panel.style.left = sl+'px'; panel.style.top = st+'px'; panel.style.right=''; panel.style.bottom='';

    arming=true; dragging=false;
    head.setPointerCapture?.(e.pointerId);
    document.body.classList.add('clo-noselect');
    showShield();
  }
  function onHeadMove(e){
    if(!arming && !dragging) return;
    const dx=e.clientX-sx, dy=e.clientY-sy;
    if(!dragging){
      if(Math.abs(dx)>THRESH || Math.abs(dy)>THRESH){
        dragging=true; arming=false;
      }else{
        e.stopImmediatePropagation(); // ì„ê³„ ì „ì—” ì–´ë–¤ ì´ë™ë„ ê¸ˆì§€
        return;
      }
    }
    e.stopImmediatePropagation(); e.preventDefault();
    panel.style.left = (sl+dx)+'px';
    panel.style.top  = (st+dy)+'px';
  }
  function onHeadUp(e){
    if(!(arming||dragging)) return;
    e.stopImmediatePropagation();
    arming=false; dragging=false;
    head.releasePointerCapture?.(e.pointerId);
    document.body.classList.remove('clo-noselect');
    hideShield();
  }

  head.addEventListener('pointerdown', onHeadDown, {capture:true});
  window.addEventListener('pointermove', onHeadMove, {capture:true});
  window.addEventListener('pointerup',   onHeadUp,   {capture:true});
  head.addEventListener('dblclick', (e)=>{
    // ì›ìœ„ì¹˜ë¡œ ë˜ëŒë¦¬ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
    // panel.style.width=''; panel.style.height='';
    // panel.style.left=''; panel.style.top=''; panel.style.right='16px'; panel.style.bottom='90px';
  }, {capture:true});

  /* â”€â”€ 3) 4ë³€ ë¦¬ì‚¬ì´ì¦ˆ(ì¢Œ/ìƒ ë¬´ì œí•œ), ë“œë˜ê·¸ì™€ ë™ì¼í•œ ë³´í˜¸ì¥ì¹˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function startResize(e, which){
    e.stopImmediatePropagation(); e.preventDefault();
    const r=panel.getBoundingClientRect();
    sx=e.clientX; sy=e.clientY; sl=r.left; st=r.top; sw=r.width; sh=r.height;

    panel.style.left=sl+'px'; panel.style.top=st+'px';
    panel.style.right=''; panel.style.bottom='';
    document.body.style.cursor=(which==='left'||which==='right')?'ew-resize':'ns-resize';
    document.body.classList.add('clo-noselect');
    showShield();

    function move(ev){
      ev.stopImmediatePropagation(); ev.preventDefault();
      const dx=ev.clientX-sx, dy=ev.clientY-sy;
      if(which==='right'){ panel.style.width = Math.max(minW, sw+dx)+'px'; }
      if(which==='left' ){ const w=Math.max(minW, sw-dx); panel.style.width=w+'px'; panel.style.left=(sl+dx)+'px'; }
      if(which==='bottom'){ panel.style.height= Math.max(minH, sh+dy)+'px'; }
      if(which==='top'   ){ const h=Math.max(minH, sh-dy); panel.style.height=h+'px'; panel.style.top=(st+dy)+'px'; }
    }
    function up(ev){
      ev.stopImmediatePropagation();
      document.removeEventListener('pointermove', move, true);
      document.removeEventListener('pointerup',   up,   true);
      document.body.style.cursor='';
      document.body.classList.remove('clo-noselect');
      hideShield();
    }
    document.addEventListener('pointermove', move, true);
    document.addEventListener('pointerup',   up,   true);
  }
  const el=panel.querySelector('.e-left'), er=panel.querySelector('.e-right'),
        et=panel.querySelector('.e-top'),  eb=panel.querySelector('.e-bottom');
  if(el) el.addEventListener('pointerdown', e=>startResize(e,'left'),  {capture:true});
  if(er) er.addEventListener('pointerdown', e=>startResize(e,'right'), {capture:true});
  if(et) et.addEventListener('pointerdown', e=>startResize(e,'top'),   {capture:true});
  if(eb) eb.addEventListener('pointerdown', e=>startResize(e,'bottom'),{capture:true});

})();
</script><script>
(function(){
  const $=(q,root=document)=>root.querySelector(q);
  const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));

  const panel = $('#selPanel'); if(!panel || panel.dataset.v10Applied) return;
  panel.dataset.v10Applied='1';

  const head   = panel.querySelector('.head') || panel;
  const shield = $('#mapShield');

  const showShield = ()=>{ if(shield) shield.style.display='block'; };
  const hideShield = ()=>{ if(shield) shield.style.display='none'; };

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * 0) ìµœì´ˆ í‘œì‹œ ì‹œ í™”ë©´ ì •ì¤‘ì•™ ë°°ì¹˜ (ì²˜ìŒ 1íšŒ)
   *    - íŒ¨ë„ì´ display:block ë˜ê±°ë‚˜, ì„ íƒëª©ë¡ì— ì²« í–‰ì´ ì¶”ê°€ë˜ë©´ ì„¼í„°ë§
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function centerPanel(){
    const r = panel.getBoundingClientRect();
    const vw = window.innerWidth, vh = window.innerHeight;
    const w  = Math.max(r.width || 520, 380);
    const h  = Math.max(r.height || 260, 220);
    const left = Math.max(8, Math.round((vw - w)/2));
    const top  = Math.max(8, Math.round((vh - h)/2));
    panel.style.left = left + 'px';
    panel.style.top  = top  + 'px';
    panel.style.right=''; panel.style.bottom='';
  }
  let centeredOnce=false;

  // íŒ¨ë„ display ë³€í™” ê°ì§€
  const moPanel = new MutationObserver(()=>{
    const disp = getComputedStyle(panel).display;
    if(!centeredOnce && disp!=='none'){
      centerPanel(); centeredOnce=true;
    }
  });
  moPanel.observe(panel,{attributes:true,attributeFilter:['style','class']});

  // ì„ íƒëª©ë¡ ì²« í–‰ ì¶”ê°€ ì‹œì—ë„ ì„¼í„°ë§ (ì´ˆê¸° ì‚¬ìš© íë¦„ ë³´ì™„)
  const selBody = $('#selBody');
  if(selBody){
    const moBody = new MutationObserver(()=>{
      if(!centeredOnce && selBody.children.length>0){
        // íŒ¨ë„ì´ ìˆ¨ê²¨ì ¸ ìˆë‹¤ë©´ ì—´ì–´ì£¼ê¸°
        if(getComputedStyle(panel).display==='none') panel.style.display='block';
        centerPanel(); centeredOnce=true;
      }
    });
    moBody.observe(selBody,{childList:true});
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * 1) ë¦¬ì‚¬ì´ì¦ˆ: ë°”ê¹¥ í•¸ë“¤ + ì•ˆìª½ ì–‡ì€ ê·¸ë¦½ ëª¨ë‘ ì§€ì›
   *    ìƒ/í•˜/ì¢Œ/ìš° ë¬´ì œí•œ(ìµœì†Œ 120px) Â· ë“œë˜ê·¸ì™€ ë™ì¼í•œ ì‹¤ë“œ/ë…¸ì…€ë ‰íŠ¸
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  // ë°”ê¹¥ í•¸ë“¤ ë³´ê°•
  if(!panel.querySelector('.e-left')){
    ['left','right','top','bottom'].forEach(k=>{
      const d=document.createElement('div'); d.className='edge e-'+k; panel.appendChild(d);
    });
  }
  // ì•ˆìª½ ê·¸ë¦½ ì¶”ê°€
  if(!panel.querySelector('.g-left')){
    ['left','right','top','bottom'].forEach(k=>{
      const d=document.createElement('div'); d.className='grip g-'+k; panel.appendChild(d);
    });
  }

  const minW=120, minH=120;
  function startResize(e, which){
    e.stopImmediatePropagation(); e.preventDefault();
    const r=panel.getBoundingClientRect();
    let sx=e.clientX, sy=e.clientY, sl=r.left, st=r.top, sw=r.width, sh=r.height;

    panel.style.left=sl+'px'; panel.style.top=st+'px';
    panel.style.right=''; panel.style.bottom='';
    document.body.style.cursor=(which==='left'||which==='right')?'ew-resize':'ns-resize';
    document.body.classList.add('clo-noselect');
    showShield();

    function move(ev){
      ev.stopImmediatePropagation(); ev.preventDefault();
      const dx=ev.clientX-sx, dy=ev.clientY-sy;
      if(which==='right'){ panel.style.width = Math.max(minW, sw+dx)+'px'; }
      if(which==='left' ){ const w=Math.max(minW, sw-dx); panel.style.width=w+'px'; panel.style.left=(sl+dx)+'px'; }
      if(which==='bottom'){ panel.style.height= Math.max(minH, sh+dy)+'px'; }
      if(which==='top'   ){ const h=Math.max(minH, sh-dy); panel.style.height=h+'px'; panel.style.top=(st+dy)+'px'; }
    }
    function up(ev){
      ev.stopImmediatePropagation();
      document.removeEventListener('pointermove', move, true);
      document.removeEventListener('pointerup',   up,   true);
      document.body.style.cursor=''; document.body.classList.remove('clo-noselect'); hideShield();
    }
    document.addEventListener('pointermove', move, true);
    document.addEventListener('pointerup',   up,   true);
  }
  ['.e-left','.e-right','.e-top','.e-bottom','.g-left','.g-right','.g-top','.g-bottom'].forEach(sel=>{
    const el=panel.querySelector(sel); if(!el) return;
    const side = /left/.test(sel)?'left':/right/.test(sel)?'right':/top/.test(sel)?'top':'bottom';
    el.addEventListener('pointerdown', e=>startResize(e, side), {capture:true});
  });

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * 2) ë“œë˜ê·¸: hover-ghost ë°©ì§€, ì„ê³„ê°’ 4px, í¬ì¸í„°ìº¡ì²˜, ì‚¬ì´ì¦ˆ ê³ ì •
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const THRESH=4;
  let arming=false, dragging=false;
  let sx=0, sy=0, sl=0, st=0, sw=0, sh=0;

  function onHeadDown(e){
    if(/BUTTON|A|INPUT|SELECT|TEXTAREA/.test(e.target.tagName)) return;
    e.stopImmediatePropagation(); e.preventDefault();

    const r=panel.getBoundingClientRect();
    sx=e.clientX; sy=e.clientY; sl=r.left; st=r.top; sw=r.width; sh=r.height;

    panel.style.width=sw+'px'; panel.style.height=sh+'px';
    panel.style.left=sl+'px'; panel.style.top=st+'px';
    panel.style.right=''; panel.style.bottom='';

    arming=true; dragging=false;
    head.setPointerCapture?.(e.pointerId);
    document.body.classList.add('clo-noselect'); showShield();
  }
  function onHeadMove(e){
    if(!arming && !dragging) return;
    const dx=e.clientX-sx, dy=e.clientY-sy;
    if(!dragging){
      if(Math.abs(dx)>THRESH || Math.abs(dy)>THRESH){ dragging=true; arming=false; }
      else{ e.stopImmediatePropagation(); return; }
    }
    e.stopImmediatePropagation(); e.preventDefault();
    panel.style.left=(sl+dx)+'px';
    panel.style.top =(st+dy)+'px';
  }
  function onHeadUp(e){
    if(!(arming||dragging)) return;
    e.stopImmediatePropagation();
    arming=false; dragging=false;
    head.releasePointerCapture?.(e.pointerId);
    document.body.classList.remove('clo-noselect'); hideShield();
  }
  head.addEventListener('pointerdown', onHeadDown, {capture:true});
  window.addEventListener('pointermove', onHeadMove, {capture:true});
  window.addEventListener('pointerup',   onHeadUp,   {capture:true});

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * 3) í‘œ ë²„íŠ¼(ë¹„ìš°ê¸°/TSV/XLSX) ë‹¤ì‹œ ë°”ì¸ë”©
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function bindTableButtons(){
    const body = $('#selBody'); if(!body) return;

    // í‘œ ë¹„ìš°ê¸°
    const bClear = $('#btnClearSel');
    if(bClear && !bClear.dataset.bound){
      bClear.dataset.bound='1';
      bClear.addEventListener('click', ()=>{
        body.innerHTML='';
        // ë¹¨ê°„ ì„ íƒ í‘œì‹œ í•´ì œ
        $$('.mk-bubble.sel,.mk-circle.sel,.mk-tag.sel').forEach(el=>el.classList.remove('sel'));
      }, {capture:true});
    }

    // TSV ë³µì‚¬
    const bTSV = $('#btnCopyTSV');
    if(bTSV && !bTSV.dataset.bound){
      bTSV.dataset.bound='1';
      bTSV.addEventListener('click', async ()=>{
        const headRow = ["ê³ ìœ ë²ˆí˜¸","ì‹œì„¤ëª…","êµ¬ë¶„ì£¼ì†Œ","êµ°ì§‘","ìœ„ë„","ê²½ë„","ê²½ë¡œ"];
        const rows=[headRow.join('\t')];
        $$('#selBody tr').forEach(tr=>{
          const t=Array.from(tr.querySelectorAll('td'));
          const route=tr.querySelector('input.routeOrder')?.value||"";
          rows.push([
            t[0]?.innerText||"", t[1]?.innerText||"", t[2]?.innerText||"", t[3]?.innerText||"",
            t[4]?.innerText||"", t[5]?.innerText||"", route
          ].join('\t'));
        });
        const txt=rows.join('\n');
        try{ await navigator.clipboard.writeText(txt); alert('TSVê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        catch(_){
          const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta);
          ta.select(); document.execCommand('copy'); ta.remove(); alert('TSVê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      }, {capture:true});
    }

    // XLSX ì €ì¥
    const bXLSX = $('#btnSaveXLSX');
    if(bXLSX && !bXLSX.dataset.bound){
      bXLSX.dataset.bound='1';
      bXLSX.addEventListener('click', ()=>{
        if(!window.XLSX){ alert('XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }
        const arr=[];
        $$('#selBody tr').forEach(tr=>{
          const t=Array.from(tr.querySelectorAll('td'));
          arr.push({
            "ê³ ìœ ë²ˆí˜¸":t[0]?.innerText||"", "ì‹œì„¤ëª…":t[1]?.innerText||"", "êµ¬ë¶„ì£¼ì†Œ":t[2]?.innerText||"",
            "êµ°ì§‘":t[3]?.innerText||"", "ìœ„ë„":t[4]?.innerText||"", "ê²½ë„":t[5]?.innerText||"",
            "ê²½ë¡œ":tr.querySelector('input.routeOrder')?.value||""
          });
        });
        const ws=XLSX.utils.json_to_sheet(arr);
        const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"ì„ íƒëª©ë¡");
        XLSX.writeFile(wb,"ì„ íƒëª©ë¡.xlsx");
      }, {capture:true});
    }
  }
  bindTableButtons();

})();
</script><script>
(function(){
  const $=(q,root=document)=>root.querySelector(q);
  const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));

  const panel = $('#selPanel');
  const shield= $('#mapShield');
  if(!panel || panel.dataset.v11Applied) return;
  panel.dataset.v11Applied='1';

  /* â–¸ ë²„íŠ¼ ë™ì‘ ë³´ê°•(í˜¹ì‹œ ëŠê²¨ìˆì„ ê²½ìš° ì¬ë°”ì¸ë”©) */
  // TSV ë³µì‚¬
  if($('#btnCopyTSV') && !$('#btnCopyTSV').dataset.bound){
    $('#btnCopyTSV').addEventListener('click', async ()=>{
      const head=["ê³ ìœ ë²ˆí˜¸","ì‹œì„¤ëª…","êµ¬ë¶„ì£¼ì†Œ","êµ°ì§‘","ìœ„ë„","ê²½ë„","ê²½ë¡œ"];
      const out=[head.join('\t')];
      $$('#selBody tr').forEach(tr=>{
        const t=Array.from(tr.querySelectorAll('td'));
        const route=tr.querySelector('input.routeOrder')?.value||"";
        out.push([t[0]?.innerText||"", t[1]?.innerText||"", t[2]?.innerText||"", t[3]?.innerText||"", t[4]?.innerText||"", t[5]?.innerText||"", route].join('\t'));
      });
      const txt=out.join('\n');
      try{ await navigator.clipboard.writeText(txt); alert("TSVê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }
      catch(e){ const ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert("TSVê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }
    });
    $('#btnCopyTSV').dataset.bound='1';
  }
  // XLSX ì €ì¥
  if($('#btnSaveXLSX') && !$('#btnSaveXLSX').dataset.bound){
    $('#btnSaveXLSX').addEventListener('click', ()=>{
      if(!window.XLSX){ alert('XLSX ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const arr=[];
      $$('#selBody tr').forEach(tr=>{
        const t=Array.from(tr.querySelectorAll('td'));
        arr.push({"ê³ ìœ ë²ˆí˜¸":t[0]?.innerText||"", "ì‹œì„¤ëª…":t[1]?.innerText||"", "êµ¬ë¶„ì£¼ì†Œ":t[2]?.innerText||"", "êµ°ì§‘":t[3]?.innerText||"", "ìœ„ë„":t[4]?.innerText||"", "ê²½ë„":t[5]?.innerText||"", "ê²½ë¡œ":tr.querySelector('input.routeOrder')?.value||""});
      });
      const ws=XLSX.utils.json_to_sheet(arr);
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,"ì„ íƒëª©ë¡");
      XLSX.writeFile(wb,"ì„ íƒëª©ë¡.xlsx");
    });
    $('#btnSaveXLSX').dataset.bound='1';
  }
  // í‘œ ë¹„ìš°ê¸° (ì„ íƒ/ê²½ë¡œë„ í•¨ê»˜ ë¦¬ì…‹)
  if($('#btnClearSel') && !$('#btnClearSel').dataset.bound){
    $('#btnClearSel').addEventListener('click', ()=>{
      const body=$('#selBody'); if(body) body.innerHTML='';
      (window.selectedIds?.clear?.bind(window.selectedIds) || function(){})();
      // ì„ íƒ ìŠ¤íƒ€ì¼ í•´ì œ
      $$('.mk-bubble.sel,.mk-circle.sel,.mk-tag.sel').forEach(el=>el.classList.remove('sel'));
      // ê²½ë¡œ ë¼ì¸ ì œê±°
      try{ window.routeLayer && window.routeLayer.clearLayers && window.routeLayer.clearLayers(); }catch(_){}
      // ìˆœë²ˆ ì…ë ¥ ë¹„ìš°ê¸°/ìƒíƒœ ë¦¬ì…‹
      $$('input.routeOrder').forEach(i=>i.value='');
      const ab=$('#abInfo'); if(ab) ab.textContent='A/B: -';
      const st=$('#routeStat'); if(st) st.textContent='ê±°ë¦¬: - / ì‹œê°„: -';
    });
    $('#btnClearSel').dataset.bound='1';
  }

  /* â–¸ ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ(ì•ˆì •í™”ëŠ” ì´ì „ v8/v10 ìœ ì§€) â€“ ê¸°ë³¸ ë™ì‘ë§Œ: íŒ¨ë„ ìœ„ hover ì‹œ ì§€ë„ ì°¨ë‹¨ */
  const stop=(e)=>{ e.preventDefault(); e.stopPropagation(); };
  function showShield(){ shield && (shield.style.display='block'); }
  function hideShield(){ shield && (shield.style.display='none'); }
  panel.addEventListener('mouseenter', ()=>{
    showShield();
    panel.addEventListener('wheel', stop, {passive:false});
    panel.addEventListener('touchmove', stop, {passive:false});
    if(window.L && L?.DomEvent){
      try{ L.DomEvent.disableClickPropagation(panel); L.DomEvent.disableScrollPropagation(panel); }catch(_){}
    }
  });
  panel.addEventListener('mouseleave', ()=>{
    hideShield();
    panel.removeEventListener('wheel', stop, {passive:false});
    panel.removeEventListener('touchmove', stop, {passive:false});
  });

  /* â–¸ ì¤‘ì•™ ì´ˆê¸° ìœ„ì¹˜ ë³´ì • + ê²½ê³„ ì œí•œ ê¸°ëŠ¥ */
  function constrainPanelToViewport() {
    const vw = window.innerWidth, vh = window.innerHeight;
    const rect = panel.getBoundingClientRect();
    
    // íŒ¨ë„ì´ ë·°í¬íŠ¸ ê²½ê³„ë¥¼ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ì œí•œ
    const minX = 0;
    const maxX = vw - rect.width;
    const minY = 0; 
    const maxY = vh - rect.height;
    
    const currentX = parseInt(panel.style.left) || rect.left;
    const currentY = parseInt(panel.style.top) || rect.top;
    
    const constrainedX = Math.max(minX, Math.min(maxX, currentX));
    const constrainedY = Math.max(minY, Math.min(maxY, currentY));
    
    if (constrainedX !== currentX || constrainedY !== currentY) {
      panel.style.left = constrainedX + 'px';
      panel.style.top = constrainedY + 'px';
      panel.style.right = '';
      panel.style.bottom = '';
    }
  }

  if(!panel.dataset.centered){
    const vw=window.innerWidth, vh=window.innerHeight;
    const r=panel.getBoundingClientRect();
    panel.style.left = Math.max(16, (vw - r.width)/2) + 'px';
    panel.style.top  = Math.max(16, (vh - r.height)/2) + 'px';
    panel.style.right = ''; panel.style.bottom = '';
    panel.dataset.centered='1';
  }
  
  // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ íŒ¨ë„ ê²½ê³„ ì²´í¬
  window.addEventListener('resize', constrainPanelToViewport, {passive: true});

  /* â–¸ ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ìƒí•œ ì¬í•´ì œ(í…Œë§ˆê°€ ê°±ì‹ í•´ë²„ë¦¬ëŠ” ê²½ìš° ìˆ˜ì‹œ ë³´ì •) */
  const scroller = Array.from(panel.children).find(el=>/overflow:auto|scroll/i.test(el.style?.overflow||''));
  function unlock(){ if(!scroller) return; scroller.style.maxHeight='none'; scroller.style.height='auto'; }
  unlock(); window.addEventListener('resize', unlock, {passive:true});
})();
</script><script>
(function() {
  'use strict';
  
  const panel = document.getElementById('selPanel');
  if (!panel || panel.dataset.mobileEnhanced) return;
  panel.dataset.mobileEnhanced = '1';
  
  // Mobile/Touch device detection
  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  const isMobileViewport = () => window.innerWidth <= 768;
  const isTabletViewport = () => window.innerWidth > 768 && window.innerWidth <= 1024;
  
  // Enhanced touch event handling for better mobile experience
  function addTouchSupport() {
    const head = panel.querySelector('.head');
    const edges = panel.querySelectorAll('.edge');
    
    // Prevent scrolling on the panel during interactions
    function preventScroll(e) {
      if (panel.contains(e.target)) {
        e.preventDefault();
      }
    }
    
    // Enhanced drag support with touch events
    let isDragging = false;
    let isResizing = false;
    let startPos = { x: 0, y: 0 };
    let startRect = null;
    let activeEdge = null;
    
    // Universal event handling (mouse, touch, pointer)
    function getEventPos(e) {
      return {
        x: e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0),
        y: e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0)
      };
    }
    
    // Start dragging/resizing
    function startInteraction(e, type, edge = null) {
      const pos = getEventPos(e);
      startPos = pos;
      startRect = panel.getBoundingClientRect();
      
      if (type === 'drag') {
        isDragging = true;
        panel.style.cursor = 'grabbing';
      } else if (type === 'resize') {
        isResizing = true;
        activeEdge = edge;
      }
      
      // Prevent text selection and other default behaviors
      e.preventDefault();
      document.body.style.userSelect = 'none';
      document.body.style.webkitUserSelect = 'none';
      
      // Add event listeners to document for global tracking
      if (isTouchDevice) {
        document.addEventListener('touchmove', handleMove, { passive: false });
        document.addEventListener('touchend', endInteraction, { passive: false });
      } else {
        document.addEventListener('mousemove', handleMove, { passive: false });
        document.addEventListener('mouseup', endInteraction, { passive: false });
      }
    }
    
    // Handle movement during drag/resize
    function handleMove(e) {
      if (!isDragging && !isResizing) return;
      
      const pos = getEventPos(e);
      const deltaX = pos.x - startPos.x;
      const deltaY = pos.y - startPos.y;
      
      if (isDragging) {
        // Drag the panel
        const newLeft = Math.max(0, Math.min(window.innerWidth - startRect.width, startRect.left + deltaX));
        const newTop = Math.max(0, Math.min(window.innerHeight - startRect.height, startRect.top + deltaY));
        
        panel.style.left = newLeft + 'px';
        panel.style.top = newTop + 'px';
        panel.style.right = 'auto';
        panel.style.bottom = 'auto';
      } else if (isResizing && activeEdge) {
        // Resize the panel based on active edge
        const minWidth = isMobileViewport() ? 280 : 360;
        const minHeight = isMobileViewport() ? 180 : 220;
        const maxWidth = window.innerWidth - 32;
        const maxHeight = window.innerHeight - 120;
        
        let newWidth = startRect.width;
        let newHeight = startRect.height;
        let newLeft = startRect.left;
        let newTop = startRect.top;
        
        switch (activeEdge) {
          case 'right':
            newWidth = Math.max(minWidth, Math.min(maxWidth, startRect.width + deltaX));
            break;
          case 'left':
            const leftDelta = Math.min(deltaX, startRect.width - minWidth);
            newWidth = Math.max(minWidth, startRect.width - leftDelta);
            newLeft = Math.max(0, startRect.left + leftDelta);
            break;
          case 'bottom':
            newHeight = Math.max(minHeight, Math.min(maxHeight, startRect.height + deltaY));
            break;
          case 'top':
            const topDelta = Math.min(deltaY, startRect.height - minHeight);
            newHeight = Math.max(minHeight, startRect.height - topDelta);
            newTop = Math.max(0, startRect.top + topDelta);
            break;
        }
        
            // Ensure panel header stays within map boundaries
        const mapContainer = document.getElementById('map');
        const mapRect = mapContainer ? mapContainer.getBoundingClientRect() : { left: 0, top: 0, right: window.innerWidth, bottom: window.innerHeight };
        const headerHeight = 50; // Approximate header height
        
        // Constrain position so header stays within map bounds
        const constrainedLeft = Math.max(mapRect.left, Math.min(mapRect.right - 200, newLeft));
        const constrainedTop = Math.max(mapRect.top, Math.min(mapRect.bottom - headerHeight, newTop));
        
        // Apply new dimensions and position
        panel.style.width = newWidth + 'px';
        panel.style.height = newHeight + 'px';
        panel.style.left = constrainedLeft + 'px';
        panel.style.top = constrainedTop + 'px';
        panel.style.right = 'auto';
        panel.style.bottom = 'auto';
      }
      
      e.preventDefault();
    }
    
    // End interaction
    function endInteraction(e) {
      isDragging = false;
      isResizing = false;
      activeEdge = null;
      panel.style.cursor = '';
      
      document.body.style.userSelect = '';
      document.body.style.webkitUserSelect = '';
      
      // Remove event listeners
      if (isTouchDevice) {
        document.removeEventListener('touchmove', handleMove);
        document.removeEventListener('touchend', endInteraction);
      } else {
        document.removeEventListener('mousemove', handleMove);
        document.removeEventListener('mouseup', endInteraction);
      }
    }
    
    // Add touch/mouse event listeners to header (for dragging)
    if (head) {
      if (isTouchDevice) {
        head.addEventListener('touchstart', (e) => {
          if (!e.target.matches('button, input, select, textarea, a')) {
            startInteraction(e, 'drag');
          }
        }, { passive: false });
      } else {
        head.addEventListener('mousedown', (e) => {
          if (!e.target.matches('button, input, select, textarea, a')) {
            startInteraction(e, 'drag');
          }
        });
      }
      
      // Enhanced double-click/tap to center
      let lastTap = 0;
      function handleDoubleTap(e) {
        const now = Date.now();
        if (now - lastTap < 300) {
          e.preventDefault();
          if (window.centerSelectionPanel) {
            window.centerSelectionPanel();
          }
        }
        lastTap = now;
      }
      
      if (isTouchDevice) {
        head.addEventListener('touchend', handleDoubleTap, { passive: false });
      } else {
        head.addEventListener('dblclick', (e) => {
          if (window.centerSelectionPanel) {
            window.centerSelectionPanel();
          }
        });
      }
    }
    
    // Add touch/mouse event listeners to edges (for resizing)
    edges.forEach(edge => {
      const edgeType = edge.className.split(' ').find(cls => cls.startsWith('e-'))?.substring(2);
      if (!edgeType) return;
      
      if (isTouchDevice) {
        edge.addEventListener('touchstart', (e) => {
          startInteraction(e, 'resize', edgeType);
        }, { passive: false });
      } else {
        edge.addEventListener('mousedown', (e) => {
          startInteraction(e, 'resize', edgeType);
        });
      }
    });
  }
  
  // Apply enhanced touch support
  addTouchSupport();
  
  // Window resize handler for responsive adjustments
  function handleWindowResize() {
    if (panel.style.display !== 'block') return;
    
    const rect = panel.getBoundingClientRect();
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    // Ensure panel stays within viewport bounds
    let needsAdjustment = false;
    let newLeft = parseFloat(panel.style.left) || rect.left;
    let newTop = parseFloat(panel.style.top) || rect.top;
    let newWidth = parseFloat(panel.style.width) || rect.width;
    let newHeight = parseFloat(panel.style.height) || rect.height;
    
    // Constrain panel to stay within map boundaries
    const mapContainer = document.getElementById('map');
    const mapRect = mapContainer ? mapContainer.getBoundingClientRect() : { left: 0, top: 0, right: window.innerWidth, bottom: window.innerHeight };
    const headerHeight = 50; // Approximate header height
    
    // Constrain to map viewport with header accessibility
    if (newLeft + newWidth > mapRect.right) {
      newLeft = Math.max(mapRect.left, mapRect.right - newWidth);
      needsAdjustment = true;
    }
    if (newLeft < mapRect.left) {
      newLeft = mapRect.left;
      needsAdjustment = true;
    }
    if (newTop + headerHeight > mapRect.bottom) {
      newTop = Math.max(mapRect.top, mapRect.bottom - headerHeight);
      needsAdjustment = true;
    }
    if (newTop < mapRect.top) {
      newTop = mapRect.top;
      needsAdjustment = true;
    }
    
    // Ensure minimum size based on viewport
    const minWidth = isMobileViewport() ? 280 : 360;
    const minHeight = isMobileViewport() ? 180 : 220;
    const maxWidth = viewportWidth - 32;
    const maxHeight = viewportHeight - 120;
    
    if (newWidth < minWidth || newWidth > maxWidth) {
      newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
      needsAdjustment = true;
    }
    if (newHeight < minHeight || newHeight > maxHeight) {
      newHeight = Math.max(minHeight, Math.min(maxHeight, newHeight));
      needsAdjustment = true;
    }
    
    if (needsAdjustment) {
      panel.style.left = newLeft + 'px';
      panel.style.top = newTop + 'px';
      panel.style.width = newWidth + 'px';
      panel.style.height = newHeight + 'px';
      panel.style.right = 'auto';
      panel.style.bottom = 'auto';
    }
  }
  
  // Debounce window resize events
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(handleWindowResize, 100);
  }, { passive: true });
  
  // Initial setup
  handleWindowResize();
})();
</script></body>
</html>