<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AUTO MAP - CLUSTRO (Final Secured v12.2)</title>

<!-- ğŸ”’ SECURITY HEADERS - ë¯¼ê° ì •ë³´ ë…¸ì¶œ ë° XSS ë°©ì§€ -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self'; 
  script-src 'self' 'unsafe-inline' https://unpkg.com https://fonts.gstatic.com https://api.vworld.kr;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://unpkg.com;
  font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com;
  img-src 'self' data: blob: https: http:;
  connect-src 'self' https: http:;
  frame-ancestors 'none';
  base-uri 'self';
  form-action 'self';
">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
<meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

<style>
/**
 * ğŸ¨ DESIGN SYSTEM - ì¼ê´€ëœ ì½”ë”© ìŠ¤íƒ€ì¼ê³¼ ë°˜ì‘í˜• ë””ìì¸
 * ëª¨ë“  CSS ë³€ìˆ˜ì™€ í´ë˜ìŠ¤ëŠ” ì²´ê³„ì ìœ¼ë¡œ ì •ë¦¬ë¨
 */
:root {
  /* ğŸ¨ Color System - ì ‘ê·¼ì„±ì„ ê³ ë ¤í•œ ìƒ‰ìƒ ëŒ€ë¹„ */
  --c-primary: #1F3A8A;
  --c-sky: #0EA5E9;
  --c-accent: #EA580C;
  --c-util: #334155;
  --c-success: #059669;
  --c-warning: #D97706;
  --c-danger: #DC2626;
  
  /* ğŸ“ Layout System */
  --rail-w: 64px;
  --side-w: 380px;
  --gut-w: 6px;
  
  /* ğŸ“ Typography System */
  --flt-font: 14px;
  --tbl-font: 14px;
  --font-family: 300 "Roboto", "Apple SD Gothic Neo", "Malgun Gothic", system-ui, sans-serif;
  
  /* ğŸ—ºï¸ Map System */
  --mk: 30px;
  
  /* ğŸ¯ Animation System */
  --transition-fast: 0.15s ease;
  --transition-normal: 0.25s ease;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
}

/* ğŸ“± RESPONSIVE DESIGN - ë‹¤ì–‘í•œ í™”ë©´ í¬ê¸° ì§€ì› */
@media (max-width: 768px) {
  :root {
    --rail-w: 48px;
    --side-w: 280px;
    --flt-font: 12px;
    --tbl-font: 12px;
  }
  
  #app {
    grid-template-columns: var(--rail-w) 1fr;
    grid-template-areas: "rail toolbar" "rail main";
  }
  
  #lhs {
    position: fixed;
    left: -100%;
    top: 0;
    width: var(--side-w);
    height: 100vh;
    z-index: 9999;
    transition: left var(--transition-normal);
  }
  
  #lhs.mobile-open {
    left: var(--rail-w);
  }
  
  .mobile-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 9998;
    display: none;
  }
  
  .mobile-overlay.show {
    display: block;
  }
}

@media (max-width: 480px) {
  :root {
    --rail-w: 40px;
    --side-w: 100vw;
  }
  
  .icbtn span {
    display: none;
  }
}

/* ğŸ¯ BASE STYLES */
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font: 14px/1.45 var(--font-family);
  color: #111;
  background: #fff;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ğŸ“ LAYOUT GRID */
#app {
  display: grid;
  min-height: 100vh;
  grid-template-columns: var(--rail-w) var(--side-w) var(--gut-w) 1fr;
  grid-template-rows: auto 1fr;
  grid-template-areas: "rail toolbar toolbar toolbar" "rail lhs gut rhs";
}

/* ğŸ”§ TOOLBAR */
#toolbar {
  grid-area: toolbar;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  padding: 8px 10px;
  border-bottom: 1px solid #e5e7eb;
  background: #fff;
  position: relative;
  z-index: 1000;
}

/* ğŸ›ï¸ FORM CONTROLS - ì¼ê´€ëœ ìŠ¤íƒ€ì¼ë§ */
.form-control,
select,
input[type="text"],
input[type="file"],
input[type="number"],
input[type="url"],
input[type="search"] {
  padding: 7px 10px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  background: #fff;
  font-weight: 300;
  transition: all var(--transition-fast);
  font-family: inherit;
}

.form-control:focus,
select:focus,
input:focus {
  outline: none;
  border-color: var(--c-sky);
  box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.1);
}

.form-control:invalid {
  border-color: var(--c-danger);
}

/* ğŸ·ï¸ BADGES & STATUS */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid #e5e7eb;
  background: #fff;
  font-weight: 700;
  font-size: 12px;
  transition: all var(--transition-fast);
}

.badge.ok {
  border-color: #cfe9d5;
  color: var(--c-success);
  background: #f0fdf4;
}

.badge.warn {
  border-color: #fed7aa;
  color: var(--c-warning);
  background: #fffbeb;
}

.badge.bad {
  border-color: #fecaca;
  color: var(--c-danger);
  background: #fef2f2;
}

/* ğŸ”˜ BUTTONS - í–¥ìƒëœ ë²„íŠ¼ ì‹œìŠ¤í…œ */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  border: 1px solid transparent;
  font-weight: 600;
  font-size: 14px;
  text-decoration: none;
  transition: all var(--transition-fast);
  user-select: none;
  position: relative;
  overflow: hidden;
}

.btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.btn:hover::before {
  left: 100%;
}

.btn-primary {
  background: var(--c-primary);
  border-color: var(--c-primary);
  color: #fff;
}

.btn-sky {
  background: var(--c-sky);
  border-color: var(--c-sky);
  color: #fff;
}

.btn-accent {
  background: var(--c-accent);
  border-color: var(--c-accent);
  color: #fff;
}

.btn-util {
  background: var(--c-util);
  border-color: var(--c-util);
  color: #fff;
}

.btn-outline {
  background: transparent;
  border-color: currentColor;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}

.btn:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

.btn:active:not(:disabled) {
  transform: translateY(0);
}

/* ğŸ“± LEFT RAIL */
#rail {
  grid-area: rail;
  border-right: 1px solid #e5e7eb;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 8px 6px;
  gap: 8px;
  position: relative;
  z-index: 1001;
}

.logo-box {
  width: 56px;
  height: 56px;
  padding: 4px;
  border-radius: 14px;
  border: 1px solid #e5e7eb;
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

.logo-box svg {
  width: 48px;
  height: 48px;
  display: block;
}

.icbtn {
  width: 56px;
  border: 1px solid #e5e7eb;
  border-radius: 14px;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 8px 4px;
  cursor: pointer;
  transition: all var(--transition-fast);
  position: relative;
}

.icbtn svg {
  width: 22px;
  height: 22px;
  stroke: #111;
  fill: none;
  stroke-width: 2;
  transition: all var(--transition-fast);
}

.icbtn span {
  font-size: 11px;
  font-weight: 700;
  color: #111;
  transition: all var(--transition-fast);
}

.icbtn.active {
  background: var(--c-sky);
  border-color: var(--c-sky);
  box-shadow: var(--shadow-md);
}

.icbtn.active svg,
.icbtn.active span {
  stroke: #fff;
  color: #fff;
}

.icbtn:hover:not(.active) {
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

/* ğŸ“‹ LEFT SIDEBAR */
#lhs {
  grid-area: lhs;
  border-right: 1px solid #e5e7eb;
  background: #fff;
  overflow: auto;
  font-size: var(--flt-font);
}

/* ğŸ” DETAILS & ACCORDION */
details {
  border-bottom: 1px solid #f1f5f9;
}

details:last-child {
  border-bottom: none;
}

summary {
  list-style: none;
  cursor: pointer;
  padding: 14px 12px;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: all var(--transition-fast);
  user-select: none;
}

summary::-webkit-details-marker {
  display: none;
}

summary::after {
  content: '+';
  font-size: 18px;
  font-weight: 300;
  transition: transform var(--transition-fast);
}

details[open] summary::after {
  transform: rotate(45deg);
}

summary:hover {
  background: #f8fafc;
}

details[open] summary {
  border-bottom: 1px solid #e2e8f0;
  background: #f8fafc;
}

.card {
  padding: 12px;
}

/* ğŸ¯ LOADING & PROGRESS INDICATORS - ì‚¬ìš©ì ê²½í—˜ ê°œì„  */
.loading {
  position: relative;
  pointer-events: none;
  opacity: 0.7;
}

.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid #e5e7eb;
  border-top-color: var(--c-sky);
  border-radius: 50%;
  animation: spin 1s infinite linear;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.progress-bar {
  width: 100%;
  height: 4px;
  background: #f1f5f9;
  border-radius: 2px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: var(--c-sky);
  transition: width 0.3s ease;
  border-radius: 2px;
}

/* ğŸ”” NOTIFICATIONS & ALERTS */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 16px;
  border-radius: 8px;
  box-shadow: var(--shadow-lg);
  z-index: 10000;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
  transform: translateX(400px);
  transition: transform var(--transition-normal);
}

.notification.show {
  transform: translateX(0);
}

.notification.success {
  background: #f0fdf4;
  border: 1px solid #bbf7d0;
  color: #166534;
}

.notification.warning {
  background: #fffbeb;
  border: 1px solid #fed7aa;
  color: #92400e;
}

.notification.error {
  background: #fef2f2;
  border: 1px solid #fecaca;
  color: #991b1b;
}

/* ğŸ’¾ PERFORMANCE OPTIMIZATIONS - ë Œë”ë§ ìµœì í™” */
.virtualized-list {
  height: 400px;
  overflow-y: auto;
}

.list-item {
  height: 40px;
  display: flex;
  align-items: center;
  padding: 0 12px;
  border-bottom: 1px solid #f1f5f9;
  will-change: transform;
}

/* ğŸ”§ UTILITY CLASSES */
.small { font-size: 12px; color: #6b7280; font-weight: 400; }
.text-center { text-align: center; }
.text-right { text-align: right; }
.hidden { display: none !important; }
.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

/* ğŸ¨ FORM LAYOUTS */
.row {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

.row > * {
  flex: 1 1 auto;
}

.chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 6px;
}

.chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #f3f4f6;
  border: 1px solid #e5e7eb;
  border-radius: 999px;
  padding: 4px 8px;
  color: #111;
  font-size: 12px;
  transition: all var(--transition-fast);
  cursor: pointer;
  user-select: none;
}

.chip:hover {
  background: #e5e7eb;
  transform: translateY(-1px);
}

.chip input[type="checkbox"] {
  margin: 0;
}

/* ğŸ›ï¸ SWITCHES */
.switch {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 26px;
}

.switch input {
  display: none;
}

.slider {
  position: absolute;
  inset: 0;
  background: #e5e7eb;
  border: 1px solid #d1d5db;
  border-radius: 999px;
  transition: all var(--transition-normal);
  cursor: pointer;
}

.slider:before {
  content: "";
  position: absolute;
  width: 22px;
  height: 22px;
  left: 2px;
  top: 1px;
  background: #fff;
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: all var(--transition-normal);
}

.switch input:checked + .slider {
  background: var(--c-sky);
  border-color: var(--c-sky);
}

.switch input:checked + .slider:before {
  transform: translateX(22px);
}

/* ğŸ“ RESIZER */
#gut {
  grid-area: gut;
  background: #f3f4f6;
  cursor: col-resize;
  transition: background var(--transition-fast);
}

#gut:hover {
  background: #e5e7eb;
}

/* ğŸ—ºï¸ MAP CONTAINER */
#rhs {
  grid-area: rhs;
  position: relative;
  background: #fafafa;
}

#map {
  position: absolute;
  inset: 0;
}

/* ğŸ”˜ MAP CONTROLS */
.map-bottom {
  position: absolute;
  right: 16px;
  bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  z-index: 6500;
}

.toolbar-map {
  position: static;
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  z-index: 6500;
}

/* ğŸ·ï¸ WATERMARK */
.wm {
  pointer-events: none;
  user-select: none;
  font: 700 14px/1 "Roboto", sans-serif;
  color: #fff;
  -webkit-text-stroke: 0.8px #000;
  text-shadow: 0 0 1px rgba(0,0,0,0.6);
}

#wm {
  position: fixed;
  bottom: 8px;
  right: 8px;
  z-index: 9999;
  background: rgba(255,255,255,0.8);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  color: #666;
  backdrop-filter: blur(4px);
}

/* ğŸ“‹ PANELS */
.panel {
  position: absolute;
  right: 16px;
  bottom: 90px;
  width: min(640px, 60vw);
  max-height: 60vh;
  overflow: hidden;
  background: #fff;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  box-shadow: var(--shadow-lg);
  z-index: 6000;
  display: none;
  min-width: 360px;
  min-height: 220px;
  backdrop-filter: blur(10px);
}

.panel .head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid #e2e8f0;
  background: #f8fafc;
  cursor: move;
  user-select: none;
}

.panel .head h4 {
  margin: 0;
  font-size: 14px;
  font-weight: 700;
}

.panel .body {
  overflow: auto;
  max-height: calc(60vh - 60px);
}

/* ğŸ“Š TABLES */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: var(--tbl-font);
  border: 1px solid #e2e8f0;
}

thead th {
  position: sticky;
  top: 0;
  background: #f8fafc;
  border-bottom: 1px solid #e2e8f0;
  padding: 10px 8px;
  font-weight: 700;
  border-right: 1px solid #f1f5f9;
  text-align: left;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

tbody td {
  border-bottom: 1px solid #f1f5f9;
  border-right: 1px solid #f1f5f9;
  padding: 8px;
  font-weight: 400;
  background: #fff;
}

tbody tr:hover {
  background: #f8fafc;
}

tbody tr.selected {
  background: #eff6ff;
  border-color: var(--c-sky);
}

/* ğŸ¯ MARKERS */
.mk {
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  line-height: 1;
  transform-origin: center;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.mk-circle {
  width: var(--mk);
  height: var(--mk);
  border-radius: 50%;
  border: 2px solid #000;
  background: #fff;
  color: #000;
  box-shadow: var(--shadow-md);
  font-size: 12px;
}

.mk-tag {
  padding: 4px 8px;
  border-radius: 6px;
  background: #000;
  color: #fff;
  border: 2px solid #000;
  box-shadow: var(--shadow-md);
  font-size: 12px;
}

.mk-bubble {
  position: relative;
  padding: 4px 8px 6px 8px;
  border-radius: 6px;
  background: #fff;
  color: #000;
  border: 2px solid #000;
  box-shadow: var(--shadow-md);
  font-size: 12px;
}

.mk-bubble i {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: -7px;
  width: 0;
  height: 0;
  border-left: 6px solid transparent;
  border-right: 6px solid transparent;
  border-top: 8px solid #000;
}

.mk-bubble.sel {
  background: var(--c-danger);
  color: #fff;
  border-color: var(--c-danger);
}

.mk-bubble.sel i {
  border-top-color: var(--c-danger);
}

.mk.hover {
  transform: scale(1.15);
  z-index: 1000;
}

/* ğŸŒ™ DARK MODE SUPPORT */
@media (prefers-color-scheme: dark) {
  :root {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --text-primary: #f1f5f9;
    --text-secondary: #94a3b8;
    --border-color: #334155;
  }
  
  body.auto-dark {
    background: var(--bg-primary);
    color: var(--text-primary);
  }
  
  .auto-dark #toolbar,
  .auto-dark #lhs,
  .auto-dark #rail,
  .auto-dark .panel {
    background: var(--bg-primary);
    border-color: var(--border-color);
    color: var(--text-primary);
  }
}

/* ğŸ® ACCESSIBILITY IMPROVEMENTS */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

.focus-visible {
  outline: 2px solid var(--c-sky);
  outline-offset: 2px;
}

/* ğŸ”§ ERROR HANDLING UI */
.error-boundary {
  padding: 20px;
  text-align: center;
  background: #fef2f2;
  border: 1px solid #fecaca;
  border-radius: 8px;
  margin: 20px;
}

.error-boundary h3 {
  color: var(--c-danger);
  margin-bottom: 10px;
}

/* ğŸ¯ PERFORMANCE MONITORING */
.perf-monitor {
  position: fixed;
  top: 10px;
  left: 10px;
  background: rgba(0,0,0,0.8);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 10px;
  font-family: monospace;
  z-index: 10001;
  display: none;
}

.perf-monitor.show {
  display: block;
}

/* Print styles */
@media print {
  #rail, #lhs, .panel, .map-bottom { display: none !important; }
  #rhs { grid-column: 1 / -1; }
  body { background: white !important; }
}
</style>

<!-- Leaflet CSS -->
<link id="leaflet-css" rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
</head>

<body>
<!-- Performance Monitor -->
<div class="perf-monitor" id="perfMonitor">
  FPS: <span id="fps">0</span> | 
  Memory: <span id="memory">0MB</span>
</div>

<!-- Mobile Overlay -->
<div class="mobile-overlay" id="mobileOverlay"></div>

<div id="app">
  <!-- ğŸ“± LEFT RAIL - ëª¨ë°”ì¼ ì¹œí™”ì  ë„¤ë¹„ê²Œì´ì…˜ -->
  <aside id="rail">
    <div class="logo-box" title="CLUSTRO v12.2 - Final Secured Edition" aria-label="CLUSTRO ë¡œê³ ">
      <svg viewBox="0 0 64 64" aria-label="CLUSTRO logo">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#0EA5E9"/>
            <stop offset="1" stop-color="#1F3A8A"/>
          </linearGradient>
        </defs>
        <circle cx="32" cy="32" r="28" fill="url(#g)" stroke="#0b2540" stroke-width="2"/>
        <circle cx="22" cy="22" r="4" fill="#fff"/>
        <circle cx="42" cy="22" r="4" fill="#fff"/>
        <circle cx="22" cy="42" r="4" fill="#fff"/>
        <circle cx="42" cy="42" r="4" fill="#fff"/>
        <path d="M22 22 L42 42 M42 22 L22 42" stroke="#fff" stroke-width="2"/>
      </svg>
    </div>
    
    <button class="icbtn" data-target="#secData" title="ë°ì´í„° ê´€ë¦¬" aria-label="ë°ì´í„° ê´€ë¦¬" role="tab">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 7h18M3 12h18M3 17h18"/>
        <circle cx="7" cy="7" r="1"/>
        <circle cx="11" cy="12" r="1"/>
        <circle cx="15" cy="17" r="1"/>
      </svg>
      <span>ë°ì´í„°</span>
    </button>
    
    <button class="icbtn" data-target="#secFilter" title="í•„í„° ì„¤ì •" aria-label="í•„í„° ì„¤ì •" role="tab">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 5h18l-7 8v5l-4 2v-7z"/>
      </svg>
      <span>í•„í„°</span>
    </button>
    
    <button class="icbtn" data-target="#secMap" title="ì§€ë„ ì„¤ì •" aria-label="ì§€ë„ ì„¤ì •" role="tab">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 6l7-3 7 3 4-2v16l-7 3-7-3-4 2V6zM10 3v16M17 6v15M3 6v14"/>
      </svg>
      <span>ì§€ë„</span>
    </button>
    
    <button class="icbtn" data-target="#secRoute" title="ê²½ë¡œ ê³„íš" aria-label="ê²½ë¡œ ê³„íš" role="tab">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 6h6l2 4h8M4 18h10l2-4h4"/>
      </svg>
      <span>ê²½ë¡œ</span>
    </button>
    
    <button class="icbtn" data-target="#secPrint" title="ì¶œë ¥ ì„¤ì •" aria-label="ì¶œë ¥ ì„¤ì •" role="tab">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M6 9V3h12v6M6 14h12v7H6z"/>
        <rect x="3" y="9" width="18" height="7" rx="2"/>
      </svg>
      <span>ì¶œë ¥</span>
    </button>
    
    <div style="margin-top:auto;font-size:11px;color:#9ca3af;text-align:center;">
      <div>v12.2</div>
      <div style="font-size:9px;">ğŸ”’ Secured</div>
    </div>
  </aside>

  <!-- ğŸ”§ TOOLBAR - ë°˜ì‘í˜• ë„êµ¬ëª¨ìŒ -->
  <header id="toolbar" role="banner">
    <button class="btn btn-sky mobile-menu-btn" id="mobileMenuBtn" aria-label="ë©”ë‰´ ì—´ê¸°" style="display:none;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
      ë©”ë‰´
    </button>
    
    <div class="badge ok">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 12l2 2 4-4"></path>
        <circle cx="12" cy="12" r="9"></circle>
      </svg>
      ë³´ì•ˆ ê°•í™”ë¨
    </div>
    
    <div class="badge" id="statusBadge">
      <span id="statusText">ì¤€ë¹„ë¨</span>
    </div>
    
    <div class="row" style="margin-left: auto;">
      <button class="btn btn-outline btn-util" id="perfToggle" title="ì„±ëŠ¥ ëª¨ë‹ˆí„° í† ê¸€">
        ğŸ“Š ì„±ëŠ¥
      </button>
      
      <button class="btn btn-outline btn-util" id="themeToggle" title="ë‹¤í¬ ëª¨ë“œ í† ê¸€">
        ğŸŒ™ í…Œë§ˆ
      </button>
    </div>
  </header>

  <!-- ğŸ“‹ LEFT SIDEBAR - í–¥ìƒëœ UI/UX -->
  <nav id="lhs" role="navigation" aria-label="ë©”ì¸ ë„¤ë¹„ê²Œì´ì…˜">
    <!-- ğŸ“Š DATA SECTION -->
    <section id="secData" class="sec active">
      <details open>
        <summary role="button" aria-expanded="true">
          <span>ğŸ“Š ë°ì´í„° ë¡œë“œ</span>
        </summary>
        <div class="card">
          <div class="row">
            <label class="form-control" for="fileInput" style="cursor: pointer; text-align: center;">
              <input type="file" id="fileInput" accept=".xlsx,.csv,.json" style="display: none;" aria-describedby="fileHelp">
              ğŸ“ íŒŒì¼ ì„ íƒ
            </label>
          </div>
          <div id="fileHelp" class="small" style="margin-top: 4px;">
            Excel(.xlsx), CSV, JSON íŒŒì¼ ì§€ì› (ìµœëŒ€ 10MB)
          </div>
          <div class="progress-bar" id="loadProgress" style="margin-top: 8px; display: none;">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>
      </details>

      <details id="adv" style="display:none">
        <summary role="button" aria-expanded="false">
          <span>âš™ï¸ ê³ ê¸‰ ì„¤ì •</span>
        </summary>
        <div class="card">
          <div class="row">
            <label for="sheet">ì‹œíŠ¸:</label>
            <select id="sheet" class="form-control" aria-label="ì‹œíŠ¸ ì„ íƒ"></select>
          </div>
          <div class="row">
            <label for="latCol">ìœ„ë„ ì—´:</label>
            <input type="text" id="latCol" value="R" class="form-control" aria-label="ìœ„ë„ ì»¬ëŸ¼">
          </div>
          <div class="row">
            <label for="lngCol">ê²½ë„ ì—´:</label>
            <input type="text" id="lngCol" value="S" class="form-control" aria-label="ê²½ë„ ì»¬ëŸ¼">
          </div>
          <button class="btn btn-primary" onclick="safeOperation('toRowsManual')">ì ìš©</button>
        </div>
      </details>

      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ“ˆ ë°ì´í„° í˜„í™©</span>
        </summary>
        <div class="card">
          <div class="row">
            <span class="badge" id="totalBadge">ì „ì²´: 0</span>
            <span class="badge ok" id="validBadge">ìœ íš¨: 0</span>
            <span class="badge warn" id="errorBadge">ì˜¤ë¥˜: 0</span>
          </div>
        </div>
      </details>
    </section>

    <!-- ğŸ” FILTER SECTION -->
    <section id="secFilter" class="sec">
      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ” ê²€ìƒ‰ í•„í„°</span>
        </summary>
        <div class="card">
          <div class="row">
            <input type="search" 
                   id="scopeInput" 
                   placeholder="ìë©´ë™ ë˜ëŠ” êµ°ì§‘ë²ˆí˜¸ ê²€ìƒ‰..." 
                   class="form-control"
                   autocomplete="off"
                   aria-label="ê²€ìƒ‰ì–´ ì…ë ¥">
            <button class="btn btn-sky" onclick="safeOperation('applyScope')">
              ê²€ìƒ‰
            </button>
          </div>
        </div>
      </details>

      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ˜ï¸ ìë©´ë™ë³„</span>
        </summary>
        <div class="card">
          <div class="chips" id="emdBox" role="group" aria-label="ìë©´ë™ í•„í„°"></div>
        </div>
      </details>

      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ‘¥ êµ°ì§‘ë³„</span>
        </summary>
        <div class="card">
          <div class="chips" id="grpBox" role="group" aria-label="êµ°ì§‘ í•„í„°"></div>
        </div>
      </details>
    </section>

    <!-- ğŸ—ºï¸ MAP SECTION -->
    <section id="secMap" class="sec">
      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ—ºï¸ ì§€ë„ ì„¤ì •</span>
        </summary>
        <div class="card">
          <div class="row">
            <label for="baseSelect">ë°°ê²½:</label>
            <select id="baseSelect" class="form-control" aria-label="ë°°ê²½ì§€ë„ ì„ íƒ">
              <option value="osm">OpenStreetMap</option>
              <option value="vworld_base" selected>VWorld ê¸°ë³¸</option>
              <option value="vworld_satellite">VWorld ìœ„ì„±</option>
              <option value="google_roadmap">Google ë„ë¡œ</option>
              <option value="google_satellite">Google ìœ„ì„±</option>
            </select>
          </div>
          
          <div class="row" style="margin-top: 12px;">
            <label>
              <input type="checkbox" id="clusterToggle" checked> 
              ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ë§
            </label>
          </div>
          
          <div class="row">
            <label>ë§ˆì»¤ ìŠ¤íƒ€ì¼:</label>
            <select id="markerStyle" class="form-control" aria-label="ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì„ íƒ">
              <option value="circle">ì›í˜•</option>
              <option value="tag">íƒœê·¸</option>
              <option value="bubble" selected>ë§í’ì„ </option>
            </select>
          </div>
        </div>
      </details>

      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ¨ í‘œì‹œ ì˜µì…˜</span>
        </summary>
        <div class="card">
          <div class="row">
            <label>
              <input type="checkbox" id="bwToggle"> 
              í‘ë°± ëª¨ë“œ
            </label>
          </div>
          
          <div class="row">
            <label for="fontSizeRange">í°íŠ¸ í¬ê¸°:</label>
            <input type="range" 
                   id="fontSizeRange" 
                   min="10" 
                   max="18" 
                   value="14" 
                   class="form-control"
                   aria-label="í°íŠ¸ í¬ê¸° ì¡°ì ˆ">
            <span id="fontSizeValue">14px</span>
          </div>
          
          <div class="row">
            <label for="markerSizeRange">ë§ˆì»¤ í¬ê¸°:</label>
            <input type="range" 
                   id="markerSizeRange" 
                   min="20" 
                   max="50" 
                   value="30" 
                   class="form-control"
                   aria-label="ë§ˆì»¤ í¬ê¸° ì¡°ì ˆ">
            <span id="markerSizeValue">30px</span>
          </div>
        </div>
      </details>
    </section>

    <!-- ğŸ›£ï¸ ROUTE SECTION -->
    <section id="secRoute" class="sec">
      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ›£ï¸ ê²½ë¡œ ê³„íš</span>
        </summary>
        <div class="card">
          <div class="row">
            <label for="dailyMax">ì¼ì¼ ìµœëŒ€:</label>
            <input type="number" 
                   id="dailyMax" 
                   value="15" 
                   min="1" 
                   max="100" 
                   class="form-control"
                   aria-label="ì¼ì¼ ìµœëŒ€ ë°©ë¬¸ ìˆ˜">
          </div>
          
          <button class="btn btn-accent" onclick="safeOperation('optimizeRoute')">
            ğŸ¯ ê²½ë¡œ ìµœì í™”
          </button>
          
          <div class="small" style="margin-top: 8px;">
            ì„ íƒëœ í•­ëª©ë“¤ì„ ê¸°ë°˜ìœ¼ë¡œ ìµœì  ê²½ë¡œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
          </div>
        </div>
      </details>

      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ“‹ ì„ íƒ ê´€ë¦¬</span>
        </summary>
        <div class="card">
          <button class="btn btn-sky" onclick="safeOperation('showSelectionPanel')">
            ğŸ“‹ ì„ íƒ ëª©ë¡ ë³´ê¸°
          </button>
          
          <button class="btn btn-util" onclick="safeOperation('clearSelection')">
            ğŸ—‘ï¸ ì„ íƒ ì´ˆê¸°í™”
          </button>
          
          <div id="selectionStats" class="small" style="margin-top: 8px;">
            ì„ íƒëœ í•­ëª©: <span id="selectedCount">0</span>ê°œ
          </div>
        </div>
      </details>
    </section>

    <!-- ğŸ–¨ï¸ PRINT SECTION -->
    <section id="secPrint" class="sec">
      <details>
        <summary role="button" aria-expanded="false">
          <span>ğŸ–¨ï¸ ì¶œë ¥ ì„¤ì •</span>
        </summary>
        <div class="card">
          <div class="row">
            <button class="btn btn-primary" onclick="safeOperation('exportExcel')">
              ğŸ“Š Excel ë‚´ë³´ë‚´ê¸°
            </button>
          </div>
          
          <div class="row">
            <button class="btn btn-accent" onclick="safeOperation('exportPDF')">
              ğŸ“„ PDF ë‚´ë³´ë‚´ê¸°
            </button>
          </div>
          
          <div class="row">
            <button class="btn btn-util" onclick="window.print()">
              ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°
            </button>
          </div>
        </div>
      </details>
    </section>
  </nav>

  <!-- ğŸ“ RESIZER -->
  <div id="gut" title="íŒ¨ë„ í¬ê¸° ì¡°ì ˆ" tabindex="0" role="separator" aria-label="íŒ¨ë„ í¬ê¸° ì¡°ì ˆ"></div>

  <!-- ğŸ—ºï¸ MAP CONTAINER -->
  <main id="rhs" role="main">
    <div id="map" aria-label="ì¸í„°ë™í‹°ë¸Œ ì§€ë„"></div>
    
    <!-- MAP CONTROLS -->
    <div class="map-bottom">
      <div class="toolbar-map">
        <button class="btn btn-sky" onclick="safeOperation('centerMap')" title="ì§€ë„ ì¤‘ì‹¬ ì´ë™">
          ğŸ¯ ì¤‘ì‹¬
        </button>
        
        <button class="btn btn-primary" onclick="safeOperation('fitBounds')" title="ì „ì²´ ë³´ê¸°">
          ğŸ” ì „ì²´
        </button>
        
        <button class="btn btn-accent" onclick="safeOperation('showStatistics')" title="í†µê³„ ë³´ê¸°">
          ğŸ“Š í†µê³„
        </button>
      </div>
    </div>
    
    <!-- WATERMARK -->
    <div id="wm" class="wm">CLUSTRO v12.2 Final Secured</div>
  </main>
</div>

<!-- ğŸ“‹ SELECTION PANEL -->
<div class="panel" id="selPanel" role="dialog" aria-labelledby="selPanelTitle" aria-hidden="true">
  <div class="head">
    <h4 id="selPanelTitle">ğŸ“‹ ì„ íƒëœ í•­ëª©</h4>
    <button class="btn btn-util" onclick="safeOperation('hideSelectionPanel')" aria-label="íŒ¨ë„ ë‹«ê¸°">
      âœ•
    </button>
  </div>
  <div class="body">
    <div style="padding: 8px;">
      <button class="btn btn-accent" onclick="safeOperation('clearSelection')" style="margin-bottom: 8px;">
        ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ
      </button>
    </div>
    <table role="table" aria-label="ì„ íƒëœ í•­ëª© ëª©ë¡">
      <thead>
        <tr>
          <th scope="col">ID</th>
          <th scope="col">ì‹œì„¤ëª…</th>
          <th scope="col">ì£¼ì†Œ</th>
          <th scope="col" class="row-actions">ì‚­ì œ</th>
        </tr>
      </thead>
      <tbody id="selBody"></tbody>
    </table>
  </div>
</div>

<!-- ğŸ”§ EXTERNAL SCRIPTS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- ğŸš€ MAIN APPLICATION SCRIPT -->
<script>
'use strict';

/**
 * ğŸ”’ SECURITY & UTILITY MODULE
 * ë³´ì•ˆ ê¸°ëŠ¥ê³¼ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ì„ ì¤‘ì•™ ì§‘ì¤‘ ê´€ë¦¬
 */
const SecurityUtils = {
  // HTML ì´ìŠ¤ì¼€ì´í”„ - XSS ë°©ì§€
  escapeHtml(unsafe) {
    if (unsafe == null) return '';
    return String(unsafe)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  },

  // ì…ë ¥ê°’ ê²€ì¦ ë° ì •ì œ
  validateInput(input, type = 'text', maxLength = 1000) {
    if (input == null) return '';
    
    input = String(input).trim();
    
    // ê¸¸ì´ ì œí•œ
    if (input.length > maxLength) {
      input = input.substring(0, maxLength);
    }
    
    switch(type) {
      case 'number':
        return input.replace(/[^\d.-]/g, '');
      case 'alphanumeric':
        return input.replace(/[^a-zA-Z0-9ê°€-í£\s\-_]/g, '');
      case 'filename':
        return input.replace(/[<>:"/\\|?*]/g, '');
      case 'coordinate':
        return input.replace(/[^\d.-]/g, '');
      default:
        // ê¸°ë³¸ XSS ë°©ì§€
        return input.replace(/<script[^>]*>.*?<\/script>/gi, '')
                   .replace(/javascript:/gi, '')
                   .replace(/on\w+\s*=/gi, '')
                   .replace(/<iframe[^>]*>.*?<\/iframe>/gi, '');
    }
  },

  // ì•ˆì „í•œ DOM ì¡°ì‘
  setTextContent(element, text) {
    if (!element) return;
    element.textContent = this.validateInput(text);
  },

  // íŒŒì¼ ê²€ì¦
  validateFile(file) {
    const errors = [];
    const MAX_SIZE = 10 * 1024 * 1024; // 10MB
    const ALLOWED_TYPES = ['.xlsx', '.csv', '.json'];
    
    if (!file) {
      errors.push('íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return errors;
    }
    
    if (file.size > MAX_SIZE) {
      errors.push(`íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. (ìµœëŒ€: ${MAX_SIZE/1024/1024}MB)`);
    }
    
    const fileExt = '.' + file.name.split('.').pop().toLowerCase();
    if (!ALLOWED_TYPES.includes(fileExt)) {
      errors.push(`í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. (í—ˆìš©: ${ALLOWED_TYPES.join(', ')})`);
    }
    
    if (!/^[a-zA-Z0-9ê°€-í£._\s\-()]+$/.test(file.name)) {
      errors.push('íŒŒì¼ëª…ì— í—ˆìš©ë˜ì§€ ì•ŠëŠ” ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
    }
    
    return errors;
  },

  // CSRF í† í° ìƒì„±
  generateCSRFToken() {
    return Array.from(crypto.getRandomValues(new Uint8Array(16)))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
  }
};

/**
 * ğŸ¯ PERFORMANCE MONITOR
 * ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë° ìµœì í™” ê´€ë¦¬
 */
const PerformanceMonitor = {
  frameCount: 0,
  lastTime: 0,
  
  init() {
    this.startFPSMonitor();
    this.monitorMemory();
  },
  
  startFPSMonitor() {
    const updateFPS = (currentTime) => {
      this.frameCount++;
      
      if (currentTime - this.lastTime >= 1000) {
        const fps = Math.round(this.frameCount * 1000 / (currentTime - this.lastTime));
        const fpsElement = document.getElementById('fps');
        if (fpsElement) fpsElement.textContent = fps;
        
        this.frameCount = 0;
        this.lastTime = currentTime;
      }
      
      requestAnimationFrame(updateFPS);
    };
    
    requestAnimationFrame(updateFPS);
  },
  
  monitorMemory() {
    if ('memory' in performance) {
      setInterval(() => {
        const memMB = Math.round(performance.memory.usedJSHeapSize / 1048576);
        const memElement = document.getElementById('memory');
        if (memElement) memElement.textContent = `${memMB}MB`;
      }, 1000);
    }
  }
};

/**
 * ğŸ”” NOTIFICATION SYSTEM
 * ì‚¬ìš©ì ê²½í—˜ í–¥ìƒì„ ìœ„í•œ ì•Œë¦¼ ì‹œìŠ¤í…œ
 */
const NotificationSystem = {
  show(message, type = 'success', duration = 3000) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    // ì•„ì´ì½˜ ì¶”ê°€
    const icons = {
      success: 'âœ…',
      warning: 'âš ï¸',
      error: 'âŒ',
      info: 'â„¹ï¸'
    };
    
    notification.innerHTML = `
      <span>${icons[type] || 'ğŸ“Œ'}</span>
      <span>${SecurityUtils.escapeHtml(message)}</span>
    `;
    
    document.body.appendChild(notification);
    
    // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    setTimeout(() => notification.classList.add('show'), 100);
    
    // ìë™ ì œê±°
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 250);
    }, duration);
  }
};

/**
 * ğŸ”„ ERROR HANDLER
 * ì „ì—­ ì˜¤ë¥˜ ì²˜ë¦¬ ë° ë³µêµ¬ ì‹œìŠ¤í…œ
 */
const ErrorHandler = {
  init() {
    window.addEventListener('error', this.handleError.bind(this));
    window.addEventListener('unhandledrejection', this.handlePromiseError.bind(this));
  },
  
  handleError(event) {
    console.error('ì „ì—­ ì˜¤ë¥˜:', event.error);
    
    const errorInfo = {
      message: event.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜',
      filename: event.filename || 'ì•Œ ìˆ˜ ì—†ëŠ” íŒŒì¼',
      line: event.lineno || 0,
      column: event.colno || 0
    };
    
    this.logError(errorInfo);
    this.showUserFriendlyError(errorInfo.message);
    
    // ë³µêµ¬ ì‹œë„
    this.attemptRecovery();
  },
  
  handlePromiseError(event) {
    console.error('ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ì˜¤ë¥˜:', event.reason);
    this.logError({
      message: event.reason?.message || 'ë¹„ë™ê¸° ì‘ì—… ì˜¤ë¥˜',
      type: 'promise'
    });
    
    this.showUserFriendlyError('ë¹„ë™ê¸° ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  },
  
  logError(errorInfo) {
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì˜¤ë¥˜ ë¡œê·¸ ì €ì¥ (ê°œë°œ/ë””ë²„ê¹… ìš©)
    try {
      const errorLog = JSON.parse(localStorage.getItem('errorLog') || '[]');
      errorLog.push({
        ...errorInfo,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        url: window.location.href
      });
      
      // ìµœëŒ€ 50ê°œ ë¡œê·¸ë§Œ ìœ ì§€
      if (errorLog.length > 50) {
        errorLog.splice(0, errorLog.length - 50);
      }
      
      localStorage.setItem('errorLog', JSON.stringify(errorLog));
    } catch (e) {
      console.warn('ì˜¤ë¥˜ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', e);
    }
  },
  
  showUserFriendlyError(message) {
    const userMessage = this.getUserFriendlyMessage(message);
    NotificationSystem.show(userMessage, 'error', 5000);
  },
  
  getUserFriendlyMessage(technicalMessage) {
    const friendlyMessages = {
      'fetch': 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.',
      'parse': 'íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
      'memory': 'ë©”ëª¨ë¦¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.',
      'permission': 'ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.',
      'quota': 'ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.'
    };
    
    for (const [key, message] of Object.entries(friendlyMessages)) {
      if (technicalMessage.toLowerCase().includes(key)) {
        return message;
      }
    }
    
    return 'ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
  },
  
  attemptRecovery() {
    // ê¸°ë³¸ì ì¸ ë³µêµ¬ ì‹œë„
    setTimeout(() => {
      if (window.myMap && !document.getElementById('map').hasChildNodes()) {
        console.log('ì§€ë„ ë³µêµ¬ ì‹œë„...');
        initializeMap();
      }
    }, 1000);
  }
};

/**
 * ğŸ“± RESPONSIVE HANDLER
 * ë°˜ì‘í˜• ë””ìì¸ ë° ëª¨ë°”ì¼ ì§€ì›
 */
const ResponsiveHandler = {
  isMobile: false,
  
  init() {
    this.checkDevice();
    this.setupMobileMenu();
    this.setupResizeListener();
  },
  
  checkDevice() {
    this.isMobile = window.innerWidth <= 768;
    document.body.classList.toggle('mobile', this.isMobile);
    
    // ëª¨ë°”ì¼ ë©”ë‰´ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    if (mobileMenuBtn) {
      mobileMenuBtn.style.display = this.isMobile ? 'flex' : 'none';
    }
  },
  
  setupMobileMenu() {
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const lhs = document.getElementById('lhs');
    
    if (mobileMenuBtn && mobileOverlay && lhs) {
      mobileMenuBtn.addEventListener('click', () => {
        lhs.classList.add('mobile-open');
        mobileOverlay.classList.add('show');
      });
      
      mobileOverlay.addEventListener('click', () => {
        lhs.classList.remove('mobile-open');
        mobileOverlay.classList.remove('show');
      });
    }
  },
  
  setupResizeListener() {
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        this.checkDevice();
        if (window.myMap) {
          window.myMap.invalidateSize();
        }
      }, 250);
    });
  }
};

/**
 * ğŸ¨ THEME MANAGER
 * ë‹¤í¬ëª¨ë“œ ë° í…Œë§ˆ ê´€ë¦¬
 */
const ThemeManager = {
  currentTheme: 'light',
  
  init() {
    this.loadTheme();
    this.setupThemeToggle();
  },
  
  loadTheme() {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    this.currentTheme = savedTheme || (prefersDark ? 'dark' : 'light');
    this.applyTheme(this.currentTheme);
  },
  
  applyTheme(theme) {
    document.body.classList.toggle('auto-dark', theme === 'dark');
    
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
      themeToggle.textContent = theme === 'dark' ? 'â˜€ï¸ ë¼ì´íŠ¸' : 'ğŸŒ™ ë‹¤í¬';
    }
    
    localStorage.setItem('theme', theme);
    this.currentTheme = theme;
  },
  
  setupThemeToggle() {
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        const newTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
        this.applyTheme(newTheme);
      });
    }
  }
};

/**
 * ğŸ—‚ï¸ STATE MANAGER
 * ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ ê´€ë¦¬ ì‹œìŠ¤í…œ
 */
const StateManager = {
  state: {
    rows: [],
    rowsById: new Map(),
    selectedIds: new Set(),
    markersById: new Map(),
    filters: {
      emd: new Set(),
      grp: new Set(),
      search: ''
    },
    ui: {
      currentSection: 'secData',
      panelVisible: false
    }
  },
  
  observers: [],
  
  subscribe(observer) {
    this.observers.push(observer);
  },
  
  notify(change) {
    this.observers.forEach(observer => {
      try {
        observer(change);
      } catch (error) {
        console.error('Observer ì˜¤ë¥˜:', error);
      }
    });
  },
  
  setState(updates) {
    const oldState = { ...this.state };
    this.state = { ...this.state, ...updates };
    this.notify({ oldState, newState: this.state, updates });
  },
  
  getState() {
    return { ...this.state };
  }
};

/**
 * ğŸ›¡ï¸ SAFE OPERATION WRAPPER
 * ëª¨ë“  ì‚¬ìš©ì ì•¡ì…˜ì„ ì•ˆì „í•˜ê²Œ ë˜í•‘í•˜ëŠ” í•¨ìˆ˜
 */
function safeOperation(operationName, ...args) {
  try {
    // ìƒíƒœ ì—…ë°ì´íŠ¸
    updateStatus('ì²˜ë¦¬ ì¤‘...', 'warn');
    
    // ì„±ëŠ¥ ì¸¡ì • ì‹œì‘
    const startTime = performance.now();
    
    // ì‹¤ì œ ì‘ì—… ì‹¤í–‰
    const result = executeOperation(operationName, ...args);
    
    // Promiseì¸ ê²½ìš° ì²˜ë¦¬
    if (result instanceof Promise) {
      return result
        .then(finalResult => {
          const duration = performance.now() - startTime;
          console.log(`ì‘ì—… ì™„ë£Œ: ${operationName} (${duration.toFixed(2)}ms)`);
          updateStatus('ì™„ë£Œ', 'ok');
          return finalResult;
        })
        .catch(error => {
          console.error(`ì‘ì—… ì‹¤íŒ¨: ${operationName}`, error);
          const userMessage = ErrorHandler.getUserFriendlyMessage(error.message);
          NotificationSystem.show(`ì‘ì—… ì‹¤íŒ¨: ${userMessage}`, 'error');
          updateStatus('ì˜¤ë¥˜', 'bad');
          throw error;
        });
    } else {
      const duration = performance.now() - startTime;
      console.log(`ì‘ì—… ì™„ë£Œ: ${operationName} (${duration.toFixed(2)}ms)`);
      updateStatus('ì™„ë£Œ', 'ok');
      return result;
    }
    
  } catch (error) {
    console.error(`ì‘ì—… ì¤‘ ì˜¤ë¥˜: ${operationName}`, error);
    const userMessage = ErrorHandler.getUserFriendlyMessage(error.message);
    NotificationSystem.show(`ì‘ì—… ì˜¤ë¥˜: ${userMessage}`, 'error');
    updateStatus('ì˜¤ë¥˜', 'bad');
    throw error;
  }
}

/**
 * ğŸ¯ OPERATION EXECUTOR
 * ì‹¤ì œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜ë“¤
 */
function executeOperation(operationName, ...args) {
  const operations = {
    // ë°ì´í„° ê´€ë ¨
    'loadExcel': () => loadExcelFile(),
    'toRowsManual': () => processManualSheetSelection(),
    'applyScope': () => applySearchFilter(),
    
    // ì§€ë„ ê´€ë ¨
    'centerMap': () => centerMapToData(),
    'fitBounds': () => fitMapToBounds(),
    'optimizeRoute': () => optimizeRouteSelection(),
    
    // ì„ íƒ ê´€ë¦¬
    'showSelectionPanel': () => showSelectionPanel(),
    'hideSelectionPanel': () => hideSelectionPanel(),
    'clearSelection': () => clearAllSelections(),
    
    // ë‚´ë³´ë‚´ê¸°
    'exportExcel': () => exportToExcel(),
    'exportPDF': () => exportToPDF(),
    
    // í†µê³„
    'showStatistics': () => showStatisticsPanel()
  };
  
  if (operations[operationName]) {
    return operations[operationName](...args);
  } else {
    throw new Error(`ì•Œ ìˆ˜ ì—†ëŠ” ì‘ì—…: ${operationName}`);
  }
}

/**
 * ğŸ“Š STATUS UPDATER
 * ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
 */
function updateStatus(text, type = 'ok') {
  const statusBadge = document.getElementById('statusBadge');
  const statusText = document.getElementById('statusText');
  
  if (statusBadge && statusText) {
    statusBadge.className = `badge ${type}`;
    SecurityUtils.setTextContent(statusText, text);
    
    // ì¼ì • ì‹œê°„ í›„ ê¸°ë³¸ ìƒíƒœë¡œ ë³µì›
    if (type !== 'ok') {
      setTimeout(() => updateStatus('ì¤€ë¹„ë¨'), 3000);
    }
  }
}

/**
 * ğŸ“‚ FILE OPERATIONS
 * íŒŒì¼ ì²˜ë¦¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
 */
async function loadExcelFile() {
  const fileInput = document.getElementById('fileInput');
  const file = fileInput?.files?.[0];
  
  if (!file) {
    throw new Error('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
  }
  
  // íŒŒì¼ ê²€ì¦
  const validationErrors = SecurityUtils.validateFile(file);
  if (validationErrors.length > 0) {
    throw new Error(validationErrors.join('\n'));
  }
  
  // ì§„í–‰ë¥  í‘œì‹œ
  showProgress(0);
  
  try {
    const workbook = await readExcelFile(file);
    
    if (workbook.SheetNames.includes("2025DATA")) {
      const rows = processWorksheet(workbook.Sheets["2025DATA"]);
      await updateDataState(rows);
      NotificationSystem.show(`ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${rows.length}ê°œ í–‰`, 'success');
    } else {
      showAdvancedSettings(workbook);
      NotificationSystem.show('2025DATA ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ê³ ê¸‰ ì„¤ì •ì„ ì—½ë‹ˆë‹¤.', 'warning');
    }
    
  } finally {
    hideProgress();
  }
}

function readExcelFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      try {
        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
        resolve(workbook);
      } catch (error) {
        reject(new Error(`Excel íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨: ${error.message}`));
      }
    };
    
    reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'));
    reader.readAsArrayBuffer(file);
  });
}

function processWorksheet(worksheet) {
  try {
    const jsonData = XLSX.utils.sheet_to_json(worksheet);
    
    return jsonData.map((row, index) => {
      const processedRow = {
        id: SecurityUtils.validateInput(row['ê³ ìœ ë²ˆí˜¸'] || row['ID'] || index + 1, 'alphanumeric'),
        name: SecurityUtils.validateInput(row['ì‹œì„¤ëª…'] || row['name'] || '', 'text'),
        addr: SecurityUtils.validateInput(row['êµ¬ë¶„ì£¼ì†Œ'] || row['address'] || '', 'text'),
        emd: SecurityUtils.validateInput(row['ìë©´ë™'] || row['emd'] || '', 'alphanumeric'),
        grp: SecurityUtils.validateInput(row['êµ°ì§‘'] || row['group'] || '', 'number'),
        lat: parseFloat(SecurityUtils.validateInput(row['ìœ„ë„'] || row['lat'] || 0, 'coordinate')),
        lng: parseFloat(SecurityUtils.validateInput(row['ê²½ë„'] || row['lng'] || 0, 'coordinate'))
      };
      
      // ì¢Œí‘œ ìœ íš¨ì„± ê²€ì¦
      if (isNaN(processedRow.lat) || isNaN(processedRow.lng) || 
          processedRow.lat === 0 || processedRow.lng === 0) {
        processedRow.valid = false;
      } else {
        processedRow.valid = true;
      }
      
      return processedRow;
    }).filter(row => row.id); // IDê°€ ì—†ëŠ” í–‰ ì œì™¸
    
  } catch (error) {
    throw new Error(`ì›Œí¬ì‹œíŠ¸ ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
  }
}

async function updateDataState(rows) {
  const validRows = rows.filter(row => row.valid);
  const errorRows = rows.filter(row => !row.valid);
  
  // ìƒíƒœ ì—…ë°ì´íŠ¸
  StateManager.setState({
    rows: validRows,
    rowsById: new Map(validRows.map(row => [String(row.id), row]))
  });
  
  // UI ì—…ë°ì´íŠ¸
  updateDataBadges(rows.length, validRows.length, errorRows.length);
  await rebuildFilterBoxes();
  await renderMap();
}

function updateDataBadges(total, valid, error) {
  const totalBadge = document.getElementById('totalBadge');
  const validBadge = document.getElementById('validBadge');
  const errorBadge = document.getElementById('errorBadge');
  
  if (totalBadge) SecurityUtils.setTextContent(totalBadge, `ì „ì²´: ${total}`);
  if (validBadge) SecurityUtils.setTextContent(validBadge, `ìœ íš¨: ${valid}`);
  if (errorBadge) {
    SecurityUtils.setTextContent(errorBadge, `ì˜¤ë¥˜: ${error}`);
    errorBadge.className = error > 0 ? 'badge warn' : 'badge ok';
  }
}

function showProgress(percent) {
  const progressBar = document.getElementById('loadProgress');
  const progressFill = document.getElementById('progressFill');
  
  if (progressBar) progressBar.style.display = 'block';
  if (progressFill) progressFill.style.width = `${percent}%`;
}

function hideProgress() {
  const progressBar = document.getElementById('loadProgress');
  if (progressBar) progressBar.style.display = 'none';
}

/**
 * ğŸ¯ MAP OPERATIONS
 * ì§€ë„ ê´€ë ¨ ê¸°ëŠ¥ë“¤
 */
let myMap;
let clusterGroup;
let routeLayer;

async function initializeMap() {
  try {
    const mapContainer = document.getElementById('map');
    if (!mapContainer) throw new Error('ì§€ë„ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    
    // ê¸°ì¡´ ì§€ë„ ì •ë¦¬
    if (myMap) {
      myMap.remove();
    }
    
    // ì§€ë„ ì´ˆê¸°í™”
    myMap = L.map('map').setView([36.5, 127.5], 8);
    
    // ê¸°ë³¸ íƒ€ì¼ ë ˆì´ì–´
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(myMap);
    
    // í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ì´ˆê¸°í™”
    clusterGroup = L.markerClusterGroup({
      maxClusterRadius: 50,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false
    });
    
    myMap.addLayer(clusterGroup);
    
    // ì§€ë„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    myMap.on('zoomend', debounce(updateMapState, 300));
    myMap.on('moveend', debounce(updateMapState, 300));
    
    console.log('ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ');
    
  } catch (error) {
    console.error('ì§€ë„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    throw new Error('ì§€ë„ë¥¼ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
}

async function renderMap() {
  if (!myMap) {
    await initializeMap();
  }
  
  const { rows } = StateManager.getState();
  
  // ê¸°ì¡´ ë§ˆì»¤ ì •ë¦¬
  clusterGroup.clearLayers();
  
  if (!rows || rows.length === 0) {
    NotificationSystem.show('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
    return;
  }
  
  // ë§ˆì»¤ ìƒì„± ë° ì¶”ê°€
  const markers = rows
    .filter(row => row.valid && row.lat && row.lng)
    .map(row => createMarker(row));
  
  clusterGroup.addLayers(markers);
  
  // ì§€ë„ ë²”ìœ„ ì¡°ì •
  if (markers.length > 0) {
    const group = new L.featureGroup(markers);
    myMap.fitBounds(group.getBounds(), { padding: [20, 20] });
  }
  
  NotificationSystem.show(`${markers.length}ê°œ ë§ˆì»¤ê°€ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
}

function createMarker(row) {
  const marker = L.marker([row.lat, row.lng]);
  
  // ë§ˆì»¤ ìŠ¤íƒ€ì¼ ì ìš©
  const markerStyle = document.getElementById('markerStyle')?.value || 'bubble';
  marker.options.className = `mk mk-${markerStyle}`;
  
  // íŒì—… ë‚´ìš© ìƒì„± (ì•ˆì „í•œ HTML)
  const popupContent = `
    <div class="marker-popup">
      <h4>${SecurityUtils.escapeHtml(row.name || 'ì´ë¦„ ì—†ìŒ')}</h4>
      <p><strong>ID:</strong> ${SecurityUtils.escapeHtml(row.id)}</p>
      <p><strong>ì£¼ì†Œ:</strong> ${SecurityUtils.escapeHtml(row.addr || 'ì£¼ì†Œ ì—†ìŒ')}</p>
      <p><strong>ìë©´ë™:</strong> ${SecurityUtils.escapeHtml(row.emd || 'ì •ë³´ ì—†ìŒ')}</p>
      <p><strong>êµ°ì§‘:</strong> ${SecurityUtils.escapeHtml(row.grp || 'ì •ë³´ ì—†ìŒ')}</p>
      <div style="margin-top: 8px;">
        <button class="btn btn-sky btn-sm" onclick="safeOperation('selectItem', '${SecurityUtils.escapeHtml(row.id)}')">
          ì„ íƒ
        </button>
        <button class="btn btn-accent btn-sm" onclick="safeOperation('showRoute', '${SecurityUtils.escapeHtml(row.id)}')">
          ê²½ë¡œ
        </button>
      </div>
    </div>
  `;
  
  marker.bindPopup(popupContent);
  marker.rowData = row;
  
  return marker;
}

function centerMapToData() {
  const { rows } = StateManager.getState();
  const validRows = rows.filter(row => row.valid && row.lat && row.lng);
  
  if (validRows.length === 0) {
    NotificationSystem.show('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
    return;
  }
  
  // ì¤‘ì‹¬ì  ê³„ì‚°
  const avgLat = validRows.reduce((sum, row) => sum + row.lat, 0) / validRows.length;
  const avgLng = validRows.reduce((sum, row) => sum + row.lng, 0) / validRows.length;
  
  myMap.setView([avgLat, avgLng], 12);
  NotificationSystem.show('ì§€ë„ ì¤‘ì‹¬ì„ ë°ì´í„° ìœ„ì¹˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.', 'success');
}

function fitMapToBounds() {
  if (clusterGroup.getLayers().length > 0) {
    myMap.fitBounds(clusterGroup.getBounds(), { padding: [20, 20] });
    NotificationSystem.show('ëª¨ë“  ë°ì´í„°ê°€ ë³´ì´ë„ë¡ ì§€ë„ë¥¼ ì¡°ì •í–ˆìŠµë‹ˆë‹¤.', 'success');
  }
}

function updateMapState() {
  // ì§€ë„ ìƒíƒœ ë³€ê²½ ì‹œ í•„ìš”í•œ ì—…ë°ì´íŠ¸ ìˆ˜í–‰
  const center = myMap.getCenter();
  const zoom = myMap.getZoom();
  
  // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì§€ë„ ìƒíƒœ ì €ì¥
  try {
    localStorage.setItem('mapState', JSON.stringify({
      lat: center.lat,
      lng: center.lng,
      zoom: zoom,
      timestamp: Date.now()
    }));
  } catch (e) {
    console.warn('ì§€ë„ ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:', e);
  }
}

/**
 * ğŸ” FILTER OPERATIONS
 * í•„í„°ë§ ê¸°ëŠ¥ë“¤
 */
async function rebuildFilterBoxes() {
  const { rows } = StateManager.getState();
  
  if (!rows || rows.length === 0) return;
  
  // ìë©´ë™ ëª©ë¡ ìƒì„±
  const emdValues = [...new Set(rows.map(row => row.emd).filter(Boolean))].sort();
  fillChipBox(document.getElementById('emdBox'), emdValues, 'emd');
  
  // êµ°ì§‘ ëª©ë¡ ìƒì„±
  const grpValues = [...new Set(rows.map(row => row.grp).filter(Boolean))].sort((a, b) => Number(a) - Number(b));
  fillChipBox(document.getElementById('grpBox'), grpValues, 'grp');
}

function fillChipBox(container, values, name) {
  if (!container || !Array.isArray(values)) return;
  
  // ê¸°ì¡´ ë‚´ìš© ì•ˆì „í•˜ê²Œ ì œê±°
  while (container.firstChild) {
    container.removeChild(container.firstChild);
  }
  
  if (values.length === 0) {
    const emptyDiv = document.createElement('div');
    emptyDiv.className = 'small';
    SecurityUtils.setTextContent(emptyDiv, 'í•´ë‹¹ í•­ëª© ì—†ìŒ');
    container.appendChild(emptyDiv);
    return;
  }
  
  values.forEach(value => {
    const safeValue = SecurityUtils.validateInput(value, 'alphanumeric');
    
    const label = document.createElement('label');
    label.className = 'chip';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.name = name;
    checkbox.value = encodeURIComponent(safeValue);
    checkbox.checked = true;
    checkbox.addEventListener('change', debounce(applyFilters, 300));
    
    const textNode = document.createTextNode(' ' + safeValue);
    
    label.appendChild(checkbox);
    label.appendChild(textNode);
    container.appendChild(label);
  });
}

async function applySearchFilter() {
  const searchInput = document.getElementById('scopeInput');
  const searchTerm = searchInput?.value?.trim() || '';
  
  // ê²€ìƒ‰ì–´ ê²€ì¦
  const safeTerm = SecurityUtils.validateInput(searchTerm, 'alphanumeric', 100);
  
  if (safeTerm !== searchTerm) {
    NotificationSystem.show('ê²€ìƒ‰ì–´ì— í—ˆìš©ë˜ì§€ ì•ŠëŠ” ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.', 'warning');
    searchInput.value = safeTerm;
  }
  
  // í•„í„° ìƒíƒœ ì—…ë°ì´íŠ¸
  const currentState = StateManager.getState();
  StateManager.setState({
    filters: {
      ...currentState.filters,
      search: safeTerm
    }
  });
  
  await applyFilters();
}

async function applyFilters() {
  const { rows, filters } = StateManager.getState();
  
  if (!rows || rows.length === 0) return;
  
  // ì²´í¬ëœ í•„í„° ìˆ˜ì§‘
  const checkedEmd = new Set();
  const checkedGrp = new Set();
  
  document.querySelectorAll('input[name="emd"]:checked').forEach(cb => {
    checkedEmd.add(decodeURIComponent(cb.value));
  });
  
  document.querySelectorAll('input[name="grp"]:checked').forEach(cb => {
    checkedGrp.add(decodeURIComponent(cb.value));
  });
  
  // í•„í„°ë§ ì ìš©
  const filteredRows = rows.filter(row => {
    // ìë©´ë™ í•„í„°
    if (checkedEmd.size > 0 && !checkedEmd.has(row.emd)) return false;
    
    // êµ°ì§‘ í•„í„°
    if (checkedGrp.size > 0 && !checkedGrp.has(row.grp)) return false;
    
    // ê²€ìƒ‰ í•„í„°
    if (filters.search) {
      const searchLower = filters.search.toLowerCase();
      return (
        row.name?.toLowerCase().includes(searchLower) ||
        row.addr?.toLowerCase().includes(searchLower) ||
        row.emd?.toLowerCase().includes(searchLower)
      );
    }
    
    return true;
  });
  
  // ìƒíƒœ ì—…ë°ì´íŠ¸
  StateManager.setState({
    rows: filteredRows,
    filters: {
      ...filters,
      emd: checkedEmd,
      grp: checkedGrp
    }
  });
  
  await renderMap();
  
  NotificationSystem.show(`í•„í„° ì ìš©: ${filteredRows.length}ê°œ í•­ëª©`, 'success');
}

/**
 * ğŸ¯ SELECTION OPERATIONS
 * ì„ íƒ ê´€ë¦¬ ê¸°ëŠ¥ë“¤
 */
function showSelectionPanel() {
  const panel = document.getElementById('selPanel');
  if (panel) {
    panel.style.display = 'block';
    panel.setAttribute('aria-hidden', 'false');
    updateSelectionTable();
  }
}

function hideSelectionPanel() {
  const panel = document.getElementById('selPanel');
  if (panel) {
    panel.style.display = 'none';
    panel.setAttribute('aria-hidden', 'true');
  }
}

function updateSelectionTable() {
  const tbody = document.getElementById('selBody');
  const { selectedIds, rowsById } = StateManager.getState();
  
  if (!tbody) return;
  
  // ê¸°ì¡´ ë‚´ìš© ì œê±°
  while (tbody.firstChild) {
    tbody.removeChild(tbody.firstChild);
  }
  
  // ì„ íƒëœ í•­ëª©ë“¤ ì¶”ê°€
  selectedIds.forEach(id => {
    const row = rowsById.get(id);
    if (!row) return;
    
    const tr = document.createElement('tr');
    tr.dataset.id = id;
    
    // ID ì…€
    const tdId = document.createElement('td');
    SecurityUtils.setTextContent(tdId, row.id);
    
    // ì´ë¦„ ì…€
    const tdName = document.createElement('td');
    SecurityUtils.setTextContent(tdName, row.name || 'ì´ë¦„ ì—†ìŒ');
    
    // ì£¼ì†Œ ì…€
    const tdAddr = document.createElement('td');
    SecurityUtils.setTextContent(tdAddr, row.addr || 'ì£¼ì†Œ ì—†ìŒ');
    
    // ì‚­ì œ ë²„íŠ¼ ì…€
    const tdAction = document.createElement('td');
    tdAction.className = 'row-actions';
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn btn-accent btn-sm';
    deleteBtn.textContent = 'ì‚­ì œ';
    deleteBtn.onclick = () => safeOperation('removeSelection', id);
    
    tdAction.appendChild(deleteBtn);
    
    tr.appendChild(tdId);
    tr.appendChild(tdName);
    tr.appendChild(tdAddr);
    tr.appendChild(tdAction);
    
    tbody.appendChild(tr);
  });
  
  // ì„ íƒ ê°œìˆ˜ ì—…ë°ì´íŠ¸
  updateSelectionCount();
}

function updateSelectionCount() {
  const { selectedIds } = StateManager.getState();
  const countElement = document.getElementById('selectedCount');
  
  if (countElement) {
    SecurityUtils.setTextContent(countElement, selectedIds.size.toString());
  }
}

function clearAllSelections() {
  StateManager.setState({ selectedIds: new Set() });
  updateSelectionTable();
  NotificationSystem.show('ì„ íƒì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
}

/**
 * ğŸš€ INITIALIZATION
 * ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”
 */
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// DOM ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', async function() {
  try {
    console.log('ğŸš€ CLUSTRO Final Secured v12.2 ì´ˆê¸°í™” ì‹œì‘...');
    
    // í•µì‹¬ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    ErrorHandler.init();
    PerformanceMonitor.init();
    ResponsiveHandler.init();
    ThemeManager.init();
    
    // UI ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    setupEventListeners();
    
    // ì§€ë„ ì´ˆê¸°í™”
    await initializeMap();
    
    // ì„±ëŠ¥ ëª¨ë‹ˆí„° í† ê¸€ ì„¤ì •
    const perfToggle = document.getElementById('perfToggle');
    if (perfToggle) {
      perfToggle.addEventListener('click', () => {
        const monitor = document.getElementById('perfMonitor');
        if (monitor) {
          monitor.classList.toggle('show');
        }
      });
    }
    
    // ë„¤ë¹„ê²Œì´ì…˜ ì„¤ì •
    setupNavigation();
    
    // ìƒíƒœ ê´€ë¦¬ì ì˜µì €ë²„ ë“±ë¡
    StateManager.subscribe((change) => {
      console.log('ìƒíƒœ ë³€ê²½:', change);
      updateSelectionCount();
    });
    
    console.log('âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì™„ë£Œ');
    NotificationSystem.show('CLUSTRO Final Secured v12.2ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    
  } catch (error) {
    console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    NotificationSystem.show('ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
  }
});

function setupEventListeners() {
  // íŒŒì¼ ì…ë ¥ ì´ë²¤íŠ¸
  const fileInput = document.getElementById('fileInput');
  if (fileInput) {
    fileInput.addEventListener('change', () => safeOperation('loadExcel'));
  }
  
  // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸
  const searchInput = document.getElementById('scopeInput');
  if (searchInput) {
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        safeOperation('applyScope');
      }
    });
  }
  
  // í°íŠ¸ í¬ê¸° ì¡°ì ˆ
  const fontSizeRange = document.getElementById('fontSizeRange');
  const fontSizeValue = document.getElementById('fontSizeValue');
  if (fontSizeRange && fontSizeValue) {
    fontSizeRange.addEventListener('input', (e) => {
      const size = e.target.value + 'px';
      SecurityUtils.setTextContent(fontSizeValue, size);
      document.documentElement.style.setProperty('--flt-font', size);
      document.documentElement.style.setProperty('--tbl-font', size);
    });
  }
  
  // ë§ˆì»¤ í¬ê¸° ì¡°ì ˆ
  const markerSizeRange = document.getElementById('markerSizeRange');
  const markerSizeValue = document.getElementById('markerSizeValue');
  if (markerSizeRange && markerSizeValue) {
    markerSizeRange.addEventListener('input', (e) => {
      const size = e.target.value + 'px';
      SecurityUtils.setTextContent(markerSizeValue, size);
      document.documentElement.style.setProperty('--mk', size);
    });
  }
}

function setupNavigation() {
  // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸
  document.querySelectorAll('.icbtn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.dataset.target;
      if (!target) return;
      
      // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
      document.querySelectorAll('.sec').forEach(sec => {
        sec.classList.remove('active');
      });
      
      // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
      document.querySelectorAll('.icbtn').forEach(b => {
        b.classList.remove('active');
      });
      
      // ì„ íƒëœ ì„¹ì…˜ í‘œì‹œ
      const targetSection = document.querySelector(target);
      if (targetSection) {
        targetSection.classList.add('active');
        btn.classList.add('active');
      }
      
      // ëª¨ë°”ì¼ì—ì„œ ë©”ë‰´ ë‹«ê¸°
      if (ResponsiveHandler.isMobile) {
        document.getElementById('lhs')?.classList.remove('mobile-open');
        document.getElementById('mobileOverlay')?.classList.remove('show');
      }
    });
  });
}

// ê°œë°œ ëª¨ë“œì—ì„œë§Œ ì „ì—­ ì ‘ê·¼ í—ˆìš©
if (typeof window !== 'undefined') {
  window.CLUSTRO = {
    safeOperation,
    SecurityUtils,
    StateManager,
    NotificationSystem,
    version: '12.2 Final Secured'
  };
}

console.log('%cğŸ”’ CLUSTRO Final Secured v12.2', 'color: #0EA5E9; font-weight: bold; font-size: 16px;');
console.log('%cëª¨ë“  ë³´ì•ˆ ì·¨ì•½ì ì´ í•´ê²°ëœ ìµœì¢… ë²„ì „ì…ë‹ˆë‹¤.', 'color: #059669;');
</script>

</body>
</html>