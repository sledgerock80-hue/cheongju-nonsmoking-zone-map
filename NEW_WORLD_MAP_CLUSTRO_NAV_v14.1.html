<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>CLUSTRO ì²­ì£¼ ê¸ˆì—°êµ¬ì—­ ì ê²€ì§€ë„ - ë„¤ë¹„ê²Œì´ì…˜ í†µí•©íŒ v14.1 (Enhanced)</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    /* ì²­ì£¼ì‹œ CI ìƒ‰ìƒì„ ë°˜ì˜í•œ í˜„ëŒ€ì ì¸ ë””ìì¸ */
    --primary: #1E40AF; /* ì²­ì£¼ì‹œ ëŒ€í‘œìƒ‰ìƒ */
    --primary-light: #3B82F6;
    --accent: #F59E0B; /* ê°•ì¡°ìƒ‰ */
    --accent-light: #FCD34D;
    --success: #10B981;
    --warning: #F59E0B;
    --danger: #EF4444;
    --gray-50: #F9FAFB;
    --gray-100: #F3F4F6;
    --gray-200: #E5E7EB;
    --gray-300: #D1D5DB;
    --gray-400: #9CA3AF;
    --gray-500: #6B7280;
    --gray-600: #4B5563;
    --gray-700: #374151;
    --gray-800: #1F2937;
    --gray-900: #111827;
    
    --rail-w: 68px;
    --side-w: 400px;
    --gap: 8px;
    --marker-size: 32px;
    --border-radius: 12px;
    --border-radius-sm: 8px;
    --shadow: 0 4px 12px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
    --transition: all 0.2s ease;
  }

  /* ì˜¤í”„ë¼ì¸/ì˜¨ë¼ì¸ ìƒíƒœ í‘œì‹œ */
  .online-status {
    position: fixed;
    top: 16px;
    right: 16px;
    z-index: 10000;
    padding: 8px 12px;
    border-radius: var(--border-radius-sm);
    font-size: 12px;
    font-weight: 600;
    transition: var(--transition);
    box-shadow: var(--shadow);
  }
  .online-status.online {
    background: var(--success);
    color: white;
  }
  .online-status.offline {
    background: var(--danger);
    color: white;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
  }

  /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë¦¬ì…‹ ë° ê°œì„  */
  * { box-sizing: border-box; }
  
  body {
    margin: 0;
    font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    color: var(--gray-800);
    background: var(--gray-50);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* ì ‘ê·¼ì„± ê°œì„  */
  *:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
  }

  button, .btn {
    cursor: pointer;
    transition: var(--transition);
    border: none;
    font-family: inherit;
  }

  button:hover, .btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow);
  }

  button:active, .btn:active {
    transform: translateY(0);
  }

  /* ë ˆì´ì•„ì›ƒ ê·¸ë¦¬ë“œ */
  #app {
    display: grid;
    min-height: 100vh;
    grid-template-columns: var(--rail-w) var(--side-w) var(--gap) 1fr;
    grid-template-rows: auto 1fr;
    grid-template-areas: 
      "rail toolbar toolbar toolbar" 
      "rail sidebar gap main";
  }

  /* ìƒë‹¨ íˆ´ë°” */
  #toolbar {
    grid-area: toolbar;
    background: white;
    border-bottom: 2px solid var(--gray-200);
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  /* ì¢Œì¸¡ ë ˆì¼ */
  #rail {
    grid-area: rail;
    background: white;
    border-right: 2px solid var(--gray-200);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px 8px;
    gap: 12px;
  }

  .logo-container {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 12px;
    text-align: center;
    line-height: 1.2;
    box-shadow: var(--shadow);
  }

  .nav-button {
    width: 52px;
    height: 52px;
    background: var(--gray-100);
    border: 2px solid var(--gray-200);
    border-radius: var(--border-radius-sm);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: var(--transition);
    text-decoration: none;
    color: var(--gray-600);
    font-size: 10px;
    font-weight: 500;
    title: 'tooltip';
  }

  .nav-button:hover {
    background: var(--primary-light);
    border-color: var(--primary);
    color: white;
    transform: translateY(-2px);
  }

  .nav-button.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
  }

  .nav-button svg {
    width: 20px;
    height: 20px;
    stroke-width: 2;
  }

  /* ì‚¬ì´ë“œë°” */
  #sidebar {
    grid-area: sidebar;
    background: white;
    border-right: 2px solid var(--gray-200);
    overflow-y: auto;
    font-size: 13px;
  }

  .section {
    border-bottom: 1px solid var(--gray-200);
  }

  .section-header {
    padding: 16px 20px;
    background: var(--gray-50);
    border-bottom: 1px solid var(--gray-200);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 600;
    color: var(--gray-700);
    transition: var(--transition);
  }

  .section-header:hover {
    background: var(--gray-100);
  }

  .section-content {
    padding: 20px;
  }

  /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°œì„  */
  .btn {
    padding: 8px 16px;
    border-radius: var(--border-radius-sm);
    font-size: 13px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: var(--transition);
    text-decoration: none;
    cursor: pointer;
    min-height: 36px;
  }

  .btn-primary {
    background: var(--primary);
    color: white;
    border: 2px solid var(--primary);
  }

  .btn-primary:hover {
    background: var(--primary-light);
    border-color: var(--primary-light);
  }

  .btn-secondary {
    background: var(--gray-100);
    color: var(--gray-700);
    border: 2px solid var(--gray-200);
  }

  .btn-secondary:hover {
    background: var(--gray-200);
    border-color: var(--gray-300);
  }

  .btn-accent {
    background: var(--accent);
    color: white;
    border: 2px solid var(--accent);
  }

  .btn-accent:hover {
    background: var(--accent-light);
    border-color: var(--accent-light);
  }

  .btn-success {
    background: var(--success);
    color: white;
    border: 2px solid var(--success);
  }

  .btn-danger {
    background: var(--danger);
    color: white;
    border: 2px solid var(--danger);
  }

  /* ì…ë ¥ ìš”ì†Œ ê°œì„  */
  input, select, textarea {
    padding: 8px 12px;
    border: 2px solid var(--gray-200);
    border-radius: var(--border-radius-sm);
    background: white;
    font-size: 13px;
    transition: var(--transition);
    min-height: 36px;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  /* ë°°ì§€ ìŠ¤íƒ€ì¼ */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
    border: 1px solid;
  }

  .badge-primary {
    background: rgba(59, 130, 246, 0.1);
    color: var(--primary);
    border-color: rgba(59, 130, 246, 0.2);
  }

  .badge-success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
    border-color: rgba(16, 185, 129, 0.2);
  }

  .badge-warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
    border-color: rgba(245, 158, 11, 0.2);
  }

  .badge-danger {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
    border-color: rgba(239, 68, 68, 0.2);
  }

  /* ì¹© ìŠ¤íƒ€ì¼ */
  .chips {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--gray-100);
    border: 1px solid var(--gray-200);
    border-radius: 999px;
    font-size: 12px;
    cursor: pointer;
    transition: var(--transition);
  }

  .chip:hover {
    background: var(--gray-200);
  }

  .chip input[type="checkbox"] {
    margin: 0;
    min-height: auto;
  }

  /* ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ ê°œì„  */
  .switch {
    position: relative;
    display: inline-block;
    width: 52px;
    height: 28px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
    min-height: auto;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--gray-300);
    transition: var(--transition);
    border-radius: 28px;
    border: 2px solid var(--gray-200);
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 2px;
    top: 2px;
    background: white;
    transition: var(--transition);
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .switch input:checked + .slider {
    background: var(--primary);
    border-color: var(--primary);
  }

  .switch input:checked + .slider:before {
    transform: translateX(24px);
  }

  .switch input:indeterminate + .slider {
    background: var(--warning);
    border-color: var(--warning);
  }

  /* ê°­ ì˜ì—­ */
  #gap {
    grid-area: gap;
    background: var(--gray-200);
    cursor: col-resize;
    position: relative;
  }

  #gap:hover {
    background: var(--primary-light);
  }

  #gap::after {
    content: 'â‹®';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--gray-500);
    font-size: 16px;
  }

  /* ë©”ì¸ ì§€ë„ ì˜ì—­ */
  #main {
    grid-area: main;
    position: relative;
    background: var(--gray-100);
  }

  #map {
    position: absolute;
    inset: 0;
    border-radius: 0;
  }

  /* ì§€ë„ ì»¨íŠ¸ë¡¤ */
  .map-controls {
    position: absolute;
    top: 16px;
    left: 16px;
    z-index: 1000;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* ì„ íƒ íŒ¨ë„ ê°œì„  - ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ì§€ì› */
  .selection-panel {
    position: fixed;
    right: 20px;
    bottom: 20px;
    width: min(600px, 45vw);
    max-width: 90vw;
    max-height: 60vh;
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    z-index: 2000;
    display: none;
    overflow: hidden;
    resize: both;
    min-width: 400px;
    min-height: 300px;
    touch-action: none;
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
  }

  /* ë§ˆì»¤ ìˆ¨ê¹€ í´ë˜ìŠ¤ */
  .hidden-marker {
    opacity: 0 !important;
    pointer-events: none !important;
    transition: opacity 0.3s ease;
  }

  /* A/B í¬ì¸íŠ¸ ë§ˆì»¤ ìŠ¤íƒ€ì¼ */
  .ab-marker {
    width: 30px !important;
    height: 30px !important;
    background: var(--danger) !important;
    border: 3px solid white !important;
    border-radius: 50% !important;
    color: white !important;
    font-weight: bold !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 14px !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
    z-index: 1000 !important;
  }

  /* ê²½ë¡œ í´ë¦¬ë¼ì¸ ìŠ¤íƒ€ì¼ */
  .route-polyline {
    color: var(--primary);
    weight: 4;
    opacity: 0.8;
    dashArray: '10, 5';
  }

  .ab-route-polyline {
    color: var(--danger);
    weight: 3;
    opacity: 0.9;
    dashArray: '5, 5';
  }

  /* í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ ìŠ¤íƒ€ì¼ ê°œì„  */
  .marker-cluster-small {
    background-color: rgba(59, 130, 246, 0.6);
  }
  .marker-cluster-small div {
    background-color: rgba(59, 130, 246, 0.8);
  }
  .marker-cluster-medium {
    background-color: rgba(245, 158, 11, 0.6);
  }
  .marker-cluster-medium div {
    background-color: rgba(245, 158, 11, 0.8);
  }
  .marker-cluster-large {
    background-color: rgba(239, 68, 68, 0.6);
  }
  .marker-cluster-large div {
    background-color: rgba(239, 68, 68, 0.8);
  }

  /* ë°˜ì‘í˜• ë””ìì¸ */
  @media (max-width: 1024px) {
    #app {
      grid-template-columns: var(--rail-w) 1fr;
      grid-template-areas: 
        "rail toolbar" 
        "rail main";
    }
    
    #sidebar {
      position: fixed;
      left: var(--rail-w);
      top: 0;
      bottom: 0;
      width: var(--side-w);
      z-index: 3000;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }
    
    #sidebar.open {
      transform: translateX(0);
    }
    
    #gap {
      display: none;
    }
  }

  /* ë‹¤í¬ëª¨ë“œ ì§€ì› */
  body.dark {
    --gray-50: #1F2937;
    --gray-100: #374151;
    --gray-200: #4B5563;
    --gray-300: #6B7280;
    --gray-800: #F9FAFB;
    --gray-900: #F3F4F6;
    background: var(--gray-50);
    color: var(--gray-800);
  }

  /* ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
  @keyframes slideInUp {
    from {
      transform: translateY(100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .animate-slide-up {
    animation: slideInUp 0.3s ease-out;
  }

  .animate-fade-in {
    animation: fadeIn 0.3s ease-out;
  }

  /* ë¡œë”© ìƒíƒœ */
  .loading {
    position: relative;
    pointer-events: none;
  }

  .loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border: 2px solid var(--gray-300);
    border-top: 2px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
  }
</style>

<!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

</head>
<body>
<div class="online-status" id="onlineStatus">ì˜¨ë¼ì¸</div>

<div id="app">
  <div id="rail">
    <div class="logo-container">
      ì²­ì£¼ì‹œ<br>ê¸ˆì—°êµ¬ì—­
    </div>
    
    <a href="#" class="nav-button active" id="dataTab" title="ë°ì´í„° ê´€ë¦¬">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 00-2-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
      </svg>
      <span>ë°ì´í„°</span>
    </a>
    
    <a href="#" class="nav-button" id="filterTab" title="í•„í„° ë° ê²€ìƒ‰">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
      </svg>
      <span>í•„í„°</span>
    </a>
    
    <a href="#" class="nav-button" id="routeTab" title="ê²½ë¡œ ê³„ì‚°">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
      </svg>
      <span>ê²½ë¡œ</span>
    </a>
    
    <a href="#" class="nav-button" id="exportTab" title="ë‚´ë³´ë‚´ê¸°">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
      </svg>
      <span>ë‚´ë³´ë‚´ê¸°</span>
    </a>
    
    <a href="#" class="nav-button" id="settingsTab" title="ì„¤ì •">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
      </svg>
      <span>ì„¤ì •</span>
    </a>
    
    <label class="switch" id="darkToggle" title="ë‹¤í¬ ëª¨ë“œ">
      <input type="checkbox" id="darkMode">
      <span class="slider"></span>
    </label>
  </div>

  <div id="toolbar">
    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
      <span class="badge badge-primary" id="totalCount">ì´: 0</span>
      <span class="badge badge-success" id="shownCount">í‘œì‹œ: 0</span>
      <span class="badge badge-warning" id="missingCount">ì¢Œí‘œì—†ìŒ: 0</span>
      <span class="badge badge-danger" id="filteredCount">ì œì™¸: 0</span>
    </div>
    
    <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
      <input type="search" id="searchInput" placeholder="ì‹œì„¤ëª…, ì£¼ì†Œ, ìë©´ë™, êµ°ì§‘ ê²€ìƒ‰..." 
             style="width: 300px;" title="ê²€ìƒ‰ì–´ ì…ë ¥">
      <button class="btn btn-primary" id="showSelectionPanel">ğŸ“‹ ì„ íƒ ëª©ë¡ (0)</button>
      <button class="btn btn-secondary" id="toggleSidebar" style="display: none;">â˜° ë©”ë‰´</button>
    </div>
  </div>

  <div id="sidebar">
    <!-- ë°ì´í„° ì„¹ì…˜ -->
    <div class="section" id="dataSection">
      <div class="section-header">
        <span>ğŸ“Š ë°ì´í„° ê´€ë¦¬</span>
        <span>â–¼</span>
      </div>
      <div class="section-content">
        <div style="margin-bottom: 16px;">
          <button class="btn btn-primary" id="fileInput" style="width: 100%;">
            ğŸ“ ì—‘ì…€/CSV íŒŒì¼ ì—…ë¡œë“œ
          </button>
          <input type="file" id="hiddenFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
        </div>
        
        <details style="margin-bottom: 16px;">
          <summary style="cursor: pointer; padding: 8px 0; font-weight: 500;">
            ğŸ”§ ê³ ê¸‰ ì„¤ì •
          </summary>
          <div style="margin-top: 12px; padding-left: 16px;">
            <label style="display: block; margin-bottom: 8px;">
              ì‹œíŠ¸ ì„ íƒ:
              <select id="sheetSelect" style="width: 100%; margin-top: 4px;"></select>
            </label>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px;">
              <label>
                ìœ„ë„ ì—´:
                <select id="latColumn" style="width: 100%;">
                  <option value="B">B (ìœ„ë„)</option>
                  <option value="C">C</option>
                  <option value="H" selected>H (ìœ„ë„)</option>
                </select>
              </label>
              <label>
                ê²½ë„ ì—´:
                <select id="lngColumn" style="width: 100%;">
                  <option value="C">C (ê²½ë„)</option>
                  <option value="D">D</option>
                  <option value="G" selected>G (ê²½ë„)</option>
                </select>
              </label>
            </div>
          </div>
        </details>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <label class="chip">
            <input type="checkbox" id="includeNoCoords">
            <span>ì¢Œí‘œ ì—†ëŠ” ë°ì´í„° í¬í•¨</span>
          </label>
          <label class="chip">
            <input type="checkbox" id="onlyUninspected">
            <span>ë¯¸ì ê²€ë§Œ í‘œì‹œ</span>
          </label>
        </div>
      </div>
    </div>

    <!-- í•„í„° ì„¹ì…˜ -->
    <div class="section" id="filterSection" style="display: none;">
      <div class="section-header">
        <span>ğŸ” í•„í„° ë° ê²€ìƒ‰</span>
        <span>â–¼</span>
      </div>
      <div class="section-content">
        <div style="margin-bottom: 16px;">
          <input type="search" id="searchInputSidebar" placeholder="ê²€ìƒ‰..." style="width: 100%;">
          <button class="btn btn-accent" id="addAllFiltered" style="width: 100%; margin-top: 8px;">
            â• í•„í„°ê²°ê³¼ ëª¨ë‘ ì„ íƒëª©ë¡ì— ì¶”ê°€
          </button>
        </div>

        <div style="margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-weight: 600;">êµ°ì§‘ë³„</span>
            <label class="switch">
              <input type="checkbox" id="clusterToggle" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div id="clusterChips" class="chips"></div>
        </div>

        <div style="margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-weight: 600;">ìë©´ë™ë³„</span>
            <label class="switch">
              <input type="checkbox" id="districtToggle" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div id="districtChips" class="chips"></div>
        </div>

        <div style="margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-weight: 600;">ì¹´í…Œê³ ë¦¬ë³„</span>
            <label class="switch">
              <input type="checkbox" id="categoryToggle" checked>
              <span class="slider"></span>
            </label>
          </div>
          <div id="categoryChips" class="chips"></div>
        </div>
      </div>
    </div>

    <!-- ê²½ë¡œ ì„¹ì…˜ -->
    <div class="section" id="routeSection" style="display: none;">
      <div class="section-header">
        <span>ğŸ—ºï¸ ê²½ë¡œ ê³„ì‚°</span>
        <span>â–¼</span>
      </div>
      <div class="section-content">
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px;">
            ê²½ë¡œ ì•Œê³ ë¦¬ì¦˜:
            <select id="routeAlgorithm" style="width: 100%; margin-top: 4px;">
              <option value="nearest">ìµœê·¼ì ‘ ì´ì›ƒ</option>
              <option value="tsp">TSP ìµœì í™”</option>
              <option value="cluster">í´ëŸ¬ìŠ¤í„° ê¸°ë°˜</option>
            </select>
          </label>
        </div>

        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px;">
            ì¼ì¼ ìµœëŒ€ ë°©ë¬¸ì§€:
            <input type="number" id="dailyLimit" value="50" min="1" max="200" style="width: 100%;">
          </label>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;">
          <label class="chip">
            <input type="checkbox" id="fixEnds">
            <span>ì‹œì‘/ë ê³ ì •</span>
          </label>
          <label class="chip">
            <input type="checkbox" id="toggleHideNonRoute">
            <span>ê²½ë¡œì™¸ ë§ˆì»¤ ìˆ¨ê¸°ê¸°</span>
          </label>
        </div>

        <button class="btn btn-primary" id="calculateRoute" style="width: 100%;">
          ğŸ¯ ê²½ë¡œ ê³„ì‚°
        </button>

        <div style="margin-top: 16px; padding: 12px; background: var(--gray-50); border-radius: var(--border-radius-sm);">
          <div id="routeStats" style="display: none;">
            <div style="font-size: 12px; color: var(--gray-600);">ê²½ë¡œ ì •ë³´:</div>
            <div style="font-weight: 600; margin-top: 4px;">
              <span id="routeDistance">0km</span> Â· 
              <span id="routeTime">0ë¶„</span> Â· 
              <span id="routeCount">0ê³³</span>
            </div>
          </div>
        </div>

        <div style="margin-top: 16px;">
          <button class="btn btn-accent" id="pickAB" style="width: 100%;">
            ğŸ“ ì§€ë„ì—ì„œ A/B ì„ íƒ
          </button>
          <button class="btn btn-secondary" id="clearAB" style="width: 100%; margin-top: 8px; display: none;">
            ğŸ”„ A/B ê²½ë¡œ ì´ˆê¸°í™”
          </button>
          <div id="abInfo" style="margin-top: 8px; font-size: 12px; color: var(--gray-600);"></div>
        </div>
      </div>
    </div>

    <!-- ë‚´ë³´ë‚´ê¸° ì„¹ì…˜ -->
    <div class="section" id="exportSection" style="display: none;">
      <div class="section-header">
        <span>ğŸ’¾ ë‚´ë³´ë‚´ê¸°</span>
        <span>â–¼</span>
      </div>
      <div class="section-content">
        <div style="margin-bottom: 16px;">
          <button class="btn btn-success" id="exportExcel" style="width: 100%;">
            ğŸ“— Excel ë‚´ë³´ë‚´ê¸°
          </button>
        </div>

        <div style="margin-bottom: 16px;">
          <button class="btn btn-danger" id="exportPDF" style="width: 100%;">
            ğŸ“• PDF ë‚´ë³´ë‚´ê¸°
          </button>
        </div>

        <div style="margin-bottom: 16px;">
          <button class="btn btn-primary" id="exportImage" style="width: 100%;">
            ğŸ–¼ï¸ ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸°
          </button>
        </div>

        <div>
          <label class="chip">
            <input type="checkbox" id="exportHighQuality">
            <span>ê³ í™”ì§ˆ ì¶œë ¥</span>
          </label>
        </div>
      </div>
    </div>

    <!-- ì„¤ì • ì„¹ì…˜ -->
    <div class="section" id="settingsSection" style="display: none;">
      <div class="section-header">
        <span>âš™ï¸ ì„¤ì •</span>
        <span>â–¼</span>
      </div>
      <div class="section-content">
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px;">
            ì§€ë„ ë°°ê²½:
            <select id="mapStyle" style="width: 100%; margin-top: 4px;">
              <option value="vworld" selected>VWorld ì§€ë„</option>
              <option value="none">ë°°ê²½ì§€ë„ ì—†ìŒ</option>
            </select>
          </label>
        </div>

        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px;">
            ë§ˆì»¤ ìŠ¤íƒ€ì¼:
            <select id="markerStyle" style="width: 100%; margin-top: 4px;">
              <option value="circle">ì›í˜•</option>
              <option value="square">ì‚¬ê°í˜•</option>
              <option value="pin">ë§í’ì„ </option>
            </select>
          </label>
        </div>

        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px;">
            ë§ˆì»¤ í¬ê¸°:
            <input type="range" id="markerSize" min="16" max="48" value="32" style="width: 100%;">
            <span id="markerSizeValue">32px</span>
          </label>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <label class="chip">
            <input type="checkbox" id="clusterMarkers">
            <span>ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ë§</span>
          </label>
          <label class="chip">
            <input type="checkbox" id="showLabels">
            <span>ë¼ë²¨ í‘œì‹œ</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <div id="gap"></div>

  <div id="main">
    <div class="map-controls">
      <button class="btn btn-secondary" id="fitToMarkers" title="ì „ì²´ ë³´ê¸°">ğŸ”</button>
      <button class="btn btn-secondary" id="refreshMap" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
    </div>
    <div id="map"></div>
  </div>
</div>

<!-- ì„ íƒ ëª©ë¡ íŒ¨ë„ -->
<div class="selection-panel" id="selectionPanel">
  <div style="padding: 16px 20px; border-bottom: 1px solid var(--gray-200); background: var(--gray-50); display: flex; justify-content: between; align-items: center;">
    <h3 style="margin: 0; font-size: 16px; font-weight: 600;">ğŸ“‹ ì„ íƒ ëª©ë¡</h3>
    <div>
      <button class="btn btn-accent" id="exportSelection" style="margin-right: 8px;">ğŸ“— ì„ íƒí•­ëª© ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn btn-danger" id="clearSelection">ğŸ—‘ ëª¨ë‘ ì‚­ì œ</button>
    </div>
  </div>
  <div style="flex: 1; overflow-y: auto; padding: 0;">
    <table id="selectionTable" style="width: 100%; font-size: 12px; border-collapse: collapse;">
      <thead>
        <tr style="background: var(--gray-100); position: sticky; top: 0;">
          <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--gray-200);">ID</th>
          <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--gray-200);">ì‹œì„¤ëª…</th>
          <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--gray-200);">ì£¼ì†Œ</th>
          <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--gray-200);">ì¹´í…Œê³ ë¦¬</th>
          <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--gray-200);">êµ°ì§‘</th>
          <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--gray-200);">ìˆœì„œ</th>
          <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--gray-200);">ì•¡ì…˜</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  class CheongJuInspectionMap {
    constructor() {
      this.map = null;
      this.data = [];
      this.filteredData = [];
      this.markers = new Map();
      this.selectedMarkers = new Set();
      this.currentRoute = [];
      this.routePolyline = null;
      this.clusterLayer = null;
      this.dataLayer = null;
      this.useClusterMode = false;
      
      // A/B ê²½ë¡œ ê¸°ëŠ¥
      this.ABpoints = [];
      this.ABmarkers = [];
      this.ABpolyline = null;
      this.ABmode = false;

      this.init();
    }

    async init() {
      this.setupMap();
      this.setupEventListeners();
      this.setupKeyboardNavigation();
      this.setupOnlineStatus();
      this.loadSampleData();
      this.updateUI();
    }

    setupMap() {
      // ì§€ë„ ì´ˆê¸°í™”
      this.map = L.map('map', {
        center: [36.6372, 127.4897], // ì²­ì£¼ì‹œ ì¢Œí‘œ
        zoom: 12,
        zoomControl: true,
        preferCanvas: true
      });

      // ê¸°ë³¸ íƒ€ì¼ ë ˆì´ì–´ (VWorld)
      L.tileLayer('http://api.vworld.kr/req/wmts/1.0.0/D3363E9B-42C1-3E23-9DD1-5618F78E8D33/Base/{z}/{y}/{x}.png', {
        attribution: 'Â© VWorld',
        maxZoom: 18
      }).addTo(this.map);

      // í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ê³¼ ì¼ë°˜ ë ˆì´ì–´ ê·¸ë£¹ ìƒì„±
      this.clusterLayer = L.markerClusterGroup({
        maxClusterRadius: 50,
        iconCreateFunction: function(cluster) {
          const count = cluster.getChildCount();
          let className = 'marker-cluster-small';
          if (count >= 10) className = 'marker-cluster-medium';
          if (count >= 50) className = 'marker-cluster-large';
          
          return L.divIcon({
            html: '<div><span>' + count + '</span></div>',
            className: 'marker-cluster ' + className,
            iconSize: L.point(40, 40)
          });
        }
      });
      
      this.dataLayer = L.layerGroup();
      this.dataLayer.addTo(this.map);
    }

    setupEventListeners() {
      // ë„¤ë¹„ê²Œì´ì…˜ íƒ­
      document.querySelectorAll('.nav-button').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const targetId = btn.id.replace('Tab', 'Section');
          this.showSection(targetId);
          
          // í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
          document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });

      // íŒŒì¼ ì—…ë¡œë“œ
      document.getElementById('fileInput').addEventListener('click', () => {
        document.getElementById('hiddenFileInput').click();
      });
      
      document.getElementById('hiddenFileInput').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          this.loadFile(e.target.files[0]);
        }
      });

      // ê²€ìƒ‰ ê¸°ëŠ¥
      document.getElementById('searchInput').addEventListener('input', () => {
        this.applyFilters();
      });
      
      document.getElementById('searchInputSidebar').addEventListener('input', (e) => {
        document.getElementById('searchInput').value = e.target.value;
        this.applyFilters();
      });

      // í•„í„° ì²´í¬ë°•ìŠ¤ë“¤
      document.getElementById('includeNoCoords').addEventListener('change', () => {
        this.applyFilters();
      });
      
      document.getElementById('onlyUninspected').addEventListener('change', () => {
        this.applyFilters();
      });

      // ê²½ë¡œ ê³„ì‚°
      document.getElementById('calculateRoute').addEventListener('click', () => {
        this.calculateRoute();
      });

      // ì„ íƒ ëª©ë¡ íŒ¨ë„
      document.getElementById('showSelectionPanel').addEventListener('click', () => {
        const panel = document.getElementById('selectionPanel');
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        if (panel.style.display === 'block') {
          this.updateSelectionPanel();
        }
      });

      document.getElementById('clearSelection').addEventListener('click', () => {
        this.clearSelection();
      });

      document.getElementById('exportSelection').addEventListener('click', () => {
        this.exportSelection();
      });

      // ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ë“¤
      document.getElementById('exportExcel').addEventListener('click', () => {
        this.exportToExcel();
      });
      
      document.getElementById('exportPDF').addEventListener('click', () => {
        this.exportToPDF();
      });
      
      document.getElementById('exportImage').addEventListener('click', () => {
        this.exportToImage();
      });

      // ì§€ë„ ì»¨íŠ¸ë¡¤
      document.getElementById('fitToMarkers').addEventListener('click', () => {
        this.fitToMarkers();
      });
      
      document.getElementById('refreshMap').addEventListener('click', () => {
        this.refreshMap();
      });

      // ë‹¤í¬ëª¨ë“œ í† ê¸€
      document.getElementById('darkMode').addEventListener('change', (e) => {
        document.body.classList.toggle('dark', e.target.checked);
      });

      // ë§ˆì»¤ í¬ê¸° ìŠ¬ë¼ì´ë”
      document.getElementById('markerSize').addEventListener('input', (e) => {
        document.getElementById('markerSizeValue').textContent = e.target.value + 'px';
        document.documentElement.style.setProperty('--marker-size', e.target.value + 'px');
      });

      // ì„¤ì • ë³€ê²½ ì´ë²¤íŠ¸ë“¤
      document.getElementById('clusterMarkers').addEventListener('change', (e) => {
        this.toggleClusterMode(e.target.checked);
      });

      document.getElementById('showLabels').addEventListener('change', () => {
        this.updateMarkers();
      });

      // A/B ê²½ë¡œ ê¸°ëŠ¥
      document.getElementById('pickAB').addEventListener('click', () => {
        this.startABMode();
      });
      
      document.getElementById('clearAB').addEventListener('click', () => {
        this.clearABRoute();
      });

      // í•„í„°ê²°ê³¼ ëª¨ë‘ ì¶”ê°€
      document.getElementById('addAllFiltered').addEventListener('click', () => {
        this.addAllFilteredToSelection();
      });

      // ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€ í† ê¸€
      document.getElementById('toggleHideNonRoute').addEventListener('change', () => {
        this.toggleHideNonRouteMarkers();
      });

      // í•„í„° í† ê¸€ë“¤
      document.getElementById('clusterToggle').addEventListener('change', () => {
        this.toggleAllChips('clusterChips', document.getElementById('clusterToggle').checked);
      });
      
      document.getElementById('districtToggle').addEventListener('change', () => {
        this.toggleAllChips('districtChips', document.getElementById('districtToggle').checked);
      });
      
      document.getElementById('categoryToggle').addEventListener('change', () => {
        this.toggleAllChips('categoryChips', document.getElementById('categoryToggle').checked);
      });
    }

    showSection(sectionId) {
      // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
      document.querySelectorAll('.section').forEach(section => {
        section.style.display = 'none';
      });
      
      // í•´ë‹¹ ì„¹ì…˜ë§Œ ë³´ì´ê¸°
      const targetSection = document.getElementById(sectionId);
      if (targetSection) {
        targetSection.style.display = 'block';
      }
    }

    async loadFile(file) {
      try {
        const data = await this.readFile(file);
        let workbook;
        
        if (file.name.endsWith('.csv')) {
          // CSV ì²˜ë¦¬
          const text = new TextDecoder('utf-8').decode(data);
          workbook = XLSX.read(text, { type: 'string' });
        } else {
          // Excel ì²˜ë¦¬
          workbook = XLSX.read(data, { type: 'array' });
        }
        
        // ì‹œíŠ¸ ëª©ë¡ ì—…ë°ì´íŠ¸
        const sheetSelect = document.getElementById('sheetSelect');
        sheetSelect.innerHTML = '';
        workbook.SheetNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          sheetSelect.appendChild(option);
        });
        
        // ì²« ë²ˆì§¸ ì‹œíŠ¸ ë¡œë“œ
        this.processWorksheet(workbook.Sheets[workbook.SheetNames[0]]);
        
      } catch (error) {
        console.error('íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
      }
    }

    readFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(new Uint8Array(e.target.result));
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    processWorksheet(worksheet) {
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
      
      // ë°ì´í„° ë§¤í•‘
      this.data = jsonData.slice(1).map((row, index) => {
        const item = {
          id: `item_${index + 1}`,
          name: row[9] || `í•­ëª© ${index + 1}`, // Jì—´ (ì‹œì„¤ëª…)
          addr: row[17] || '', // Rì—´ (ì£¼ì†Œ)  
          category: row[4] || 'ì¼ë°˜', // Eì—´ (ì¹´í…Œê³ ë¦¬)
          district: row[20] || '', // Uì—´ (ìë©´ë™)
          cluster: row[18] || '1', // Sì—´ (êµ°ì§‘)
          inspectionDate: row[1] || '', // Bì—´ (ì ê²€ì¼)
          lat: parseFloat(row[7]) || null, // Hì—´ (ìœ„ë„)
          lng: parseFloat(row[6]) || null, // Gì—´ (ê²½ë„)
        };
        
        return item;
      }).filter(item => item.name); // ì‹œì„¤ëª…ì´ ìˆëŠ” í•­ëª©ë§Œ
      
      console.log(`ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${this.data.length}ê°œ í•­ëª©`);
      
      this.buildFilterChips();
      this.applyFilters();
      this.updateMarkers();
      this.updateUI();
    }

    buildFilterChips() {
      // êµ°ì§‘ ì¹© ìƒì„±
      const clusters = [...new Set(this.data.map(item => item.cluster))].sort();
      this.buildChips('clusterChips', clusters, 'cluster');
      
      // ìë©´ë™ ì¹© ìƒì„±
      const districts = [...new Set(this.data.map(item => item.district))].filter(d => d).sort();
      this.buildChips('districtChips', districts, 'district');
      
      // ì¹´í…Œê³ ë¦¬ ì¹© ìƒì„±
      const categories = [...new Set(this.data.map(item => item.category))].filter(c => c).sort();
      this.buildChips('categoryChips', categories, 'category');
    }

    buildChips(containerId, values, filterType) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      values.forEach(value => {
        const chip = document.createElement('label');
        chip.className = 'chip';
        chip.innerHTML = `
          <input type="checkbox" checked data-filter="${filterType}" data-value="${value}">
          <span>${value}</span>
        `;
        container.appendChild(chip);
      });
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
      container.addEventListener('change', () => {
        this.applyFilters();
        this.updateToggleStates();
      });
    }

    toggleAllChips(containerId, checked) {
      const container = document.getElementById(containerId);
      const checkboxes = container.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = checked);
      this.applyFilters();
    }

    updateToggleStates() {
      // ê° í† ê¸€ì˜ ìƒíƒœë¥¼ ì‹¤ì œ ì²´í¬ë°•ìŠ¤ ìƒíƒœì— ë§ì¶° ì—…ë°ì´íŠ¸
      this.updateToggleState('clusterToggle', 'clusterChips');
      this.updateToggleState('districtToggle', 'districtChips'); 
      this.updateToggleState('categoryToggle', 'categoryChips');
    }

    updateToggleState(toggleId, chipsId) {
      const toggle = document.getElementById(toggleId);
      const chips = document.getElementById(chipsId);
      const checkboxes = chips.querySelectorAll('input[type="checkbox"]');
      
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      const totalCount = checkboxes.length;
      
      if (checkedCount === totalCount) {
        toggle.checked = true;
        toggle.indeterminate = false;
      } else if (checkedCount === 0) {
        toggle.checked = false;
        toggle.indeterminate = false;
      } else {
        toggle.checked = false;
        toggle.indeterminate = true;
      }
    }

    applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
      const includeNoCoords = document.getElementById('includeNoCoords').checked;
      const onlyUninspected = document.getElementById('onlyUninspected').checked;
      
      // ì„ íƒëœ í•„í„°ê°’ë“¤ ìˆ˜ì§‘
      const selectedClusters = new Set();
      const selectedDistricts = new Set();
      const selectedCategories = new Set();
      
      // ê²€ìƒ‰ì–´ê°€ ìˆì„ ë•Œ ìë™ í•„í„°ë§ ë¡œì§ ê°œì„ 
      if (searchTerm) {
        this.applySearchBasedFiltering(searchTerm, selectedClusters, selectedDistricts, selectedCategories);
      } else {
        // ì¼ë°˜ì ì¸ ì¹© ê¸°ë°˜ í•„í„°ë§
        this.collectSelectedFilters(selectedClusters, selectedDistricts, selectedCategories);
      }
      
      // í•„í„° ì ìš©
      this.filteredData = this.data.filter(item => {
        // ê²€ìƒ‰ì–´ í•„í„°
        if (searchTerm) {
          const searchableText = `${item.name} ${item.addr} ${item.district} ${item.cluster} ${item.category}`.toLowerCase();
          if (!searchableText.includes(searchTerm)) return false;
        }
        
        // ì¢Œí‘œ í•„í„°
        if (!includeNoCoords && (!item.lat || !item.lng)) return false;
        
        // ì ê²€ ìƒíƒœ í•„í„°
        if (onlyUninspected && item.inspectionDate) return false;
        
        // ì„ íƒëœ í•„í„° ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§
        if (selectedClusters.size > 0 && !selectedClusters.has(item.cluster)) return false;
        if (selectedDistricts.size > 0 && !selectedDistricts.has(item.district)) return false;
        if (selectedCategories.size > 0 && !selectedCategories.has(item.category)) return false;
        
        return true;
      });
      
      this.updateMarkers();
      this.updateUI();
      this.updateToggleStates();
    }

    applySearchBasedFiltering(searchTerm, selectedClusters, selectedDistricts, selectedCategories) {
      // ê²€ìƒ‰ì–´ í† í° ë¶„ë¦¬
      const emdTokens = searchTerm.match(/[ê°€-í£]+/g) || [];
      const clusterTokens = searchTerm.match(/\d+/g) || [];
      
      // ëª¨ë“  ê°’ë“¤ì„ ê¸°ë³¸ì ìœ¼ë¡œ ì„ íƒ
      const allClusters = [...new Set(this.data.map(item => item.cluster))];
      const allDistricts = [...new Set(this.data.map(item => item.district))].filter(d => d);
      const allCategories = [...new Set(this.data.map(item => item.category))].filter(c => c);
      
      allClusters.forEach(c => selectedClusters.add(c));
      allDistricts.forEach(d => selectedDistricts.add(d));
      allCategories.forEach(c => selectedCategories.add(c));
      
      // í•œê¸€ í† í°ì´ ìˆìœ¼ë©´ ë§¤ì¹­ë˜ëŠ” ìë©´ë™ë§Œ ì„ íƒ
      if (emdTokens.length > 0) {
        selectedDistricts.clear();
        allDistricts.forEach(district => {
          if (emdTokens.some(token => district.includes(token))) {
            selectedDistricts.add(district);
          }
        });
      }
      
      // ìˆ«ì í† í°ì´ ìˆìœ¼ë©´ ë§¤ì¹­ë˜ëŠ” êµ°ì§‘ë§Œ ì„ íƒ
      if (clusterTokens.length > 0) {
        selectedClusters.clear();
        clusterTokens.forEach(token => {
          if (allClusters.includes(token)) {
            selectedClusters.add(token);
          }
        });
      }
    }

    collectSelectedFilters(selectedClusters, selectedDistricts, selectedCategories) {
      document.querySelectorAll('#clusterChips input:checked').forEach(cb => {
        selectedClusters.add(cb.dataset.value);
      });
      
      document.querySelectorAll('#districtChips input:checked').forEach(cb => {
        selectedDistricts.add(cb.dataset.value);
      });
      
      document.querySelectorAll('#categoryChips input:checked').forEach(cb => {
        selectedCategories.add(cb.dataset.value);
      });
    }

    updateMarkers() {
      // ê¸°ì¡´ ë§ˆì»¤ë“¤ ì œê±°
      this.clearAllMarkers();
      
      // í‘œì‹œí•  ë°ì´í„°ì˜ ì¢Œí‘œê°€ ìˆëŠ” í•­ëª©ë“¤ë§Œ ì²˜ë¦¬
      const validItems = this.filteredData.filter(item => item.lat && item.lng);
      
      validItems.forEach(item => {
        const marker = this.createMarker(item);
        this.markers.set(item.id, marker);
        
        // í˜„ì¬ í´ëŸ¬ìŠ¤í„° ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ë ˆì´ì–´ì— ì¶”ê°€
        if (this.useClusterMode) {
          this.clusterLayer.addLayer(marker);
        } else {
          this.dataLayer.addLayer(marker);
        }
      });
      
      // ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€ ìƒíƒœ ì ìš©
      if (document.getElementById('toggleHideNonRoute').checked) {
        this.toggleHideNonRouteMarkers();
      }
    }

    clearAllMarkers() {
      this.dataLayer.clearLayers();
      this.clusterLayer.clearLayers();
      this.markers.clear();
    }

    createMarker(item) {
      const markerStyle = document.getElementById('markerStyle').value;
      const showLabels = document.getElementById('showLabels').checked;
      const size = parseInt(document.getElementById('markerSize').value);
      
      let markerHtml;
      switch (markerStyle) {
        case 'square':
          markerHtml = `<div style="width: ${size}px; height: ${size}px; background: var(--primary); border: 2px solid white; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${item.cluster}</div>`;
          break;
        case 'pin':
          markerHtml = `<div style="width: ${size}px; height: ${size}px; background: var(--primary); border: 2px solid white; border-radius: 50% 50% 50% 0; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3); transform: rotate(-45deg);"><span style="transform: rotate(45deg);">${item.cluster}</span></div>`;
          break;
        default: // circle
          markerHtml = `<div style="width: ${size}px; height: ${size}px; background: var(--primary); border: 2px solid white; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${item.cluster}</div>`;
      }
      
      const marker = L.marker([item.lat, item.lng], {
        icon: L.divIcon({
          html: markerHtml,
          className: 'custom-marker',
          iconSize: [size, size],
          iconAnchor: [size/2, size/2]
        })
      });
      
      // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
      marker.on('click', () => {
        if (this.ABmode) {
          this.addABPoint([item.lat, item.lng]);
          return;
        }
        
        if (this.selectedMarkers.has(item.id)) {
          this.removeFromSelection(item.id);
        } else {
          this.addToSelection(item.id);
        }
      });
      
      // íŒì—… ì„¤ì •
      const popupContent = `
        <div style="min-width: 200px;">
          <h4 style="margin: 0 0 8px 0; color: var(--primary);">${item.name}</h4>
          <p style="margin: 4px 0; font-size: 12px;"><strong>ì£¼ì†Œ:</strong> ${item.addr}</p>
          <p style="margin: 4px 0; font-size: 12px;"><strong>ì—…ì¢…:</strong> ${item.category}</p>
          <p style="margin: 4px 0; font-size: 12px;"><strong>ìë©´ë™:</strong> ${item.district}</p>
          <p style="margin: 4px 0; font-size: 12px;"><strong>êµ°ì§‘:</strong> ${item.cluster}</p>
          <div style="margin-top: 12px; display: flex; gap: 8px;">
            <button onclick="app.addToSelection('${item.id}')" class="btn btn-primary" style="font-size: 11px; padding: 4px 8px;">ì„ íƒ ì¶”ê°€</button>
            <button onclick="app.openNavigation('${item.lat}', '${item.lng}', '${item.name}')" class="btn btn-accent" style="font-size: 11px; padding: 4px 8px;">ê¸¸ì°¾ê¸°</button>
          </div>
        </div>
      `;
      
      marker.bindPopup(popupContent);
      
      // ë¼ë²¨ í‘œì‹œ
      if (showLabels) {
        marker.bindTooltip(item.name, {
          permanent: true,
          direction: 'top',
          className: 'marker-label',
          opacity: 0.9
        });
      }
      
      // ë§ˆì»¤ì— ë°ì´í„° ID ì €ì¥
      marker.getElement().dataset.id = item.id;
      
      return marker;
    }

    addToSelection(itemId) {
      const item = this.data.find(i => i.id === itemId);
      if (!item) return;
      
      const dailyLimit = parseInt(document.getElementById('dailyLimit').value) || 50;
      
      if (this.selectedMarkers.size >= dailyLimit) {
        alert(`ì¼ì¼ ìµœëŒ€ ë°©ë¬¸ì§€(${dailyLimit}ê°œ)ë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        return;
      }
      
      this.selectedMarkers.add(itemId);
      
      // ë§ˆì»¤ ì‹œê°ì  í‘œì‹œ ì—…ë°ì´íŠ¸
      const marker = this.markers.get(itemId);
      if (marker) {
        marker.getElement().classList.add('selected');
        marker.getElement().style.transform = 'scale(1.2)';
        marker.getElement().style.zIndex = '1000';
      }
      
      this.updateSelectionPanel();
      this.updateUI();
      
      // 2ê°œ ì´ìƒ ì„ íƒë˜ë©´ ìë™ ê²½ë¡œ ê³„ì‚°
      if (this.selectedMarkers.size >= 2) {
        this.calculateRoute();
      }
    }

    removeFromSelection(itemId) {
      this.selectedMarkers.delete(itemId);
      
      // ë§ˆì»¤ ì‹œê°ì  í‘œì‹œ ì œê±°
      const marker = this.markers.get(itemId);
      if (marker) {
        marker.getElement().classList.remove('selected');
        marker.getElement().style.transform = '';
        marker.getElement().style.zIndex = '';
      }
      
      this.updateSelectionPanel();
      this.updateUI();
      
      // ê²½ë¡œ ì¬ê³„ì‚°
      if (this.selectedMarkers.size >= 2) {
        this.calculateRoute();
      } else {
        this.clearRoute();
      }
    }

    clearSelection() {
      // ëª¨ë“  ë§ˆì»¤ì˜ ì„ íƒ ìƒíƒœ ì œê±°
      this.selectedMarkers.forEach(itemId => {
        const marker = this.markers.get(itemId);
        if (marker) {
          marker.getElement().classList.remove('selected');
          marker.getElement().style.transform = '';
          marker.getElement().style.zIndex = '';
        }
      });
      
      this.selectedMarkers.clear();
      this.clearRoute();
      this.updateSelectionPanel();
      this.updateUI();
    }

    updateSelectionPanel() {
      const tbody = document.querySelector('#selectionTable tbody');
      tbody.innerHTML = '';
      
      const selectedItems = this.data.filter(item => this.selectedMarkers.has(item.id));
      
      selectedItems.forEach((item, index) => {
        const routeIndex = this.currentRoute.findIndex(r => r.id === item.id);
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid var(--gray-200)';
        
        row.innerHTML = `
          <td style="padding: 8px; font-weight: 600;">${item.id}</td>
          <td style="padding: 8px;">${item.name}</td>
          <td style="padding: 8px; font-size: 11px;">${item.addr}</td>
          <td style="padding: 8px;">${item.category}</td>
          <td style="padding: 8px; text-align: center;">${item.cluster}</td>
          <td style="padding: 8px; text-align: center;">${routeIndex >= 0 ? routeIndex + 1 : '-'}</td>
          <td style="padding: 8px;">
            <button onclick="app.removeFromSelection('${item.id}')" class="btn btn-danger" style="font-size: 10px; padding: 2px 6px;">ì‚­ì œ</button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    async calculateRoute() {
      if (this.selectedMarkers.size < 2) {
        alert('ìµœì†Œ 2ê°œ ì´ìƒì˜ ì§€ì ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }
      
      const button = document.getElementById('calculateRoute');
      const originalText = button.textContent;
      button.textContent = 'ê³„ì‚° ì¤‘...';
      button.classList.add('loading');
      
      try {
        const selectedItems = this.data.filter(item => this.selectedMarkers.has(item.id) && item.lat && item.lng);
        const algorithm = document.getElementById('routeAlgorithm').value;
        const fixEnds = document.getElementById('fixEnds').checked;
        
        let orderedRoute;
        
        switch (algorithm) {
          case 'tsp':
            orderedRoute = await this.solveTSP(selectedItems, fixEnds);
            break;
          case 'cluster':
            orderedRoute = this.clusterBasedRoute(selectedItems, fixEnds);
            break;
          default: // nearest
            orderedRoute = this.nearestNeighborRoute(selectedItems, fixEnds);
        }
        
        this.currentRoute = orderedRoute;
        this.drawRoute();
        this.updateRouteStats();
        this.updateSelectionPanel();
        
        // ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€ ì²˜ë¦¬
        if (document.getElementById('toggleHideNonRoute').checked) {
          this.toggleHideNonRouteMarkers();
        }
        
      } catch (error) {
        console.error('ê²½ë¡œ ê³„ì‚° ì‹¤íŒ¨:', error);
        alert('ê²½ë¡œ ê³„ì‚°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      } finally {
        button.textContent = originalText;
        button.classList.remove('loading');
      }
    }

    nearestNeighborRoute(points, fixEnds = false) {
      if (points.length === 0) return [];
      
      const route = [];
      const remaining = [...points];
      
      // ì‹œì‘ì  ê²°ì •
      let current;
      if (fixEnds && points.length >= 2) {
        current = remaining.shift(); // ì²« ë²ˆì§¸ë¥¼ ì‹œì‘ì ìœ¼ë¡œ
      } else {
        current = remaining.splice(0, 1)[0]; // ì²« ë²ˆì§¸ ì ë¶€í„° ì‹œì‘
      }
      
      route.push(current);
      
      // ìµœê·¼ì ‘ ì´ì›ƒìœ¼ë¡œ ê²½ë¡œ êµ¬ì„±
      while (remaining.length > 1 || (remaining.length === 1 && !fixEnds)) {
        let nearestIndex = 0;
        let minDistance = this.calculateDistance(current, remaining[0]);
        
        for (let i = 1; i < remaining.length; i++) {
          const distance = this.calculateDistance(current, remaining[i]);
          if (distance < minDistance) {
            minDistance = distance;
            nearestIndex = i;
          }
        }
        
        current = remaining.splice(nearestIndex, 1)[0];
        route.push(current);
      }
      
      // ëì  ê³ ì •
      if (fixEnds && remaining.length === 1) {
        route.push(remaining[0]);
      }
      
      return route;
    }

    clusterBasedRoute(points, fixEnds = false) {
      // êµ°ì§‘ë³„ë¡œ ê·¸ë£¹í•‘
      const clusters = {};
      points.forEach(point => {
        if (!clusters[point.cluster]) {
          clusters[point.cluster] = [];
        }
        clusters[point.cluster].push(point);
      });
      
      // ê° í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ ìµœê·¼ì ‘ ì´ì›ƒ ì ìš©
      const route = [];
      Object.keys(clusters).sort().forEach(clusterKey => {
        const clusterPoints = clusters[clusterKey];
        const clusterRoute = this.nearestNeighborRoute(clusterPoints, false);
        route.push(...clusterRoute);
      });
      
      return route;
    }

    async solveTSP(points, fixEnds = false) {
      // ê°„ë‹¨í•œ 2-opt ìµœì í™”ë¥¼ ì ìš©í•œ TSP í•´ë²•
      let route = this.nearestNeighborRoute(points, fixEnds);
      
      // 2-opt ê°œì„ 
      let improved = true;
      while (improved) {
        improved = false;
        
        for (let i = 1; i < route.length - 2; i++) {
          for (let j = i + 1; j < route.length - 1; j++) {
            if (fixEnds && (i === 0 || j === route.length - 2)) continue;
            
            const currentDistance = 
              this.calculateDistance(route[i-1], route[i]) +
              this.calculateDistance(route[j], route[j+1]);
            
            const newDistance =
              this.calculateDistance(route[i-1], route[j]) +
              this.calculateDistance(route[i], route[j+1]);
            
            if (newDistance < currentDistance) {
              // ê²½ë¡œ ìˆœì„œ ë’¤ì§‘ê¸°
              const newRoute = [
                ...route.slice(0, i),
                ...route.slice(i, j + 1).reverse(),
                ...route.slice(j + 1)
              ];
              route = newRoute;
              improved = true;
            }
          }
        }
      }
      
      return route;
    }

    calculateDistance(point1, point2) {
      const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
      const dLat = (point2.lat - point1.lat) * Math.PI / 180;
      const dLon = (point2.lng - point1.lng) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    drawRoute() {
      // ê¸°ì¡´ ê²½ë¡œ ì œê±°
      if (this.routePolyline) {
        this.map.removeLayer(this.routePolyline);
      }
      
      if (this.currentRoute.length < 2) return;
      
      const routeCoords = this.currentRoute.map(item => [item.lat, item.lng]);
      
      this.routePolyline = L.polyline(routeCoords, {
        color: 'var(--primary)',
        weight: 4,
        opacity: 0.8,
        dashArray: '10, 5',
        className: 'route-polyline'
      }).addTo(this.map);
      
      // ê²½ë¡œì— ìˆœì„œ í‘œì‹œ
      this.currentRoute.forEach((item, index) => {
        const marker = this.markers.get(item.id);
        if (marker) {
          const element = marker.getElement();
          if (element) {
            const orderLabel = document.createElement('div');
            orderLabel.className = 'route-order-label';
            orderLabel.style.cssText = `
              position: absolute;
              top: -8px;
              right: -8px;
              background: var(--accent);
              color: white;
              border-radius: 50%;
              width: 18px;
              height: 18px;
              font-size: 10px;
              font-weight: bold;
              display: flex;
              align-items: center;
              justify-content: center;
              box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            `;
            orderLabel.textContent = index + 1;
            
            // ê¸°ì¡´ ìˆœì„œ ë¼ë²¨ ì œê±°
            const existingLabel = element.querySelector('.route-order-label');
            if (existingLabel) {
              existingLabel.remove();
            }
            
            element.appendChild(orderLabel);
          }
        }
      });
    }

    clearRoute() {
      if (this.routePolyline) {
        this.map.removeLayer(this.routePolyline);
        this.routePolyline = null;
      }
      
      // ìˆœì„œ ë¼ë²¨ ì œê±°
      this.markers.forEach(marker => {
        const element = marker.getElement();
        if (element) {
          const label = element.querySelector('.route-order-label');
          if (label) {
            label.remove();
          }
        }
      });
      
      this.currentRoute = [];
      document.getElementById('routeStats').style.display = 'none';
    }

    updateRouteStats() {
      if (this.currentRoute.length < 2) return;
      
      let totalDistance = 0;
      for (let i = 0; i < this.currentRoute.length - 1; i++) {
        totalDistance += this.calculateDistance(this.currentRoute[i], this.currentRoute[i + 1]);
      }
      
      const estimatedTime = Math.ceil(totalDistance / 30 * 60); // 30km/h ê°€ì •, ë¶„ ë‹¨ìœ„
      
      document.getElementById('routeDistance').textContent = `${totalDistance.toFixed(1)}km`;
      document.getElementById('routeTime').textContent = `${estimatedTime}ë¶„`;
      document.getElementById('routeCount').textContent = `${this.currentRoute.length}ê³³`;
      document.getElementById('routeStats').style.display = 'block';
    }

    // A/B ê²½ë¡œ ì¸¡ì • ê¸°ëŠ¥
    startABMode() {
      this.ABmode = true;
      this.clearABRoute();
      
      document.getElementById('abInfo').textContent = 'A/B: ì§€ë„ì—ì„œ ë‘ ì§€ì ì„ í´ë¦­í•˜ì„¸ìš”';
      document.getElementById('pickAB').style.display = 'none';
      document.getElementById('clearAB').style.display = 'block';
      
      // ì§€ë„ ì»¤ì„œ ë³€ê²½
      this.map.getContainer().style.cursor = 'crosshair';
    }

    addABPoint(latlng) {
      if (this.ABpoints.length >= 2) return;
      
      this.ABpoints.push(latlng);
      
      // A/B ë§ˆì»¤ ìƒì„±
      const label = this.ABpoints.length === 1 ? 'A' : 'B';
      const marker = L.marker(latlng, {
        icon: L.divIcon({
          html: `<div class="ab-marker">${label}</div>`,
          className: '',
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        })
      }).addTo(this.map);
      
      this.ABmarkers.push(marker);
      
      document.getElementById('abInfo').textContent = `A/B: ${this.ABpoints.length}ê°œ ì„ íƒë¨`;
      
      if (this.ABpoints.length === 2) {
        this.calculateABRoute();
        this.ABmode = false;
        this.map.getContainer().style.cursor = '';
      }
    }

    calculateABRoute() {
      if (this.ABpoints.length !== 2) return;
      
      // ì§ì„  ê±°ë¦¬ ê³„ì‚°
      const distance = this.calculateDistance(
        {lat: this.ABpoints[0][0], lng: this.ABpoints[0][1]},
        {lat: this.ABpoints[1][0], lng: this.ABpoints[1][1]}
      );
      
      // ê²½ë¡œì„  ê·¸ë¦¬ê¸°
      this.ABpolyline = L.polyline(this.ABpoints, {
        color: 'var(--danger)',
        weight: 3,
        opacity: 0.9,
        dashArray: '5, 5',
        className: 'ab-route-polyline'
      }).addTo(this.map);
      
      // ê²°ê³¼ í‘œì‹œ
      document.getElementById('abInfo').innerHTML = `
        <strong>A/B ê±°ë¦¬:</strong> ${distance.toFixed(2)}km<br>
        <small>ì§ì„ ê±°ë¦¬ ê¸°ì¤€</small>
      `;
    }

    clearABRoute() {
      // A/B ë§ˆì»¤ ì œê±°
      this.ABmarkers.forEach(marker => {
        this.map.removeLayer(marker);
      });
      this.ABmarkers = [];
      
      // A/B ê²½ë¡œì„  ì œê±°
      if (this.ABpolyline) {
        this.map.removeLayer(this.ABpolyline);
        this.ABpolyline = null;
      }
      
      this.ABpoints = [];
      this.ABmode = false;
      
      document.getElementById('abInfo').textContent = '';
      document.getElementById('pickAB').style.display = 'block';
      document.getElementById('clearAB').style.display = 'none';
      
      this.map.getContainer().style.cursor = '';
    }

    // í•„í„°ê²°ê³¼ ëª¨ë‘ ì„ íƒëª©ë¡ì— ì¶”ê°€
    addAllFilteredToSelection() {
      const validItems = this.filteredData.filter(item => item.lat && item.lng);
      const dailyLimit = parseInt(document.getElementById('dailyLimit').value) || 50;
      
      if (validItems.length === 0) {
        alert('ì¶”ê°€í•  ìˆ˜ ìˆëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ì¼ì¼ í•œë„ ì²´í¬
      const availableSlots = dailyLimit - this.selectedMarkers.size;
      if (availableSlots <= 0) {
        alert('ì¼ì¼ ìµœëŒ€ ë°©ë¬¸ì§€ í•œë„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.');
        return;
      }
      
      const itemsToAdd = validItems.slice(0, availableSlots);
      let addedCount = 0;
      
      itemsToAdd.forEach(item => {
        if (!this.selectedMarkers.has(item.id)) {
          this.selectedMarkers.add(item.id);
          
          // ë§ˆì»¤ ì‹œê°ì  í‘œì‹œ ì—…ë°ì´íŠ¸
          const marker = this.markers.get(item.id);
          if (marker) {
            marker.getElement().classList.add('selected');
            marker.getElement().style.transform = 'scale(1.2)';
            marker.getElement().style.zIndex = '1000';
          }
          
          addedCount++;
        }
      });
      
      if (addedCount > 0) {
        this.updateSelectionPanel();
        this.updateUI();
        
        if (this.selectedMarkers.size >= 2) {
          this.calculateRoute();
        }
        
        alert(`${addedCount}ê°œ í•­ëª©ì„ ì„ íƒëª©ë¡ì— ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.`);
      } else {
        alert('ì¶”ê°€í•  ìˆ˜ ìˆëŠ” ìƒˆë¡œìš´ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
      }
    }

    // ê²½ë¡œ ì™¸ ë§ˆì»¤ ìˆ¨ê¹€/í‘œì‹œ
    toggleHideNonRouteMarkers() {
      const hideNonRoute = document.getElementById('toggleHideNonRoute').checked;
      
      if (!hideNonRoute || this.currentRoute.length === 0) {
        // ëª¨ë“  ë§ˆì»¤ í‘œì‹œ
        this.markers.forEach(marker => {
          const element = marker.getElement();
          if (element) {
            element.classList.remove('hidden-marker');
          }
        });
        return;
      }
      
      // ê²½ë¡œì— í¬í•¨ëœ ë§ˆì»¤ IDë“¤
      const routeIds = new Set(this.currentRoute.map(item => item.id));
      
      // ë§ˆì»¤ ìˆ¨ê¹€/í‘œì‹œ ì²˜ë¦¬
      this.markers.forEach((marker, id) => {
        const element = marker.getElement();
        if (element) {
          if (routeIds.has(id)) {
            element.classList.remove('hidden-marker');
          } else {
            element.classList.add('hidden-marker');
          }
        }
      });
    }

    // í´ëŸ¬ìŠ¤í„° ëª¨ë“œ í† ê¸€
    toggleClusterMode(useCluster) {
      this.useClusterMode = useCluster;
      
      // í˜„ì¬ ë ˆì´ì–´ì—ì„œ ëª¨ë“  ë§ˆì»¤ ì œê±°
      this.map.removeLayer(this.dataLayer);
      this.map.removeLayer(this.clusterLayer);
      
      // ë§ˆì»¤ë“¤ì„ ì ì ˆí•œ ë ˆì´ì–´ë¡œ ì´ë™
      if (useCluster) {
        this.markers.forEach(marker => {
          this.clusterLayer.addLayer(marker);
        });
        this.map.addLayer(this.clusterLayer);
      } else {
        this.markers.forEach(marker => {
          this.dataLayer.addLayer(marker);
        });
        this.map.addLayer(this.dataLayer);
      }
    }

    fitToMarkers() {
      if (this.filteredData.length === 0) return;

      const validPoints = this.filteredData.filter(item => item.lat && item.lng);
      if (validPoints.length === 0) return;

      const bounds = L.latLngBounds(validPoints.map(item => [item.lat, item.lng]));
      this.map.fitBounds(bounds, { padding: [20, 20] });
    }

    refreshMap() {
      this.applyFilters();
      this.updateMarkers();
    }

    updateUI() {
      // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
      const totalCount = this.data.length;
      const shownCount = this.filteredData.filter(item => item.lat && item.lng).length;
      const missingCount = this.data.filter(item => !item.lat || !item.lng).length;
      const filteredCount = totalCount - this.filteredData.length;

      document.getElementById('totalCount').textContent = `ì´: ${totalCount}`;
      document.getElementById('shownCount').textContent = `í‘œì‹œ: ${shownCount}`;
      document.getElementById('missingCount').textContent = `ì¢Œí‘œì—†ìŒ: ${missingCount}`;
      document.getElementById('filteredCount').textContent = `ì œì™¸: ${filteredCount}`;

      // ì„ íƒ ë²„íŠ¼ ì—…ë°ì´íŠ¸
      document.getElementById('showSelectionPanel').innerHTML = 
        `ğŸ“‹ ì„ íƒ ëª©ë¡ (${this.selectedMarkers.size})`;
    }

    setupKeyboardNavigation() {
      document.addEventListener('keydown', (e) => {
        // Escape: íŒì—… ë‹«ê¸°
        if (e.key === 'Escape') {
          this.map.closePopup();
          const panel = document.getElementById('selectionPanel');
          if (panel.style.display === 'block') {
            panel.style.display = 'none';
          }
        }

        // Ctrl+A: ì „ì²´ ì„ íƒ
        if (e.ctrlKey && e.key === 'a') {
          e.preventDefault();
          this.selectAll();
        }

        // Ctrl+D: ì„ íƒ í•´ì œ
        if (e.ctrlKey && e.key === 'd') {
          e.preventDefault();
          this.clearSelection();
        }

        // F: ì§€ë„ ë§ì¶¤
        if (e.key === 'f' || e.key === 'F') {
          this.fitToMarkers();
        }
      });
    }

    selectAll() {
      const validItems = this.filteredData.filter(item => item.lat && item.lng);
      const dailyLimit = parseInt(document.getElementById('dailyLimit').value) || 50;
      
      // ì¼ì¼ í•œë„ë§Œí¼ë§Œ ì„ íƒ
      const itemsToSelect = validItems.slice(0, dailyLimit);
      
      this.clearSelection();
      itemsToSelect.forEach(item => {
        this.selectedMarkers.add(item.id);
        const marker = this.markers.get(item.id);
        if (marker) {
          marker.getElement().classList.add('selected');
        }
      });

      this.updateSelectionPanel();
      this.updateUI();
      
      if (this.selectedMarkers.size >= 2) {
        this.calculateRoute();
      }
    }

    setupOnlineStatus() {
      const statusEl = document.getElementById('onlineStatus');
      
      const updateStatus = () => {
        if (navigator.onLine) {
          statusEl.textContent = 'ì˜¨ë¼ì¸';
          statusEl.className = 'online-status online';
        } else {
          statusEl.textContent = 'ì˜¤í”„ë¼ì¸';
          statusEl.className = 'online-status offline';
        }
      };
      
      window.addEventListener('online', updateStatus);
      window.addEventListener('offline', updateStatus);
      updateStatus();
    }

    openNavigation(lat, lng, name) {
      // ë‚´ë¹„ê²Œì´ì…˜ ì•±ìœ¼ë¡œ ì—°ê²°
      const apps = [
        { name: 'ì¹´ì¹´ì˜¤ë§µ', url: `kakaomap://route?ep=${lat},${lng}&by=CAR` },
        { name: 'ë„¤ì´ë²„ì§€ë„', url: `nmap://route/car?dlat=${lat}&dlng=${lng}&dname=${encodeURIComponent(name)}` },
        { name: 'êµ¬ê¸€ì§€ë„', url: `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}` }
      ];
      
      // ì‚¬ìš© ê°€ëŠ¥í•œ ì•± í™•ì¸ í›„ ì—°ê²°
      apps.forEach(app => {
        window.open(app.url, '_blank');
      });
    }

    // ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ë“¤
    exportSelection() {
      if (this.selectedMarkers.size === 0) {
        alert('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const selectedItems = this.data.filter(item => this.selectedMarkers.has(item.id));
      this.exportToExcel(selectedItems);
    }

    exportToExcel(data = null) {
      const exportData = data || this.filteredData;
      
      if (exportData.length === 0) {
        alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const worksheet = XLSX.utils.json_to_sheet(exportData.map((item, index) => ({
        'ìˆœë²ˆ': index + 1,
        'ê³ ìœ ë²ˆí˜¸': item.id,
        'ì‹œì„¤ëª…': item.name,
        'ì£¼ì†Œ': item.addr,
        'ì—…ì¢…': item.category,
        'ìë©´ë™': item.district,
        'êµ°ì§‘': item.cluster,
        'ì ê²€ì¼': item.inspectionDate,
        'ìœ„ë„': item.lat,
        'ê²½ë„': item.lng,
        'ê²½ë¡œìˆœì„œ': this.currentRoute.findIndex(r => r.id === item.id) + 1 || ''
      })));

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'ì ê²€ëŒ€ìƒì§€');

      const filename = `ì²­ì£¼_ê¸ˆì—°êµ¬ì—­_ì ê²€ëŒ€ìƒì§€_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(workbook, filename);
    }

    async exportToPDF() {
      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('l', 'mm', 'a4'); // ê°€ë¡œ ë°©í–¥
        
        // ì§€ë„ ìº¡ì²˜
        const mapElement = document.getElementById('map');
        const canvas = await html2canvas(mapElement, {
          useCORS: true,
          allowTaint: true,
          scale: document.getElementById('exportHighQuality').checked ? 2 : 1
        });
        
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 277; // A4 ê°€ë¡œ í¬ê¸° (mm)
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
        
        // ë©”íƒ€ë°ì´í„° ì¶”ê°€
        pdf.setFontSize(12);
        pdf.text(`ì²­ì£¼ì‹œ ê¸ˆì—°êµ¬ì—­ ì ê²€ì§€ë„`, 10, imgHeight + 25);
        pdf.text(`ìƒì„±ì¼: ${new Date().toLocaleDateString()}`, 10, imgHeight + 35);
        pdf.text(`ì´ ${this.filteredData.length}ê°œ ì§€ì  í‘œì‹œ`, 10, imgHeight + 45);
        
        if (this.currentRoute.length > 0) {
          pdf.text(`ê²½ë¡œ: ${this.currentRoute.length}ê°œ ì§€ì `, 10, imgHeight + 55);
        }
        
        const filename = `ì²­ì£¼_ê¸ˆì—°êµ¬ì—­_ì§€ë„_${new Date().toISOString().slice(0, 10)}.pdf`;
        pdf.save(filename);
      } catch (error) {
        console.error('PDF ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
        alert('PDF ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async exportToImage() {
      try {
        const mapElement = document.getElementById('map');
        const canvas = await html2canvas(mapElement, {
          useCORS: true,
          allowTaint: true,
          scale: document.getElementById('exportHighQuality').checked ? 2 : 1
        });
        
        // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
        const link = document.createElement('a');
        link.download = `ì²­ì£¼_ê¸ˆì—°êµ¬ì—­_ì§€ë„_${new Date().toISOString().slice(0, 10)}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (error) {
        console.error('ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
        alert('ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ (í…ŒìŠ¤íŠ¸ìš©)
    loadSampleData() {
      this.data = [
        {
          id: 'sample_1',
          name: 'ì²­ì£¼ì‹œì²­ ê¸ˆì—°êµ¬ì—­',
          addr: 'ì¶©ì²­ë¶ë„ ì²­ì£¼ì‹œ ìƒë‹¹êµ¬ ìƒë‹¹ë¡œ 69',
          category: 'ê´€ê³µì„œ',
          district: 'ì¤‘ì•™ë™',
          cluster: '1',
          inspectionDate: '2024-01-15',
          lat: 36.6372,
          lng: 127.4897
        },
        {
          id: 'sample_2', 
          name: 'ì²­ì£¼ì—­ ê¸ˆì—°êµ¬ì—­',
          addr: 'ì¶©ì²­ë¶ë„ ì²­ì£¼ì‹œ í¥ë•êµ¬ ê°€ê²½ë™',
          category: 'êµí†µì‹œì„¤',
          district: 'ê°€ê²½ë™',
          cluster: '2',
          inspectionDate: '',
          lat: 36.6145,
          lng: 127.4199
        },
        {
          id: 'sample_3',
          name: 'ì²­ì£¼ëŒ€í•™êµ ê¸ˆì—°êµ¬ì—­',
          addr: 'ì¶©ì²­ë¶ë„ ì²­ì£¼ì‹œ ì²­ì›êµ¬ ëŒ€ì„±ë¡œ 298',
          category: 'êµìœ¡ì‹œì„¤',
          district: 'ë‚´ë•ë™',
          cluster: '3',
          inspectionDate: '2024-02-01',
          lat: 36.6040,
          lng: 127.4760
        }
      ];

      this.buildFilterChips();
      this.applyFilters();
      this.updateMarkers();
      this.updateUI();
    }
  }

  // ì• í”Œë¦¬ì¼€ì´ì…˜ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì „ì—­ ë…¸ì¶œ
  let app;
  document.addEventListener('DOMContentLoaded', () => {
    app = new CheongJuInspectionMap();
    window.app = app; // ì „ì—­ ì ‘ê·¼ì„ ìœ„í•´
  });
</script>
</body>
</html>